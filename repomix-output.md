This file is a merged representation of the entire codebase, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.claude/
  settings.local.json
agentic_fixer/
  code_security_auto_fixer/
    orchestrators/
      __init__.py
      autogen_orchestrator.py
      base.py
      crewai_orchestrator.py
      langgraph_orchestrator.py
      sequential_orchestrator.py
      shared_tools.py
    __init__.py
    ai_fixer.py
    cli.py
    comprehensive_db_storage.py
    config.py
    csv_exporter.py
    db_exporter.py
    db_reader.py
    enhanced_security_policies.py
    langgraph_graph.py
    langgraph_tools.py
    language_detector.py
    patcher.py
    pattern_detector.py
    repo_scanner.py
    reporter.py
    security_policies.py
    test_runner.py
  repo_storage/
    COMP.SE.610-620-Autumn-2024-Software-Engineering-Project-1-and-2.git.db
  static/
    css/
      style.css
    js/
      app.js
  templates/
    error.html
    index.html
    results.html
  app.py
  batch_scan_repos.py
  debug_large_scan.py
  debug_scan.py
  direct_test.py
  minimal_test.py
  README.md
  requirements.txt
  scan_onlook_repo.py
  test_analytics.py
  test_comprehensive_storage.py
  test_globals.py
  test_side_by_side.py
  test_simple.py
  test_status.py
  test_upload_debug.py
electron/
  services/
    analysis.ts
    fileSystem.ts
    git.ts
    languages.ts
    patchBatch.ts
    scheduler.ts
    securityScanner.ts
  main.ts
  preload.ts
releases/
  .gitkeep
  Bridge-0.1.0-arm64.dmg
src/
  components/
    Cleanup/
      Cleanup.tsx
    Dashboard/
      Dashboard.tsx
    FileBrowser/
      FileBrowser.tsx
    Layout/
      Header.tsx
      Sidebar.tsx
    PatchBatch/
      PatchBatch.tsx
    Scheduler/
      Scheduler.tsx
    Security/
      Security.tsx
  contexts/
    RepositoryContext.tsx
    ThemeContext.tsx
  types/
    global.d.ts
    index.ts
  App.tsx
  index.css
  main.tsx
.gitignore
index.html
package.json
README.md
tsconfig.json
tsconfig.node.json
vite.config.ts
```

# Files

## File: .claude/settings.local.json
````json
{
  "permissions": {
    "allow": [
      "Bash(npm install:*)",
      "Bash(npm run dev:*)",
      "Bash(npm run build:*)",
      "Bash(git status:*)"
    ]
  }
}
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/__init__.py
````python
"""
Orchestrator module for different agentic frameworks.
All orchestrators implement the same workflow for fair comparison.
"""

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class BaseOrchestrator(ABC):
    """Abstract base class for all orchestrator implementations"""
    
    @abstractmethod
    def run(self, repo: str, fix: bool = False, report_path: str = 'remediation_report.md', **kwargs) -> Dict[str, Any]:
        """
        Execute the security scanning workflow
        
        Args:
            repo: Repository path or URL
            fix: Whether to auto-fix issues
            report_path: Path for the output report
            **kwargs: Additional framework-specific parameters (may include progress_callback)
            
        Returns:
            Dictionary with results including 'report_path', 'status', 'languages', 
            'findings', 'prioritized', 'explanations', 'file_status', etc.
        """
        pass
    
    @abstractmethod
    def get_name(self) -> str:
        """Return the name of the orchestrator"""
        pass
    
    @abstractmethod
    def get_description(self) -> str:
        """Return a description of the orchestrator"""
        pass


def get_orchestrator(name: str) -> BaseOrchestrator:
    """
    Factory function to get an orchestrator instance
    
    Args:
        name: Name of the orchestrator ('langgraph', 'autogen', 'crewai', 'sequential')
        
    Returns:
        BaseOrchestrator instance
    """
    name_lower = name.lower()
    
    if name_lower == 'langgraph':
        from .langgraph_orchestrator import LangGraphOrchestrator
        return LangGraphOrchestrator()
    elif name_lower == 'autogen':
        from .autogen_orchestrator import AutoGenOrchestrator
        return AutoGenOrchestrator()
    elif name_lower == 'sequential':
        from .sequential_orchestrator import SequentialOrchestrator
        return SequentialOrchestrator()
    elif name_lower == 'crewai':
        from .crewai_orchestrator import CrewAIOrchestrator
        return CrewAIOrchestrator()
    else:
        raise ValueError(f"Unknown orchestrator: {name}. Available: langgraph, autogen, crewai, sequential")


def list_available_orchestrators() -> Dict[str, str]:
    """
    List all available orchestrators with their descriptions
    
    Returns:
        Dictionary mapping orchestrator names to descriptions
    """
    orchestrators = {}
    
    try:
        from .langgraph_orchestrator import LangGraphOrchestrator
        lg = LangGraphOrchestrator()
        orchestrators[lg.get_name()] = lg.get_description()
    except ImportError:
        pass
    
    try:
        from .autogen_orchestrator import AutoGenOrchestrator
        ag = AutoGenOrchestrator()
        orchestrators[ag.get_name()] = ag.get_description()
    except ImportError:
        pass
    
    try:
        from .sequential_orchestrator import SequentialOrchestrator
        sq = SequentialOrchestrator()
        orchestrators[sq.get_name()] = sq.get_description()
    except ImportError:
        pass
    
    try:
        from .crewai_orchestrator import CrewAIOrchestrator
        ca = CrewAIOrchestrator()
        orchestrators[ca.get_name()] = ca.get_description()
    except ImportError:
        pass
    
    return orchestrators

__all__ = ['BaseOrchestrator', 'get_orchestrator', 'list_available_orchestrators']
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/autogen_orchestrator.py
````python
"""
AutoGen orchestrator implementation using multi-agent collaboration.
Agents: Scanner, Analyzer, Fixer, Validator

This implementation uses AutoGen's multi-agent conversation pattern
while executing the actual workflow steps directly for reliability.
"""

from typing import Dict, Any, Optional, Callable
import os

try:
    # Check if pyautogen or autogen_agentchat is installed
    import pyautogen
    AUTOGEN_AVAILABLE = True
except ImportError:
    try:
        import autogen_agentchat
        AUTOGEN_AVAILABLE = True
    except ImportError:
        AUTOGEN_AVAILABLE = False

from .base import BaseOrchestrator
from .shared_tools import (
    detect_repo_path,
    detect_languages,
    scan_patterns,
    prioritize,
    explain,
    apply_patches,
    run_tests,
    build_file_status,
    write_report,
)

# Import config for AI model settings
try:
    from ..config import QWEN3_API_BASE_URL, QWEN3_MODEL_NAME
except ImportError:
    QWEN3_API_BASE_URL = "http://86.50.169.115:11434"
    QWEN3_MODEL_NAME = "qwen3-coder:latest"


class AutoGenOrchestrator(BaseOrchestrator):
    """AutoGen-based orchestrator with multi-agent collaboration"""
    
    def __init__(self):
        if not AUTOGEN_AVAILABLE:
            raise ImportError(
                "AutoGen is not installed. Install it with: pip install pyautogen"
            )
        # Don't initialize agents here - do it lazily if needed
        # This avoids LLM initialization issues when just checking availability
        self._agents_initialized = False
    
    def _initialize_agents(self):
        """Initialize AutoGen agents with their specific roles"""
        if self._agents_initialized:
            return
        
        # For AutoGen v0.10+, we can skip LLM initialization since we execute tools directly
        # This makes the orchestrator work even if LLM config is not set up
        # The multi-agent coordination is simulated through the workflow steps
        
        # Store agent names for logging purposes
        self.scanner_agent_name = "scanner"
        self.analyzer_agent_name = "analyzer"
        self.fixer_agent_name = "fixer"
        self.validator_agent_name = "validator"
        
        self._agents_initialized = True
    
    def run(self, repo: str, fix: bool = False, report_path: str = 'remediation_report.md', 
            progress_callback: Optional[Callable] = None, **kwargs) -> Dict[str, Any]:
        """
        Execute the security scanning workflow using AutoGen multi-agent collaboration.
        This follows the same workflow as LangGraph for fair comparison.
        
        Args:
            repo: Repository path or URL
            fix: Whether to auto-fix issues
            report_path: Path for the output report
            progress_callback: Optional callback function(step, progress, message) for progress updates
            **kwargs: Additional parameters
        """
        # Initialize agents if not already done
        self._initialize_agents()
        
        # Initialize state (same structure as LangGraph SecState)
        state = {
            'repo': repo,
            'repo_path': None,
            'languages': [],
            'findings': [],
            'prioritized': [],
            'explanations': [],
            'file_status': [],
            'patched': [],
            'tests_ok': True,
            'attempts': 0,
            'report_path': report_path,
            'fix': fix,
        }
        
        # Step 1: Scanner Agent - Scan repository and detect languages
        if progress_callback:
            progress_callback('scan_repo', 10, 'Scanning repository...')
        state['repo_path'] = detect_repo_path(repo)
        
        if progress_callback:
            progress_callback('detect_langs', 25, 'Detecting programming languages...')
        state['languages'] = detect_languages(state['repo_path'])
        
        # Notify scanner agent (for coordination/logging)
        # In AutoGen workflow, agents coordinate the steps
        # Since we're executing tools directly, we simulate agent coordination
        print(f"[AutoGen] {self.scanner_agent_name}: Repository scanned: {state['repo_path']}. Languages detected: {', '.join(state['languages'])}")
        
        # Step 2: Analyzer Agent - Scan patterns, prioritize, and explain
        if progress_callback:
            progress_callback('scan_patterns', 40, 'Scanning for insecure patterns...')
        state['findings'] = scan_patterns(state['repo_path'], state['languages'])
        
        if progress_callback:
            progress_callback('prioritize', 55, 'Normalizing and prioritizing findings...')
        state['prioritized'] = prioritize(state['findings'])
        state['explanations'] = explain(state['prioritized'])
        state['file_status'] = build_file_status(state['repo_path'], state['prioritized'])
        
        # Notify analyzer agent
        print(f"[AutoGen] {self.analyzer_agent_name}: Analysis complete. Found {len(state['prioritized'])} security issues.")
        
        # Step 3: Fixer Agent - Apply patches (if fix is enabled)
        if fix:
            if progress_callback:
                progress_callback('apply_patches', 85, 'Applying patches...')
            state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
            
            # Notify fixer agent
            print(f"[AutoGen] {self.fixer_agent_name}: Applied patches to {len(state['patched'])} files.")
            
            # Step 4: Validator Agent - Run tests
            if progress_callback:
                progress_callback('run_tests', 90, 'Running tests...')
            state['tests_ok'] = run_tests(state['repo_path'])
            state['attempts'] += 1
            
            # Retry logic if tests fail (same as LangGraph)
            if not state['tests_ok'] and state['attempts'] < 2:
                # Try fixing again
                state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
                state['tests_ok'] = run_tests(state['repo_path'])
                state['attempts'] += 1
            
            # Notify validator agent
            status_msg = "Tests passed" if state['tests_ok'] else "Tests failed"
            print(f"[AutoGen] {self.validator_agent_name}: Validation complete: {status_msg}")
        
        # Step 5: Generate report
        if progress_callback:
            progress_callback('write_report', 95, 'Generating final report...')
        write_report(
            report_path,
            state['explanations'],
            state['prioritized'],
            state['file_status']
        )
        
        state['report_path'] = report_path
        
        if progress_callback:
            progress_callback('completed', 100, 'Scan completed successfully!')
        
        return state
    
    def get_name(self) -> str:
        return "autogen"
    
    def get_description(self) -> str:
        return "AutoGen multi-agent collaboration framework with Scanner, Analyzer, Fixer, and Validator agents"
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/base.py
````python
"""
Base orchestrator class (re-exported from __init__ for convenience)
"""

from .__init__ import BaseOrchestrator, get_orchestrator, list_available_orchestrators

__all__ = ['BaseOrchestrator', 'get_orchestrator', 'list_available_orchestrators']
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/crewai_orchestrator.py
````python
"""
CrewAI orchestrator implementation using Crew-based multi-agent collaboration.
Agents: Scanner Agent, Analyzer Agent, Fixer Agent, Validator Agent

This implementation uses CrewAI's Crew pattern for orchestrating autonomous
AI agents while executing the actual workflow steps directly for reliability.
"""

from typing import Dict, Any, Optional, Callable
import os

try:
    import crewai
    # Try importing the main classes
    from crewai import Agent, Task, Crew, Process
    CREWAI_AVAILABLE = True
except ImportError:
    try:
        # Alternative import path
        from crewai.agent import Agent
        from crewai.task import Task
        from crewai.crew import Crew
        CREWAI_AVAILABLE = True
        Process = None  # Process might not be available in all versions
    except ImportError:
        CREWAI_AVAILABLE = False

from .base import BaseOrchestrator
from .shared_tools import (
    detect_repo_path,
    detect_languages,
    scan_patterns,
    prioritize,
    explain,
    apply_patches,
    run_tests,
    build_file_status,
    write_report,
)

# Import config for AI model settings
try:
    from ..config import QWEN3_API_BASE_URL, QWEN3_MODEL_NAME
except ImportError:
    QWEN3_API_BASE_URL = "http://86.50.169.115:11434"
    QWEN3_MODEL_NAME = "qwen3-coder:latest"


class CrewAIOrchestrator(BaseOrchestrator):
    """CrewAI-based orchestrator with multi-agent crew collaboration"""
    
    def __init__(self):
        if not CREWAI_AVAILABLE:
            raise ImportError(
                "CrewAI is not installed. Install it with: pip install crewai"
            )
        # Don't initialize crew here - do it lazily if needed
        # This avoids LLM initialization issues when just checking availability
        self._crew_initialized = False
    
    def _initialize_crew(self):
        """Initialize CrewAI agents with their specific roles"""
        if self._crew_initialized:
            return
        
        # For CrewAI, we define agents but execute tools directly
        # This makes the orchestrator work even if LLM config is not set up
        # The crew coordination is simulated through the workflow steps
        
        # Store agent names for logging purposes
        self.scanner_agent_name = "scanner_agent"
        self.analyzer_agent_name = "analyzer_agent"
        self.fixer_agent_name = "fixer_agent"
        self.validator_agent_name = "validator_agent"
        
        self._crew_initialized = True
    
    def run(self, repo: str, fix: bool = False, report_path: str = 'remediation_report.md', 
            progress_callback: Optional[Callable] = None, **kwargs) -> Dict[str, Any]:
        """
        Execute the security scanning workflow using CrewAI crew collaboration.
        This follows the same workflow as other orchestrators for fair comparison.
        
        Args:
            repo: Repository path or URL
            fix: Whether to auto-fix issues
            report_path: Path for the output report
            progress_callback: Optional callback function(step, progress, message) for progress updates
            **kwargs: Additional parameters
        """
        # Initialize crew if not already done
        self._initialize_crew()
        
        # Initialize state (same structure as other orchestrators)
        state = {
            'repo': repo,
            'repo_path': None,
            'languages': [],
            'findings': [],
            'prioritized': [],
            'explanations': [],
            'file_status': [],
            'patched': [],
            'tests_ok': True,
            'attempts': 0,
            'report_path': report_path,
            'fix': fix,
        }
        
        # Step 1: Scanner Agent - Scan repository and detect languages
        if progress_callback:
            progress_callback('scan_repo', 10, 'Scanning repository...')
        state['repo_path'] = detect_repo_path(repo)
        
        if progress_callback:
            progress_callback('detect_langs', 25, 'Detecting programming languages...')
        state['languages'] = detect_languages(state['repo_path'])
        
        # Notify scanner agent (for coordination/logging)
        # In CrewAI workflow, agents coordinate the steps
        # Since we're executing tools directly, we simulate crew coordination
        print(f"[CrewAI] {self.scanner_agent_name}: Repository scanned: {state['repo_path']}. Languages detected: {', '.join(state['languages'])}")
        
        # Step 2: Analyzer Agent - Scan patterns, prioritize, and explain
        if progress_callback:
            progress_callback('scan_patterns', 40, 'Scanning for insecure patterns...')
        state['findings'] = scan_patterns(state['repo_path'], state['languages'])
        
        if progress_callback:
            progress_callback('prioritize', 55, 'Normalizing and prioritizing findings...')
        state['prioritized'] = prioritize(state['findings'])
        state['explanations'] = explain(state['prioritized'])
        state['file_status'] = build_file_status(state['repo_path'], state['prioritized'])
        
        # Notify analyzer agent
        print(f"[CrewAI] {self.analyzer_agent_name}: Analysis complete. Found {len(state['prioritized'])} security issues.")
        
        # Step 3: Fixer Agent - Apply patches (if fix is enabled)
        if fix:
            if progress_callback:
                progress_callback('apply_patches', 85, 'Applying patches...')
            state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
            
            # Notify fixer agent
            print(f"[CrewAI] {self.fixer_agent_name}: Applied patches to {len(state['patched'])} files.")
            
            # Step 4: Validator Agent - Run tests
            if progress_callback:
                progress_callback('run_tests', 90, 'Running tests...')
            state['tests_ok'] = run_tests(state['repo_path'])
            state['attempts'] += 1
            
            # Retry logic if tests fail (same as other orchestrators)
            if not state['tests_ok'] and state['attempts'] < 2:
                # Try fixing again
                state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
                state['tests_ok'] = run_tests(state['repo_path'])
                state['attempts'] += 1
            
            # Notify validator agent
            status_msg = "Tests passed" if state['tests_ok'] else "Tests failed"
            print(f"[CrewAI] {self.validator_agent_name}: Validation complete: {status_msg}")
        
        # Step 5: Generate report
        if progress_callback:
            progress_callback('write_report', 95, 'Generating final report...')
        write_report(
            report_path,
            state['explanations'],
            state['prioritized'],
            state['file_status']
        )
        
        state['report_path'] = report_path
        
        if progress_callback:
            progress_callback('completed', 100, 'Scan completed successfully!')
        
        return state
    
    def get_name(self) -> str:
        return "crewai"
    
    def get_description(self) -> str:
        return "CrewAI crew-based multi-agent collaboration framework with Scanner, Analyzer, Fixer, and Validator agents"
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/langgraph_orchestrator.py
````python
"""
LangGraph orchestrator implementation - wraps existing LangGraph graph
"""

from typing import Dict, Any, Optional, Callable

from .base import BaseOrchestrator

try:
    from ..langgraph_graph import build_graph
    LANGGRAPH_AVAILABLE = True
except ImportError:
    LANGGRAPH_AVAILABLE = False


class LangGraphOrchestrator(BaseOrchestrator):
    """LangGraph-based orchestrator using StateGraph"""
    
    def __init__(self):
        if not LANGGRAPH_AVAILABLE:
            raise ImportError(
                "LangGraph is not installed. Install it with: pip install langgraph>=0.6.8"
            )
    
    def run(self, repo: str, fix: bool = False, report_path: str = 'remediation_report.md', 
            progress_callback: Optional[Callable] = None, **kwargs) -> Dict[str, Any]:
        """
        Execute the security scanning workflow using LangGraph
        
        Args:
            repo: Repository path or URL
            fix: Whether to auto-fix issues
            report_path: Path for the output report
            progress_callback: Optional callback function(step, progress, message) for progress updates
            **kwargs: Additional parameters
        """
        if not LANGGRAPH_AVAILABLE:
            raise ImportError("LangGraph is not installed")
        
        graph = build_graph()
        state = {
            'repo': repo,
            'fix': fix,
            'report_path': report_path,
        }
        
        # Execute graph with progress tracking
        if progress_callback:
            # Use stream mode to get intermediate states
            try:
                # Try using stream if available (LangGraph 0.2+)
                final_state = None
                for event in graph.stream(state):
                    # Update progress based on current node
                    node_name = list(event.keys())[0] if event else None
                    if node_name:
                        progress_map = {
                            'scan_repo': (10, 'Scanning repository...'),
                            'detect_langs': (25, 'Detecting programming languages...'),
                            'scan_patterns': (40, 'Scanning for insecure patterns...'),
                            'prioritize': (55, 'Normalizing and prioritizing findings...'),
                            'apply_patches': (85, 'Applying patches...'),
                            'run_tests': (90, 'Running tests...'),
                            'write_report': (95, 'Generating final report...'),
                        }
                        if node_name in progress_map:
                            progress, message = progress_map[node_name]
                            progress_callback(node_name, progress, message)
                    final_state = event[node_name] if node_name else final_state
                
                return final_state or state
            except (AttributeError, TypeError):
                # Fallback to invoke if stream not available or fails
                final_state = graph.invoke(state)
                if progress_callback:
                    progress_callback('completed', 100, 'Scan completed successfully!')
                return final_state
        else:
            # No progress callback, just run normally
            final_state = graph.invoke(state)
            return final_state
    
    def get_name(self) -> str:
        return "langgraph"
    
    def get_description(self) -> str:
        return "LangGraph state machine orchestration framework"
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/sequential_orchestrator.py
````python
"""
Sequential orchestrator - simple sequential execution without agentic framework
This serves as a baseline for comparison.
"""

from typing import Dict, Any
import os

from .base import BaseOrchestrator
from .shared_tools import (
    detect_repo_path,
    detect_languages,
    scan_patterns,
    prioritize,
    explain,
    apply_patches,
    run_tests,
    build_file_status,
    write_report,
)
from .. import patcher


class SequentialOrchestrator(BaseOrchestrator):
    """Sequential orchestrator - baseline implementation"""
    
    def run(self, repo: str, fix: bool = False, report_path: str = 'remediation_report.md', **kwargs) -> Dict[str, Any]:
        """
        Execute the security scanning workflow sequentially
        """
        # Initialize state
        state = {
            'repo': repo,
            'repo_path': None,
            'languages': [],
            'findings': [],
            'prioritized': [],
            'explanations': [],
            'file_status': [],
            'patched': [],
            'tests_ok': True,
            'attempts': 0,
            'report_path': report_path,
            'fix': fix,
        }
        
        # Step 1: Scan repository
        state['repo_path'] = detect_repo_path(repo)
        
        # Step 2: Detect languages
        state['languages'] = detect_languages(state['repo_path'])
        
        # Step 3: Scan patterns
        state['findings'] = scan_patterns(state['repo_path'], state['languages'])
        
        # Step 4: Prioritize
        state['prioritized'] = prioritize(state['findings'])
        state['explanations'] = explain(state['prioritized'])
        state['file_status'] = build_file_status(state['repo_path'], state['prioritized'])
        
        # Step 5: Apply patches (if fix enabled)
        if fix:
            state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
            
            # Step 6: Run tests
            state['tests_ok'] = run_tests(state['repo_path'])
            state['attempts'] += 1
            
            # Retry logic if tests fail
            if not state['tests_ok'] and state['attempts'] < 2:
                state['patched'] = apply_patches(state['repo_path'], state['prioritized'])
                state['tests_ok'] = run_tests(state['repo_path'])
                state['attempts'] += 1
        
        # Step 7: Generate report
        write_report(
            report_path,
            state['explanations'],
            state['prioritized'],
            state['file_status']
        )
        
        state['report_path'] = report_path
        
        return state
    
    def get_name(self) -> str:
        return "sequential"
    
    def get_description(self) -> str:
        return "Sequential execution baseline (no agentic framework)"
````

## File: agentic_fixer/code_security_auto_fixer/orchestrators/shared_tools.py
````python
"""
Shared tools used by all orchestrators.
This ensures all frameworks execute the same workflow steps.
"""

from typing import Dict, Any, List
from ..langgraph_tools import (
    detect_repo_path,
    detect_languages,
    scan_patterns,
    prioritize,
    explain,
    apply_patches,
    run_tests,
    build_file_status,
    write_report,
)

__all__ = [
    'detect_repo_path',
    'detect_languages',
    'scan_patterns',
    'prioritize',
    'explain',
    'apply_patches',
    'run_tests',
    'build_file_status',
    'write_report',
]
````

## File: agentic_fixer/code_security_auto_fixer/__init__.py
````python
# Agentic Code Security Auto-Fixer package
import code_security_auto_fixer.repo_scanner as repo_scanner
import code_security_auto_fixer.language_detector as language_detector
import code_security_auto_fixer.pattern_detector as pattern_detector
import code_security_auto_fixer.patcher as patcher
import code_security_auto_fixer.test_runner as test_runner
import code_security_auto_fixer.reporter as reporter
import code_security_auto_fixer.csv_exporter as csv_exporter
import code_security_auto_fixer.db_exporter as db_exporter

# Import comprehensive DB storage
try:
    from code_security_auto_fixer import comprehensive_db_storage
except ImportError:
    comprehensive_db_storage = None

__all__ = [
    'repo_scanner',
    'language_detector',
    'pattern_detector',
    'patcher',
    'test_runner',
    'reporter',
    'csv_exporter',
    'db_exporter',
    'comprehensive_db_storage'
]
````

## File: agentic_fixer/code_security_auto_fixer/ai_fixer.py
````python
"""
AI-powered code fixer powered by Google Gemini (gemini-3-pro-preview)
"""

import requests
from typing import Dict, Any, Optional
import re

class AIFixer:
    def __init__(
        self,
        api_base_url: str = None,
        model_name: str = None,
        api_key: str = None,
        access_token: str = None,
        temperature: float = None,
        max_output_tokens: int = None,
        candidate_count: int = None,
    ):
        """Initialize the AI Fixer with Google Gemini generative API"""
        self.api_base_url = (api_base_url or "https://generativelanguage.googleapis.com/v1beta/models").rstrip('/')
        self.model_name = model_name or "gemini-3-pro-preview"
        self.api_key = api_key
        self.access_token = access_token
        self.temperature = temperature if temperature is not None else 0.2
        self.max_output_tokens = max_output_tokens if max_output_tokens is not None else 1024
        self.candidate_count = candidate_count if candidate_count is not None else 1

    def _call_gemini_api(self, prompt: str) -> str:
        """Call Google Gemini text generation endpoint"""
        url = f"{self.api_base_url}/{self.model_name}:generateText"
        headers = {"Content-Type": "application/json"}
        params = {}

        if self.access_token:
            headers["Authorization"] = f"Bearer {self.access_token}"
        if self.api_key:
            params["key"] = self.api_key

        payload = {
            "prompt": {
                "text": prompt
            },
            "temperature": self.temperature,
            "candidate_count": self.candidate_count,
            "max_output_tokens": self.max_output_tokens,
        }

        response = requests.post(
            url,
            headers=headers,
            params=params,
            json=payload,
            timeout=120
        )
        response.raise_for_status()
        data = response.json()
        candidates = data.get("candidates") or []

        if not candidates:
            raise ValueError("Gemini response does not include any candidates")

        return candidates[0].get("output", "").strip()
    
    def generate_secure_solution(self, issue_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Generate a secure code solution for a security issue
        
        Args:
            issue_data: Dictionary containing issue information
            
        Returns:
            Dictionary with the secure solution and metadata
        """
        
        # Extract issue information
        vulnerability_type = issue_data.get('vulnerability_name', 'Unknown')
        cwe_id = issue_data.get('cwe', 'Unknown')
        file_path = issue_data.get('file', 'Unknown')
        line_number = issue_data.get('line', 0)
        problematic_code = issue_data.get('code', '')
        description = issue_data.get('description', '')
        context_lines = issue_data.get('context', [])
        
        # Determine programming language from file extension
        language = self._get_language_from_file(file_path)
        
        # Create the prompt
        prompt = self._create_fix_prompt(
            vulnerability_type=vulnerability_type,
            cwe_id=cwe_id,
            language=language,
            problematic_code=problematic_code,
            description=description,
            context_lines=context_lines,
            line_number=line_number
        )
        
        try:
            # Combine system and user prompt for Gemini
            full_prompt = (
                "You are an expert cybersecurity developer specializing in secure coding practices. "
                "Your task is to provide secure, production-ready code solutions that fix security "
                "vulnerabilities while maintaining functionality.\n\n"
                f"{prompt}"
            )

            # Call Gemini API
            solution_text = self._call_gemini_api(full_prompt)
            
            # Extract the solution code
            solution_code = self._extract_solution_code(solution_text, language)
            
            return {
                'success': True,
                'solution_code': solution_code,
                'explanation': solution_text,
                'language': language,
                'original_code': problematic_code,
                'line_number': line_number,
                'file_path': file_path
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e),
                'solution_code': '',
                'explanation': f'Failed to generate solution: {str(e)}'
            }
    
    def generate_secure_solution_with_full_context(self, file_path: str, file_content: str, 
                                                   line_number: int, issue_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Generate a secure code solution for a security issue with full file context
        
        Args:
            file_path: Path to the file
            file_content: Full content of the file
            line_number: Line number where the issue occurs
            issue_data: Dictionary containing issue information
            
        Returns:
            Dictionary with the secure solution and metadata
        """
        
        # Extract issue information
        vulnerability_type = issue_data.get('vulnerability_name', issue_data.get('issue', 'Unknown'))
        cwe_id = issue_data.get('cwe', 'Unknown')
        problematic_code = issue_data.get('code', '')
        description = issue_data.get('description', '')
        
        # Split file content into lines
        file_lines = file_content.split('\n')
        
        # Get context around the problematic line (up to 20 lines before and after)
        context_before = file_lines[max(0, line_number - 21):line_number - 1]
        context_after = file_lines[line_number:min(len(file_lines), line_number + 20)]
        
        # Determine programming language
        language = self._get_language_from_file(file_path)
        
        # Create enhanced prompt with full file context
        prompt = self._create_fix_prompt_with_full_context(
            vulnerability_type=vulnerability_type,
            cwe_id=cwe_id,
            language=language,
            file_content=file_content,
            problematic_code=problematic_code,
            description=description,
            context_before=context_before,
            context_after=context_after,
            line_number=line_number
        )
        
        try:
            # Combine system and user prompt for Gemini
            full_prompt = (
                "You are an expert cybersecurity developer specializing in secure coding practices. "
                "Your task is to analyze the entire file from top to bottom and provide secure, "
                "production-ready code solutions that fix security vulnerabilities while maintaining functionality.\n\n"
                f"{prompt}"
            )

            # Call Gemini API
            solution_text = self._call_gemini_api(full_prompt)
            
            # Extract the solution code
            solution_code = self._extract_solution_code(solution_text, language)
            
            return {
                'success': True,
                'solution_code': solution_code,
                'explanation': solution_text,
                'language': language,
                'original_code': problematic_code if problematic_code else file_lines[line_number - 1] if line_number <= len(file_lines) else '',
                'line_number': line_number,
                'file_path': file_path
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e),
                'solution_code': '',
                'explanation': f'Failed to generate solution: {str(e)}'
            }
    
    def _create_fix_prompt_with_full_context(self, vulnerability_type: str, cwe_id: str, language: str,
                                             file_content: str, problematic_code: str, description: str,
                                             context_before: list, context_after: list, line_number: int) -> str:
        """Create an enhanced prompt for generating secure code solutions with full file context"""
        
        context_before_str = '\n'.join(f"{i + line_number - len(context_before)}: {line}" 
                                      for i, line in enumerate(context_before))
        context_after_str = '\n'.join(f"{i + line_number + 1}: {line}" 
                                     for i, line in enumerate(context_after))
        
        prompt = f"""
SECURITY VULNERABILITY FIX REQUEST - FULL FILE ANALYSIS

VULNERABILITY DETAILS:
- Type: {vulnerability_type}
- CWE ID: {cwe_id}
- Language: {language}
- File: Line {line_number}
- Description: {description}

FULL FILE CONTEXT (Scanned from top to bottom):
```{language}
{file_content}
```

SPECIFIC ISSUE AREA:
```{language}
{context_before_str}
{line_number}: {problematic_code}
{context_after_str}
```

PROBLEMATIC LINE (Line {line_number}):
```{language}
{problematic_code}
```

REQUIREMENTS:
1. Analyze the entire file from top to bottom to understand the context
2. Provide ONLY the corrected line of code that fixes the security vulnerability
3. Maintain the same functionality while making it secure
4. Use industry best practices for {language} security
5. Ensure the solution is production-ready and fits seamlessly with the existing code
6. Do not change the logic, only fix the security issue
7. Use proper input validation, sanitization, or secure alternatives
8. Consider the full file context when generating the fix

RESPONSE FORMAT:
Provide your response in this exact format:

SOLUTION:
```{language}
[your secure code solution here - ONLY the fixed line]
```

EXPLANATION:
[Brief explanation of what was changed and why it's secure, considering the full file context]

IMPORTANT:
- Return ONLY the corrected line, not the entire function or file
- The solution should be a drop-in replacement for the problematic line at line {line_number}
- Focus on the specific security issue without over-engineering
- Use the most appropriate secure method for this {language} vulnerability type
- Ensure the fix works with the existing code structure and dependencies
"""
        
        return prompt
    
    def _create_fix_prompt(self, vulnerability_type: str, cwe_id: str, language: str, 
                          problematic_code: str, description: str, context_lines: list, 
                          line_number: int) -> str:
        """Create an efficient prompt for generating secure code solutions"""
        
        context_code = '\n'.join(context_lines) if context_lines else problematic_code
        
        prompt = f"""
SECURITY VULNERABILITY FIX REQUEST

VULNERABILITY DETAILS:
- Type: {vulnerability_type}
- CWE ID: {cwe_id}
- Language: {language}
- File: Line {line_number}
- Description: {description}

PROBLEMATIC CODE:
```{language}
{context_code}
```

SPECIFIC ISSUE LINE:
```{language}
{problematic_code}
```

REQUIREMENTS:
1. Provide ONLY the corrected line of code that fixes the security vulnerability
2. Maintain the same functionality while making it secure
3. Use industry best practices for {language} security
4. Ensure the solution is production-ready
5. Do not change the logic, only fix the security issue
6. Use proper input validation, sanitization, or secure alternatives

RESPONSE FORMAT:
Provide your response in this exact format:

SOLUTION:
```{language}
[your secure code solution here]
```

EXPLANATION:
[Brief explanation of what was changed and why it's secure]

IMPORTANT:
- Return ONLY the corrected line, not the entire function
- The solution should be a drop-in replacement for the problematic line
- Focus on the specific security issue without over-engineering
- Use the most appropriate secure method for this {language} vulnerability type
"""
        
        return prompt
    
    def _get_language_from_file(self, file_path: str) -> str:
        """Determine programming language from file extension"""
        extension_map = {
            '.js': 'javascript',
            '.jsx': 'javascript',
            '.ts': 'typescript',
            '.tsx': 'typescript',
            '.py': 'python',
            '.java': 'java',
            '.php': 'php',
            '.rb': 'ruby',
            '.go': 'go',
            '.rs': 'rust',
            '.cpp': 'cpp',
            '.c': 'c',
            '.cs': 'csharp',
            '.html': 'html',
            '.css': 'css',
            '.sql': 'sql',
            '.sh': 'bash',
            '.ps1': 'powershell'
        }
        
        for ext, lang in extension_map.items():
            if file_path.lower().endswith(ext):
                return lang
        
        return 'javascript'  # Default fallback
    
    def _extract_solution_code(self, response_text: str, language: str) -> str:
        """Extract the solution code from the Gemini response text"""
        
        # Look for code blocks
        code_pattern = rf'```{language}\s*\n(.*?)\n```'
        match = re.search(code_pattern, response_text, re.DOTALL | re.IGNORECASE)
        
        if match:
            return match.group(1).strip()
        
        # Fallback: look for any code block
        code_pattern = r'```\s*\n(.*?)\n```'
        match = re.search(code_pattern, response_text, re.DOTALL)
        
        if match:
            return match.group(1).strip()
        
        # Fallback: look for SOLUTION: section
        solution_pattern = r'SOLUTION:\s*\n(.*?)(?:\n\n|\nEXPLANATION:|$)'
        match = re.search(solution_pattern, response_text, re.DOTALL | re.IGNORECASE)
        
        if match:
            return match.group(1).strip()
        
        # Last resort: return the whole response
        return response_text.strip()
````

## File: agentic_fixer/code_security_auto_fixer/cli.py
````python
import argparse

# ...existing code...

def main():

    parser = argparse.ArgumentParser(description='Agentic Code Security Auto-Fixer CLI')
    parser.add_argument('repo', help='Path to local repo or GitHub URL')
    parser.add_argument('--fix', action='store_true', help='Auto-fix detected issues')
    parser.add_argument('--report', default='remediation_report.md', help='Output report file')
    parser.add_argument('--orchestrator', 
                        choices=['sequential', 'langgraph', 'autogen', 'crewai'],
                        default='sequential',
                        help='Orchestration framework to use (default: sequential)')
    parser.add_argument('--graph', action='store_true', help='[DEPRECATED] Use LangGraph orchestration. Use --orchestrator langgraph instead.')
    args = parser.parse_args()

    # Handle deprecated --graph flag
    if args.graph:
        args.orchestrator = 'langgraph'
        print("[WARNING] --graph flag is deprecated. Use --orchestrator langgraph instead.")

    from .orchestrators import get_orchestrator, list_available_orchestrators
    
    # Get the orchestrator
    try:
        orchestrator = get_orchestrator(args.orchestrator)
        print(f"[{orchestrator.get_name().upper()}] Using {orchestrator.get_description()}")
    except Exception as e:
        print(f"Error: Failed to initialize orchestrator '{args.orchestrator}': {e}")
        print("\nAvailable orchestrators:")
        for name, desc in list_available_orchestrators().items():
            print(f"  - {name}: {desc}")
        return

    # Run the orchestrator
    try:
        result = orchestrator.run(
            repo=args.repo,
            fix=args.fix,
            report_path=args.report
        )
        
        print(f"\n[{orchestrator.get_name().upper()}] Workflow completed successfully!")
        print(f"Report: {result.get('report_path', args.report)}")
        
        # Export to database (same as before)
        from . import db_exporter
        import os
        
        repo_name = os.path.basename(args.repo.rstrip('/\\'))
        if not repo_name or repo_name == '.':
            repo_name = 'local_repo'
        
        db_data = {
            'repo_path': args.repo,
            'completed_at': '',
            'languages': result.get('languages', []),
            'file_status': result.get('file_status', []),
            'explanations': result.get('explanations', []),
            'prioritized': result.get('prioritized', []),
            'findings': result.get('findings', [])
        }
        
        print("[Database] Exporting data to SQLite database...")
        db_path = db_exporter.export_to_db(db_data, repo_name)
        print(f"Database exported to {db_path}")
        
    except Exception as e:
        print(f"Error during execution: {e}")
        import traceback
        traceback.print_exc()
        return

if __name__ == '__main__':
    main()
````

## File: agentic_fixer/code_security_auto_fixer/comprehensive_db_storage.py
````python
"""
Comprehensive database storage system for security scans.

This module implements a detailed database schema to store:
- Project and scan context
- File contents (deduplicated) and file-at-scan mapping
- Findings and recommendations
- Secrets (sanitized) and evidence
- Dependency/SBOM information
- Aggregates for fast dashboards
"""

import os
import sqlite3
import hashlib
import json
import uuid
from datetime import datetime
from typing import Dict, List, Optional, Tuple


class ComprehensiveDBStorage:
    """Manages comprehensive database storage for security scans."""
    
    def __init__(self, scan_id: str, project_name: str, output_dir: str = "repo_storage", custom_dir_name: Optional[str] = None, flat_structure: bool = False):
        """
        Initialize the database storage system.
        
        Args:
            scan_id: Unique identifier for this scan
            project_name: Name of the project being scanned
            output_dir: Base directory for storing scan data
            custom_dir_name: Custom directory name for the scan (if None, uses scan_{scan_id})
            flat_structure: If True, store database directly in output_dir without subdirectories
        """
        self.scan_id = scan_id
        self.project_name = project_name
        self.output_dir = output_dir
        
        # Use flat structure - store directly in output_dir
        if flat_structure:
            from re import sub as re_sub
            self.scan_dir = output_dir
            os.makedirs(output_dir, exist_ok=True)
            # Database filename uses exactly the repository or file name (sanitized)
            # Simple sanitization for filename
            safe_name = re_sub(r'[<>:"/\\|?*]', '_', custom_dir_name or project_name)
            safe_name = safe_name.replace(' ', '_')[:100]
            db_filename = f"{safe_name}.db"
            self.db_path = os.path.join(output_dir, db_filename)
            
            # Note: We no longer remove existing database files to preserve historical scan data
            # Multiple scans of the same repo will be stored in the same database file with different scan_ids
        else:
            # Use custom directory name if provided, otherwise use scan_{scan_id}
            if custom_dir_name:
                self.scan_dir = os.path.join(output_dir, custom_dir_name)
                # Remove existing directory if it exists to replace it
                if os.path.exists(self.scan_dir):
                    import shutil
                    shutil.rmtree(self.scan_dir)
            else:
                self.scan_dir = os.path.join(output_dir, f"scan_{scan_id}")
            
            os.makedirs(self.scan_dir, exist_ok=True)
            
            # Database path
            db_filename = custom_dir_name if custom_dir_name else "scan_data"
            self.db_path = os.path.join(self.scan_dir, f"{db_filename}.db")
        
        # Initialize database
        self.conn = sqlite3.connect(self.db_path)
        self.conn.row_factory = sqlite3.Row
        self.cursor = self.conn.cursor()
        
        # Create schema
        self._create_schema()
        
        # Initialize project
        self.project_id = self._init_project()
        self.scan_record_id = None
        
    def _create_schema(self):
        """Create all database tables."""
        
        # 1. Projects table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS projects (
                project_id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                root_path TEXT,
                created_at TEXT NOT NULL
            )
        ''')
        
        # 2. Scans table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS scans (
                scan_id TEXT PRIMARY KEY,
                project_id TEXT NOT NULL,
                ref TEXT,
                started_at TEXT NOT NULL,
                finished_at TEXT,
                files_scanned INTEGER DEFAULT 0,
                bytes_scanned INTEGER DEFAULT 0,
                tool_versions_json TEXT,
                orchestrator TEXT,
                execution_time REAL,
                total_issues INTEGER DEFAULT 0,
                success INTEGER DEFAULT 1,
                FOREIGN KEY (project_id) REFERENCES projects(project_id)
            )
        ''')
        
        # Add new columns to existing tables if they don't exist (for backward compatibility)
        try:
            self.cursor.execute('ALTER TABLE scans ADD COLUMN orchestrator TEXT')
        except sqlite3.OperationalError:
            pass  # Column already exists
        
        try:
            self.cursor.execute('ALTER TABLE scans ADD COLUMN execution_time REAL')
        except sqlite3.OperationalError:
            pass  # Column already exists
        
        try:
            self.cursor.execute('ALTER TABLE scans ADD COLUMN total_issues INTEGER DEFAULT 0')
        except sqlite3.OperationalError:
            pass  # Column already exists
        
        try:
            self.cursor.execute('ALTER TABLE scans ADD COLUMN success INTEGER DEFAULT 1')
        except sqlite3.OperationalError:
            pass  # Column already exists
        
        # 3. Blobs table (deduplicated file contents)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS blobs (
                blob_sha256 TEXT PRIMARY KEY,
                size_bytes INTEGER NOT NULL,
                is_binary INTEGER NOT NULL DEFAULT 0,
                encoding TEXT,
                line_count INTEGER,
                content BLOB
            )
        ''')
        
        # 4. Files table (file metadata at scan)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS files (
                scan_id TEXT NOT NULL,
                path TEXT NOT NULL,
                mode TEXT,
                size_bytes INTEGER,
                blob_sha256 TEXT,
                language TEXT,
                loc INTEGER,
                sloc INTEGER,
                PRIMARY KEY (scan_id, path),
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id),
                FOREIGN KEY (blob_sha256) REFERENCES blobs(blob_sha256)
            )
        ''')
        
        # 5. Rules table (catalog of rules)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS rules (
                rule_id TEXT PRIMARY KEY,
                title TEXT NOT NULL,
                category TEXT,
                cwe TEXT,
                owasp TEXT,
                default_severity TEXT,
                description TEXT,
                references_json TEXT
            )
        ''')
        
        # 6. Findings table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS findings (
                finding_id TEXT PRIMARY KEY,
                scan_id TEXT NOT NULL,
                rule_id TEXT,
                path TEXT NOT NULL,
                line_start INTEGER NOT NULL,
                line_end INTEGER,
                severity TEXT,
                confidence REAL,
                message TEXT,
                fingerprint TEXT,
                snippet TEXT,
                created_at TEXT NOT NULL,
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id),
                FOREIGN KEY (rule_id) REFERENCES rules(rule_id)
            )
        ''')
        
        # 7. Recommendations table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS recommendations (
                recommendation_id TEXT PRIMARY KEY,
                finding_id TEXT,
                rule_id TEXT,
                fix_type TEXT,
                summary TEXT,
                steps_md TEXT,
                example_patch TEXT,
                references_json TEXT,
                FOREIGN KEY (finding_id) REFERENCES findings(finding_id),
                FOREIGN KEY (rule_id) REFERENCES rules(rule_id)
            )
        ''')
        
        # 8. Secrets table (sanitized evidence only)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS secrets (
                secret_id TEXT PRIMARY KEY,
                scan_id TEXT NOT NULL,
                path TEXT NOT NULL,
                line INTEGER NOT NULL,
                detector TEXT,
                secret_type TEXT,
                fingerprint TEXT,
                evidence_masked TEXT,
                detected_at TEXT NOT NULL,
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id)
            )
        ''')
        
        # 9. Evidence table (context for findings)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS evidence (
                evidence_id TEXT PRIMARY KEY,
                finding_id TEXT NOT NULL,
                context_before TEXT,
                context_after TEXT,
                FOREIGN KEY (finding_id) REFERENCES findings(finding_id)
            )
        ''')
        
        # 10. SBOM items table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS sbom_items (
                scan_id TEXT NOT NULL,
                eco TEXT NOT NULL,
                name TEXT NOT NULL,
                version TEXT NOT NULL,
                purl TEXT,
                licenses TEXT,
                source_file TEXT,
                PRIMARY KEY (scan_id, eco, name, version),
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id)
            )
        ''')
        
        # 11. SCA vulnerabilities table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS sca_vulns (
                sca_id TEXT PRIMARY KEY,
                scan_id TEXT NOT NULL,
                purl TEXT,
                cve_id TEXT,
                severity TEXT,
                cvss REAL,
                fixed_version TEXT,
                advisory_url TEXT,
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id)
            )
        ''')
        
        # 12. Aggregates table
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS aggregates (
                scan_id TEXT NOT NULL,
                kind TEXT NOT NULL,
                key TEXT NOT NULL,
                count INTEGER DEFAULT 0,
                value TEXT,
                PRIMARY KEY (scan_id, kind, key),
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id)
            )
        ''')
        
        # Create indexes for performance
        self.cursor.execute('CREATE INDEX IF NOT EXISTS idx_files_scan ON files(scan_id)')
        self.cursor.execute('CREATE INDEX IF NOT EXISTS idx_findings_scan ON findings(scan_id)')
        self.cursor.execute('CREATE INDEX IF NOT EXISTS idx_findings_path ON findings(path)')
        self.cursor.execute('CREATE INDEX IF NOT EXISTS idx_findings_severity ON findings(severity)')
        
        self.conn.commit()
    
    def _init_project(self) -> str:
        """Initialize or retrieve project record."""
        # Check if project exists
        self.cursor.execute('SELECT project_id FROM projects WHERE name = ?', (self.project_name,))
        row = self.cursor.fetchone()
        
        if row:
            project_id = row['project_id']
        else:
            # Create new project
            project_id = str(uuid.uuid4())
            self.cursor.execute('''
                INSERT INTO projects (project_id, name, created_at)
                VALUES (?, ?, ?)
            ''', (project_id, self.project_name, datetime.now().isoformat()))
            self.conn.commit()
        
        return project_id
    
    def start_scan(self, ref: Optional[str] = None, orchestrator: Optional[str] = None) -> str:
        """
        Start a new scan session.
        
        Args:
            ref: Branch/commit/path reference
            orchestrator: Name of the orchestrator/framework used
            
        Returns:
            scan_id
        """
        self.cursor.execute('''
            INSERT INTO scans (scan_id, project_id, ref, started_at, tool_versions_json, orchestrator)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            self.scan_id,
            self.project_id,
            ref,
            datetime.now().isoformat(),
            json.dumps({}),  # Could include tool versions
            orchestrator
        ))
        self.conn.commit()
        return self.scan_id
    
    def finish_scan(self, files_scanned: int = 0, bytes_scanned: int = 0, 
                   execution_time: Optional[float] = None, total_issues: int = 0, 
                   success: bool = True):
        """
        Mark scan as finished.
        
        Args:
            files_scanned: Number of files scanned
            bytes_scanned: Number of bytes scanned
            execution_time: Execution time in seconds
            total_issues: Total number of issues found
            success: Whether the scan completed successfully
        """
        self.cursor.execute('''
            UPDATE scans
            SET finished_at = ?, files_scanned = ?, bytes_scanned = ?, 
                execution_time = ?, total_issues = ?, success = ?
            WHERE scan_id = ?
        ''', (
            datetime.now().isoformat(), 
            files_scanned, 
            bytes_scanned,
            execution_time,
            total_issues,
            1 if success else 0,
            self.scan_id
        ))
        self.conn.commit()
    
    def store_file(self, path: str, content: bytes, language: Optional[str] = None,
                   mode: Optional[str] = None) -> Optional[str]:
        """
        Store file content (deduplicated via blob table).
        
        Args:
            path: File path
            content: File content as bytes
            language: Detected language
            mode: File mode/permissions
            
        Returns:
            blob_sha256 if successful, None otherwise
        """
        # Compute SHA256 hash
        blob_sha256 = hashlib.sha256(content).hexdigest()
        
        # Check if blob already exists
        self.cursor.execute('SELECT blob_sha256 FROM blobs WHERE blob_sha256 = ?', (blob_sha256,))
        existing = self.cursor.fetchone()
        
        if not existing:
            # Determine encoding and line count
            is_binary = False
            encoding = 'utf-8'
            line_count = 0
            
            try:
                # Try to decode as text
                text_content = content.decode('utf-8')
                encoding = 'utf-8'
                line_count = len(text_content.splitlines())
            except UnicodeDecodeError:
                try:
                    text_content = content.decode('latin-1')
                    encoding = 'latin-1'
                    line_count = len(text_content.splitlines())
                except:
                    is_binary = True
                    encoding = 'binary'
            
            # Store blob
            self.cursor.execute('''
                INSERT INTO blobs (blob_sha256, size_bytes, is_binary, encoding, line_count, content)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (blob_sha256, len(content), 1 if is_binary else 0, encoding, line_count, content))
        
        # Store file metadata
        self.cursor.execute('''
            INSERT INTO files (scan_id, path, mode, size_bytes, blob_sha256, language, loc, sloc)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            self.scan_id,
            path,
            mode,
            len(content),
            blob_sha256,
            language,
            line_count if not is_binary else 0,
            line_count if not is_binary else 0
        ))
        
        self.conn.commit()
        return blob_sha256
    
    def register_rule(self, rule_id: str, title: str, category: Optional[str] = None,
                     cwe: Optional[str] = None, owasp: Optional[str] = None,
                     default_severity: Optional[str] = None, description: Optional[str] = None,
                     references: Optional[Dict] = None):
        """Register a security rule."""
        self.cursor.execute('''
            INSERT OR REPLACE INTO rules 
            (rule_id, title, category, cwe, owasp, default_severity, description, references_json)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            rule_id,
            title,
            category,
            cwe,
            owasp,
            default_severity,
            description,
            json.dumps(references) if references else None
        ))
        self.conn.commit()
    
    def store_finding(self, finding_id: Optional[str], rule_id: str, path: str,
                      line_start: int, line_end: Optional[int], severity: str,
                      confidence: float, message: str, fingerprint: str,
                      snippet: Optional[str] = None, context_before: Optional[str] = None,
                      context_after: Optional[str] = None) -> str:
        """
        Store a security finding.
        
        Returns:
            finding_id
        """
        if not finding_id:
            finding_id = str(uuid.uuid4())
        
        # Store finding
        self.cursor.execute('''
            INSERT INTO findings 
            (finding_id, scan_id, rule_id, path, line_start, line_end, severity, 
             confidence, message, fingerprint, snippet, created_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            finding_id,
            self.scan_id,
            rule_id,
            path,
            line_start,
            line_end,
            severity,
            confidence,
            message,
            fingerprint,
            snippet,
            datetime.now().isoformat()
        ))
        
        # Store evidence if provided
        if context_before or context_after:
            evidence_id = str(uuid.uuid4())
            self.cursor.execute('''
                INSERT INTO evidence (evidence_id, finding_id, context_before, context_after)
                VALUES (?, ?, ?, ?)
            ''', (evidence_id, finding_id, context_before, context_after))
        
        self.conn.commit()
        return finding_id
    
    def store_recommendation(self, recommendation_id: Optional[str], finding_id: Optional[str],
                            rule_id: Optional[str], fix_type: str, summary: str,
                            steps_md: Optional[str] = None, example_patch: Optional[str] = None,
                            references: Optional[Dict] = None) -> str:
        """Store a recommendation."""
        if not recommendation_id:
            recommendation_id = str(uuid.uuid4())
        
        self.cursor.execute('''
            INSERT INTO recommendations
            (recommendation_id, finding_id, rule_id, fix_type, summary, steps_md, 
             example_patch, references_json)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            recommendation_id,
            finding_id,
            rule_id,
            fix_type,
            summary,
            steps_md,
            example_patch,
            json.dumps(references) if references else None
        ))
        
        self.conn.commit()
        return recommendation_id
    
    def store_secret(self, path: str, line: int, detector: str, secret_type: str,
                     fingerprint: str, evidence_masked: str) -> str:
        """Store sanitized secret evidence."""
        secret_id = str(uuid.uuid4())
        
        self.cursor.execute('''
            INSERT INTO secrets
            (secret_id, scan_id, path, line, detector, secret_type, fingerprint, 
             evidence_masked, detected_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            secret_id,
            self.scan_id,
            path,
            line,
            detector,
            secret_type,
            fingerprint,
            evidence_masked,
            datetime.now().isoformat()
        ))
        
        self.conn.commit()
        return secret_id
    
    def store_sbom_item(self, eco: str, name: str, version: str, purl: Optional[str] = None,
                       licenses: Optional[str] = None, source_file: Optional[str] = None):
        """Store SBOM/dependency item."""
        try:
            self.cursor.execute('''
                INSERT INTO sbom_items (scan_id, eco, name, version, purl, licenses, source_file)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (self.scan_id, eco, name, version, purl, licenses, source_file))
            self.conn.commit()
        except sqlite3.IntegrityError:
            # Already exists, skip
            pass
    
    def store_sca_vuln(self, purl: str, cve_id: str, severity: str, cvss: Optional[float] = None,
                      fixed_version: Optional[str] = None, advisory_url: Optional[str] = None) -> str:
        """Store SCA vulnerability."""
        sca_id = str(uuid.uuid4())
        
        self.cursor.execute('''
            INSERT INTO sca_vulns 
            (sca_id, scan_id, purl, cve_id, severity, cvss, fixed_version, advisory_url)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (sca_id, self.scan_id, purl, cve_id, severity, cvss, fixed_version, advisory_url))
        
        self.conn.commit()
        return sca_id
    
    def store_aggregate(self, kind: str, key: str, count: int, value: Optional[str] = None):
        """Store an aggregate metric."""
        self.cursor.execute('''
            INSERT OR REPLACE INTO aggregates (scan_id, kind, key, count, value)
            VALUES (?, ?, ?, ?, ?)
        ''', (self.scan_id, kind, key, count, value))
        self.conn.commit()
    
    def compute_and_store_aggregates(self):
        """Compute and store aggregate metrics for fast dashboards."""
        
        # Count by severity
        self.cursor.execute('''
            SELECT severity, COUNT(*) as cnt
            FROM findings
            WHERE scan_id = ?
            GROUP BY severity
        ''', (self.scan_id,))
        
        for row in self.cursor.fetchall():
            self.store_aggregate('by_severity', row['severity'], row['cnt'])
        
        # Count by rule
        self.cursor.execute('''
            SELECT rule_id, COUNT(*) as cnt
            FROM findings
            WHERE scan_id = ?
            GROUP BY rule_id
        ''', (self.scan_id,))
        
        for row in self.cursor.fetchall():
            self.store_aggregate('by_rule', row['rule_id'], row['cnt'])
        
        # Count by language
        self.cursor.execute('''
            SELECT language, COUNT(*) as cnt
            FROM files
            WHERE scan_id = ?
            GROUP BY language
        ''', (self.scan_id,))
        
        for row in self.cursor.fetchall():
            self.store_aggregate('by_language', row['language'] or 'unknown', row['cnt'])
        
        # Count by category
        self.cursor.execute('''
            SELECT category, COUNT(*) as cnt
            FROM rules r
            JOIN findings f ON r.rule_id = f.rule_id
            WHERE f.scan_id = ?
            GROUP BY category
        ''', (self.scan_id,))
        
        for row in self.cursor.fetchall():
            if row['category']:
                self.store_aggregate('by_category', row['category'], row['cnt'])
        
        self.conn.commit()
    
    def close(self):
        """Close database connection."""
        self.conn.close()
    
    def __enter__(self):
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.close()
````

## File: agentic_fixer/code_security_auto_fixer/config.py
````python
# Handles configuration, security policies, and AI model configuration
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

def _parse_env_int(name: str, default: int) -> int:
    value = os.getenv(name)
    if not value:
        return default
    try:
        return int(value)
    except ValueError:
        return default

def _parse_env_float(name: str, default: float) -> float:
    value = os.getenv(name)
    if not value:
        return default
    try:
        return float(value)
    except ValueError:
        return default

# Google Gemini Model Configuration
GEMINI_API_BASE_URL = os.getenv(
    'GEMINI_API_BASE_URL',
    'https://generativelanguage.googleapis.com/v1beta/models'
)
GEMINI_MODEL_NAME = os.getenv('GEMINI_MODEL_NAME', 'gemini-3-pro-preview')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')
GEMINI_ACCESS_TOKEN = os.getenv('GEMINI_ACCESS_TOKEN')
GEMINI_TEMPERATURE = _parse_env_float('GEMINI_TEMPERATURE', 0.2)
GEMINI_MAX_OUTPUT_TOKENS = _parse_env_int('GEMINI_MAX_OUTPUT_TOKENS', 1024)
GEMINI_CANDIDATE_COUNT = _parse_env_int('GEMINI_CANDIDATE_COUNT', 1)

# Legacy Local Qwen3 Model Configuration (kept for reference)
QWEN3_API_BASE_URL = os.getenv('QWEN3_API_BASE_URL', 'http://86.50.169.115:11434')
QWEN3_MODEL_NAME = os.getenv('QWEN3_MODEL_NAME', 'qwen3-coder:latest')

# Legacy OpenAI Configuration (kept for backward compatibility, but not used)
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
OPENAI_MODEL = os.getenv('OPENAI_MODEL', 'gpt-3.5-turbo')
OPENAI_MAX_TOKENS = int(os.getenv('OPENAI_MAX_TOKENS', '1000'))

# Security Policy Configuration
SECURITY_POLICIES = {
    'severity_thresholds': {
        'critical': 100,
        'high': 80,
        'medium': 60,
        'low': 40,
        'info': 20
    },
    'enabled_checks': {
        'injection': True,
        'xss': True,
        'path_traversal': True,
        'cryptography': True,
        'hardcoded_secrets': True,
        'banned_apis': True,
        'general_issues': True
    },
    'language_specific_policies': {
        'python': {
            'banned_imports': ['pickle', 'marshal', 'yaml', 'eval', 'exec'],
            'required_imports': ['os', 'sys', 'subprocess'],
            'severity_overrides': {
                'eval': 'critical',
                'exec': 'critical',
                'pickle.loads': 'high'
            }
        },
        'java': {
            'banned_imports': ['java.io.ObjectInputStream', 'java.beans.XMLDecoder'],
            'required_imports': ['java.sql', 'java.security'],
            'severity_overrides': {
                'ObjectInputStream.readObject': 'high',
                'XMLDecoder.readObject': 'high'
            }
        },
        'javascript': {
            'banned_imports': ['eval', 'Function', 'child_process'],
            'required_imports': ['fs', 'path', 'crypto'],
            'severity_overrides': {
                'eval': 'critical',
                'Function': 'critical',
                'child_process.exec': 'high'
            }
        }
    }
}

# CWE (Common Weakness Enumeration) Configuration
CWE_CONFIG = {
    'enabled_cwes': [
        'CWE-89',   # SQL Injection
        'CWE-78',   # Command Injection
        'CWE-79',   # XSS
        'CWE-22',   # Path Traversal
        'CWE-94',   # Code Injection
        'CWE-327',  # Weak Crypto
        'CWE-330',  # Insecure Randomness
        'CWE-295',  # TLS Issues
        'CWE-798',  # Hardcoded Secrets
        'CWE-120',  # Buffer Overflow
        'CWE-401',  # Memory Leak
        'CWE-119',  # Unsafe Code
        'CWE-477',  # Banned API
        'CWE-502',  # Insecure Deserialization
        'CWE-918',  # SSRF
        'CWE-611',  # XXE
        'CWE-362',  # Race Condition
        'CWE-269',  # Privilege Escalation
        'CWE-90',   # LDAP Injection
        'CWE-943'   # NoSQL Injection
    ],
    'cwe_priorities': {
        'CWE-89': 95,    # SQL Injection
        'CWE-78': 95,    # Command Injection
        'CWE-79': 90,    # XSS
        'CWE-22': 90,    # Path Traversal
        'CWE-94': 100,   # Code Injection
        'CWE-327': 70,   # Weak Crypto
        'CWE-330': 70,   # Insecure Randomness
        'CWE-295': 85,   # TLS Issues
        'CWE-798': 85,   # Hardcoded Secrets
        'CWE-120': 90,   # Buffer Overflow
        'CWE-401': 60,   # Memory Leak
        'CWE-119': 70,   # Unsafe Code
        'CWE-477': 60,   # Banned API
        'CWE-502': 85,   # Insecure Deserialization
        'CWE-918': 80,   # SSRF
        'CWE-611': 80,   # XXE
        'CWE-362': 50,   # Race Condition
        'CWE-269': 75,   # Privilege Escalation
        'CWE-90': 90,    # LDAP Injection
        'CWE-943': 90,   # NoSQL Injection
    }
}

# OWASP Top 10 2021 Configuration
OWASP_CONFIG = {
    'enabled_categories': [
        'A01:2021 - Broken Access Control',
        'A02:2021 - Cryptographic Failures',
        'A03:2021 - Injection',
        'A04:2021 - Insecure Design',
        'A05:2021 - Security Misconfiguration',
        'A06:2021 - Vulnerable and Outdated Components',
        'A07:2021 - Identification and Authentication Failures',
        'A08:2021 - Software and Data Integrity Failures',
        'A09:2021 - Security Logging and Monitoring Failures',
        'A10:2021 - Server-Side Request Forgery'
    ],
    'category_weights': {
        'A01:2021 - Broken Access Control': 90,
        'A02:2021 - Cryptographic Failures': 85,
        'A03:2021 - Injection': 95,
        'A04:2021 - Insecure Design': 80,
        'A05:2021 - Security Misconfiguration': 75,
        'A06:2021 - Vulnerable and Outdated Components': 70,
        'A07:2021 - Identification and Authentication Failures': 85,
        'A08:2021 - Software and Data Integrity Failures': 80,
        'A09:2021 - Security Logging and Monitoring Failures': 60,
        'A10:2021 - Server-Side Request Forgery': 80
    }
}

# Reporting Configuration
REPORT_CONFIG = {
    'include_cwe_mappings': True,
    'include_owasp_classifications': True,
    'include_severity_scores': True,
    'include_priority_rankings': True,
    'include_remediation_suggestions': True,
    'include_code_context': True,
    'max_findings_per_report': 1000,
    'group_by_file': True,
    'group_by_severity': True,
    'group_by_cwe': True,
    'group_by_owasp': True
}

# File Processing Configuration
FILE_CONFIG = {
    'max_file_size_mb': 10,
    'supported_extensions': [
        '.py', '.java', '.js', '.ts', '.php', '.rb', '.go', '.rs', 
        '.c', '.cpp', '.h', '.hpp', '.cs', '.swift', '.kt', '.scala',
        '.clj', '.hs', '.ml', '.fs', '.vb', '.pl', '.sh', '.sql',
        '.html', '.css', '.scss', '.sass', '.less', '.vue', '.jsx', 
        '.tsx', '.mjs'
    ],
    'excluded_directories': [
        'node_modules', 'venv', '__pycache__', 'target', 'build', 
        'dist', '.git', '.svn', '.hg', '.bzr', 'vendor', 'lib',
        'libs', 'dependencies', 'external', 'third_party'
    ],
    'excluded_files': [
        'package-lock.json', 'yarn.lock', 'composer.lock',
        'requirements.txt', 'Pipfile.lock', 'Gemfile.lock',
        'go.sum', 'Cargo.lock', 'yarn.lock'
    ]
}

# Scan Configuration
SCAN_CONFIG = {
    'parallel_processing': True,
    'max_workers': 4,
    'timeout_seconds': 300,
    'memory_limit_mb': 1024,
    'enable_ast_analysis': True,
    'enable_regex_analysis': True,
    'enable_semantic_analysis': False,  # Requires additional setup
    'enable_dependency_analysis': False,  # Requires additional setup
    'enable_secret_detection': True,
    'enable_hardcoded_credentials': True,
    'enable_api_misuse_detection': True
}

def get_config():
    """Get the complete configuration dictionary"""
    return {
        'gemini': {
            'api_base_url': GEMINI_API_BASE_URL,
            'model_name': GEMINI_MODEL_NAME,
            'api_key': GEMINI_API_KEY,
            'access_token': GEMINI_ACCESS_TOKEN,
            'temperature': GEMINI_TEMPERATURE,
            'max_output_tokens': GEMINI_MAX_OUTPUT_TOKENS,
            'candidate_count': GEMINI_CANDIDATE_COUNT
        },
        'qwen3': {
            'api_base_url': QWEN3_API_BASE_URL,
            'model_name': QWEN3_MODEL_NAME
        },
        'openai': {
            'api_key': OPENAI_API_KEY,
            'model': OPENAI_MODEL,
            'max_tokens': OPENAI_MAX_TOKENS
        },
        'security_policies': SECURITY_POLICIES,
        'cwe_config': CWE_CONFIG,
        'owasp_config': OWASP_CONFIG,
        'report_config': REPORT_CONFIG,
        'file_config': FILE_CONFIG,
        'scan_config': SCAN_CONFIG
    }

def is_check_enabled(check_type):
    """Check if a specific security check is enabled"""
    return SECURITY_POLICIES['enabled_checks'].get(check_type, True)

def get_severity_threshold(severity):
    """Get the threshold value for a severity level"""
    return SECURITY_POLICIES['severity_thresholds'].get(severity, 60)

def get_language_policy(language):
    """Get language-specific security policy"""
    return SECURITY_POLICIES['language_specific_policies'].get(language, {})

def is_cwe_enabled(cwe):
    """Check if a CWE is enabled for scanning"""
    return cwe in CWE_CONFIG['enabled_cwes']

def get_cwe_priority(cwe):
    """Get the priority score for a CWE"""
    return CWE_CONFIG['cwe_priorities'].get(cwe, 50)

def is_owasp_category_enabled(category):
    """Check if an OWASP category is enabled"""
    return category in OWASP_CONFIG['enabled_categories']

def get_owasp_weight(category):
    """Get the weight for an OWASP category"""
    return OWASP_CONFIG['category_weights'].get(category, 50)
````

## File: agentic_fixer/code_security_auto_fixer/csv_exporter.py
````python
# Exports scan data to CSV format
import os
import csv
from datetime import datetime


def export_to_csv(data, repo_name, output_dir="repo_storage"):
    """
    Export all scan data to CSV files in the repo_storage folder.
    
    Args:
        data: Dictionary containing scan results
        repo_name: Name of the repository (used for filename)
        output_dir: Directory to store CSV files (default: "repo_storage")
    
    Returns:
        str: Path to the generated CSV file
    """
    # Create the output directory if it doesn't exist
    os.makedirs(output_dir, exist_ok=True)
    
    # Generate CSV filename from repo name
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    # Sanitize repo name for filename
    safe_repo_name = "".join(c for c in repo_name if c.isalnum() or c in ('-', '_')).strip()
    csv_filename = f'{safe_repo_name}_data_{timestamp}.csv'
    csv_path = os.path.join(output_dir, csv_filename)
    
    print(f"[csv_exporter] Exporting scan data to {csv_path}")
    
    # Combine all data into a single CSV
    with open(csv_path, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        
        # Write header row
        writer.writerow([
            'Type',
            'File Path',
            'Line Number',
            'Issue Type',
            'Severity',
            'CWE',
            'OWASP',
            'Category',
            'Priority Score',
            'Language',
            'Status',
            'Description',
            'Code',
            'Suggestion',
            'Context',
            'Completed At'
        ])
        
        # Extract key data
        explanations = data.get('explanations', [])
        file_status = data.get('file_status', [])
        completed_at = data.get('completed_at', datetime.now().isoformat())
        repo_path = data.get('repo_path', 'unknown')
        
        # Create a mapping of file to language and status for quick lookup
        file_info_map = {}
        for file_info in file_status:
            file_info_map[file_info.get('file', '')] = {
                'language': file_info.get('language', 'unknown'),
                'status': file_info.get('status', 'unknown')
            }
        
        # Write all findings/issues
        for issue in explanations:
            file_path = issue.get('file', '')
            file_info = file_info_map.get(file_path, {})
            
            writer.writerow([
                'Security Issue',
                file_path,
                issue.get('line', 0),
                issue.get('issue', ''),
                issue.get('severity', ''),
                issue.get('cwe', ''),
                issue.get('owasp', ''),
                issue.get('category', ''),
                issue.get('priority_score', 0),
                file_info.get('language', 'unknown'),
                file_info.get('status', 'unknown'),
                issue.get('description') or issue.get('explanation', ''),
                str(issue.get('code', ''))[:500],  # Limit code length
                str(issue.get('suggestion', ''))[:500],  # Limit suggestion length
                '; '.join(issue.get('context', []))[:500] if issue.get('context') else '',  # Join context lines
                completed_at
            ])
        
        # Write file information (files without issues)
        for file_info in file_status:
            file_path = file_info.get('file', '')
            # Only write files that don't have issues recorded above
            if file_info.get('status', '') == 'clean':
                writer.writerow([
                    'File Info',
                    file_path,
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    file_info.get('language', 'unknown'),
                    'clean',
                    'No security issues found in this file',
                    '',
                    '',
                    '',
                    completed_at
                ])
        
        # Write repository summary
        writer.writerow([
            'Repository Summary',
            repo_path,
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            f"Total Issues: {len(explanations)}, Files Scanned: {len(file_status)}",
            f"Languages: {', '.join(data.get('languages', []))}",
            '',
            '',
            completed_at
        ])
    
    print(f"[csv_exporter] Successfully exported {len(explanations)} findings to {csv_path}")
    return csv_path


def export_detailed_csv(data, repo_name, output_dir="repo_storage"):
    """
    Export detailed scan data with separate CSV files for different data types.
    
    Args:
        data: Dictionary containing scan results
        repo_name: Name of the repository (used for filename)
        output_dir: Directory to store CSV files (default: "repo_storage")
    
    Returns:
        list: List of paths to generated CSV files
    """
    os.makedirs(output_dir, exist_ok=True)
    
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    safe_repo_name = "".join(c for c in repo_name if c.isalnum() or c in ('-', '_')).strip()
    
    generated_files = []
    
    # 1. Export all security issues
    issues_csv = os.path.join(output_dir, f'{safe_repo_name}_issues_{timestamp}.csv')
    with open(issues_csv, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow([
            'File', 'Line', 'Issue', 'Severity', 'CWE', 'OWASP', 'Category', 
            'Priority', 'Description', 'Code', 'Suggestion', 'Context'
        ])
        
        for issue in data.get('explanations', []):
            writer.writerow([
                issue.get('file', ''),
                issue.get('line', 0),
                issue.get('issue', ''),
                issue.get('severity', ''),
                issue.get('cwe', ''),
                issue.get('owasp', ''),
                issue.get('category', ''),
                issue.get('priority_score', 0),
                issue.get('description') or issue.get('explanation', ''),
                str(issue.get('code', ''))[:1000],
                str(issue.get('suggestion', ''))[:1000],
                ' | '.join(issue.get('context', [])) if issue.get('context') else ''
            ])
    generated_files.append(issues_csv)
    
    # 2. Export file status
    files_csv = os.path.join(output_dir, f'{safe_repo_name}_files_{timestamp}.csv')
    with open(files_csv, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['File', 'Language', 'Status'])
        
        issues_by_file = {}
        for issue in data.get('explanations', []):
            file_path = issue.get('file', '')
            issues_by_file[file_path] = issues_by_file.get(file_path, 0) + 1
        
        for file_info in data.get('file_status', []):
            file_path = file_info.get('file', '')
            writer.writerow([
                file_path,
                file_info.get('language', 'unknown'),
                file_info.get('status', 'unknown'),
                issues_by_file.get(file_path, 0)  # Add issue count
            ])
    generated_files.append(files_csv)
    
    # 3. Export summary statistics
    summary_csv = os.path.join(output_dir, f'{safe_repo_name}_summary_{timestamp}.csv')
    with open(summary_csv, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['Metric', 'Value'])
        
        explanations = data.get('explanations', [])
        file_status = data.get('file_status', [])
        
        writer.writerow(['Repository', data.get('repo_path', 'unknown')])
        writer.writerow(['Scan Completed', data.get('completed_at', 'unknown')])
        writer.writerow(['Total Issues', len(explanations)])
        writer.writerow(['Files Scanned', len(file_status)])
        writer.writerow(['Files with Issues', sum(1 for f in file_status if f.get('status') == 'issue')])
        writer.writerow(['Clean Files', sum(1 for f in file_status if f.get('status') == 'clean')])
        writer.writerow(['Languages', ', '.join(data.get('languages', []))])
        
        # Severity breakdown
        severity_counts = {}
        for issue in explanations:
            severity = issue.get('severity', 'unknown')
            severity_counts[severity] = severity_counts.get(severity, 0) + 1
        
        writer.writerow([])
        writer.writerow(['Severity Breakdown'])
        for severity in ['critical', 'high', 'medium', 'low', 'info']:
            count = severity_counts.get(severity, 0)
            writer.writerow([severity.title(), count])
    generated_files.append(summary_csv)
    
    print(f"[csv_exporter] Generated {len(generated_files)} CSV files in {output_dir}")
    return generated_files
````

## File: agentic_fixer/code_security_auto_fixer/db_exporter.py
````python
# Exports scan data to SQLite database
import os
import sqlite3
from datetime import datetime
import uuid
import json
import hashlib
import re


def sanitize_name(name):
    """
    Sanitize repository/file name to ensure it's safe for use as a database folder name.
    Removes or replaces invalid characters.
    """
    # Remove invalid characters for directory names
    sanitized = re.sub(r'[<>:"/\\|?*]', '_', name)
    # Replace spaces with underscores
    sanitized = sanitized.replace(' ', '_')
    # Limit length to avoid path issues
    if len(sanitized) > 100:
        sanitized = sanitized[:100]
    return sanitized


def export_to_db(data, repo_name, output_dir="repo_storage", scan_id=None, orchestrator=None, 
                 execution_time=None, total_issues=None, success=True):
    """
    Export all scan data to SQLite database in the repo_storage folder.
    
    Args:
        data: Dictionary containing scan results
        repo_name: Name of the repository (used for filename)
        output_dir: Directory to store database files (default: "repo_storage")
        scan_id: Optional scan ID (if None, generates a new UUID)
        orchestrator: Optional orchestrator/framework name
        execution_time: Optional execution time in seconds
        total_issues: Optional total number of issues found
        success: Whether the scan completed successfully (default: True)
    
    Returns:
        str: Path to the generated database file
    """
    from .comprehensive_db_storage import ComprehensiveDBStorage
    
    # Sanitize repo name for use as filename
    sanitized_repo_name = sanitize_name(repo_name)
    
    # Generate unique scan ID if not provided
    if scan_id is None:
        scan_id = str(uuid.uuid4())
    
    # Create comprehensive storage with flat structure (no subdirectories)
    with ComprehensiveDBStorage(scan_id, repo_name, output_dir, custom_dir_name=sanitized_repo_name, flat_structure=True) as storage:
        # Start scan
        storage.start_scan(ref=data.get('repo_path'), orchestrator=orchestrator)
        
        # Extract data
        explanations = data.get('explanations', [])
        file_status = data.get('file_status', [])
        findings = data.get('findings', [])
        
        # Register rules from findings
        rules_registered = {}
        for item in explanations:
            issue = item.get('issue', '')
            if issue and issue not in rules_registered:
                storage.register_rule(
                    rule_id=issue,
                    title=issue,
                    category=item.get('category', 'General'),
                    cwe=item.get('cwe', ''),
                    owasp=item.get('owasp', ''),
                    default_severity=item.get('severity', 'medium'),
                    description=item.get('description') or item.get('explanation', ''),
                    references={}
                )
                rules_registered[issue] = True
        
        # Process files and store their contents
        files_scanned = len(file_status)
        bytes_scanned = 0
        repo_path = data.get('repo_path', '')
        
        for file_info in file_status:
            file_path = file_info.get('file', '')
            language = file_info.get('language', 'unknown')
            
            # Construct full file path
            full_path = os.path.join(repo_path, file_path) if repo_path else file_path
            
            # Try to read and store file content
            if os.path.exists(full_path) and os.path.isfile(full_path):
                try:
                    # Read file content
                    with open(full_path, 'rb') as f:
                        content = f.read()
                        bytes_scanned += len(content)
                    
                    # Store file content (deduplicated via blobs table)
                    # This also creates the files table entry
                    storage.store_file(
                        path=file_path,
                        content=content,
                        language=language
                    )
                    
                except Exception as e:
                    print(f"[db_exporter] Warning: Could not read file {file_path}: {e}")
                    # Insert file record without content
                    try:
                        storage.cursor.execute('''
                            INSERT INTO files (scan_id, path, language)
                            VALUES (?, ?, ?)
                        ''', (scan_id, file_path, language))
                        storage.conn.commit()
                    except sqlite3.IntegrityError:
                        # File already exists, skip
                        pass
            else:
                # File doesn't exist (might be from a temporary scan that was cleaned up)
                # Just create the file record without content
                try:
                    storage.cursor.execute('''
                        INSERT INTO files (scan_id, path, language)
                        VALUES (?, ?, ?)
                    ''', (scan_id, file_path, language))
                    storage.conn.commit()
                except sqlite3.IntegrityError:
                    # File already exists, skip
                    pass
        
        # Store findings
        for item in explanations:
            finding_id = str(uuid.uuid4())
            
            # Create fingerprint for deduplication
            fingerprint = f"{item.get('file', '')}:{item.get('line', 0)}:{item.get('issue', '')}"
            fingerprint_hash = hashlib.sha256(fingerprint.encode()).hexdigest()
            
            # Prepare snippet
            code = item.get('code', '')
            snippet = str(code)[:500] if code else None
            
            # Prepare context
            context_items = item.get('context', [])
            context_before = '\n'.join(context_items[:-1]) if len(context_items) > 1 else None
            context_after = None  # Can be populated from later context
            
            storage.store_finding(
                finding_id=finding_id,
                rule_id=item.get('issue', 'unknown'),
                path=item.get('file', ''),
                line_start=item.get('line', 0),
                line_end=item.get('line', 0),
                severity=item.get('severity', 'medium'),
                confidence=0.8,  # Default confidence
                message=item.get('description') or item.get('explanation', ''),
                fingerprint=fingerprint_hash,
                snippet=snippet,
                context_before=context_before,
                context_after=context_after
            )
            
            # Store recommendation
            suggestion = item.get('suggestion', '')
            if suggestion:
                storage.store_recommendation(
                    recommendation_id=None,
                    finding_id=finding_id,
                    rule_id=item.get('issue', ''),
                    fix_type='code_change',
                    summary=suggestion[:200],
                    steps_md=suggestion,
                    example_patch=suggestion,
                    references={}
                )
        
        # Compute aggregates
        storage.compute_and_store_aggregates()
        
        # Get total issues if not provided
        if total_issues is None:
            total_issues = len(explanations)
        
        # Finish scan
        storage.finish_scan(
            files_scanned=files_scanned, 
            bytes_scanned=bytes_scanned,
            execution_time=execution_time,
            total_issues=total_issues,
            success=success
        )
        
        # Return path to database file (stored directly in output_dir)
        db_path = storage.db_path
    
    print(f"[db_exporter] Successfully exported scan data to {db_path}")
    return db_path


# Legacy table creation kept for backward compatibility
def _create_tables(cursor):
    """Create legacy database tables for storing scan data."""
    
    # Repository information table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS repository_info (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            path TEXT,
            completed_at TEXT,
            total_issues INTEGER,
            files_scanned INTEGER,
            files_with_issues INTEGER,
            clean_files INTEGER
        )
    ''')
    
    # Security issues table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS security_issues (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            file_path TEXT,
            line_number INTEGER,
            issue_type TEXT,
            severity TEXT,
            cwe TEXT,
            owasp TEXT,
            category TEXT,
            priority_score INTEGER,
            description TEXT,
            code TEXT,
            suggestion TEXT,
            context TEXT,
            language TEXT
        )
    ''')
    
    # File status table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS file_status (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            file_path TEXT,
            language TEXT,
            status TEXT,
            issues_count INTEGER
        )
    ''')
    
    # Languages table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS languages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            language TEXT,
            file_count INTEGER
        )
    ''')
    
    # Statistics table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS statistics (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            metric_name TEXT,
            metric_value TEXT
        )
    ''')
    
    # Severity breakdown table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS severity_breakdown (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            severity TEXT,
            count INTEGER,
            percentage REAL
        )
    ''')
    
    # CWE breakdown table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cwe_breakdown (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cwe TEXT,
            count INTEGER
        )
    ''')
    
    # Category breakdown table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS category_breakdown (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            category TEXT,
            count INTEGER
        )
    ''')


def _insert_repository_info(cursor, data):
    """Insert repository information."""
    explanations = data.get('explanations', [])
    file_status = data.get('file_status', [])
    
    files_with_issues = sum(1 for f in file_status if f.get('status') == 'issue')
    clean_files = sum(1 for f in file_status if f.get('status') == 'clean')
    
    cursor.execute('''
        INSERT INTO repository_info 
        (name, path, completed_at, total_issues, files_scanned, files_with_issues, clean_files)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (
        data.get('repo_path', 'unknown'),
        data.get('repo_path', 'unknown'),
        data.get('completed_at', datetime.now().isoformat()),
        len(explanations),
        len(file_status),
        files_with_issues,
        clean_files
    ))


def _insert_security_issues(cursor, data):
    """Insert security issues."""
    explanations = data.get('explanations', [])
    file_status = data.get('file_status', [])
    
    # Create language mapping
    language_map = {f['file']: f['language'] for f in file_status}
    
    for issue in explanations:
        file_path = issue.get('file', '')
        context_text = ' | '.join(issue.get('context', [])) if issue.get('context') else ''
        
        cursor.execute('''
            INSERT INTO security_issues 
            (file_path, line_number, issue_type, severity, cwe, owasp, category, 
             priority_score, description, code, suggestion, context, language)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            file_path,
            issue.get('line', 0),
            issue.get('issue', ''),
            issue.get('severity', ''),
            issue.get('cwe', ''),
            issue.get('owasp', ''),
            issue.get('category', ''),
            issue.get('priority_score', 0),
            issue.get('description') or issue.get('explanation', ''),
            str(issue.get('code', ''))[:5000],  # Limit to 5000 chars
            str(issue.get('suggestion', ''))[:5000],  # Limit to 5000 chars
            context_text[:5000],  # Limit to 5000 chars
            language_map.get(file_path, 'unknown')
        ))


def _insert_file_status(cursor, data):
    """Insert file status information."""
    file_status = data.get('file_status', [])
    explanations = data.get('explanations', [])
    
    # Count issues per file
    issues_by_file = {}
    for issue in explanations:
        file_path = issue.get('file', '')
        issues_by_file[file_path] = issues_by_file.get(file_path, 0) + 1
    
    for file_info in file_status:
        file_path = file_info.get('file', '')
        cursor.execute('''
            INSERT INTO file_status (file_path, language, status, issues_count)
            VALUES (?, ?, ?, ?)
        ''', (
            file_path,
            file_info.get('language', 'unknown'),
            file_info.get('status', 'unknown'),
            issues_by_file.get(file_path, 0)
        ))


def _insert_languages(cursor, data):
    """Insert language statistics."""
    file_status = data.get('file_status', [])
    
    # Count files by language
    language_counts = {}
    for file_info in file_status:
        lang = file_info.get('language', 'unknown')
        language_counts[lang] = language_counts.get(lang, 0) + 1
    
    for lang, count in language_counts.items():
        cursor.execute('''
            INSERT INTO languages (language, file_count)
            VALUES (?, ?)
        ''', (lang, count))


def _insert_statistics(cursor, data):
    """Insert general statistics."""
    explanations = data.get('explanations', [])
    
    # Insert general metrics
    cursor.execute('''
        INSERT INTO statistics (metric_name, metric_value)
        VALUES (?, ?)
    ''', ('Total Issues', str(len(explanations))))
    
    cursor.execute('''
        INSERT INTO statistics (metric_name, metric_value)
        VALUES (?, ?)
    ''', ('Scan Completed', data.get('completed_at', datetime.now().isoformat())))
    
    # Severity breakdown
    severity_counts = {}
    for issue in explanations:
        severity = issue.get('severity', 'unknown')
        severity_counts[severity] = severity_counts.get(severity, 0) + 1
    
    total = len(explanations)
    for severity in ['critical', 'high', 'medium', 'low', 'info']:
        count = severity_counts.get(severity, 0)
        percentage = (count / total * 100) if total > 0 else 0
        cursor.execute('''
            INSERT INTO severity_breakdown (severity, count, percentage)
            VALUES (?, ?, ?)
        ''', (severity, count, round(percentage, 2)))
    
    # CWE breakdown
    cwe_counts = {}
    for issue in explanations:
        cwe = issue.get('cwe', '')
        if cwe:
            cwe_counts[cwe] = cwe_counts.get(cwe, 0) + 1
    
    for cwe, count in cwe_counts.items():
        cursor.execute('''
            INSERT INTO cwe_breakdown (cwe, count)
            VALUES (?, ?)
        ''', (cwe, count))
    
    # Category breakdown
    category_counts = {}
    for issue in explanations:
        category = issue.get('category', 'Unknown')
        category_counts[category] = category_counts.get(category, 0) + 1
    
    for category, count in category_counts.items():
        cursor.execute('''
            INSERT INTO category_breakdown (category, count)
            VALUES (?, ?)
        ''', (category, count))


def query_database(db_path, query):
    """
    Query the database with a custom SQL query.
    
    Args:
        db_path: Path to the database file
        query: SQL query string
    
    Returns:
        list: Query results
    """
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    cursor.execute(query)
    results = cursor.fetchall()
    conn.close()
    return results


def get_repository_summary(db_path):
    """Get repository summary from the database."""
    query = "SELECT * FROM repository_info"
    return query_database(db_path, query)


def get_security_issues(db_path, severity=None):
    """Get security issues, optionally filtered by severity."""
    if severity:
        query = f"SELECT * FROM security_issues WHERE severity = '{severity}'"
    else:
        query = "SELECT * FROM security_issues"
    return query_database(db_path, query)


def get_file_status(db_path, status=None):
    """Get file status, optionally filtered by status."""
    if status:
        query = f"SELECT * FROM file_status WHERE status = '{status}'"
    else:
        query = "SELECT * FROM file_status"
    return query_database(db_path, query)
````

## File: agentic_fixer/code_security_auto_fixer/db_reader.py
````python
"""
Database reader module for retrieving scan data from SQLite databases.

This module provides functions to read scan information from the comprehensive
database storage system.
"""

import os
import sqlite3
import json
from datetime import datetime
from typing import Dict, List, Optional, Tuple


def list_available_scans(repo_storage_dir: str = "repo_storage") -> List[Dict]:
    """
    List all available scans from database files.
    
    Args:
        repo_storage_dir: Directory containing scan databases
        
    Returns:
        List of scan information dictionaries
    """
    scans = []
    
    if not os.path.exists(repo_storage_dir):
        return scans
    
    # Find all database files directly in repo_storage
    for item in os.listdir(repo_storage_dir):
        # Check if it's a .db file
        if item.endswith('.db'):
            db_path = os.path.join(repo_storage_dir, item)
            
            # Check if it's a scan database (has projects and scans tables)
            try:
                conn = sqlite3.connect(db_path)
                cursor = conn.cursor()
                
                # Check if it has the necessary tables
                cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name IN ('scans', 'projects')")
                tables = cursor.fetchall()
                conn.close()
                
                if len(tables) >= 2:
                    # It's a valid scan database
                    scan_info = get_scan_info(db_path)
                    if scan_info:
                        scans.append(scan_info)
            except Exception as e:
                print(f"Error reading scan from {db_path}: {e}")
    
    # Sort by started_at (most recent first)
    scans.sort(key=lambda x: x.get('started_at', ''), reverse=True)
    return scans


def get_scan_info(db_path: str) -> Optional[Dict]:
    """
    Get basic information about a scan from its database.
    
    Args:
        db_path: Path to the scan database
        
    Returns:
        Dictionary with scan information
    """
    try:
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # Get the most recent scan from this database
        cursor.execute('SELECT * FROM scans ORDER BY started_at DESC LIMIT 1')
        scan_row = cursor.fetchone()
        
        if not scan_row:
            conn.close()
            return None
        
        # Get scan_id from the database
        scan_id = scan_row['scan_id']
        
        # Get project details
        project_id = scan_row['project_id']
        cursor.execute('SELECT * FROM projects WHERE project_id = ?', (project_id,))
        project_row = cursor.fetchone()
        
        # Get aggregate stats
        cursor.execute('SELECT kind, key, count FROM aggregates WHERE scan_id = ?', (scan_id,))
        aggregates = cursor.fetchall()
        
        stats = {}
        for agg in aggregates:
            kind = agg['kind']
            key = agg['key']
            count = agg['count']
            
            if kind not in stats:
                stats[kind] = {}
            stats[kind][key] = count
        
        result = {
            'scan_id': scan_id,
            'db_path': db_path,
            'project_name': project_row['name'] if project_row else 'Unknown',
            'ref': scan_row['ref'],
            'started_at': scan_row['started_at'],
            'finished_at': scan_row['finished_at'],
            'files_scanned': scan_row['files_scanned'],
            'bytes_scanned': scan_row['bytes_scanned'],
            'stats': stats
        }
        
        conn.close()
        return result
        
    except Exception as e:
        print(f"Error getting scan info from {db_path}: {e}")
        return None


def get_scan_results(db_path: str, scan_id: str = None) -> Dict:
    """
    Get complete scan results from database.
    
    Args:
        db_path: Path to the scan database
        scan_id: Optional scan ID. If not provided, will try to extract from path or get most recent scan.
        
    Returns:
        Complete scan results dictionary
    """
    try:
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # Get scan ID - try to use provided scan_id, or query for it
        if scan_id is None:
            # Try to extract from path (for backward compatibility)
            path_dir = os.path.dirname(db_path)
            if path_dir and path_dir != db_path:
                scan_id = os.path.basename(path_dir).replace("scan_", "")
            
            # If still None, get the most recent scan from the database
            if not scan_id:
                cursor.execute('SELECT scan_id FROM scans ORDER BY started_at DESC LIMIT 1')
                result = cursor.fetchone()
                if result:
                    scan_id = result['scan_id']
        
        if not scan_id:
            raise ValueError("Could not determine scan_id from database")
        
        # Get scan details
        cursor.execute('SELECT * FROM scans WHERE scan_id = ?', (scan_id,))
        scan_row = cursor.fetchone()
        
        if not scan_row:
            raise ValueError(f"Scan with ID {scan_id} not found in database")
        
        # Get project details
        project_id = scan_row['project_id']
        cursor.execute('SELECT * FROM projects WHERE project_id = ?', (project_id,))
        project_row = cursor.fetchone()
        
        # Get findings first to determine which files have issues
        cursor.execute('SELECT DISTINCT path FROM findings WHERE scan_id = ?', (scan_id,))
        files_with_findings = {row['path'] for row in cursor.fetchall()}
        
        # Get files
        cursor.execute('SELECT * FROM files WHERE scan_id = ?', (scan_id,))
        file_rows = cursor.fetchall()
        
        file_status = []
        for row in file_rows:
            file_path = row['path']
            # A file has issues if it has findings associated with it
            has_issues = file_path in files_with_findings
            
            file_status.append({
                'file': file_path,
                'name': os.path.basename(file_path),  # Add name field
                'language': row['language'] or 'unknown',
                'status': 'issue' if has_issues else 'clean',
                'issues': []  # Empty array for compatibility
            })
        
        # Get findings
        cursor.execute('''
            SELECT f.*, r.title as rule_title, r.category, r.cwe, r.owasp, r.default_severity
            FROM findings f
            LEFT JOIN rules r ON f.rule_id = r.rule_id
            WHERE f.scan_id = ?
            ORDER BY 
                CASE severity 
                    WHEN 'critical' THEN 1 
                    WHEN 'high' THEN 2 
                    WHEN 'medium' THEN 3 
                    WHEN 'low' THEN 4 
                    ELSE 5 
                END,
                f.line_start
        ''', (scan_id,))
        
        finding_rows = cursor.fetchall()
        
        # Get recommendations
        cursor.execute('''
            SELECT recommendation_id, finding_id, summary, steps_md, example_patch
            FROM recommendations
            WHERE finding_id IN (SELECT finding_id FROM findings WHERE scan_id = ?)
        ''', (scan_id,))
        rec_rows = cursor.fetchall()
        
        # Helper function to safely get values from Row objects
        def safe_get(row, key, default=None):
            try:
                value = row[key]
                return value if value is not None else default
            except (KeyError, IndexError):
                return default
        
        # Convert recommendations to dict format for easier access
        recommendations_by_finding = {}
        for rec in rec_rows:
            finding_id = rec['finding_id']
            recommendations_by_finding[finding_id] = {
                'steps_md': safe_get(rec, 'steps_md', ''),
                'summary': safe_get(rec, 'summary', ''),
                'example_patch': safe_get(rec, 'example_patch', '')
            }
        
        # Convert findings to explanations format
        explanations = []
        for finding in finding_rows:
            finding_id = finding['finding_id']
            
            # Get recommendation if available
            recommendation = recommendations_by_finding.get(finding_id, {})
            
            explanation = {
                'file': finding['path'],
                'name': finding['path'],  # For file name display
                'line': finding['line_start'],
                'issue': safe_get(finding, 'rule_id', ''),
                'vulnerability_name': safe_get(finding, 'rule_title') or (safe_get(finding, 'message', '')[:100] if safe_get(finding, 'message') else 'Security Issue'),
                'vulnerability_category': safe_get(finding, 'category', 'General'),
                'module_category': safe_get(finding, 'category', 'General'),
                'severity': finding['severity'],
                'priority_score': 100 if finding['severity'] == 'critical' else 80 if finding['severity'] == 'high' else 60 if finding['severity'] == 'medium' else 40,
                'detected_at': safe_get(finding, 'detected_at', ''),
                'cwe': safe_get(finding, 'cwe', ''),
                'owasp': safe_get(finding, 'owasp', ''),
                'category': safe_get(finding, 'category', 'General'),
                'description': safe_get(finding, 'message', ''),
                'explanation': safe_get(finding, 'message', ''),
                'code': safe_get(finding, 'snippet', ''),
                'suggestion': recommendation.get('steps_md', recommendation.get('summary', '')),
                'context': safe_get(finding, 'snippet', '').split('\n') if safe_get(finding, 'snippet') else [],
                'auto_fixable': False  # Default to false
            }
            
            explanations.append(explanation)
        
        # Get languages
        cursor.execute('''
            SELECT DISTINCT language
            FROM files
            WHERE scan_id = ? AND language IS NOT NULL AND language != ''
        ''', (scan_id,))
        
        languages_data = cursor.fetchall()
        languages = [row['language'] for row in languages_data]  # Return as array, not dict
        
        # Build results
        results = {
            'repo_path': project_row['root_path'] if project_row else 'Unknown',
            'completed_at': scan_row['finished_at'],
            'languages': languages,
            'file_status': file_status,
            'explanations': explanations,
            'prioritized': explanations,  # Same as explanations for now
            'findings': explanations,  # Same as explanations for now
            'stats': {
                'total_issues': len(explanations),
                'files_scanned': len(file_status),
                'auto_fixes': 0,
                'manual_reviews': len(explanations)
            }
        }
        
        conn.close()
        return results
        
    except Exception as e:
        print(f"Error getting scan results from {db_path}: {e}")
        raise


def get_scan_aggregates(db_path: str) -> Dict:
    """
    Get aggregated statistics from a scan database.
    
    Args:
        db_path: Path to the scan database
        
    Returns:
        Dictionary with aggregated statistics
    """
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        scan_id = os.path.basename(os.path.dirname(db_path)).replace("scan_", "")
        
        cursor.execute('''
            SELECT kind, key, count
            FROM aggregates
            WHERE scan_id = ?
        ''', (scan_id,))
        
        aggregates = cursor.fetchall()
        result = {
            'by_severity': {},
            'by_rule': {},
            'by_language': {},
            'by_category': {}
        }
        
        for kind, key, count in aggregates:
            if kind in result:
                result[kind][key] = count
        
        conn.close()
        return result
        
    except Exception as e:
        print(f"Error getting aggregates from {db_path}: {e}")
        return {}


def get_files_by_scan_id(scan_id: str, repo_storage_dir: str = "repo_storage") -> Optional[str]:
    """
    Get the database path for a specific scan ID.
    
    Args:
        scan_id: Scan ID to look up
        repo_storage_dir: Directory containing scan databases
        
    Returns:
        Path to the database file, or None if not found
    """
    if not os.path.exists(repo_storage_dir):
        return None
    
    # Look for database files that contain this scan_id
    for item in os.listdir(repo_storage_dir):
        if item.endswith('.db'):
            db_path = os.path.join(repo_storage_dir, item)
            
            try:
                conn = sqlite3.connect(db_path)
                cursor = conn.cursor()
                
                # Check if this database contains the scan_id
                cursor.execute("SELECT scan_id FROM scans WHERE scan_id = ?", (scan_id,))
                result = cursor.fetchone()
                conn.close()
                
                if result:
                    return db_path
            except Exception:
                # Not a valid scan database or doesn't have the scan
                continue
    
    return None
````

## File: agentic_fixer/code_security_auto_fixer/enhanced_security_policies.py
````python
# Enhanced Security Policies with Exact Solutions
# Provides precise detection with exact line numbers, lines, issues, and solutions

import re
from typing import Dict, List, Tuple, Any

# Enhanced security pattern definitions with exact solutions
ENHANCED_SECURITY_PATTERNS = {
    'python': {
        'sql-injection': [
            {
                'pattern': r'execute\s*\(\s*["\'].*%[sd].*["\']',
                'issue_type': 'sql-injection',
                'severity': 'high',
                'description': 'SQL Injection via string formatting in execute()',
                'exact_solution': '''# VULNERABLE CODE:
cursor.execute("SELECT * FROM users WHERE id = %s" % user_id)

# SECURE SOLUTION:
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
# OR use parameterized queries:
cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))'''
            },
            {
                'pattern': r'execute\s*\(\s*f["\'].*\{.*\}.*["\']',
                'issue_type': 'sql-injection',
                'severity': 'high',
                'description': 'SQL Injection via f-string formatting in execute()',
                'exact_solution': '''# VULNERABLE CODE:
cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")

# SECURE SOLUTION:
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
# OR use parameterized queries:
cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))'''
            },
            {
                'pattern': r'execute\s*\(\s*["\'].*\+.*["\']',
                'issue_type': 'sql-injection',
                'severity': 'high',
                'description': 'SQL Injection via string concatenation in execute()',
                'exact_solution': '''# VULNERABLE CODE:
cursor.execute("SELECT * FROM users WHERE name = '" + user_name + "'")

# SECURE SOLUTION:
cursor.execute("SELECT * FROM users WHERE name = %s", (user_name,))
# OR use parameterized queries:
cursor.execute("SELECT * FROM users WHERE name = ?", (user_name,))'''
            }
        ],
        'command-injection': [
            {
                'pattern': r'os\.system\s*\(',
                'issue_type': 'command-injection',
                'severity': 'high',
                'description': 'Command Injection via os.system()',
                'exact_solution': '''# VULNERABLE CODE:
os.system(f"echo {user_input}")

# SECURE SOLUTION:
import subprocess
# Use subprocess with shell=False and proper argument handling:
subprocess.run(['echo', user_input], shell=False, check=True)
# OR use shlex.quote for shell commands:
import shlex
subprocess.run(f"echo {shlex.quote(user_input)}", shell=True)'''
            },
            {
                'pattern': r'subprocess\.call\s*\([^)]*shell\s*=\s*True',
                'issue_type': 'command-injection',
                'severity': 'high',
                'description': 'Command Injection via subprocess.call with shell=True',
                'exact_solution': '''# VULNERABLE CODE:
subprocess.call(f"echo {user_input}", shell=True)

# SECURE SOLUTION:
import subprocess
# Use shell=False and pass arguments as list:
subprocess.call(['echo', user_input], shell=False)
# OR use shlex.quote for shell commands:
import shlex
subprocess.call(f"echo {shlex.quote(user_input)}", shell=True)'''
            }
        ],
        'code-injection': [
            {
                'pattern': r'eval\s*\(',
                'issue_type': 'code-injection',
                'severity': 'critical',
                'description': 'Code Injection via eval() function',
                'exact_solution': '''# VULNERABLE CODE:
result = eval(user_input)

# SECURE SOLUTION:
# Use safe alternatives based on your needs:
# For mathematical expressions:
import ast
result = ast.literal_eval(user_input)  # Only for literals
# For JSON data:
import json
result = json.loads(user_input)
# For configuration, use config parsers or safe evaluation libraries'''
            },
            {
                'pattern': r'exec\s*\(',
                'issue_type': 'code-injection',
                'severity': 'critical',
                'description': 'Code Injection via exec() function',
                'exact_solution': '''# VULNERABLE CODE:
exec(user_input)

# SECURE SOLUTION:
# Avoid exec() entirely. Use alternatives:
# For dynamic imports:
import importlib
module = importlib.import_module(module_name)
# For configuration:
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
# For safe code execution, use restricted environments or sandboxing'''
            }
        ],
        'xss': [
            {
                'pattern': r'innerHTML\s*=',
                'issue_type': 'xss',
                'severity': 'high',
                'description': 'Cross-Site Scripting via innerHTML assignment',
                'exact_solution': '''# VULNERABLE CODE:
element.innerHTML = user_input

# SECURE SOLUTION:
# Use textContent for plain text:
element.textContent = user_input
# OR sanitize HTML input:
import html
element.innerHTML = html.escape(user_input)
# OR use a proper HTML sanitizer library like bleach'''
            }
        ],
        'path-traversal': [
            {
                'pattern': r'open\s*\(\s*[^)]*\+.*\)',
                'issue_type': 'path-traversal',
                'severity': 'high',
                'description': 'Path Traversal via string concatenation in open()',
                'exact_solution': '''# VULNERABLE CODE:
with open("/uploads/" + filename, "r") as f:
    content = f.read()

# SECURE SOLUTION:
import os
# Validate and sanitize the filename:
safe_filename = os.path.basename(filename)
if ".." in safe_filename or safe_filename.startswith("/"):
    raise ValueError("Invalid filename")
safe_path = os.path.join("/uploads", safe_filename)
# Ensure the path is within allowed directory:
if not safe_path.startswith("/uploads/"):
    raise ValueError("Path traversal detected")
with open(safe_path, "r") as f:
    content = f.read()'''
            },
            {
                'pattern': r'\.\./',
                'issue_type': 'path-traversal',
                'severity': 'high',
                'description': 'Path Traversal via ../ directory traversal',
                'exact_solution': '''# VULNERABLE CODE:
file_path = "/uploads/" + user_input  # user_input = "../../etc/passwd"

# SECURE SOLUTION:
import os
# Use os.path.basename to prevent directory traversal:
safe_filename = os.path.basename(user_input)
# Validate filename doesn't contain dangerous patterns:
if ".." in safe_filename or safe_filename.startswith("/"):
    raise ValueError("Invalid filename")
# Use os.path.join for safe path construction:
safe_path = os.path.join("/uploads", safe_filename)
# Verify path is within allowed directory:
if not os.path.abspath(safe_path).startswith(os.path.abspath("/uploads")):
    raise ValueError("Path traversal detected")'''
            }
        ],
        'weak-crypto': [
            {
                'pattern': r'hashlib\.md5\s*\(',
                'issue_type': 'weak-crypto',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function MD5',
                'exact_solution': '''# VULNERABLE CODE:
import hashlib
hash_value = hashlib.md5(password.encode()).hexdigest()

# SECURE SOLUTION:
import hashlib
# Use SHA-256 or stronger:
hash_value = hashlib.sha256(password.encode()).hexdigest()
# For password hashing, use bcrypt or Argon2:
import bcrypt
hash_value = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
# OR use Argon2:
from argon2 import PasswordHasher
ph = PasswordHasher()
hash_value = ph.hash(password)'''
            }
        ],
        'hardcoded-secret': [
            {
                'pattern': r'password\s*=\s*["\'][^"\']+["\']',
                'issue_type': 'hardcoded-secret',
                'severity': 'high',
                'description': 'Hardcoded password in source code',
                'exact_solution': '''# VULNERABLE CODE:
password = "mysecretpassword123"

# SECURE SOLUTION:
import os
# Use environment variables:
password = os.getenv('DB_PASSWORD')
if not password:
    raise ValueError("DB_PASSWORD environment variable not set")
# OR use a configuration file (not in version control):
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
password = config.get('database', 'password')
# OR use a secrets management system like HashiCorp Vault'''
            }
        ],
        'insecure-randomness': [
            {
                'pattern': r'random\.random\s*\(',
                'issue_type': 'insecure-randomness',
                'severity': 'medium',
                'description': 'Insecure random number generation using random.random()',
                'exact_solution': '''# VULNERABLE CODE:
import random
value = random.random()  # Predictable and not cryptographically secure

# SECURE SOLUTION:
import secrets
# Use secrets module for cryptographically secure random numbers:
value = secrets.randbelow(100)  # Random integer below 100
# OR for random bytes:
random_bytes = secrets.token_bytes(16)
# OR for random hex:
random_hex = secrets.token_hex(16)'''
            },
            {
                'pattern': r'random\.randint\s*\(',
                'issue_type': 'insecure-randomness',
                'severity': 'medium',
                'description': 'Insecure random integer generation using random.randint()',
                'exact_solution': '''# VULNERABLE CODE:
import random
value = random.randint(1, 100)  # Not cryptographically secure

# SECURE SOLUTION:
import secrets
# Use secrets.randbelow for cryptographically secure random integers:
value = secrets.randbelow(100) + 1  # Random integer between 1 and 100
# OR use secrets.randbits for random bits:
random_bits = secrets.randbits(32)'''
            }
        ],
        'tls-issues': [
            {
                'pattern': r'verify\s*=\s*False',
                'issue_type': 'tls-issues',
                'severity': 'high',
                'description': 'TLS/SSL verification disabled - insecure communication',
                'exact_solution': '''# VULNERABLE CODE:
import requests
response = requests.get('https://example.com', verify=False)  # Disables SSL verification

# SECURE SOLUTION:
import requests
# Always verify SSL certificates:
response = requests.get('https://example.com', verify=True)  # Default is True
# OR specify a certificate bundle:
response = requests.get('https://example.com', verify='/path/to/cert.pem')
# If you must disable verification (NOT RECOMMENDED), only for self-signed certs in development:
# response = requests.get('https://internal-api.example.com', verify=False)  # Only in DEV'''
            },
            {
                'pattern': r'requests\.(get|post|put|delete|patch)\s*\([^)]*verify\s*=\s*False',
                'issue_type': 'tls-issues',
                'severity': 'high',
                'description': 'TLS/SSL verification disabled in requests calls',
                'exact_solution': '''# VULNERABLE CODE:
import requests
response = requests.get(url, verify=False)  # Disables SSL verification

# SECURE SOLUTION:
import requests
# Always verify SSL certificates:
response = requests.get(url, verify=True)  # Default is True
# OR specify a certificate bundle:
response = requests.get(url, verify='/path/to/cert.pem')'''
            },
            {
                'pattern': r'ssl\._create_unverified_context\s*\(',
                'issue_type': 'tls-issues',
                'severity': 'high',
                'description': 'Unverified SSL context created - insecure communication',
                'exact_solution': '''# VULNERABLE CODE:
import ssl
import urllib.request
context = ssl._create_unverified_context()  # Disables SSL verification
response = urllib.request.urlopen('https://example.com', context=context)

# SECURE SOLUTION:
import ssl
import urllib.request
# Use default context with verification:
response = urllib.request.urlopen('https://example.com')
# OR create a verified context:
context = ssl.create_default_context()
response = urllib.request.urlopen('https://example.com', context=context)'''
            }
        ],
        'banned-api': [
            {
                'pattern': r'pickle\.loads?\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous pickle deserialization - can execute arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
import pickle
data = pickle.loads(user_input)

# SECURE SOLUTION:
# Avoid pickle entirely for untrusted data. Use alternatives:
import json
data = json.loads(user_input)  # For JSON data
# OR use safe serialization formats like YAML with safe_load:
import yaml
data = yaml.safe_load(user_input)
# OR use protocol buffers or other safe serialization libraries'''
            },
            {
                'pattern': r'marshal\.loads?\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous marshal deserialization - can execute arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
import marshal
data = marshal.loads(user_input)

# SECURE SOLUTION:
# Avoid marshal entirely for untrusted data. Use alternatives:
import json
data = json.loads(user_input)  # For JSON data
# OR use safe serialization formats:
import yaml
data = yaml.safe_load(user_input)
# OR use protocol buffers or other safe serialization libraries'''
            },
            {
                'pattern': r'yaml\.load\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous YAML deserialization - can execute arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
import yaml
data = yaml.load(user_input)

# SECURE SOLUTION:
# Use yaml.safe_load instead of yaml.load:
import yaml
data = yaml.safe_load(user_input)
# OR use json for simple data structures:
import json
data = json.loads(user_input)'''
            },
            {
                'pattern': r'json\.loads?\s*\([^)]*\)',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Potentially unsafe JSON deserialization',
                'exact_solution': '''# VULNERABLE CODE:
data = json.loads(user_input)

# SECURE SOLUTION:
import json
# Validate input before parsing:
if not isinstance(user_input, str):
    raise ValueError("Input must be a string")
# Use json.loads with proper error handling:
try:
    data = json.loads(user_input)
except json.JSONDecodeError as e:
    raise ValueError(f"Invalid JSON: {e}")
# For untrusted data, consider using a JSON schema validator'''
            },
            {
                'pattern': r'eval\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous eval() function - can execute arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
result = eval(user_input)

# SECURE SOLUTION:
# Use safe alternatives based on your needs:
# For mathematical expressions:
import ast
result = ast.literal_eval(user_input)  # Only for literals
# For JSON data:
import json
result = json.loads(user_input)
# For configuration, use config parsers or safe evaluation libraries'''
            },
            {
                'pattern': r'exec\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous exec() function - can execute arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
exec(user_input)

# SECURE SOLUTION:
# Avoid exec() entirely. Use alternatives:
# For dynamic imports:
import importlib
module = importlib.import_module(module_name)
# For configuration:
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
# For safe code execution, use restricted environments or sandboxing'''
            },
            {
                'pattern': r'compile\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous compile() function - can compile arbitrary code',
                'exact_solution': '''# VULNERABLE CODE:
code = compile(user_input, '<string>', 'exec')

# SECURE SOLUTION:
# Avoid compile() with user input entirely. Use alternatives:
# For configuration parsing:
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
# For safe code execution, use restricted environments or sandboxing
# If you must use compile(), validate the input thoroughly'''
            },
            {
                'pattern': r'__import__\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous __import__() function - can import arbitrary modules',
                'exact_solution': '''# VULNERABLE CODE:
module = __import__(user_input)

# SECURE SOLUTION:
# Use importlib.import_module with validation:
import importlib
# Validate module name against whitelist:
allowed_modules = ['os', 'sys', 'json', 'math']
if user_input in allowed_modules:
    module = importlib.import_module(user_input)
else:
    raise ValueError("Module not allowed")
# OR use a predefined mapping of allowed modules'''
            },
            {
                'pattern': r'getattr\s*\([^)]*,\s*[^)]*\)',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous getattr() function - can access arbitrary attributes',
                'exact_solution': '''# VULNERABLE CODE:
value = getattr(obj, user_input)

# SECURE SOLUTION:
# Validate attribute name against whitelist:
allowed_attrs = ['name', 'value', 'status']
if user_input in allowed_attrs:
    value = getattr(obj, user_input)
else:
    raise ValueError("Attribute not allowed")
# OR use a predefined mapping of allowed attributes'''
            },
            {
                'pattern': r'setattr\s*\([^)]*,\s*[^)]*\)',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous setattr() function - can modify arbitrary attributes',
                'exact_solution': '''# VULNERABLE CODE:
setattr(obj, user_input, value)

# SECURE SOLUTION:
# Validate attribute name against whitelist:
allowed_attrs = ['name', 'value', 'status']
if user_input in allowed_attrs:
    setattr(obj, user_input, value)
else:
    raise ValueError("Attribute not allowed")
# OR use a predefined mapping of allowed attributes'''
            },
            {
                'pattern': r'os\.system\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous os.system() - can execute arbitrary commands',
                'exact_solution': '''# VULNERABLE CODE:
os.system(f"echo {user_input}")

# SECURE SOLUTION:
import subprocess
# Use subprocess with shell=False and proper argument handling:
subprocess.run(['echo', user_input], shell=False, check=True)
# OR use shlex.quote for shell commands:
import shlex
subprocess.run(f"echo {shlex.quote(user_input)}", shell=True)'''
            },
            {
                'pattern': r'subprocess\.call\s*\([^)]*shell\s*=\s*True',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous subprocess.call with shell=True - can execute arbitrary commands',
                'exact_solution': '''# VULNERABLE CODE:
subprocess.call(f"echo {user_input}", shell=True)

# SECURE SOLUTION:
import subprocess
# Use shell=False and pass arguments as list:
subprocess.call(['echo', user_input], shell=False)
# OR use shlex.quote for shell commands:
import shlex
subprocess.call(f"echo {shlex.quote(user_input)}", shell=True)'''
            },
            {
                'pattern': r'hashlib\.md5\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function MD5',
                'exact_solution': '''# VULNERABLE CODE:
import hashlib
hash_value = hashlib.md5(password.encode()).hexdigest()

# SECURE SOLUTION:
import hashlib
# Use SHA-256 or stronger:
hash_value = hashlib.sha256(password.encode()).hexdigest()
# For password hashing, use bcrypt or Argon2:
import bcrypt
hash_value = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
# OR use Argon2:
from argon2 import PasswordHasher
ph = PasswordHasher()
hash_value = ph.hash(password)'''
            },
            {
                'pattern': r'hashlib\.sha1\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function SHA-1',
                'exact_solution': '''# VULNERABLE CODE:
import hashlib
hash_value = hashlib.sha1(password.encode()).hexdigest()

# SECURE SOLUTION:
import hashlib
# Use SHA-256 or stronger:
hash_value = hashlib.sha256(password.encode()).hexdigest()
# For password hashing, use bcrypt or Argon2:
import bcrypt
hash_value = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())'''
            },
            {
                'pattern': r'random\.random\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Insecure random number generation',
                'exact_solution': '''# VULNERABLE CODE:
import random
value = random.random()

# SECURE SOLUTION:
import secrets
# Use secrets module for cryptographically secure random numbers:
value = secrets.randbelow(100)  # Random integer below 100
# OR for random bytes:
random_bytes = secrets.token_bytes(16)
# OR for random hex:
random_hex = secrets.token_hex(16)'''
            },
            {
                'pattern': r'random\.randint\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Insecure random integer generation',
                'exact_solution': '''# VULNERABLE CODE:
import random
value = random.randint(1, 100)

# SECURE SOLUTION:
import secrets
# Use secrets.randbelow for cryptographically secure random integers:
value = secrets.randbelow(100) + 1  # Random integer between 1 and 100
# OR use secrets.randbits for random bits:
random_bits = secrets.randbits(32)'''
            },
            {
                'pattern': r'input\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Dangerous input() function - can read arbitrary input',
                'exact_solution': '''# VULNERABLE CODE:
user_input = input("Enter value: ")

# SECURE SOLUTION:
# Validate and sanitize input:
user_input = input("Enter value: ")
# Sanitize input:
user_input = user_input.strip()
# Validate input format:
if not user_input.isalnum():
    raise ValueError("Invalid input format")
# OR use specific input validation based on expected format'''
            },
            {
                'pattern': r'raw_input\s*\(',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Dangerous raw_input() function - deprecated and can read arbitrary input',
                'exact_solution': '''# VULNERABLE CODE:
user_input = raw_input("Enter value: ")

# SECURE SOLUTION:
# Use input() instead (Python 3) and validate input:
user_input = input("Enter value: ")
# Sanitize input:
user_input = user_input.strip()
# Validate input format:
if not user_input.isalnum():
    raise ValueError("Invalid input format")'''
            }
        ]
    },
    'javascript': {
        'sql-injection': [
            {
                'pattern': r'query\s*\(\s*["\'].*\+.*["\']',
                'issue_type': 'sql-injection',
                'severity': 'high',
                'description': 'SQL Injection via string concatenation in query()',
                'exact_solution': '''// VULNERABLE CODE:
db.query("SELECT * FROM users WHERE id = " + userId)

// SECURE SOLUTION:
// Use parameterized queries:
db.query("SELECT * FROM users WHERE id = ?", [userId])
// OR with named parameters:
db.query("SELECT * FROM users WHERE id = :id", { id: userId })
// OR use prepared statements:
const stmt = db.prepare("SELECT * FROM users WHERE id = ?");
stmt.run(userId);'''
            }
        ],
        'command-injection': [
            {
                'pattern': r'child_process\.exec\s*\(',
                'issue_type': 'command-injection',
                'severity': 'high',
                'description': 'Command Injection via child_process.exec()',
                'exact_solution': '''// VULNERABLE CODE:
const { exec } = require('child_process');
exec(`echo ${userInput}`);

// SECURE SOLUTION:
const { spawn } = require('child_process');
// Use spawn with array of arguments:
const child = spawn('echo', [userInput]);
// OR use execFile for safer execution:
const { execFile } = require('child_process');
execFile('echo', [userInput], (error, stdout, stderr) => {
    // Handle result
});'''
            }
        ],
        'code-injection': [
            {
                'pattern': r'eval\s*\(',
                'issue_type': 'code-injection',
                'severity': 'critical',
                'description': 'Code Injection via eval() function',
                'exact_solution': '''// VULNERABLE CODE:
const result = eval(userInput);

// SECURE SOLUTION:
// Avoid eval() entirely. Use alternatives:
// For JSON parsing:
const result = JSON.parse(userInput);
// For mathematical expressions, use a safe math parser
// For dynamic property access:
const obj = { prop: 'value' };
const result = obj[propertyName]; // Instead of eval
// For configuration, use proper config parsers'''
            }
        ],
        'xss': [
            {
                'pattern': r'innerHTML\s*=',
                'issue_type': 'xss',
                'severity': 'high',
                'description': 'Cross-Site Scripting via innerHTML assignment',
                'exact_solution': '''// VULNERABLE CODE:
element.innerHTML = userInput;

// SECURE SOLUTION:
// Use textContent for plain text:
element.textContent = userInput;
// OR escape HTML:
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
element.innerHTML = escapeHtml(userInput);
// OR use a proper HTML sanitizer library like DOMPurify'''
            }
        ],
        'banned-api': [
            {
                'pattern': r'eval\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous eval() function - can execute arbitrary code',
                'exact_solution': '''// VULNERABLE CODE:
const result = eval(userInput);

// SECURE SOLUTION:
// Avoid eval() entirely. Use alternatives:
// For JSON parsing:
const result = JSON.parse(userInput);
// For mathematical expressions, use a safe math parser
// For dynamic property access:
const obj = { prop: 'value' };
const result = obj[propertyName]; // Instead of eval
// For configuration, use proper config parsers'''
            },
            {
                'pattern': r'Function\s*\(',
                'issue_type': 'banned-api',
                'severity': 'critical',
                'description': 'Dangerous Function() constructor - can execute arbitrary code',
                'exact_solution': '''// VULNERABLE CODE:
const func = new Function(userInput);

// SECURE SOLUTION:
// Avoid Function() constructor entirely. Use alternatives:
// For dynamic property access:
const obj = { prop: 'value' };
const result = obj[propertyName];
// For configuration, use proper config parsers
// For safe code execution, use restricted environments'''
            },
            {
                'pattern': r'child_process\.exec\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous child_process.exec() - can execute arbitrary commands',
                'exact_solution': '''// VULNERABLE CODE:
const { exec } = require('child_process');
exec(`echo ${userInput}`);

// SECURE SOLUTION:
const { spawn } = require('child_process');
// Use spawn with array of arguments:
const child = spawn('echo', [userInput]);
// OR use execFile for safer execution:
const { execFile } = require('child_process');
execFile('echo', [userInput], (error, stdout, stderr) => {
    // Handle result
});'''
            },
            {
                'pattern': r'innerHTML\s*=',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous innerHTML assignment - can lead to XSS',
                'exact_solution': '''// VULNERABLE CODE:
element.innerHTML = userInput;

// SECURE SOLUTION:
// Use textContent for plain text:
element.textContent = userInput;
// OR escape HTML:
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
element.innerHTML = escapeHtml(userInput);
// OR use a proper HTML sanitizer library like DOMPurify'''
            },
            {
                'pattern': r'document\.write\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous document.write() - can lead to XSS',
                'exact_solution': '''// VULNERABLE CODE:
document.write(userInput);

// SECURE SOLUTION:
// Use DOM manipulation instead:
const element = document.createElement('div');
element.textContent = userInput;
document.body.appendChild(element);
// OR use innerHTML with sanitization:
element.innerHTML = escapeHtml(userInput);'''
            },
            {
                'pattern': r'crypto\.createHash\s*\(\s*["\']md5["\']',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function MD5',
                'exact_solution': '''// VULNERABLE CODE:
const crypto = require('crypto');
const hash = crypto.createHash('md5').update(data).digest('hex');

// SECURE SOLUTION:
const crypto = require('crypto');
// Use SHA-256 or stronger:
const hash = crypto.createHash('sha256').update(data).digest('hex');
// For password hashing, use bcrypt:
const bcrypt = require('bcrypt');
const hash = bcrypt.hashSync(password, 10);'''
            },
            {
                'pattern': r'crypto\.createHash\s*\(\s*["\']sha1["\']',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function SHA-1',
                'exact_solution': '''// VULNERABLE CODE:
const crypto = require('crypto');
const hash = crypto.createHash('sha1').update(data).digest('hex');

// SECURE SOLUTION:
const crypto = require('crypto');
// Use SHA-256 or stronger:
const hash = crypto.createHash('sha256').update(data).digest('hex');
// For password hashing, use bcrypt:
const bcrypt = require('bcrypt');
const hash = bcrypt.hashSync(password, 10);'''
            }
        ]
    },
    'java': {
        'sql-injection': [
            {
                'pattern': r'Statement\.executeQuery\s*\(\s*["\'].*\+.*["\']',
                'issue_type': 'sql-injection',
                'severity': 'high',
                'description': 'SQL Injection via string concatenation in Statement.executeQuery()',
                'exact_solution': '''// VULNERABLE CODE:
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM users WHERE id = " + userId);

// SECURE SOLUTION:
// Use PreparedStatement:
PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
pstmt.setInt(1, userId);
ResultSet rs = pstmt.executeQuery();
// OR use parameterized queries with named parameters:
PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM users WHERE id = :id");
pstmt.setInt("id", userId);
ResultSet rs = pstmt.executeQuery();'''
            }
        ],
        'command-injection': [
            {
                'pattern': r'Runtime\.getRuntime\(\)\.exec\s*\(',
                'issue_type': 'command-injection',
                'severity': 'high',
                'description': 'Command Injection via Runtime.getRuntime().exec()',
                'exact_solution': '''// VULNERABLE CODE:
Runtime.getRuntime().exec("echo " + userInput);

// SECURE SOLUTION:
// Use ProcessBuilder with array of arguments:
ProcessBuilder pb = new ProcessBuilder("echo", userInput);
Process process = pb.start();
// OR validate and sanitize input:
if (userInput.matches("[a-zA-Z0-9\\s]+")) {
    ProcessBuilder pb = new ProcessBuilder("echo", userInput);
    Process process = pb.start();
} else {
    throw new IllegalArgumentException("Invalid input");
}'''
            }
        ],
        'code-injection': [
            {
                'pattern': r'Class\.forName\s*\(',
                'issue_type': 'code-injection',
                'severity': 'high',
                'description': 'Code Injection via Class.forName()',
                'exact_solution': '''// VULNERABLE CODE:
Class<?> clazz = Class.forName(userInput);

// SECURE SOLUTION:
// Validate class name against whitelist:
Set<String> allowedClasses = Set.of("java.lang.String", "java.util.List");
if (allowedClasses.contains(userInput)) {
    Class<?> clazz = Class.forName(userInput);
} else {
    throw new IllegalArgumentException("Class not allowed");
}
// OR use reflection with proper access controls and validation'''
            }
        ],
        'xss': [
            {
                'pattern': r'response\.getWriter\(\)\.print\s*\(',
                'issue_type': 'xss',
                'severity': 'high',
                'description': 'Cross-Site Scripting via response.getWriter().print()',
                'exact_solution': '''// VULNERABLE CODE:
response.getWriter().print(userInput);

// SECURE SOLUTION:
// Escape HTML output:
import org.apache.commons.text.StringEscapeUtils;
response.getWriter().print(StringEscapeUtils.escapeHtml4(userInput));
// OR use JSP with proper escaping:
<c:out value="${userInput}" />
// OR use OWASP Java Encoder:
import org.owasp.encoder.Encode;
response.getWriter().print(Encode.forHtml(userInput));'''
            }
        ],
        'banned-api': [
            {
                'pattern': r'Runtime\.getRuntime\(\)\.exec\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous Runtime.getRuntime().exec() - can execute arbitrary commands',
                'exact_solution': '''// VULNERABLE CODE:
Runtime.getRuntime().exec("echo " + userInput);

// SECURE SOLUTION:
// Use ProcessBuilder with array of arguments:
ProcessBuilder pb = new ProcessBuilder("echo", userInput);
Process process = pb.start();
// OR validate and sanitize input:
if (userInput.matches("[a-zA-Z0-9\\s]+")) {
    ProcessBuilder pb = new ProcessBuilder("echo", userInput);
    Process process = pb.start();
} else {
    throw new IllegalArgumentException("Invalid input");
}'''
            },
            {
                'pattern': r'ProcessBuilder\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous ProcessBuilder - can execute arbitrary commands',
                'exact_solution': '''// VULNERABLE CODE:
ProcessBuilder pb = new ProcessBuilder(userInput);

// SECURE SOLUTION:
// Validate command against whitelist:
String[] allowedCommands = {"ls", "pwd", "whoami"};
if (Arrays.asList(allowedCommands).contains(userInput)) {
    ProcessBuilder pb = new ProcessBuilder(userInput);
    Process process = pb.start();
} else {
    throw new IllegalArgumentException("Command not allowed");
}'''
            },
            {
                'pattern': r'Class\.forName\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous Class.forName() - can load arbitrary classes',
                'exact_solution': '''// VULNERABLE CODE:
Class<?> clazz = Class.forName(userInput);

// SECURE SOLUTION:
// Validate class name against whitelist:
Set<String> allowedClasses = Set.of("java.lang.String", "java.util.List");
if (allowedClasses.contains(userInput)) {
    Class<?> clazz = Class.forName(userInput);
} else {
    throw new IllegalArgumentException("Class not allowed");
}
// OR use reflection with proper access controls and validation'''
            },
            {
                'pattern': r'ObjectInputStream\.readObject\s*\(',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Dangerous ObjectInputStream.readObject() - can deserialize arbitrary objects',
                'exact_solution': '''// VULNERABLE CODE:
ObjectInputStream ois = new ObjectInputStream(inputStream);
Object obj = ois.readObject();

// SECURE SOLUTION:
// Avoid ObjectInputStream entirely for untrusted data. Use alternatives:
// For JSON data:
import com.fasterxml.jackson.databind.ObjectMapper;
ObjectMapper mapper = new ObjectMapper();
MyClass obj = mapper.readValue(jsonString, MyClass.class);
// OR use safe serialization formats like Protocol Buffers
// OR implement custom deserialization with validation'''
            },
            {
                'pattern': r'MessageDigest\.getInstance\s*\(\s*["\']MD5["\']',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function MD5',
                'exact_solution': '''// VULNERABLE CODE:
MessageDigest digest = MessageDigest.getInstance("MD5");
byte[] hash = digest.digest(data.getBytes());

// SECURE SOLUTION:
// Use SHA-256 instead of MD5:
MessageDigest digest = MessageDigest.getInstance("SHA-256");
byte[] hash = digest.digest(data.getBytes());
// For password hashing, use BCrypt:
String hashedPassword = BCrypt.hashpw(password, BCrypt.gensalt());'''
            },
            {
                'pattern': r'MessageDigest\.getInstance\s*\(\s*["\']SHA1["\']',
                'issue_type': 'banned-api',
                'severity': 'medium',
                'description': 'Weak cryptographic hash function SHA-1',
                'exact_solution': '''// VULNERABLE CODE:
MessageDigest digest = MessageDigest.getInstance("SHA1");
byte[] hash = digest.digest(data.getBytes());

// SECURE SOLUTION:
// Use SHA-256 instead of SHA-1:
MessageDigest digest = MessageDigest.getInstance("SHA-256");
byte[] hash = digest.digest(data.getBytes());
// For password hashing, use BCrypt:
String hashedPassword = BCrypt.hashpw(password, BCrypt.gensalt());'''
            },
            {
                'pattern': r'Cipher\.getInstance\s*\(\s*["\']DES["\']',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Weak cryptographic cipher DES',
                'exact_solution': '''// VULNERABLE CODE:
Cipher cipher = Cipher.getInstance("DES");

// SECURE SOLUTION:
// Use AES-256 instead of DES:
Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
SecretKeySpec keySpec = new SecretKeySpec(key, "AES");
cipher.init(Cipher.ENCRYPT_MODE, keySpec);
// OR use ChaCha20-Poly1305 for authenticated encryption'''
            },
            {
                'pattern': r'Cipher\.getInstance\s*\(\s*["\']RC4["\']',
                'issue_type': 'banned-api',
                'severity': 'high',
                'description': 'Weak cryptographic cipher RC4',
                'exact_solution': '''// VULNERABLE CODE:
Cipher cipher = Cipher.getInstance("RC4");

// SECURE SOLUTION:
// Use AES-256 instead of RC4:
Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
SecretKeySpec keySpec = new SecretKeySpec(key, "AES");
cipher.init(Cipher.ENCRYPT_MODE, keySpec);
// OR use ChaCha20-Poly1305 for authenticated encryption'''
            }
        ]
    }
}

# Enhanced detection functions
def get_enhanced_patterns(language: str, vulnerability_type: str = None) -> List[Dict]:
    """Get enhanced security patterns with exact solutions"""
    if language not in ENHANCED_SECURITY_PATTERNS:
        return []
    
    if vulnerability_type:
        return ENHANCED_SECURITY_PATTERNS[language].get(vulnerability_type, [])
    else:
        # Return all patterns for the language
        all_patterns = []
        for patterns in ENHANCED_SECURITY_PATTERNS[language].values():
            all_patterns.extend(patterns)
        return all_patterns

def detect_exact_vulnerability(file_path: str, content: str, lines: List[str], language: str) -> List[Dict]:
    """Detect vulnerabilities with exact line information and solutions"""
    findings = []
    patterns = get_enhanced_patterns(language)
    
    for line_num, line in enumerate(lines, 1):
        for pattern_info in patterns:
            pattern = pattern_info['pattern']
            if re.search(pattern, line, re.IGNORECASE):
                # Get exact match details
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                
                # Get context lines
                context_lines = get_context_lines(lines, line_num, context_size=3)
                
                finding = {
                    'file': file_path,
                    'line_number': line_num,
                    'exact_line': line.strip(),
                    'exact_match': exact_match,
                    'issue_type': pattern_info['issue_type'],
                    'severity': pattern_info['severity'],
                    'description': pattern_info['description'],
                    'exact_solution': pattern_info['exact_solution'],
                    'context_lines': context_lines,
                    'vulnerability_category': get_vulnerability_category(pattern_info['issue_type']),
                    'risk_level': get_risk_level(pattern_info['severity']),
                    'remediation_priority': get_remediation_priority(pattern_info['severity'])
                }
                findings.append(finding)
    
    return findings

def get_context_lines(lines: List[str], line_num: int, context_size: int = 3) -> List[str]:
    """Get context lines around the vulnerable line"""
    start = max(0, line_num - context_size - 1)
    end = min(len(lines), line_num + context_size)
    return lines[start:end]

def get_vulnerability_category(issue_type: str) -> str:
    """Get vulnerability category"""
    categories = {
        'sql-injection': 'Injection',
        'command-injection': 'Injection',
        'code-injection': 'Injection',
        'xss': 'Cross-Site Scripting',
        'path-traversal': 'Path Traversal',
        'weak-crypto': 'Cryptographic Issues',
        'hardcoded-secret': 'Information Disclosure',
        'banned-api': 'API Misuse'
    }
    return categories.get(issue_type, 'Security Issue')

def get_risk_level(severity: str) -> str:
    """Get risk level description"""
    risk_levels = {
        'critical': 'Critical Risk - Immediate Action Required',
        'high': 'High Risk - Address Soon',
        'medium': 'Medium Risk - Plan Remediation',
        'low': 'Low Risk - Monitor'
    }
    return risk_levels.get(severity, 'Unknown Risk')

def get_remediation_priority(severity: str) -> str:
    """Get remediation priority"""
    priorities = {
        'critical': 'P0 - Fix Immediately',
        'high': 'P1 - Fix This Week',
        'medium': 'P2 - Fix This Month',
        'low': 'P3 - Fix When Possible'
    }
    return priorities.get(severity, 'Unknown Priority')

# Export enhanced functions
__all__ = [
    'ENHANCED_SECURITY_PATTERNS',
    'get_enhanced_patterns',
    'detect_exact_vulnerability',
    'get_context_lines',
    'get_vulnerability_category',
    'get_risk_level',
    'get_remediation_priority'
]
````

## File: agentic_fixer/code_security_auto_fixer/langgraph_graph.py
````python
from typing import TypedDict, Optional, Dict, Any, List

from langgraph.graph import StateGraph, END

from .langgraph_tools import (
    detect_repo_path,
    detect_languages,
    scan_patterns,
    prioritize,
    explain,
    apply_patches,
    run_tests,
    build_file_status,
    write_report,
)


class SecState(TypedDict, total=False):
    repo: str
    repo_path: str
    languages: List[str]
    findings: List[Dict[str, Any]]
    prioritized: List[Dict[str, Any]]
    explanations: List[Dict[str, Any]]
    file_status: List[Dict[str, Any]]
    patched: List[Dict[str, Any]]
    tests_ok: bool
    attempts: int
    report_path: str
    fix: bool


def node_scan_repo(state: SecState) -> SecState:
    state['repo_path'] = detect_repo_path(state['repo'])
    return state


def node_detect_langs(state: SecState) -> SecState:
    state['languages'] = detect_languages(state['repo_path'])
    return state


def node_scan_patterns(state: SecState) -> SecState:
    state['findings'] = scan_patterns(state['repo_path'], state.get('languages', []))
    return state


def node_prioritize(state: SecState) -> SecState:
    state['prioritized'] = prioritize(state.get('findings', []))
    state['explanations'] = explain(state['prioritized'])
    state['file_status'] = build_file_status(state['repo_path'], state['prioritized'])
    return state


def node_apply_patches(state: SecState) -> SecState:
    if state.get('fix'):
        state['patched'] = apply_patches(state['repo_path'], state.get('prioritized', []))
    return state


def node_run_tests(state: SecState) -> SecState:
    if state.get('fix'):
        state['tests_ok'] = run_tests(state['repo_path'])
        state['attempts'] = state.get('attempts', 0) + 1
    return state


def should_repair_or_report(state: SecState) -> str:
    if not state.get('fix'):
        return 'report'
    if not state.get('tests_ok', True) and state.get('attempts', 0) < 2 and state.get('prioritized'):
        return 'repair'
    return 'report'


def node_write_report(state: SecState) -> SecState:
    report_path = state.get('report_path') or 'remediation_report.md'
    write_report(report_path, state.get('explanations', []), state.get('prioritized', []), state.get('file_status', []))
    state['report_path'] = report_path
    return state


def build_graph():
    g = StateGraph(SecState)
    g.add_node('scan_repo', node_scan_repo)
    g.add_node('detect_langs', node_detect_langs)
    g.add_node('scan_patterns', node_scan_patterns)
    g.add_node('prioritize', node_prioritize)
    g.add_node('apply_patches', node_apply_patches)
    g.add_node('run_tests', node_run_tests)
    g.add_node('write_report', node_write_report)

    g.set_entry_point('scan_repo')
    g.add_edge('scan_repo', 'detect_langs')
    g.add_edge('detect_langs', 'scan_patterns')
    g.add_edge('scan_patterns', 'prioritize')
    g.add_edge('prioritize', 'apply_patches')
    g.add_edge('apply_patches', 'run_tests')
    g.add_conditional_edges('run_tests', should_repair_or_report, {
        'repair': 'apply_patches',
        'report': 'write_report',
    })
    g.add_edge('write_report', END)
    return g.compile()
````

## File: agentic_fixer/code_security_auto_fixer/langgraph_tools.py
````python
from typing import Dict, Any, List

# Lightweight tool wrapper functions around existing modules.
from . import repo_scanner, language_detector, pattern_detector, patcher, test_runner, reporter


def detect_repo_path(repo: str) -> str:
    return repo_scanner.scan(repo)


def detect_languages(repo_path: str) -> List[str]:
    file_langs = language_detector.detect_per_file(repo_path)
    # Deduplicate while preserving order of occurrence
    seen: set = set()
    ordered: List[str] = []
    for lang in file_langs.values():
        if lang not in seen and lang != "unknown":
            seen.add(lang)
            ordered.append(lang)
    return ordered


def scan_patterns(repo_path: str, languages: List[str]) -> List[Dict[str, Any]]:
    return pattern_detector.scan(repo_path, languages)


def prioritize(findings: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    return pattern_detector.normalize_and_prioritize(findings)


def explain(prioritized: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    return pattern_detector.explain_and_suggest(prioritized)


def apply_patches(repo_path: str, prioritized: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    return patcher.apply(repo_path, prioritized)


def run_tests(repo_path: str) -> bool:
    return test_runner.run(repo_path)


def build_file_status(repo_path: str, prioritized: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    file_languages = language_detector.detect_per_file(repo_path)
    all_files = set(file_languages.keys())
    files_with_issues = set(f['file'] for f in prioritized)
    file_status: List[Dict[str, Any]] = []
    for f in all_files:
        status = 'issue' if f in files_with_issues else 'clean'
        lang = file_languages.get(f, 'unknown')
        file_status.append({'file': f, 'status': status, 'language': lang})
    return file_status


def write_report(report_path: str, explanations: List[Dict[str, Any]], prioritized: List[Dict[str, Any]], file_status: List[Dict[str, Any]]) -> bool:
    return reporter.generate_enhanced(report_path, explanations, prioritized, file_status)
````

## File: agentic_fixer/code_security_auto_fixer/language_detector.py
````python
# Detects programming language of files
import os
import re
from typing import Dict, List, Set

# Language detection patterns
LANGUAGE_PATTERNS = {
    'python': [
        r'^#!.*python',
        r'import\s+\w+',
        r'from\s+\w+\s+import',
        r'def\s+\w+\s*\(',
        r'class\s+\w+',
        r'if\s+__name__\s*==\s*["\']__main__["\']',
        r'print\s*\(',
        r'\.py$'
    ],
    'java': [
        r'^package\s+\w+',
        r'import\s+java\.',
        r'public\s+class\s+\w+',
        r'public\s+static\s+void\s+main',
        r'System\.out\.print',
        r'\.java$'
    ],
    'javascript': [
        r'^#!.*node',
        r'require\s*\(\s*["\']',
        r'import\s+.*from\s+["\']',
        r'function\s+\w+\s*\(',
        r'const\s+\w+\s*=',
        r'let\s+\w+\s*=',
        r'var\s+\w+\s*=',
        r'console\.log',
        r'\.js$'
    ],
    'typescript': [
        r'import\s+.*from\s+["\']',
        r'interface\s+\w+',
        r'type\s+\w+\s*=',
        r'class\s+\w+',
        r'function\s+\w+\s*\([^)]*\)\s*:\s*\w+',
        r'const\s+\w+\s*:\s*\w+',
        r'let\s+\w+\s*:\s*\w+',
        r'\.ts$'
    ],
    'php': [
        r'^<\?php',
        r'<\?=',
        r'<\?',
        r'echo\s+',
        r'print\s+',
        r'function\s+\w+\s*\(',
        r'class\s+\w+',
        r'require\s+',
        r'include\s+',
        r'\.php$'
    ],
    'ruby': [
        r'^#!.*ruby',
        r'require\s+["\']',
        r'def\s+\w+',
        r'class\s+\w+',
        r'puts\s+',
        r'puts\s+',
        r'\.rb$'
    ],
    'go': [
        r'^package\s+\w+',
        r'import\s+\(',
        r'func\s+\w+\s*\(',
        r'type\s+\w+\s+struct',
        r'fmt\.Print',
        r'\.go$'
    ],
    'rust': [
        r'^#!\[',
        r'use\s+\w+',
        r'fn\s+\w+\s*\(',
        r'struct\s+\w+',
        r'impl\s+\w+',
        r'println!\s*\(',
        r'\.rs$'
    ],
    'c': [
        r'^#include\s*<',
        r'^#include\s*"',
        r'int\s+main\s*\(',
        r'printf\s*\(',
        r'scanf\s*\(',
        r'\.c$'
    ],
    'cpp': [
        r'^#include\s*<',
        r'^#include\s*"',
        r'using\s+namespace',
        r'std::',
        r'cout\s*<<',
        r'cin\s*>>',
        r'class\s+\w+',
        r'\.cpp$',
        r'\.cc$',
        r'\.cxx$'
    ],
    'csharp': [
        r'using\s+System',
        r'namespace\s+\w+',
        r'class\s+\w+',
        r'public\s+static\s+void\s+Main',
        r'Console\.WriteLine',
        r'\.cs$'
    ],
    'swift': [
        r'import\s+\w+',
        r'func\s+\w+\s*\(',
        r'class\s+\w+',
        r'struct\s+\w+',
        r'print\s*\(',
        r'\.swift$'
    ],
    'kotlin': [
        r'package\s+\w+',
        r'import\s+\w+',
        r'fun\s+\w+\s*\(',
        r'class\s+\w+',
        r'println\s*\(',
        r'\.kt$'
    ],
    'scala': [
        r'package\s+\w+',
        r'import\s+\w+',
        r'object\s+\w+',
        r'class\s+\w+',
        r'def\s+\w+\s*\(',
        r'println\s*\(',
        r'\.scala$'
    ],
    'clojure': [
        r'^\(ns\s+\w+',
        r'^\(defn\s+\w+',
        r'^\(def\s+\w+',
        r'^\(let\s+',
        r'println',
        r'\.clj$'
    ],
    'haskell': [
        r'^module\s+\w+',
        r'^import\s+\w+',
        r'^main\s*::\s*IO\s*\(\)',
        r'^main\s*=\s*',
        r'putStrLn',
        r'\.hs$'
    ],
    'ocaml': [
        r'^open\s+\w+',
        r'^let\s+\w+',
        r'^let\s+rec\s+\w+',
        r'^type\s+\w+',
        r'print_string',
        r'\.ml$'
    ],
    'fsharp': [
        r'^open\s+\w+',
        r'^let\s+\w+',
        r'^let\s+rec\s+\w+',
        r'^type\s+\w+',
        r'printfn',
        r'\.fs$'
    ],
    'vb': [
        r'^Imports\s+\w+',
        r'^Module\s+\w+',
        r'^Sub\s+\w+',
        r'^Function\s+\w+',
        r'Console\.WriteLine',
        r'\.vb$'
    ],
    'perl': [
        r'^#!.*perl',
        r'^use\s+\w+',
        r'^my\s+\$',
        r'^our\s+\$',
        r'print\s+',
        r'\.pl$'
    ],
    'shell': [
        r'^#!.*sh',
        r'^#!.*bash',
        r'^#!.*zsh',
        r'^#!.*fish',
        r'echo\s+',
        r'\.sh$',
        r'\.bash$'
    ],
    'sql': [
        r'^SELECT\s+',
        r'^INSERT\s+INTO',
        r'^UPDATE\s+',
        r'^DELETE\s+FROM',
        r'^CREATE\s+TABLE',
        r'^ALTER\s+TABLE',
        r'\.sql$'
    ],
    'html': [
        r'^<!DOCTYPE\s+html',
        r'^<html',
        r'^<head>',
        r'^<body>',
        r'^<div',
        r'^<span',
        r'\.html$',
        r'\.htm$'
    ],
    'css': [
        r'^@import',
        r'^@media',
        r'^@keyframes',
        r'^\w+\s*\{',
        r'^\w+\s*:\s*',
        r'\.css$'
    ],
    'scss': [
        r'^@import',
        r'^@mixin',
        r'^@include',
        r'^\$',
        r'^%',
        r'\.scss$'
    ],
    'sass': [
        r'^@import',
        r'^@mixin',
        r'^@include',
        r'^\$',
        r'^%',
        r'\.sass$'
    ],
    'less': [
        r'^@import',
        r'^@mixin',
        r'^@include',
        r'^\@',
        r'\.less$'
    ],
    'vue': [
        r'^<template>',
        r'^<script>',
        r'^<style>',
        r'^export\s+default',
        r'\.vue$'
    ],
    'jsx': [
        r'^import\s+React',
        r'^export\s+default',
        r'^<[A-Z]\w+',
        r'^<div',
        r'^<span',
        r'\.jsx$'
    ],
    'tsx': [
        r'^import\s+React',
        r'^export\s+default',
        r'^<[A-Z]\w+',
        r'^<div',
        r'^<span',
        r'\.tsx$'
    ],
    'mjs': [
        r'^import\s+',
        r'^export\s+',
        r'\.mjs$'
    ]
}

# File extension to language mapping
EXTENSION_MAPPING = {
    '.py': 'python',
    '.java': 'java',
    '.js': 'javascript',
    '.ts': 'typescript',
    '.php': 'php',
    '.rb': 'ruby',
    '.go': 'go',
    '.rs': 'rust',
    '.c': 'c',
    '.cpp': 'cpp',
    '.cc': 'cpp',
    '.cxx': 'cpp',
    '.h': 'c',
    '.hpp': 'cpp',
    '.cs': 'csharp',
    '.swift': 'swift',
    '.kt': 'kotlin',
    '.scala': 'scala',
    '.clj': 'clojure',
    '.hs': 'haskell',
    '.ml': 'ocaml',
    '.fs': 'fsharp',
    '.vb': 'vb',
    '.pl': 'perl',
    '.sh': 'shell',
    '.bash': 'shell',
    '.sql': 'sql',
    '.html': 'html',
    '.htm': 'html',
    '.css': 'css',
    '.scss': 'scss',
    '.sass': 'sass',
    '.less': 'less',
    '.vue': 'vue',
    '.jsx': 'jsx',
    '.tsx': 'tsx',
    '.mjs': 'mjs'
}

def detect(repo_path):
    """Detect programming languages in a repository"""
    print(f"[language_detector] Detecting languages in {repo_path}")
    
    languages = set()
    file_languages = detect_per_file(repo_path)
    
    # Count occurrences of each language
    language_counts = {}
    for lang in file_languages.values():
        if lang != 'unknown':
            language_counts[lang] = language_counts.get(lang, 0) + 1
    
    # Sort by count and return top languages
    sorted_languages = sorted(language_counts.items(), key=lambda x: x[1], reverse=True)
    languages = [lang for lang, count in sorted_languages if count > 0]
    
    print(f"[language_detector] Detected languages: {languages}")
    return languages

def detect_per_file(repo_path):
    """Detect programming language for each file in the repository"""
    file_languages = {}
    
    for root, dirs, files in os.walk(repo_path):
        # Skip hidden directories and common non-source directories
        dirs[:] = [d for d in dirs if not d.startswith('.') and d not in {
            'node_modules', 'venv', '__pycache__', 'target', 'build', 'dist',
            'vendor', 'lib', 'libs', 'dependencies', 'external', 'third_party'
        }]
        
        for file in files:
            file_path = os.path.join(root, file)
            rel_path = os.path.relpath(file_path, repo_path)
            
            # First try extension-based detection
            language = detect_by_extension(file)
            if language:
                file_languages[rel_path] = language
                continue
            
            # If no extension match, try content-based detection
            language = detect_by_content(file_path)
            if language:
                file_languages[rel_path] = language
                continue
            
            # Default to unknown
            file_languages[rel_path] = 'unknown'
    
    return file_languages

def detect_by_extension(filename):
    """Detect language by file extension"""
    for ext, lang in EXTENSION_MAPPING.items():
        if filename.endswith(ext):
            return lang
    return None

def detect_by_content(file_path):
    """Detect language by analyzing file content"""
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read(1024)  # Read first 1KB for analysis
        
        # Score each language based on pattern matches
        language_scores = {}
        
        for lang, patterns in LANGUAGE_PATTERNS.items():
            score = 0
            for pattern in patterns:
                if re.search(pattern, content, re.MULTILINE | re.IGNORECASE):
                    score += 1
            language_scores[lang] = score
        
        # Return the language with the highest score
        if language_scores:
            best_lang = max(language_scores.items(), key=lambda x: x[1])
            if best_lang[1] > 0:  # Only return if we found at least one pattern
                return best_lang[0]
        
        return None
        
    except Exception as e:
        print(f"[language_detector] Error reading {file_path}: {e}")
        return None

def get_language_statistics(file_languages):
    """Get statistics about detected languages"""
    stats = {}
    total_files = len(file_languages)
    
    for lang in file_languages.values():
        if lang != 'unknown':
            stats[lang] = stats.get(lang, 0) + 1
    
    # Convert counts to percentages
    for lang in stats:
        stats[lang] = {
            'count': stats[lang],
            'percentage': round((stats[lang] / total_files) * 100, 2)
        }
    
    return stats

def is_supported_language(language):
    """Check if a language is supported for security scanning"""
    supported_languages = {
        'python', 'java', 'javascript', 'typescript', 'php', 'ruby', 
        'go', 'rust', 'c', 'cpp', 'csharp', 'swift', 'kotlin', 'scala',
        'clojure', 'haskell', 'ocaml', 'fsharp', 'vb', 'perl', 'shell',
        'sql', 'html', 'css', 'scss', 'sass', 'less', 'vue', 'jsx', 'tsx', 'mjs'
    }
    return language in supported_languages

def get_language_family(language):
    """Get the language family for a given language"""
    language_families = {
        'python': 'interpreted',
        'java': 'compiled',
        'javascript': 'interpreted',
        'typescript': 'compiled',
        'php': 'interpreted',
        'ruby': 'interpreted',
        'go': 'compiled',
        'rust': 'compiled',
        'c': 'compiled',
        'cpp': 'compiled',
        'csharp': 'compiled',
        'swift': 'compiled',
        'kotlin': 'compiled',
        'scala': 'compiled',
        'clojure': 'interpreted',
        'haskell': 'compiled',
        'ocaml': 'compiled',
        'fsharp': 'compiled',
        'vb': 'compiled',
        'perl': 'interpreted',
        'shell': 'interpreted',
        'sql': 'declarative',
        'html': 'markup',
        'css': 'stylesheet',
        'scss': 'stylesheet',
        'sass': 'stylesheet',
        'less': 'stylesheet',
        'vue': 'framework',
        'jsx': 'framework',
        'tsx': 'framework',
        'mjs': 'module'
    }
    return language_families.get(language, 'unknown')
````

## File: agentic_fixer/code_security_auto_fixer/patcher.py
````python
# Applies AST-based patches to insecure code
def apply(repo_path, prioritized):
	print(f"[patcher] Applying patches in {repo_path} for {prioritized}")
	return [{'file': f['file'], 'patched': True} for f in prioritized]

def revert(repo_path):
	print(f"[patcher] Reverting patches in {repo_path}")
	return True
````

## File: agentic_fixer/code_security_auto_fixer/pattern_detector.py
````python
# Detects insecure coding patterns using AST analysis and regex patterns
import os
import re
import ast
import json
from typing import List, Dict, Any
from code_security_auto_fixer.security_policies import (
    get_security_patterns, 
    get_cwe_mapping,
    get_severity_weight,
    get_cwe_description,
    get_security_category,
    get_banned_apis
)

def scan(repo_path, languages):
    print(f"[pattern_detector] Scanning {repo_path} for {languages}")
    findings = []
    
    for root, _, files in os.walk(repo_path):
        for f in files:
            rel_path = os.path.relpath(os.path.join(root, f), repo_path)
            file_path = os.path.join(root, f)
            
            # Skip non-source files
            if not any(f.endswith(ext) for ext in ['.py', '.js', '.java', '.ts', '.php', '.rb', '.go', '.rs', '.c', '.cpp']):
                continue
            
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as file:
                    content = file.read()
                    lines = content.split('\n')
                    
                    # Detect vulnerabilities based on file type
                    if f.endswith('.py') and 'python' in languages:
                        findings.extend(scan_python_file(rel_path, content, lines))
                    elif f.endswith('.js') and 'javascript' in languages:
                        findings.extend(scan_javascript_file(rel_path, content, lines))
                    elif f.endswith('.java') and 'java' in languages:
                        findings.extend(scan_java_file(rel_path, content, lines))
                    elif f.endswith('.ts') and 'typescript' in languages:
                        findings.extend(scan_javascript_file(rel_path, content, lines))  # Same as JS
                    elif f.endswith('.php') and 'php' in languages:
                        findings.extend(scan_php_file(rel_path, content, lines))
                    elif f.endswith('.rb') and 'ruby' in languages:
                        findings.extend(scan_ruby_file(rel_path, content, lines))
                    elif f.endswith('.go') and 'go' in languages:
                        findings.extend(scan_go_file(rel_path, content, lines))
                    elif f.endswith('.rs') and 'rust' in languages:
                        findings.extend(scan_rust_file(rel_path, content, lines))
                    elif f.endswith(('.c', '.cpp')) and ('c' in languages or 'cpp' in languages):
                        findings.extend(scan_c_cpp_file(rel_path, content, lines))
                        
            except Exception as e:
                print(f"[pattern_detector] Error scanning {rel_path}: {e}")
                continue
    
    return findings

def scan_python_file(file_path, content, lines):
    """Scan Python file for security vulnerabilities using comprehensive patterns from security_policies.py"""
    findings = []
    
    # Get all security patterns for Python from security_policies.py
    security_patterns = get_security_patterns('python')
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in security_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                # Get the exact match
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                
                # Get CWE mapping
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_javascript_file(file_path, content, lines):
    """Scan JavaScript file for security vulnerabilities using comprehensive patterns from security_policies.py"""
    findings = []
    
    # Get all security patterns for JavaScript from security_policies.py
    security_patterns = get_security_patterns('javascript')
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in security_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                # Get the exact match
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                
                # Get CWE mapping
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_java_file(file_path, content, lines):
    """Scan Java file for security vulnerabilities using comprehensive patterns from security_policies.py"""
    findings = []
    
    # Get all security patterns for Java from security_policies.py
    security_patterns = get_security_patterns('java')
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in security_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                # Get the exact match
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                
                # Get CWE mapping
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_php_file(file_path, content, lines):
    """Scan PHP file for security vulnerabilities"""
    findings = []
    # PHP patterns are not yet in security_policies.py, use basic detection
    basic_patterns = [
        (r'eval\s*\(', 'code-injection', 'critical'),
        (r'system\s*\(', 'command-injection', 'high'),
        (r'exec\s*\(', 'command-injection', 'high'),
        (r'mysql_query\s*\(\s*["\'].*\$.*["\']', 'sql-injection', 'high'),
    ]
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in basic_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_ruby_file(file_path, content, lines):
    """Scan Ruby file for security vulnerabilities"""
    findings = []
    # Ruby patterns are not yet in security_policies.py, use basic detection
    basic_patterns = [
        (r'eval\s*\(', 'code-injection', 'critical'),
        (r'system\s*\(', 'command-injection', 'high'),
        (r'exec\s*\(', 'command-injection', 'high'),
        (r'execute\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
    ]
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in basic_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_go_file(file_path, content, lines):
    """Scan Go file for security vulnerabilities"""
    findings = []
    # Go patterns are not yet in security_policies.py, use basic detection
    basic_patterns = [
        (r'exec\.Command\s*\(', 'command-injection', 'high'),
        (r'exec.Command\s*\(\s*["\'].*\+.*["\']', 'command-injection', 'high'),
        (r'Query\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
    ]
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in basic_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_rust_file(file_path, content, lines):
    """Scan Rust file for security vulnerabilities"""
    findings = []
    # Rust patterns are not yet in security_policies.py, use basic detection
    basic_patterns = [
        (r'Command::new\s*\(', 'command-injection', 'high'),
        (r'Command::new\s*\(\s*["\'].*\+.*["\']', 'command-injection', 'high'),
    ]
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in basic_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def scan_c_cpp_file(file_path, content, lines):
    """Scan C/C++ file for security vulnerabilities using comprehensive patterns from security_policies.py"""
    findings = []
    
    # Determine if it's C or C++
    is_cpp = any(f for f in ['.cpp', '.hpp', '.cc', '.cxx', '.c++'] if file_path.endswith(f))
    language = 'cpp' if is_cpp else 'c'
    
    # Get all security patterns for C/C++ from security_policies.py
    security_patterns = get_security_patterns(language)
    
    for line_num, line in enumerate(lines, 1):
        for pattern, issue_type, severity in security_patterns:
            if re.search(pattern, line, re.IGNORECASE):
                # Get the exact match
                match = re.search(pattern, line, re.IGNORECASE)
                exact_match = match.group(0) if match else line.strip()
                
                # Get CWE mapping
                cwe_info = get_cwe_mapping(issue_type)
                
                findings.append({
                    'file': file_path,
                    'line': line_num,
                    'issue': issue_type,
                    'severity': severity,
                    'code': line.strip(),
                    'exact_match': exact_match,
                    'description': f'{issue_type.replace("-", " ").title()} vulnerability detected',
                    'solution': f'Review and fix the {issue_type} vulnerability on line {line_num}',
                    'example_bad': line.strip(),
                    'example_good': 'Use secure alternatives',
                    'cwe': cwe_info['cwe'],
                    'owasp': cwe_info['owasp'],
                    'context': get_context_lines(lines, line_num)
                })
    
    return findings

def get_context_lines(lines, line_num, context_size=3):
    """Get context lines around the vulnerable line"""
    start = max(0, line_num - context_size - 1)
    end = min(len(lines), line_num + context_size)
    return lines[start:end]

def normalize_and_prioritize(findings):
    """Normalize and prioritize findings"""
    # Simple prioritization based on severity
    severity_order = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1}
    
    def priority_key(finding):
        return severity_order.get(finding.get('severity', 'low'), 1)
    
    return sorted(findings, key=priority_key, reverse=True)

def explain_and_suggest(findings, detailed=False):
    """Generate explanations and suggestions for findings"""
    explanations = []
    
    for finding in findings:
        # Get vulnerability category and module info
        vulnerability_category = get_vulnerability_category(finding.get('issue', ''))
        module_category = get_module_category(finding['file'])
        
        explanation = {
            'file': finding['file'],
            'line': finding['line'],
            'issue': finding['issue'],
            'severity': finding['severity'],
            'code': finding['code'],
            'exact_match': finding.get('exact_match', finding['code']),
            'description': finding.get('description', f"This line contains a {finding['issue']} vulnerability with {finding['severity']} severity."),
            'solution': finding.get('solution', f"Review and fix the {finding['issue']} vulnerability on line {finding['line']}."),
            'suggestion': finding.get('solution', f"Review and fix the {finding['issue']} vulnerability on line {finding['line']}."),
            'example_bad': finding.get('example_bad', ''),
            'example_good': finding.get('example_good', ''),
            'cwe': finding.get('cwe', ''),
            'owasp': finding.get('owasp', ''),
            'context': finding['context'],
            'vulnerability_name': get_vulnerability_name(finding.get('issue', '')),
            'vulnerability_category': vulnerability_category,
            'module_category': module_category,
            'detected_at': get_current_timestamp(),
            'priority_score': get_priority_score(finding.get('severity', 'medium'))
        }
        explanations.append(explanation)
    
    return explanations

def get_vulnerability_category(issue_type):
    """Get vulnerability category based on issue type"""
    category_map = {
        'sql-injection': 'Injection',
        'nosql-injection': 'Injection', 
        'command-injection': 'Injection',
        'ldap-injection': 'Injection',
        'xss': 'Cross-Site Scripting',
        'path-traversal': 'Broken Access Control',
        'weak-crypto': 'Cryptographic Failures',
        'insecure-randomness': 'Cryptographic Failures',
        'tls-issues': 'Cryptographic Failures',
        'hardcoded-secret': 'Identification and Authentication Failures',
        'code-injection': 'Injection',
        'buffer-overflow': 'Vulnerable Components',
        'memory-leak': 'Vulnerable Components',
        'unsafe-code': 'Vulnerable Components',
        'banned-api': 'Vulnerable Components',
        'insecure-deserialization': 'Software Integrity Failures',
        'ssrf': 'Server-Side Request Forgery',
        'insecure-storage': 'Cryptographic Failures',
        'improper-input-validation': 'Injection',
        'missing-output-encoding': 'Injection',
        'information-exposure': 'Broken Access Control',
        'unsafe-json-parsing': 'Injection'
    }
    return category_map.get(issue_type.lower(), 'General Security Issue')

def get_vulnerability_name(issue_type):
    """Get human-readable vulnerability name"""
    name_map = {
        'sql-injection': 'SQL Injection Vulnerability',
        'nosql-injection': 'NoSQL Injection Vulnerability',
        'command-injection': 'Command Injection Vulnerability',
        'ldap-injection': 'LDAP Injection Vulnerability',
        'xss': 'Cross-Site Scripting (XSS) Vulnerability',
        'path-traversal': 'Path Traversal Vulnerability',
        'weak-crypto': 'Weak Cryptographic Implementation',
        'insecure-randomness': 'Insecure Random Number Generation',
        'tls-issues': 'TLS/SSL Configuration Issues',
        'hardcoded-secret': 'Hardcoded Credentials in Source Code',
        'code-injection': 'Code Injection Vulnerability',
        'buffer-overflow': 'Buffer Overflow Vulnerability',
        'memory-leak': 'Memory Leak Vulnerability',
        'unsafe-code': 'Unsafe Code Usage',
        'banned-api': 'Deprecated/Banned API Usage',
        'insecure-deserialization': 'Insecure Deserialization',
        'ssrf': 'Server-Side Request Forgery (SSRF)',
        'insecure-storage': 'Insecure Storage of Sensitive Information',
        'improper-input-validation': 'Improper Input Validation',
        'missing-output-encoding': 'Missing Output Encoding/Escaping',
        'information-exposure': 'Information Exposure in Source Code',
        'unsafe-json-parsing': 'Unsafe JSON Parsing or Dynamic Query Objects'
    }
    return name_map.get(issue_type.lower(), f'{issue_type.replace("-", " ").title()} Vulnerability')

def get_module_category(file_path):
    """Determine module/category based on file path"""
    if any(part in file_path.lower() for part in ['config', 'settings', 'env']):
        return 'Configuration'
    elif any(part in file_path.lower() for part in ['auth', 'login', 'user']):
        return 'Authentication'
    elif any(part in file_path.lower() for part in ['api', 'endpoint', 'route']):
        return 'API'
    elif any(part in file_path.lower() for part in ['db', 'database', 'model']):
        return 'Database'
    elif any(part in file_path.lower() for part in ['util', 'helper', 'common']):
        return 'Utilities'
    elif any(part in file_path.lower() for part in ['test', 'spec']):
        return 'Testing'
    elif any(part in file_path.lower() for part in ['static', 'public', 'assets']):
        return 'Static Assets'
    else:
        return 'Core Application'

def get_priority_score(severity):
    """Get priority score based on severity"""
    score_map = {
        'critical': 100,
        'high': 80,
        'medium': 60,
        'low': 40,
        'info': 20
    }
    return score_map.get(severity.lower(), 50)

def get_current_timestamp():
    """Get current timestamp in ISO format"""
    from datetime import datetime
    return datetime.now().isoformat()
````

## File: agentic_fixer/code_security_auto_fixer/repo_scanner.py
````python
# Handles scanning local and GitHub repositories
import os
import tempfile
import shutil
from git import Repo
import re

def scan(repo):
	print(f"[repo_scanner] Scanning {repo}")
	
	# If it's a GitHub URL, clone to a temp dir
	if re.match(r'^https?://github.com/.+/.+\.git$', repo):
		temp_dir = tempfile.mkdtemp(prefix='repo_')
		print(f"[repo_scanner] Cloning {repo} to {temp_dir}")
		try:
			Repo.clone_from(repo, temp_dir)
			if not _has_source_files(temp_dir):
				shutil.rmtree(temp_dir)
				raise Exception("No repository found")
			return temp_dir
		except Exception as e:
			if os.path.exists(temp_dir):
				shutil.rmtree(temp_dir)
			raise Exception("No repository found")
	
	# If it's a GitHub URL without .git, add .git
	if re.match(r'^https?://github.com/.+/.+$', repo):
		repo_url = repo if repo.endswith('.git') else repo + '.git'
		temp_dir = tempfile.mkdtemp(prefix='repo_')
		print(f"[repo_scanner] Cloning {repo_url} to {temp_dir}")
		try:
			Repo.clone_from(repo_url, temp_dir)
			if not _has_source_files(temp_dir):
				shutil.rmtree(temp_dir)
				raise Exception("No repository found")
			return temp_dir
		except Exception as e:
			if os.path.exists(temp_dir):
				shutil.rmtree(temp_dir)
			raise Exception("No repository found")
	
	# Otherwise, treat as local path
	if not os.path.exists(repo):
		raise Exception("No repository found")
	
	if not os.path.isdir(repo):
		raise Exception("No repository found")
	
	# For uploaded single-file scans, the temporary directory may not match
	# strict "source code" heuristics. Allow scanning to proceed so the
	# unified pipeline can run and report empty results if needed.
	if not _has_source_files(repo):
		print(f"[repo_scanner] No recognized source files detected in {repo}. Proceeding anyway for upload scans.")
		return repo
	
	return repo

def _has_source_files(path):
	"""Check if the directory contains source code files"""
	source_extensions = {
		'.py', '.java', '.js', '.ts', '.php', '.rb', '.go', '.rs', '.c', '.cpp', '.h', '.hpp',
		'.cs', '.swift', '.kt', '.scala', '.clj', '.hs', '.ml', '.fs', '.vb', '.pl', '.sh',
		'.sql', '.html', '.css', '.scss', '.sass', '.less', '.vue', '.jsx', '.tsx', '.mjs'
	}
	
	try:
		for root, dirs, files in os.walk(path):
			# Skip hidden directories and common non-source directories
			dirs[:] = [d for d in dirs if not d.startswith('.') and d not in {'node_modules', 'venv', '__pycache__', 'target', 'build', 'dist'}]
			
			for file in files:
				if any(file.endswith(ext) for ext in source_extensions):
					return True
		return False
	except Exception:
		return False
````

## File: agentic_fixer/code_security_auto_fixer/reporter.py
````python
# Generates remediation reports with line-specific details
import os
from datetime import datetime

def _extract_secure_code(suggestion, line_num):
	"""Extract the secure code from the suggestion for side-by-side comparison"""
	lines = suggestion.split('\n')
	secure_lines = []
	in_secure_section = False
	
	for line in lines:
		# Look for SECURE CODE section
		if '# SECURE CODE:' in line or '// SECURE CODE:' in line:
			in_secure_section = True
			continue
		elif '# VULNERABLE CODE:' in line or '// VULNERABLE CODE:' in line:
			in_secure_section = False
			continue
		elif line.strip().startswith('#') or line.strip().startswith('//'):
			# Skip comment lines
			continue
		elif in_secure_section and line.strip():
			# This is secure code
			secure_lines.append(line)
	
	# If no SECURE CODE section found, try to extract code after comments
	if not secure_lines:
		for line in lines:
			if line.strip() and not line.strip().startswith('#') and not line.strip().startswith('//'):
				# This might be code
				if '=' in line or '(' in line or 'import' in line or 'from' in line:
					secure_lines.append(line)
	
	# Format the secure code
	if secure_lines:
		# Take the first few lines of secure code
		max_lines = 5
		selected_lines = secure_lines[:max_lines]
		return '\n'.join(selected_lines)
	else:
		# Fallback: show a generic secure example
		return f"# Line {line_num}: Replace with secure implementation\n# Use proper security practices"

def _extract_original_code(vulnerable_code, line_num):
	"""Extract and format the original vulnerable code"""
	if vulnerable_code:
		return f"{line_num:4d}| {vulnerable_code}"
	else:
		return f"{line_num:4d}| [Code not available]"

def _get_severity_emoji(severity):
	"""Get emoji for severity level"""
	severity_emojis = {
		'critical': '',
		'high': '',
		'medium': '',
		'low': '',
		'info': ''
	}
	return severity_emojis.get(severity, '')

def _get_cwe_description(cwe):
	"""Get description for CWE identifier"""
	cwe_descriptions = {
		'CWE-89': 'SQL Injection - Improper neutralization of special elements used in an SQL command',
		'CWE-78': 'Command Injection - Improper neutralization of special elements used in an OS command',
		'CWE-79': 'Cross-site Scripting - Improper neutralization of input during web page generation',
		'CWE-22': 'Path Traversal - Improper limitation of a pathname to a restricted directory',
		'CWE-94': 'Code Injection - Improper control of generation of code',
		'CWE-327': 'Use of a Broken or Risky Cryptographic Algorithm',
		'CWE-330': 'Use of Insufficiently Random Values',
		'CWE-295': 'Improper Certificate Validation',
		'CWE-798': 'Use of Hard-coded Credentials',
		'CWE-120': 'Buffer Copy without Checking Size of Input',
		'CWE-401': 'Missing Release of Memory after Effective Lifetime',
		'CWE-119': 'Improper Restriction of Operations within the Bounds of a Memory Buffer',
		'CWE-477': 'Use of Obsolete Function',
		'CWE-502': 'Deserialization of Untrusted Data',
		'CWE-918': 'Server-Side Request Forgery',
		'CWE-611': 'Improper Restriction of XML External Entity Reference',
		'CWE-362': 'Concurrent Execution using Shared Resource with Improper Synchronization',
		'CWE-269': 'Improper Privilege Management',
		'CWE-90': 'LDAP Injection - Improper neutralization of special elements used in an LDAP query',
		'CWE-943': 'NoSQL Injection - Improper neutralization of special elements used in a NoSQL command',
	}
	return cwe_descriptions.get(cwe, 'Security vulnerability detected')

def _get_owasp_category_description(owasp):
	"""Get description for OWASP category"""
	owasp_descriptions = {
		'A01:2021 - Broken Access Control': 'Access control enforces policy such that users cannot act outside of their intended permissions.',
		'A02:2021 - Cryptographic Failures': 'Failures related to cryptography which often lead to sensitive data exposure or system compromise.',
		'A03:2021 - Injection': 'Injection flaws occur when untrusted data is sent to an interpreter as part of a command or query.',
		'A04:2021 - Insecure Design': 'Insecure design is a broad category representing different weaknesses expressed as "missing or ineffective control design."',
		'A05:2021 - Security Misconfiguration': 'Security misconfiguration is the most commonly seen issue and is often the result of insecure default configurations.',
		'A06:2021 - Vulnerable and Outdated Components': 'Components with known vulnerabilities are a common issue and can lead to serious security breaches.',
		'A07:2021 - Identification and Authentication Failures': 'Confirmation of the user identity, authentication, and session management is critical to protect against authentication-related attacks.',
		'A08:2021 - Software and Data Integrity Failures': 'Software and data integrity failures relate to code and infrastructure that does not protect against integrity violations.',
		'A09:2021 - Security Logging and Monitoring Failures': 'Logging and monitoring is critical for detecting, escalating, and responding to active breaches.',
		'A10:2021 - Server-Side Request Forgery': 'SSRF flaws occur whenever a web application is fetching a remote resource without validating the user-supplied URL.',
	}
	return owasp_descriptions.get(owasp, 'Security vulnerability category')

def generate(report_path, explanations, prioritized, file_status):
	print(f"[reporter] Generating enhanced report at {report_path}")
	with open(report_path, 'w', encoding='utf-8') as f:
		# Header
		f.write('# Security Vulnerability Report\n\n')
		f.write(f'**Generated:** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n\n')
		
		# Executive Summary
		f.write('## Executive Summary\n\n')
		
		# Count issues by severity
		severity_counts = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'info': 0}
		cwe_counts = {}
		owasp_counts = {}
		category_counts = {}
		
		for e in explanations:
			severity = e.get('severity', 'medium')
			severity_counts[severity] = severity_counts.get(severity, 0) + 1
			
			# Count CWE occurrences
			cwe = e.get('cwe', 'CWE-000')
			cwe_counts[cwe] = cwe_counts.get(cwe, 0) + 1
			
			# Count OWASP occurrences
			owasp = e.get('owasp', 'Unknown')
			owasp_counts[owasp] = owasp_counts.get(owasp, 0) + 1
			
			# Count category occurrences
			category = e.get('category', 'General')
			category_counts[category] = category_counts.get(category, 0) + 1
		
		# Severity breakdown
		f.write('### Severity Breakdown\n\n')
		f.write('| Severity | Count | Percentage |\n')
		f.write('|----------|-------|------------|\n')
		total_issues = len(explanations)
		for severity in ['critical', 'high', 'medium', 'low', 'info']:
			count = severity_counts.get(severity, 0)
			percentage = round((count / total_issues) * 100, 1) if total_issues > 0 else 0
			emoji = _get_severity_emoji(severity)
			f.write(f'| {emoji} {severity.title()} | {count} | {percentage}% |\n')
		f.write('\n')
		
		# Top CWE vulnerabilities
		f.write('### Top CWE Vulnerabilities\n\n')
		f.write('| CWE | Count | Description |\n')
		f.write('|-----|-------|-------------|\n')
		sorted_cwes = sorted(cwe_counts.items(), key=lambda x: x[1], reverse=True)[:10]
		for cwe, count in sorted_cwes:
			description = _get_cwe_description(cwe)
			f.write(f'| {cwe} | {count} | {description} |\n')
		f.write('\n')
		
		# OWASP Top 10 2021 breakdown
		f.write('### OWASP Top 10 2021 Breakdown\n\n')
		f.write('| OWASP Category | Count | Description |\n')
		f.write('|----------------|-------|-------------|\n')
		sorted_owasp = sorted(owasp_counts.items(), key=lambda x: x[1], reverse=True)
		for owasp, count in sorted_owasp:
			description = _get_owasp_category_description(owasp)
			f.write(f'| {owasp} | {count} | {description} |\n')
		f.write('\n')
		
		# Security category breakdown
		f.write('### Security Category Breakdown\n\n')
		f.write('| Category | Count | Percentage |\n')
		f.write('|----------|-------|------------|\n')
		sorted_categories = sorted(category_counts.items(), key=lambda x: x[1], reverse=True)
		for category, count in sorted_categories:
			percentage = round((count / total_issues) * 100, 1) if total_issues > 0 else 0
			f.write(f'| {category} | {count} | {percentage}% |\n')
		f.write('\n')
		
		# File status summary
		f.write('## File Status Summary\n\n')
		clean_files = sum(1 for fs in file_status if fs['status'] == 'clean')
		issue_files = sum(1 for fs in file_status if fs['status'] == 'issue')
		total_files = len(file_status)
		
		f.write(f'- **Total Files Scanned**: {total_files}\n')
		f.write(f'- **Files with Issues**: {issue_files}\n')
		f.write(f'- **Clean Files**: {clean_files}\n')
		f.write(f'- **Issue Rate**: {round((issue_files / total_files) * 100, 1) if total_files > 0 else 0}%\n\n')
		
		# Language breakdown
		language_counts = {}
		for fs in file_status:
			lang = fs['language']
			language_counts[lang] = language_counts.get(lang, 0) + 1
		
		f.write('### Language Breakdown\n\n')
		f.write('| Language | Files | Percentage |\n')
		f.write('|----------|-------|------------|\n')
		sorted_languages = sorted(language_counts.items(), key=lambda x: x[1], reverse=True)
		for lang, count in sorted_languages:
			percentage = round((count / total_files) * 100, 1) if total_files > 0 else 0
			f.write(f'| {lang.title()} | {count} | {percentage}% |\n')
		f.write('\n')
		
		# Detailed findings
		f.write('## Detailed Findings\n\n')
		
		# Group issues by file
		issues_by_file = {}
		for e in explanations:
			file_path = e['file']
			if file_path not in issues_by_file:
				issues_by_file[file_path] = []
			issues_by_file[file_path].append(e)
		
		# Sort files by number of issues (most issues first)
		sorted_files = sorted(issues_by_file.items(), key=lambda x: len(x[1]), reverse=True)
		
		for file_path, file_issues in sorted_files:
			# Get language for this file
			file_lang = 'unknown'
			for fs in file_status:
				if fs['file'] == file_path:
					file_lang = fs['language']
					break
			
			f.write(f'### {file_path} [{file_lang}]\n\n')
			
			# Sort issues by priority score (highest first)
			file_issues.sort(key=lambda x: x.get('priority_score', 0), reverse=True)
			
			for issue in file_issues:
				line_num = issue.get('line', 0)
				severity = issue.get('severity', 'medium')
				vulnerable_code = issue.get('code', '')
				context = issue.get('context', [])
				cwe = issue.get('cwe', 'CWE-000')
				owasp = issue.get('owasp', 'Unknown')
				category = issue.get('category', 'General')
				description = issue.get('description', 'Security vulnerability detected')
				priority_score = issue.get('priority_score', 0)
				
				# Severity badge
				severity_emoji = _get_severity_emoji(severity)
				severity_badge = f'{severity_emoji} **{severity.upper()}**'
				
				f.write(f'#### Line {line_num} - {issue["issue"].replace("-", " ").title()} {severity_badge}\n\n')
				
				# Security metadata
				f.write('**Security Information:**\n')
				f.write(f'- **CWE**: {cwe} - {description}\n')
				f.write(f'- **OWASP**: {owasp}\n')
				f.write(f'- **Category**: {category}\n')
				f.write(f'- **Priority Score**: {priority_score}/100\n\n')
				
				# Show explanation (robust to missing key)
				f.write('**Issue Description:**\n')
				explanation_text = issue.get('explanation', 'No detailed explanation available for this issue.')
				f.write(f'{explanation_text}\n\n')
				
				# Show context if available
				if context and len(context) > 1:
					f.write('**Code Context:**\n')
					f.write('```\n')
					for i, context_line in enumerate(context):
						context_line_num = line_num - len(context) + i + 1
						marker = '>>> ' if context_line_num == line_num else '    '
						f.write(f'{marker}{context_line_num:4d}| {context_line}\n')
					f.write('```\n\n')
				
				# Show side-by-side comparison
				f.write('**Code Comparison:**\n\n')
				f.write('<table>\n')
				f.write('<tr>\n')
				f.write('<th style="width: 50%; background-color: #ffebee; padding: 10px; border: 1px solid #ccc;"> Vulnerable Code</th>\n')
				f.write('<th style="width: 50%; background-color: #e8f5e8; padding: 10px; border: 1px solid #ccc;"> Secure Solution</th>\n')
				f.write('</tr>\n')
				f.write('<tr>\n')
				
				# Left column - Vulnerable code
				f.write('<td style="padding: 10px; border: 1px solid #ccc; vertical-align: top;">\n')
				f.write('<pre style="background-color: #fff5f5; padding: 10px; border-radius: 5px; margin: 0; overflow-x: auto;">\n')
				if vulnerable_code:
					f.write(f'{line_num:4d}| {vulnerable_code}\n')
				f.write('</pre>\n')
				f.write('</td>\n')
				
				# Right column - Secure solution
				f.write('<td style="padding: 10px; border: 1px solid #ccc; vertical-align: top;">\n')
				f.write('<pre style="background-color: #f0fff0; padding: 10px; border-radius: 5px; margin: 0; overflow-x: auto;">\n')
				
				# Extract the secure code from the suggestion (robust to missing key)
				suggestion_text = issue.get("suggestion", "")
				secure_code = _extract_secure_code(suggestion_text, line_num)
				f.write(secure_code)
				f.write('</pre>\n')
				f.write('</td>\n')
				
				f.write('</tr>\n')
				f.write('</table>\n\n')
				
				# Show detailed fix suggestion (robust to missing key)
				f.write('**Detailed Fix:**\n')
				f.write('```\n')
				f.write(suggestion_text if suggestion_text else 'No specific fix suggestion available.')
				f.write('\n```\n\n')
				
				f.write('---\n\n')
		
		# Recommendations
		f.write('## Security Recommendations\n\n')
		
		# Priority-based recommendations
		if severity_counts.get('critical', 0) > 0:
			f.write('###  Critical Priority\n\n')
			f.write('1. **Immediate Action Required**: Address all Critical severity issues immediately\n')
			f.write('2. **Emergency Response**: Consider temporary workarounds or disabling affected features\n')
			f.write('3. **Security Review**: Conduct thorough security review of affected components\n\n')
		
		if severity_counts.get('high', 0) > 0:
			f.write('###  High Priority\n\n')
			f.write('1. **Urgent Fixes**: Address High severity issues within 48 hours\n')
			f.write('2. **Code Review**: Implement mandatory code review for security-sensitive changes\n')
			f.write('3. **Testing**: Add comprehensive security testing for affected areas\n\n')
		
		if severity_counts.get('medium', 0) > 0:
			f.write('###  Medium Priority\n\n')
			f.write('1. **Scheduled Fixes**: Address Medium severity issues within 1 week\n')
			f.write('2. **Process Improvement**: Update development processes to prevent similar issues\n')
			f.write('3. **Training**: Provide security training for development team\n\n')
		
		# General recommendations
		f.write('### General Security Improvements\n\n')
		f.write('1. **Security-First Development**: Integrate security considerations into the development lifecycle\n')
		f.write('2. **Automated Security Testing**: Implement SAST, DAST, and dependency scanning in CI/CD\n')
		f.write('3. **Security Monitoring**: Deploy runtime application security monitoring (RASM)\n')
		f.write('4. **Regular Assessments**: Schedule regular security assessments and penetration testing\n')
		f.write('5. **Security Training**: Provide ongoing security training for all development staff\n')
		f.write('6. **Incident Response**: Develop and test incident response procedures\n')
		f.write('7. **Secure Coding Standards**: Establish and enforce secure coding standards\n')
		f.write('8. **Dependency Management**: Implement automated dependency vulnerability scanning\n\n')
		
		# Next steps
		f.write('## Next Steps\n\n')
		f.write('1. **Prioritize Fixes**: Address issues in order of severity and business impact\n')
		f.write('2. **Test Thoroughly**: Test all fixes in a secure environment before deployment\n')
		f.write('3. **Re-scan**: Re-scan the codebase after implementing fixes\n')
		f.write('4. **Monitor**: Implement continuous security monitoring\n')
		f.write('5. **Document**: Document security improvements and lessons learned\n')
		f.write('6. **Review Policies**: Update security policies and procedures based on findings\n')
		f.write('7. **Schedule Regular Scans**: Establish regular security scanning schedule\n\n')
		
		# Footer
		f.write('---\n\n')
		f.write('*This report was generated by the Agentic Code Security Auto-Fixer tool.*\n')
		f.write('*For questions or support, please contact your security team.*\n')
	
	return True

def _get_language_from_file(file_path):
	"""Get language from file extension"""
	ext = os.path.splitext(file_path)[1].lower()
	language_map = {
		'.py': 'python',
		'.js': 'javascript',
		'.ts': 'typescript',
		'.java': 'java',
		'.php': 'php',
		'.rb': 'ruby',
		'.go': 'go',
		'.rs': 'rust',
		'.c': 'c',
		'.cpp': 'cpp',
		'.h': 'c',
		'.hpp': 'cpp'
	}
	return language_map.get(ext, 'text')

def generate_enhanced(report_path, explanations, findings, file_status):
	"""Generate enhanced security report with exact solutions"""
	print(f"[reporter] Generating enhanced report at {report_path}")
	
	# Create reports directory if it doesn't exist
	os.makedirs(os.path.dirname(report_path), exist_ok=True)
	
	with open(report_path, 'w', encoding='utf-8') as f:
		# Header
		f.write("#  Enhanced Security Analysis Report\n\n")
		f.write(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
		
		# Executive Summary
		f.write("##  Executive Summary\n\n")
		f.write(f"- **Total Issues Found:** {len(findings)}\n")
		f.write(f"- **Files Scanned:** {len(file_status)}\n")
		f.write(f"- **Files with Issues:** {len([f for f in file_status if f['status'] == 'issue'])}\n")
		f.write(f"- **Clean Files:** {len([f for f in file_status if f['status'] == 'clean'])}\n\n")
		
		# Severity Breakdown
		severity_counts = {}
		for finding in findings:
			severity = finding.get('severity', 'unknown')
			severity_counts[severity] = severity_counts.get(severity, 0) + 1
		
		f.write("###  Severity Breakdown\n\n")
		for severity, count in sorted(severity_counts.items(), key=lambda x: ['critical', 'high', 'medium', 'low'].index(x[0]) if x[0] in ['critical', 'high', 'medium', 'low'] else 999):
			emoji = _get_severity_emoji(severity)
			f.write(f"- {emoji} **{severity.title()}:** {count} issues\n")
		f.write("\n")
		
		# Vulnerability Categories
		category_counts = {}
		for finding in findings:
			category = finding.get('vulnerability_category', 'Unknown')
			category_counts[category] = category_counts.get(category, 0) + 1
		
		f.write("###  Vulnerability Categories\n\n")
		for category, count in sorted(category_counts.items(), key=lambda x: x[1], reverse=True):
			f.write(f"- **{category}:** {count} issues\n")
		f.write("\n")
		
		# Detailed Findings
		f.write("##  Detailed Security Findings\n\n")
		
		for i, finding in enumerate(findings, 1):
			severity = finding.get('severity', 'unknown')
			emoji = _get_severity_emoji(severity)
			
			f.write(f"### {i}. {emoji} {finding.get('description', 'Security Issue')}\n\n")
			
			# Basic Information
			f.write("** Basic Information:**\n")
			f.write(f"- **File:** `{finding['file']}`\n")
			f.write(f"- **Line:** {finding['line']}\n")
			f.write(f"- **Severity:** {severity.title()}\n")
			f.write(f"- **CWE:** {finding.get('cwe', 'N/A')}\n")
			f.write(f"- **OWASP:** {finding.get('owasp', 'N/A')}\n")
			f.write(f"- **Category:** {finding.get('vulnerability_category', 'N/A')}\n")
			f.write(f"- **Risk Level:** {finding.get('risk_level', 'N/A')}\n")
			f.write(f"- **Priority:** {finding.get('remediation_priority', 'N/A')}\n\n")
			
			# Exact Code
			f.write("** Exact Vulnerable Code:**\n")
			f.write(f"```{_get_language_from_file(finding['file'])}\n")
			f.write(f"{finding['code']}\n")
			f.write("```\n\n")
			
			# Exact Match
			if 'exact_match' in finding:
				f.write("** Exact Match:**\n")
				f.write(f"```{_get_language_from_file(finding['file'])}\n")
				f.write(f"{finding['exact_match']}\n")
				f.write("```\n\n")
			
			# Context
			f.write("** Code Context:**\n")
			f.write(f"```{_get_language_from_file(finding['file'])}\n")
			for j, context_line in enumerate(finding.get('context', []), 1):
				line_num = finding['line'] - len(finding.get('context', [])) + j
				marker = ">>> " if line_num == finding['line'] else "    "
				f.write(f"{marker}{line_num:4d}: {context_line}\n")
			f.write("```\n\n")
			
			# Exact Solution
			if 'exact_solution' in finding:
				f.write("** Exact Solution:**\n")
				f.write(f"```{_get_language_from_file(finding['file'])}\n")
				f.write(f"{finding['exact_solution']}\n")
				f.write("```\n\n")
			
			f.write("---\n\n")
		
		# File Status Summary
		f.write("##  File Status Summary\n\n")
		f.write("| File | Status | Language | Issues |\n")
		f.write("|------|--------|----------|--------|\n")
		
		for file_info in file_status:
			file_issues = [f for f in findings if f['file'] == file_info['file']]
			status_emoji = "" if file_info['status'] == 'issue' else ""
			f.write(f"| `{file_info['file']}` | {status_emoji} {file_info['status'].title()} | {file_info['language']} | {len(file_issues)} |\n")
		
		f.write("\n")
		
		# Recommendations
		f.write("##  Security Recommendations\n\n")
		f.write("### High Priority Actions:\n")
		f.write("1. **Address Critical and High Severity Issues First**\n")
		f.write("2. **Implement Input Validation** for all user inputs\n")
		f.write("3. **Use Parameterized Queries** for database operations\n")
		f.write("4. **Sanitize Output** to prevent XSS attacks\n")
		f.write("5. **Implement Proper Authentication** and authorization\n\n")
		
		f.write("### General Security Best Practices:\n")
		f.write("- Regular security code reviews\n")
		f.write("- Automated security testing in CI/CD pipeline\n")
		f.write("- Keep dependencies updated\n")
		f.write("- Use security headers and HTTPS\n")
		f.write("- Implement proper error handling\n")
		f.write("- Follow the principle of least privilege\n\n")
		
		# Footer
		f.write("---\n")
		f.write("*Report generated by Code Security Auto-Fixer*\n")
		f.write(f"*Scan completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*\n")
	
	return True
````

## File: agentic_fixer/code_security_auto_fixer/security_policies.py
````python
# Security Policies Configuration
# Centralized security policy definitions for vulnerability detection

# CWE (Common Weakness Enumeration) mappings
CWE_MAPPINGS = {
    'sql-injection': {'cwe': 'CWE-89', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'nosql-injection': {'cwe': 'CWE-943', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'command-injection': {'cwe': 'CWE-78', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'ldap-injection': {'cwe': 'CWE-90', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'xss': {'cwe': 'CWE-79', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'path-traversal': {'cwe': 'CWE-22', 'owasp': 'A01:2021 - Broken Access Control', 'severity': 'high'},
    'weak-crypto': {'cwe': 'CWE-327', 'owasp': 'A02:2021 - Cryptographic Failures', 'severity': 'medium'},
    'insecure-randomness': {'cwe': 'CWE-330', 'owasp': 'A02:2021 - Cryptographic Failures', 'severity': 'medium'},
    'tls-issues': {'cwe': 'CWE-295', 'owasp': 'A02:2021 - Cryptographic Failures', 'severity': 'high'},
    'hardcoded-secret': {'cwe': 'CWE-798', 'owasp': 'A07:2021 - Identification and Authentication Failures', 'severity': 'high'},
    'code-injection': {'cwe': 'CWE-94', 'owasp': 'A03:2021 - Injection', 'severity': 'critical'},
    'buffer-overflow': {'cwe': 'CWE-120', 'owasp': 'A06:2021 - Vulnerable and Outdated Components', 'severity': 'high'},
    'memory-leak': {'cwe': 'CWE-401', 'owasp': 'A06:2021 - Vulnerable and Outdated Components', 'severity': 'medium'},
    'unsafe-code': {'cwe': 'CWE-119', 'owasp': 'A06:2021 - Vulnerable and Outdated Components', 'severity': 'medium'},
    'banned-api': {'cwe': 'CWE-676', 'owasp': 'A06:2021 - Vulnerable and Outdated Components', 'severity': 'medium'},
    'insecure-deserialization': {'cwe': 'CWE-502', 'owasp': 'A08:2021 - Software and Data Integrity Failures', 'severity': 'high'},
    'ssrf': {'cwe': 'CWE-918', 'owasp': 'A10:2021 - Server-Side Request Forgery', 'severity': 'high'},
    'xxe': {'cwe': 'CWE-611', 'owasp': 'A05:2021 - Security Misconfiguration', 'severity': 'high'},
    'race-condition': {'cwe': 'CWE-362', 'owasp': 'A04:2021 - Insecure Design', 'severity': 'medium'},
    'privilege-escalation': {'cwe': 'CWE-269', 'owasp': 'A01:2021 - Broken Access Control', 'severity': 'high'},
    'insecure-storage': {'cwe': 'CWE-312', 'owasp': 'A02:2021 - Cryptographic Failures', 'severity': 'high'},
    'improper-input-validation': {'cwe': 'CWE-20', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'missing-output-encoding': {'cwe': 'CWE-116', 'owasp': 'A03:2021 - Injection', 'severity': 'high'},
    'information-exposure': {'cwe': 'CWE-200', 'owasp': 'A01:2021 - Broken Access Control', 'severity': 'medium'},
    'unsafe-json-parsing': {'cwe': 'CWE-829', 'owasp': 'A03:2021 - Injection', 'severity': 'high'}
}

# Banned APIs and insecure patterns by language
BANNED_APIS = {
    'python': [
        'eval', 'exec', 'compile', '__import__', 'getattr', 'setattr', 'delattr',
        'hasattr', 'globals', 'locals', 'vars', 'dir', 'open', 'file', 'input',
        'raw_input', 'os.system', 'os.popen', 'os.exec*', 'subprocess.call',
        'subprocess.run', 'subprocess.Popen', 'pickle.loads', 'pickle.load',
        'marshal.loads', 'marshal.load', 'yaml.load', 'yaml.safe_load',
        'hashlib.md5', 'hashlib.sha1', 'random.random', 'random.randint',
        'ssl.wrap_socket', 'ssl.SSLContext', 'urllib.urlopen', 'urllib2.urlopen'
    ],
    'java': [
        'Runtime.exec', 'ProcessBuilder', 'Process.exec', 'System.exec',
        'Class.forName', 'ClassLoader.loadClass', 'Method.invoke',
        'Constructor.newInstance', 'ObjectInputStream.readObject',
        'XMLDecoder.readObject', 'XPath.evaluate', 'MessageDigest.getInstance',
        'Cipher.getInstance', 'SecureRandom.getInstance', 'SSLContext.getInstance',
        'TrustManager', 'HostnameVerifier', 'javax.net.ssl', 'java.security'
    ],
    'javascript': [
        'eval', 'Function', 'setTimeout', 'setInterval', 'document.write',
        'innerHTML', 'outerHTML', 'insertAdjacentHTML', 'execScript',
        'child_process.exec', 'child_process.spawn', 'child_process.fork',
        'fs.readFileSync', 'fs.writeFileSync', 'require', 'import',
        'Buffer.from', 'Buffer.alloc', 'crypto.createHash', 'crypto.randomBytes'
    ],
    'php': [
        'eval', 'exec', 'system', 'shell_exec', 'passthru', 'popen',
        'proc_open', 'file_get_contents', 'file_put_contents', 'fopen',
        'fwrite', 'fread', 'include', 'require', 'include_once', 'require_once',
        'create_function', 'call_user_func', 'call_user_func_array',
        'mysql_query', 'mysqli_query', 'PDO::query', 'md5', 'sha1'
    ],
    'c': [
        'strcpy', 'strcat', 'sprintf', 'gets', 'scanf', 'malloc', 'calloc',
        'realloc', 'free', 'memcpy', 'memmove', 'strncpy', 'strncat',
        'snprintf', 'fgets', 'fscanf', 'vfprintf', 'vsprintf', 'vsnprintf'
    ],
    'cpp': [
        'strcpy', 'strcat', 'sprintf', 'gets', 'scanf', 'malloc', 'calloc',
        'realloc', 'free', 'memcpy', 'memmove', 'strncpy', 'strncat',
        'snprintf', 'fgets', 'fscanf', 'vfprintf', 'vsprintf', 'vsnprintf',
        'std::string::c_str', 'std::vector::data', 'std::array::data'
    ]
}

# Security pattern definitions by vulnerability type
SECURITY_PATTERNS = {
    'python': {
        'sql-injection': [
            (r'execute\s*\(\s*["\'].*%[sd].*["\']', 'sql-injection', 'high'),
            (r'execute\s*\(\s*f["\'].*\{.*\}.*["\']', 'sql-injection', 'high'),
            (r'execute\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'cursor\.execute\s*\(\s*["\'].*%[sd].*["\']', 'sql-injection', 'high'),
            (r'cursor\.execute\s*\(\s*f["\'].*\{.*\}.*["\']', 'sql-injection', 'high'),
            (r'query\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'query\s*\(\s*f["\'].*\{.*\}.*["\']', 'sql-injection', 'high'),
        ],
        'command-injection': [
            (r'os\.system\s*\(', 'command-injection', 'high'),
            (r'subprocess\.call\s*\([^)]*shell\s*=\s*True', 'command-injection', 'high'),
            (r'subprocess\.run\s*\([^)]*shell\s*=\s*True', 'command-injection', 'high'),
            (r'subprocess\.Popen\s*\([^)]*shell\s*=\s*True', 'command-injection', 'high'),
            (r'os\.popen\s*\(', 'command-injection', 'high'),
            (r'os\.execv\s*\(', 'command-injection', 'high'),
            (r'os\.execve\s*\(', 'command-injection', 'high'),
        ],
        'code-injection': [
            (r'eval\s*\(', 'code-injection', 'critical'),
            (r'exec\s*\(', 'code-injection', 'critical'),
            (r'compile\s*\(', 'code-injection', 'critical'),
            (r'__import__\s*\(', 'code-injection', 'critical'),
            (r'getattr\s*\([^)]*,\s*[^)]*\)', 'code-injection', 'high'),
            (r'setattr\s*\([^)]*,\s*[^)]*\)', 'code-injection', 'high'),
        ],
        'xss': [
            (r'innerHTML\s*=', 'xss', 'high'),
            (r'outerHTML\s*=', 'xss', 'high'),
            (r'insertAdjacentHTML\s*\(', 'xss', 'high'),
            (r'document\.write\s*\(', 'xss', 'high'),
            (r'print\s*\(\s*[^)]*\+.*\)', 'xss', 'medium'),
            (r'echo\s*\(\s*[^)]*\+.*\)', 'xss', 'medium'),
            (r'res\.send\s*\(\s*[^)]*\+.*\)', 'xss', 'high'),
            (r'res\.write\s*\(\s*[^)]*\+.*\)', 'xss', 'high'),
            (r'location\.search.*innerHTML\s*=', 'xss', 'high'),
            (r'location\.hash.*innerHTML\s*=', 'xss', 'high'),
            (r'location\.search.*document\.write\s*\(', 'xss', 'high'),
            (r'location\.hash.*document\.write\s*\(', 'xss', 'high'),
            (r'req\.query.*\+.*res\.send\s*\(', 'xss', 'high'),
            (r'req\.body.*\+.*res\.send\s*\(', 'xss', 'high'),
        ],
        'insecure-storage': [
            (r'fs\.writeFileSync\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'console\.log\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'logger\.info\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'logging\.info\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'print\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'medium'),
            (r'open\s*\(\s*[^)]*config\.properties.*\+', 'insecure-storage', 'high'),
        ],
        'improper-input-validation': [
            (r'JSON\.parse\s*\(\s*req\.body', 'improper-input-validation', 'high'),
            (r'json\.loads\s*\(\s*request\.body', 'improper-input-validation', 'high'),
            (r'req\.body\s*\[.*\]', 'improper-input-validation', 'medium'),
            (r'request\.body\s*\[.*\]', 'improper-input-validation', 'medium'),
        ],
        'missing-output-encoding': [
            (r'innerHTML\s*=\s*[^;]*\+.*;', 'missing-output-encoding', 'high'),
            (r'response\.getWriter\(\)\.print\s*\(\s*[^)]*\+', 'missing-output-encoding', 'high'),
            (r'res\.send\s*\(\s*[^)]*\+.*\)', 'missing-output-encoding', 'high'),
            (r'document\.write\s*\(\s*[^)]*\+', 'missing-output-encoding', 'high'),
        ],
        'information-exposure': [
            (r'#\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']', 'information-exposure', 'medium'),
            (r'//\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']', 'information-exposure', 'medium'),
            (r'/\*\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']\s*\*/', 'information-exposure', 'medium'),
        ],
        'unsafe-json-parsing': [
            (r'eval\s*\(\s*["\']\s*\(\s*\+.*json', 'unsafe-json-parsing', 'critical'),
            (r'eval\s*\(\s*["\']\s*\(\s*\+.*JSON', 'unsafe-json-parsing', 'critical'),
            (r'collection\.find\s*\(\s*JSON\.parse\s*\([^)]*req\.body', 'unsafe-json-parsing', 'high'),
            (r'\.find\s*\(\s*JSON\.parse\s*\([^)]*req\.body', 'unsafe-json-parsing', 'high'),
            (r'db\.find\s*\(\s*json\.loads\s*\([^)]*request\.body', 'unsafe-json-parsing', 'high'),
        ],
        'path-traversal': [
            (r'open\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'file\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'os\.path\.join\s*\([^)]*\+.*\)', 'path-traversal', 'high'),
            (r'os\.path\.abspath\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'os\.path\.realpath\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'\.\./', 'path-traversal', 'high'),
            (r'\.\.\\', 'path-traversal', 'high'),
        ],
        'weak-crypto': [
            (r'hashlib\.md5\s*\(', 'weak-crypto', 'medium'),
            (r'hashlib\.sha1\s*\(', 'weak-crypto', 'medium'),
            (r'DES\s*\(', 'weak-crypto', 'high'),
            (r'RC4\s*\(', 'weak-crypto', 'high'),
            (r'MD5\s*\(', 'weak-crypto', 'medium'),
            (r'SHA1\s*\(', 'weak-crypto', 'medium'),
        ],
        'hardcoded-secret': [
            (r'["\'](?:password|passwd|pwd|secret|key|token|api_key|apikey)\s*["\']\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'password\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'secret\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'api_key\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'token\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
        ],
        'insecure-randomness': [
            (r'random\.random\s*\(', 'insecure-randomness', 'medium'),
            (r'random\.randint\s*\(', 'insecure-randomness', 'medium'),
            (r'random\.choice\s*\(', 'insecure-randomness', 'medium'),
            (r'random\.uniform\s*\(', 'insecure-randomness', 'medium'),
            (r'random\.randrange\s*\(', 'insecure-randomness', 'medium'),
        ],
        'tls-issues': [
            (r'verify\s*=\s*False', 'tls-issues', 'high'),
            (r'requests\.(get|post|put|delete|patch)\s*\([^)]*verify\s*=\s*False', 'tls-issues', 'high'),
            (r'\.get\s*\([^)]*verify\s*=\s*False', 'tls-issues', 'high'),
            (r'\.post\s*\([^)]*verify\s*=\s*False', 'tls-issues', 'high'),
            (r'urllib3\.disable_warnings', 'tls-issues', 'medium'),
            (r'SSLContext\(\)', 'tls-issues', 'medium'),
            (r'ssl\._create_unverified_context\s*\(', 'tls-issues', 'high'),
        ],
        'banned-api': [
            # Dangerous deserialization APIs
            (r'pickle\.loads?\s*\(', 'banned-api', 'high'),
            (r'marshal\.loads?\s*\(', 'banned-api', 'high'),
            (r'yaml\.load\s*\(', 'banned-api', 'high'),
            (r'json\.loads?\s*\([^)]*\)', 'banned-api', 'medium'),
            
            # Dangerous input functions
            (r'input\s*\(', 'banned-api', 'medium'),
            (r'raw_input\s*\(', 'banned-api', 'medium'),
            
            # Dangerous code execution APIs
            (r'eval\s*\(', 'banned-api', 'critical'),
            (r'exec\s*\(', 'banned-api', 'critical'),
            (r'compile\s*\(', 'banned-api', 'critical'),
            (r'__import__\s*\(', 'banned-api', 'critical'),
            
            # Dangerous reflection APIs
            (r'getattr\s*\([^)]*,\s*[^)]*\)', 'banned-api', 'high'),
            (r'setattr\s*\([^)]*,\s*[^)]*\)', 'banned-api', 'high'),
            (r'delattr\s*\([^)]*,\s*[^)]*\)', 'banned-api', 'high'),
            (r'hasattr\s*\([^)]*,\s*[^)]*\)', 'banned-api', 'medium'),
            
            # Dangerous global access APIs
            (r'globals\s*\(', 'banned-api', 'high'),
            (r'locals\s*\(', 'banned-api', 'high'),
            (r'vars\s*\(', 'banned-api', 'medium'),
            (r'dir\s*\(', 'banned-api', 'low'),
            
            # Dangerous file operations
            (r'open\s*\([^)]*\)', 'banned-api', 'medium'),
            (r'file\s*\([^)]*\)', 'banned-api', 'medium'),
            
            # Dangerous subprocess APIs
            (r'os\.system\s*\(', 'banned-api', 'high'),
            (r'os\.popen\s*\(', 'banned-api', 'high'),
            (r'os\.execv\s*\(', 'banned-api', 'high'),
            (r'os\.execve\s*\(', 'banned-api', 'high'),
            (r'subprocess\.call\s*\([^)]*shell\s*=\s*True', 'banned-api', 'high'),
            (r'subprocess\.run\s*\([^)]*shell\s*=\s*True', 'banned-api', 'high'),
            (r'subprocess\.Popen\s*\([^)]*shell\s*=\s*True', 'banned-api', 'high'),
            
            # Weak cryptographic APIs
            (r'hashlib\.md5\s*\(', 'banned-api', 'medium'),
            (r'hashlib\.sha1\s*\(', 'banned-api', 'medium'),
            (r'random\.random\s*\(', 'banned-api', 'medium'),
            (r'random\.randint\s*\(', 'banned-api', 'medium'),
            
            # Deprecated SSL APIs
            (r'ssl\.wrap_socket\s*\(', 'banned-api', 'medium'),
            (r'urllib\.urlopen\s*\(', 'banned-api', 'medium'),
            (r'urllib2\.urlopen\s*\(', 'banned-api', 'medium'),
        ]
    },
    'javascript': {
        'sql-injection': [
            (r'query\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'execute\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'query\s*\(\s*`.*\$\{.*\}.*`', 'sql-injection', 'high'),
            (r'execute\s*\(\s*`.*\$\{.*\}.*`', 'sql-injection', 'high'),
            (r'connection\.query\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'db\.query\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
        ],
        'command-injection': [
            (r'child_process\.exec\s*\(', 'command-injection', 'high'),
            (r'child_process\.spawn\s*\(', 'command-injection', 'high'),
            (r'child_process\.fork\s*\(', 'command-injection', 'high'),
            (r'child_process\.execFile\s*\(', 'command-injection', 'high'),
            (r'require\s*\(\s*["\']child_process["\']', 'command-injection', 'medium'),
        ],
        'code-injection': [
            (r'eval\s*\(', 'code-injection', 'critical'),
            (r'Function\s*\(', 'code-injection', 'critical'),
            (r'setTimeout\s*\(\s*[^)]*\+.*\)', 'code-injection', 'high'),
            (r'setInterval\s*\(\s*[^)]*\+.*\)', 'code-injection', 'high'),
            (r'new Function\s*\(', 'code-injection', 'critical'),
        ],
        'xss': [
            (r'innerHTML\s*=', 'xss', 'high'),
            (r'outerHTML\s*=', 'xss', 'high'),
            (r'insertAdjacentHTML\s*\(', 'xss', 'high'),
            (r'document\.write\s*\(', 'xss', 'high'),
            (r'document\.writeln\s*\(', 'xss', 'high'),
            (r'\.html\s*\(', 'xss', 'high'),
            (r'res\.send\s*\(\s*[^)]*\+.*\)', 'xss', 'high'),
            (r'location\.search.*innerHTML\s*=', 'xss', 'high'),
            (r'location\.hash.*innerHTML\s*=', 'xss', 'high'),
            (r'location\.search.*document\.write\s*\(', 'xss', 'high'),
            (r'location\.hash.*document\.write\s*\(', 'xss', 'high'),
            (r'window\.location\.search.*innerHTML\s*=', 'xss', 'high'),
            (r'window\.location\.hash.*innerHTML\s*=', 'xss', 'high'),
        ],
        'nosql-injection': [
            (r'JSON\.parse\s*\(\s*req\.body.*\)\.find\s*\(', 'nosql-injection', 'high'),
            (r'collection\.find\s*\(\s*req\.body', 'nosql-injection', 'high'),
            (r'db\.collection\s*\([^)]+\)\.find\s*\(\s*req\.body', 'nosql-injection', 'high'),
            (r'db\.collection\s*\([^)]+\)\.find\s*\(\s*req\.query', 'nosql-injection', 'high'),
            (r'db\.collection\s*\([^)]+\)\.find\s*\(\s*JSON\.parse', 'nosql-injection', 'high'),
        ],
        'insecure-storage': [
            (r'fs\.writeFileSync\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'fs\.writeFile\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'console\.log\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'console\.error\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
        ],
        'improper-input-validation': [
            (r'JSON\.parse\s*\(\s*req\.body', 'improper-input-validation', 'high'),
            (r'JSON\.parse\s*\(\s*req\.query', 'improper-input-validation', 'high'),
            (r'req\.body\s*\[', 'improper-input-validation', 'medium'),
        ],
        'missing-output-encoding': [
            (r'innerHTML\s*=\s*[^;]*\+.*;', 'missing-output-encoding', 'high'),
            (r'res\.send\s*\(\s*[^)]*\+.*\)', 'missing-output-encoding', 'high'),
            (r'document\.write\s*\(\s*[^)]*\+', 'missing-output-encoding', 'high'),
        ],
        'information-exposure': [
            (r'//\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']', 'information-exposure', 'medium'),
            (r'/\*\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']\s*\*/', 'information-exposure', 'medium'),
        ],
        'unsafe-json-parsing': [
            (r'eval\s*\(\s*["\']\s*\(\s*\+.*json', 'unsafe-json-parsing', 'critical'),
            (r'eval\s*\(\s*["\']\s*\(\s*\+.*JSON', 'unsafe-json-parsing', 'critical'),
            (r'collection\.find\s*\(\s*JSON\.parse\s*\([^)]*req\.body', 'unsafe-json-parsing', 'high'),
            (r'db\.collection\s*\([^)]+\)\.find\s*\(\s*JSON\.parse', 'unsafe-json-parsing', 'high'),
        ],
        'path-traversal': [
            (r'fs\.readFile\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'fs\.writeFile\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'fs\.readFileSync\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'fs\.writeFileSync\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'path\.join\s*\([^)]*\+.*\)', 'path-traversal', 'high'),
            (r'\.\./', 'path-traversal', 'high'),
        ],
        'weak-crypto': [
            (r'crypto\.createHash\s*\(\s*["\']md5["\']', 'weak-crypto', 'medium'),
            (r'crypto\.createHash\s*\(\s*["\']sha1["\']', 'weak-crypto', 'medium'),
            (r'crypto\.createHash\s*\(\s*["\']md4["\']', 'weak-crypto', 'high'),
            (r'crypto\.createCipher\s*\(', 'weak-crypto', 'high'),
            (r'crypto\.createDecipher\s*\(', 'weak-crypto', 'high'),
        ],
        'hardcoded-secret': [
            (r'["\'](?:password|passwd|pwd|secret|key|token|api_key|apikey)\s*["\']\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'password\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'secret\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'apiKey\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'const\s+\w*[Ss]ecret\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
        ],
        'banned-api': [
            # Dangerous code execution APIs
            (r'eval\s*\(', 'banned-api', 'critical'),
            (r'Function\s*\(', 'banned-api', 'critical'),
            (r'setTimeout\s*\(\s*[^)]*\+.*\)', 'banned-api', 'high'),
            (r'setInterval\s*\(\s*[^)]*\+.*\)', 'banned-api', 'high'),
            (r'new Function\s*\(', 'banned-api', 'critical'),
            
            # Dangerous DOM manipulation APIs
            (r'innerHTML\s*=', 'banned-api', 'high'),
            (r'outerHTML\s*=', 'banned-api', 'high'),
            (r'insertAdjacentHTML\s*\(', 'banned-api', 'high'),
            (r'document\.write\s*\(', 'banned-api', 'high'),
            (r'document\.writeln\s*\(', 'banned-api', 'high'),
            
            # Dangerous subprocess APIs
            (r'child_process\.exec\s*\(', 'banned-api', 'high'),
            (r'child_process\.spawn\s*\(', 'banned-api', 'high'),
            (r'child_process\.fork\s*\(', 'banned-api', 'high'),
            (r'child_process\.execFile\s*\(', 'banned-api', 'high'),
            
            # Dangerous file system APIs
            (r'fs\.readFileSync\s*\(', 'banned-api', 'medium'),
            (r'fs\.writeFileSync\s*\(', 'banned-api', 'medium'),
            
            # Dangerous require/import APIs
            (r'require\s*\(\s*["\']child_process["\']', 'banned-api', 'medium'),
            (r'import\s*.*from\s*["\']child_process["\']', 'banned-api', 'medium'),
            
            # Weak cryptographic APIs
            (r'crypto\.createHash\s*\(\s*["\']md5["\']', 'banned-api', 'medium'),
            (r'crypto\.createHash\s*\(\s*["\']sha1["\']', 'banned-api', 'medium'),
            (r'crypto\.createHash\s*\(\s*["\']md4["\']', 'banned-api', 'high'),
            (r'crypto\.createCipher\s*\(', 'banned-api', 'high'),
            (r'crypto\.createDecipher\s*\(', 'banned-api', 'high'),
            
            # Dangerous Buffer APIs
            (r'Buffer\.from\s*\(', 'banned-api', 'medium'),
            (r'Buffer\.alloc\s*\(', 'banned-api', 'medium'),
        ]
    },
    'java': {
        'sql-injection': [
            (r'Statement\.executeQuery\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'Statement\.executeUpdate\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'Statement\.execute\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
            (r'createStatement\s*\(\)', 'sql-injection', 'medium'),
            (r'PreparedStatement\s*\(\s*["\'].*\+.*["\']', 'sql-injection', 'high'),
        ],
        'command-injection': [
            (r'Runtime\.getRuntime\(\)\.exec\s*\(', 'command-injection', 'high'),
            (r'ProcessBuilder\s*\(', 'command-injection', 'high'),
            (r'Process\.exec\s*\(', 'command-injection', 'high'),
            (r'System\.exec\s*\(', 'command-injection', 'high'),
        ],
        'code-injection': [
            (r'Class\.forName\s*\(', 'code-injection', 'high'),
            (r'ClassLoader\.loadClass\s*\(', 'code-injection', 'high'),
            (r'Method\.invoke\s*\(', 'code-injection', 'high'),
            (r'Constructor\.newInstance\s*\(', 'code-injection', 'high'),
        ],
        'xss': [
            (r'response\.getWriter\(\)\.print\s*\(', 'xss', 'high'),
            (r'response\.getWriter\(\)\.println\s*\(', 'xss', 'high'),
            (r'out\.print\s*\(', 'xss', 'high'),
            (r'out\.println\s*\(', 'xss', 'high'),
            (r'System\.out\.print\s*\(', 'xss', 'medium'),
            (r'response\.getWriter\(\)\.print\s*\(\s*[^)]*\+', 'xss', 'high'),
            (r'response\.getWriter\(\)\.println\s*\(\s*[^)]*\+', 'xss', 'high'),
        ],
        'insecure-storage': [
            (r'System\.out\.println\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'logger\.info\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'log\.info\s*\(\s*[^)]*(?:password|secret|token|key|credential)', 'insecure-storage', 'high'),
            (r'FileWriter\s*\(\s*[^)]*config.*\+', 'insecure-storage', 'high'),
        ],
        'improper-input-validation': [
            (r'request\.getParameter\s*\(', 'improper-input-validation', 'medium'),
            (r'req\.getParameter\s*\(', 'improper-input-validation', 'medium'),
        ],
        'missing-output-encoding': [
            (r'response\.getWriter\(\)\.print\s*\(\s*[^)]*\+', 'missing-output-encoding', 'high'),
            (r'response\.getWriter\(\)\.println\s*\(\s*[^)]*\+', 'missing-output-encoding', 'high'),
        ],
        'information-exposure': [
            (r'//\s*(?:password|secret|key|token|apikey|credential):\s*["\'][^"\']+["\']', 'information-exposure', 'medium'),
        ],
        'unsafe-json-parsing': [
            (r'new\s+Gson\s*\(\)\.fromJson\s*\(\s*request\.getBody', 'unsafe-json-parsing', 'high'),
            (r'ObjectMapper\s+.*\.readValue\s*\(\s*request\.getBody', 'unsafe-json-parsing', 'high'),
        ],
        'path-traversal': [
            (r'new File\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'FileInputStream\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'FileOutputStream\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'Paths\.get\s*\(\s*[^)]*\+.*\)', 'path-traversal', 'high'),
            (r'\.\./', 'path-traversal', 'high'),
        ],
        'weak-crypto': [
            (r'MessageDigest\.getInstance\s*\(\s*["\']MD5["\']', 'weak-crypto', 'medium'),
            (r'MessageDigest\.getInstance\s*\(\s*["\']SHA1["\']', 'weak-crypto', 'medium'),
            (r'MessageDigest\.getInstance\s*\(\s*["\']MD4["\']', 'weak-crypto', 'high'),
            (r'Cipher\.getInstance\s*\(\s*["\']DES["\']', 'weak-crypto', 'high'),
            (r'Cipher\.getInstance\s*\(\s*["\']RC4["\']', 'weak-crypto', 'high'),
        ],
        'hardcoded-secret': [
            (r'["\'](?:password|passwd|pwd|secret|key|token|apiKey|api_key)\s*["\']\s*:\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'password\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'secret\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
            (r'String\s+\w*[Ss]ecret\s*=\s*["\'][^"\']+["\']', 'hardcoded-secret', 'high'),
        ],
        'banned-api': [
            # Dangerous command execution APIs
            (r'Runtime\.getRuntime\(\)\.exec\s*\(', 'banned-api', 'high'),
            (r'ProcessBuilder\s*\(', 'banned-api', 'high'),
            (r'Process\.exec\s*\(', 'banned-api', 'high'),
            (r'System\.exec\s*\(', 'banned-api', 'high'),
            
            # Dangerous reflection APIs
            (r'Class\.forName\s*\(', 'banned-api', 'high'),
            (r'ClassLoader\.loadClass\s*\(', 'banned-api', 'high'),
            (r'Method\.invoke\s*\(', 'banned-api', 'high'),
            (r'Constructor\.newInstance\s*\(', 'banned-api', 'high'),
            
            # Dangerous deserialization APIs
            (r'ObjectInputStream\.readObject\s*\(', 'banned-api', 'high'),
            (r'XMLDecoder\.readObject\s*\(', 'banned-api', 'high'),
            (r'XPath\.evaluate\s*\(', 'banned-api', 'high'),
            
            # Weak cryptographic APIs
            (r'MessageDigest\.getInstance\s*\(\s*["\']MD5["\']', 'banned-api', 'medium'),
            (r'MessageDigest\.getInstance\s*\(\s*["\']SHA1["\']', 'banned-api', 'medium'),
            (r'MessageDigest\.getInstance\s*\(\s*["\']MD4["\']', 'banned-api', 'high'),
            (r'Cipher\.getInstance\s*\(\s*["\']DES["\']', 'banned-api', 'high'),
            (r'Cipher\.getInstance\s*\(\s*["\']RC4["\']', 'banned-api', 'high'),
            (r'SecureRandom\.getInstance\s*\(\s*["\']SHA1PRNG["\']', 'banned-api', 'medium'),
            
            # Dangerous SSL APIs
            (r'SSLContext\.getInstance\s*\(\s*["\']SSL["\']', 'banned-api', 'medium'),
            (r'TrustManager\s*', 'banned-api', 'medium'),
            (r'HostnameVerifier\s*', 'banned-api', 'medium'),
            (r'javax\.net\.ssl\s*', 'banned-api', 'medium'),
            (r'java\.security\s*', 'banned-api', 'medium'),
        ]
    },
    'c': {
        'buffer-overflow': [
            (r'strcpy\s*\(', 'buffer-overflow', 'high'),
            (r'strcat\s*\(', 'buffer-overflow', 'high'),
            (r'sprintf\s*\(', 'buffer-overflow', 'high'),
            (r'gets\s*\(', 'buffer-overflow', 'critical'),
            (r'scanf\s*\(', 'buffer-overflow', 'high'),
            (r'strcpy\s*\(\s*[^)]*,\s*[^)]*\+.*\)', 'buffer-overflow', 'high'),
            (r'strcat\s*\(\s*[^)]*,\s*[^)]*\+.*\)', 'buffer-overflow', 'high'),
        ],
        'banned-api': [
            (r'strcpy\s*\(', 'banned-api', 'high'),
            (r'strcat\s*\(', 'banned-api', 'high'),
            (r'sprintf\s*\(', 'banned-api', 'high'),
            (r'gets\s*\(', 'banned-api', 'critical'),
            (r'scanf\s*\(', 'banned-api', 'high'),
            (r'strncpy\s*\(', 'banned-api', 'medium'),
            (r'strncat\s*\(', 'banned-api', 'medium'),
        ],
        'command-injection': [
            (r'system\s*\(', 'command-injection', 'high'),
            (r'popen\s*\(', 'command-injection', 'high'),
        ],
        'code-injection': [
            (r'eval\s*\(', 'code-injection', 'critical'),
        ],
    },
    'cpp': {
        'buffer-overflow': [
            (r'strcpy\s*\(', 'buffer-overflow', 'high'),
            (r'strcat\s*\(', 'buffer-overflow', 'high'),
            (r'sprintf\s*\(', 'buffer-overflow', 'high'),
            (r'gets\s*\(', 'buffer-overflow', 'critical'),
            (r'scanf\s*\(', 'buffer-overflow', 'high'),
            (r'strcpy\s*\(\s*[^)]*,\s*[^)]*\+.*\)', 'buffer-overflow', 'high'),
            (r'strcat\s*\(\s*[^)]*,\s*[^)]*\+.*\)', 'buffer-overflow', 'high'),
        ],
        'banned-api': [
            (r'strcpy\s*\(', 'banned-api', 'high'),
            (r'strcat\s*\(', 'banned-api', 'high'),
            (r'sprintf\s*\(', 'banned-api', 'high'),
            (r'gets\s*\(', 'banned-api', 'critical'),
            (r'scanf\s*\(', 'banned-api', 'high'),
            (r'strncpy\s*\(', 'banned-api', 'medium'),
            (r'strncat\s*\(', 'banned-api', 'medium'),
        ],
        'command-injection': [
            (r'system\s*\(', 'command-injection', 'high'),
            (r'popen\s*\(', 'command-injection', 'high'),
        ],
        'code-injection': [
            (r'eval\s*\(', 'code-injection', 'critical'),
        ],
    }
}

# Severity scoring weights
SEVERITY_WEIGHTS = {
    'critical': 100,
    'high': 80,
    'medium': 60,
    'low': 40,
    'info': 20
}

# CWE priority weights (higher = more critical)
CWE_PRIORITY_WEIGHTS = {
    'CWE-89': 95,    # SQL Injection
    'CWE-78': 95,    # Command Injection
    'CWE-79': 90,    # XSS
    'CWE-22': 90,    # Path Traversal
    'CWE-94': 100,   # Code Injection
    'CWE-327': 70,   # Weak Crypto
    'CWE-330': 70,   # Insecure Randomness
    'CWE-295': 85,   # TLS Issues
    'CWE-798': 85,   # Hardcoded Secrets
    'CWE-120': 90,   # Buffer Overflow
    'CWE-401': 60,   # Memory Leak
    'CWE-119': 70,   # Unsafe Code
    'CWE-477': 60,   # Banned API
    'CWE-502': 85,   # Insecure Deserialization
    'CWE-918': 80,   # SSRF
    'CWE-611': 80,   # XXE
    'CWE-362': 50,   # Race Condition
    'CWE-269': 75,   # Privilege Escalation
    'CWE-90': 90,    # LDAP Injection
    'CWE-943': 90,   # NoSQL Injection
    'CWE-312': 85,   # Insecure Storage
    'CWE-20': 80,    # Improper Input Validation
    'CWE-116': 85,   # Missing Output Encoding
    'CWE-200': 70,   # Information Exposure
    'CWE-829': 90,   # Unsafe JSON Parsing
    'CWE-676': 70,   # Use of Banned Functions
}

# Security category mappings
SECURITY_CATEGORIES = {
    'CWE-89': 'Injection',
    'CWE-78': 'Injection',
    'CWE-79': 'Injection',
    'CWE-22': 'Access Control',
    'CWE-94': 'Injection',
    'CWE-327': 'Cryptography',
    'CWE-330': 'Cryptography',
    'CWE-295': 'Cryptography',
    'CWE-798': 'Authentication',
    'CWE-120': 'Memory Management',
    'CWE-401': 'Memory Management',
    'CWE-119': 'Memory Management',
    'CWE-477': 'API Misuse',
    'CWE-502': 'Data Integrity',
    'CWE-918': 'Network Security',
    'CWE-611': 'Configuration',
    'CWE-362': 'Concurrency',
    'CWE-269': 'Access Control',
    'CWE-90': 'Injection',
    'CWE-943': 'Injection',
    'CWE-312': 'Cryptographic Failures',
    'CWE-20': 'Injection',
    'CWE-116': 'Injection',
    'CWE-200': 'Access Control',
    'CWE-829': 'Injection',
    'CWE-676': 'API Misuse',
}

# CWE descriptions
CWE_DESCRIPTIONS = {
    'CWE-89': 'SQL Injection - Improper neutralization of special elements used in an SQL command',
    'CWE-78': 'Command Injection - Improper neutralization of special elements used in an OS command',
    'CWE-79': 'Cross-site Scripting - Improper neutralization of input during web page generation',
    'CWE-22': 'Path Traversal - Improper limitation of a pathname to a restricted directory',
    'CWE-94': 'Code Injection - Improper control of generation of code',
    'CWE-327': 'Use of a Broken or Risky Cryptographic Algorithm',
    'CWE-330': 'Use of Insufficiently Random Values',
    'CWE-295': 'Improper Certificate Validation',
    'CWE-798': 'Use of Hard-coded Credentials',
    'CWE-120': 'Buffer Copy without Checking Size of Input',
    'CWE-401': 'Missing Release of Memory after Effective Lifetime',
    'CWE-119': 'Improper Restriction of Operations within the Bounds of a Memory Buffer',
    'CWE-477': 'Use of Obsolete Function',
    'CWE-502': 'Deserialization of Untrusted Data',
    'CWE-918': 'Server-Side Request Forgery',
    'CWE-611': 'Improper Restriction of XML External Entity Reference',
    'CWE-362': 'Concurrent Execution using Shared Resource with Improper Synchronization',
    'CWE-269': 'Improper Privilege Management',
    'CWE-90': 'LDAP Injection - Improper neutralization of special elements used in an LDAP query',
    'CWE-943': 'NoSQL Injection - Improper neutralization of special elements used in a NoSQL command',
    'CWE-312': 'Cleartext Storage of Sensitive Information',
    'CWE-20': 'Improper Input Validation',
    'CWE-116': 'Improper Encoding or Escaping of Output',
    'CWE-200': 'Exposure of Sensitive Information to an Unauthorized Actor',
    'CWE-829': 'Inclusion of Functionality from Untrusted Control Sphere',
    'CWE-676': 'Use of Potentially Dangerous Function',
}

# Policy configuration functions
def get_cwe_mapping(issue_type):
    """Get CWE mapping for an issue type"""
    return CWE_MAPPINGS.get(issue_type, {'cwe': 'CWE-000', 'owasp': 'Unknown', 'severity': 'medium'})

def get_banned_apis(language):
    """Get banned APIs for a specific language"""
    return BANNED_APIS.get(language, [])

def get_security_patterns(language, vulnerability_type=None):
    """Get security patterns for a language and optionally specific vulnerability type"""
    if language not in SECURITY_PATTERNS:
        return []
    
    if vulnerability_type:
        return SECURITY_PATTERNS[language].get(vulnerability_type, [])
    else:
        # Return all patterns for the language
        all_patterns = []
        for patterns in SECURITY_PATTERNS[language].values():
            all_patterns.extend(patterns)
        return all_patterns

def get_severity_weight(severity):
    """Get severity weight for scoring"""
    return SEVERITY_WEIGHTS.get(severity, 60)

def get_cwe_priority(cwe):
    """Get CWE priority weight"""
    return CWE_PRIORITY_WEIGHTS.get(cwe, 50)

def get_security_category(cwe):
    """Get security category from CWE"""
    return SECURITY_CATEGORIES.get(cwe, 'General')

def get_cwe_description(cwe):
    """Get CWE description"""
    return CWE_DESCRIPTIONS.get(cwe, 'Security vulnerability detected')

def calculate_priority_score(severity, cwe):
    """Calculate combined priority score"""
    severity_score = get_severity_weight(severity)
    cwe_score = get_cwe_priority(cwe)
    return (severity_score * 0.6) + (cwe_score * 0.4)

def is_vulnerability_enabled(vulnerability_type):
    """Check if a vulnerability type is enabled for scanning"""
    return vulnerability_type in CWE_MAPPINGS

def get_all_vulnerability_types():
    """Get all supported vulnerability types"""
    return list(CWE_MAPPINGS.keys())

def get_supported_languages():
    """Get all supported languages"""
    return list(SECURITY_PATTERNS.keys())

def validate_policy():
    """Validate the security policy configuration"""
    errors = []
    
    # Check for missing CWE mappings
    for vuln_type in get_all_vulnerability_types():
        if vuln_type not in CWE_MAPPINGS:
            errors.append(f"Missing CWE mapping for {vuln_type}")
    
    # Check for missing patterns
    for language in get_supported_languages():
        if language not in SECURITY_PATTERNS:
            errors.append(f"Missing security patterns for {language}")
    
    return errors

# Export all policy data
POLICY_EXPORTS = {
    'CWE_MAPPINGS': CWE_MAPPINGS,
    'BANNED_APIS': BANNED_APIS,
    'SECURITY_PATTERNS': SECURITY_PATTERNS,
    'SEVERITY_WEIGHTS': SEVERITY_WEIGHTS,
    'CWE_PRIORITY_WEIGHTS': CWE_PRIORITY_WEIGHTS,
    'SECURITY_CATEGORIES': SECURITY_CATEGORIES,
    'CWE_DESCRIPTIONS': CWE_DESCRIPTIONS,
}
````

## File: agentic_fixer/code_security_auto_fixer/test_runner.py
````python
# Runs tests and checks for failures
def run(repo_path):
	print(f"[test_runner] Running tests in {repo_path}")
	return True
````

## File: agentic_fixer/static/css/style.css
````css
/* =====================================
   Agentic Code Security Auto-Fixer - LeetCode Style Dashboard
   ===================================== */

/* CSS Reset & Base Configuration */
*,
*::before,
*::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* CSS Custom Properties (Cyan Professional Robotic Design System) */
:root {
    /* Cyan Professional Robotic Color Palette */
    --color-bg-primary: #0a0f1a;
    --color-bg-secondary: #1a2332;
    --color-bg-tertiary: #263244;
    --color-bg-card: #2d3a4d;
    --color-bg-hover: #364556;
    
    /* Text Colors */
    --color-text-primary: #e6f7ff;
    --color-text-secondary: #b3e5fc;
    --color-text-muted: #81d4fa;
    --color-text-inverse: #0a0f1a;
    
    /* Accent Colors (Cyan Professional Robotic) */
    --color-easy: #00e5ff;
    --color-medium: #00bcd4;
    --color-hard: #0097a7;
    --color-primary: #00acc1;
    --color-success: #00e5ff;
    --color-warning: #00bcd4;
    --color-error: #ff5722;
    --color-info: #00bcd4;
    
    /* Gradients (Cyan Professional Robotic) */
    --gradient-primary: linear-gradient(135deg, var(--color-primary) 0%, #00e5ff 100%);
    --gradient-success: linear-gradient(135deg, var(--color-success) 0%, #00bcd4 100%);
    --gradient-warning: linear-gradient(135deg, var(--color-warning) 0%, #0097a7 100%);
    --gradient-error: linear-gradient(135deg, var(--color-error) 0%, #d32f2f 100%);
    --gradient-card: linear-gradient(135deg, var(--color-bg-card) 0%, #364556 100%);
    
    /* Typography */
    --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    --font-family-mono: 'Fira Code', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    
    /* Font Sizes */
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    --text-4xl: 2.25rem;
    --text-5xl: 3rem;
    
    /* Font Weights */
    --font-light: 300;
    --font-normal: 400;
    --font-medium: 500;
    --font-semibold: 600;
    --font-bold: 700;
    --font-extrabold: 800;
    
    /* Spacing Scale */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.25rem;
    --space-6: 1.5rem;
    --space-8: 2rem;
    --space-10: 2.5rem;
    --space-12: 3rem;
    --space-16: 4rem;
    --space-20: 5rem;
    
    /* Border Radius */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --radius-full: 9999px;
    
    /* Shadows (Cyan Professional Robotic) */
    --shadow-card: 0 4px 6px -1px rgba(0, 172, 193, 0.2), 0 2px 4px -1px rgba(0, 172, 193, 0.1);
    --shadow-hover: 0 10px 15px -3px rgba(0, 172, 193, 0.3), 0 4px 6px -2px rgba(0, 172, 193, 0.2);
    --shadow-focus: 0 0 0 3px rgba(0, 172, 193, 0.4);
    --shadow-glow: 0 0 20px rgba(0, 172, 193, 0.3);
    
    /* Borders (Cyan Professional Robotic) */
    --border-color: #4a5c6e;
    --border-hover: #5a6c7e;
    --border-focus: var(--color-primary);
    
    /* Transitions */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Z-Index Scale */
    --z-dropdown: 1000;
    --z-sticky: 1020;
    --z-fixed: 1030;
    --z-modal: 1040;
    --z-popover: 1050;
    --z-tooltip: 1060;
}

/* Light Theme (Cyan Professional Robotic) */
body.light-mode {
    --color-bg-primary: #f0f9ff;
    --color-bg-secondary: #e0f2fe;
    --color-bg-tertiary: #b3e5fc;
    --color-bg-card: #ffffff;
    --color-bg-hover: #e0f2fe;
    
    --color-text-primary: #0a0f1a;
    --color-text-secondary: #1a2332;
    --color-text-muted: #263244;
    --color-text-inverse: #ffffff;
    
    --border-color: #b3e5fc;
    --border-hover: #81d4fa;
    
    --shadow-card: 0 1px 3px 0 rgba(0, 172, 193, 0.1), 0 1px 2px 0 rgba(0, 172, 193, 0.06);
    --shadow-hover: 0 4px 6px -1px rgba(0, 172, 193, 0.1), 0 2px 4px -1px rgba(0, 172, 193, 0.06);
}

/* Base Styles */
html {
    scroll-behavior: smooth;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    font-family: var(--font-family-base);
    font-size: var(--text-base);
    font-weight: var(--font-normal);
    line-height: 1.6;
    color: var(--color-text-primary);
    background: var(--color-bg-primary);
    min-height: 100vh;
}

/* Focus Management */
*:focus {
    outline: none;
    box-shadow: var(--shadow-focus);
}

/* Selection (Cyan Professional Robotic) */
::selection {
    background-color: var(--color-primary);
    color: var(--color-text-inverse);
}

/* =====================================
   Layout Components
   ===================================== */

.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

/* =====================================
   Header Components
   ===================================== */

.header {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.compact-header {
    padding: var(--space-6);
}

.header-content {
    position: relative;
    z-index: 1;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

/* Logo */
.logo {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.logo-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-xl);
    box-shadow: var(--shadow-card);
    transition: all var(--transition-normal);
}

.logo-icon:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-hover);
}

.logo h1 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    letter-spacing: -0.025em;
}

/* Theme Toggle */
.theme-toggle {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-3);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
}

.theme-toggle:hover {
    background: var(--color-bg-hover);
    color: var(--color-primary);
    border-color: var(--border-hover);
}

.subtitle {
    text-align: left;
    color: var(--color-text-secondary);
    font-size: var(--text-base);
    margin-bottom: var(--space-6);
}

.header-stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    flex-wrap: wrap;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-normal);
}

.stat-item:hover {
    background: var(--color-bg-hover);
    border-color: var(--border-hover);
    transform: translateY(-1px);
}

.stat-icon-wrapper {
    width: 32px;
    height: 32px;
    background: var(--gradient-primary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-sm);
}

/* =====================================
   Main Content
   ===================================== */

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

/* =====================================
   Input Options Layout
   ===================================== */

/* Input Groups */
.input-group {
    margin-bottom: var(--space-6);
}

.input-group label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
}

.input-group label i {
    color: var(--color-primary);
    font-size: var(--text-base);
}

/* =====================================
   Form Validation States
   ===================================== */

.input-option.has-error {
    border-color: var(--color-error);
    background: rgba(255, 55, 95, 0.05);
}

.input-option.has-success {
    border-color: var(--color-success);
    background: rgba(0, 184, 163, 0.05);
}

.error-message {
    color: var(--color-error);
    font-size: var(--text-xs);
    margin-top: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.success-message {
    color: var(--color-success);
    font-size: var(--text-xs);
    margin-top: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.scan-form-container {
    display: flex;
    justify-content: center;
}

.form-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    transition: all var(--transition-normal);
}

.form-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity var(--transition-normal);
}

.form-header {
    text-align: center;
    margin-bottom: var(--space-8);
}

.form-header h2 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.form-header p {
    color: var(--color-text-secondary);
    font-size: var(--text-base);
}

.scan-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.input-wrapper {
    position: relative;
}

.input-group input {
    width: 100%;
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--text-base);
    transition: all var(--transition-normal);
}

.input-group input:focus {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
    box-shadow: var(--shadow-focus);
}

.input-group input::placeholder {
    color: var(--color-text-muted);
}

.input-help {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-1);
}

.input-help i {
    color: var(--color-info);
    font-size: var(--text-xs);
}

.input-help small {
    color: var(--color-text-muted);
    font-size: var(--text-xs);
}

.scan-button {
    background: var(--gradient-primary);
    color: var(--color-text-inverse);
    border: none;
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.scan-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.scan-button:active {
    transform: translateY(0);
}

.scan-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.button-content {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.progress-section {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-8);
    position: relative;
    overflow: hidden;
}

.progress-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity var(--transition-normal);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

.progress-header h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.scan-id {
    background: var(--color-bg-tertiary);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.progress-bar-container {
    margin-bottom: var(--space-5);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: var(--radius-full);
    transition: width var(--transition-slow);
    position: relative;
    overflow: hidden;
}

.progress-text {
    text-align: right;
    font-weight: var(--font-semibold);
    color: var(--color-primary);
    font-size: var(--text-sm);
}

.results-section {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-8);
    position: relative;
    overflow: hidden;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.results-header h2,
.results-header h3 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin: 0;
}

.stat-card {
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

/* =====================================
   Form Validation States
   ===================================== */

.input-option.has-error {
    border-color: var(--color-error);
    background: rgba(255, 55, 95, 0.05);
}

.input-option.has-success {
    border-color: var(--color-success);
    background: rgba(0, 184, 163, 0.05);
}

.error-message {
    color: var(--color-error);
    font-size: var(--text-xs);
    margin-top: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.success-message {
    color: var(--color-success);
    font-size: var(--text-xs);
    margin-top: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.scan-form-container {
    display: flex;
    justify-content: center;
}

.form-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    width: 100%;
    max-width: 600px;
    position: relative;
}

.form-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.form-header {
    text-align: center;
    margin-bottom: var(--space-8);
}

.form-header h2 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.form-header p {
    color: var(--color-text-secondary);
    font-size: var(--text-base);
}

.scan-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

/* Input Groups */
.input-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.input-group label {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.input-wrapper {
    position: relative;
}

.input-group input {
    width: 100%;
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    color: var(--color-text-primary);
    font-size: var(--text-base);
    font-family: inherit;
    transition: all var(--transition-normal);
}

.input-group input:focus {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
    box-shadow: var(--shadow-focus);
}

.input-group input::placeholder {
    color: var(--color-text-muted);
}

.input-group select {
    width: 100%;
    padding: var(--space-4);
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    color: var(--color-text-primary);
    font-size: var(--text-base);
    font-family: inherit;
    transition: all var(--transition-normal);
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-4) center;
    padding-right: calc(var(--space-4) + 20px);
}

.input-group select:focus {
    border-color: var(--color-primary);
    background-color: var(--color-bg-secondary);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-4) center;
    box-shadow: var(--shadow-focus);
    outline: none;
}

.input-group select option {
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    padding: var(--space-2);
}

.input-help {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-1);
}

.input-help i {
    color: var(--color-info);
    font-size: var(--text-xs);
}

.input-help small {
    color: var(--color-text-muted);
    font-size: var(--text-xs);
}

/* Checkbox Components */
.checkbox-group {
    margin: var(--space-2) 0;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.checkbox-label:hover {
    background: var(--color-bg-hover);
    border-color: var(--border-hover);
}

.checkbox-label input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-sm);
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
    flex-shrink: 0;
    margin-top: var(--space-1);
}

.checkmark i {
    color: var(--color-text-inverse);
    font-size: 10px;
    opacity: 0;
    transform: scale(0);
    transition: all var(--transition-normal);
}

.checkbox-label input[type="checkbox"]:checked + .checkmark {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.checkbox-label input[type="checkbox"]:checked + .checkmark i {
    opacity: 1;
    transform: scale(1);
}

.checkbox-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    flex: 1;
}

.checkbox-text strong {
    color: var(--color-text-primary);
    font-weight: var(--font-semibold);
    font-size: var(--text-base);
}

.checkbox-text small {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: 1.4;
}

/* Button Components */
.scan-button {
    background: var(--gradient-primary);
    color: var(--color-text-inverse);
    border: none;
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    margin-top: var(--space-4);
    min-height: 52px;
    font-family: inherit;
    box-shadow: var(--shadow-card);
}

.scan-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.scan-button:active {
    transform: translateY(0);
}

.scan-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.button-content {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

/* Action Buttons */
.action-button {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    text-decoration: none;
    border: 1px solid var(--border-color);
}

.action-button.primary {
    background: var(--gradient-primary);
    color: var(--color-text-inverse);
    border-color: transparent;
}

.action-button.secondary {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
}

.action-button:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-card);
}

/* =====================================
   Progress Components
   ===================================== */

.progress-section {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    position: relative;
}

.progress-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-warning);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.progress-header h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.progress-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-warning);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-lg);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.scan-id {
    background: var(--color-bg-tertiary);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-family: var(--font-family-mono);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.progress-bar-container {
    margin-bottom: var(--space-5);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-2);
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: var(--radius-full);
    transition: width var(--transition-slow);
    width: 0%;
}

.progress-text {
    text-align: right;
    font-weight: var(--font-semibold);
    color: var(--color-primary);
    font-size: var(--text-sm);
}

.current-step {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    color: var(--color-text-secondary);
    font-size: var(--text-base);
}

.step-icon {
    width: 36px;
    height: 36px;
    background: var(--gradient-warning);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-base);
    flex-shrink: 0;
}

/* =====================================
   Results Components
   ===================================== */

.results-section {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.results-title {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.results-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-lg);
}

.results-header h2,
.results-header h3 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin: 0;
}

.results-actions {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

/* Toolbar */
.toolbar {
    position: sticky;
    top: var(--space-4);
    z-index: var(--z-sticky);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    box-shadow: var(--shadow-card);
    margin-bottom: var(--space-6);
}

.toolbar-left,
.toolbar-right {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.search-group,
.select-group {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--space-2) var(--space-3);
    transition: all var(--transition-normal);
}

.search-group:focus-within,
.select-group:focus-within {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
}

.search-group input,
.select-group select {
    background: transparent;
    border: none;
    outline: none;
    color: var(--color-text-primary);
    font-family: inherit;
    font-size: var(--text-sm);
}

.search-group input {
    min-width: 200px;
}

.search-group input::placeholder {
    color: var(--color-text-muted);
}

/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.switch input {
    display: none;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--color-bg-tertiary);
    transition: var(--transition-normal);
    border-radius: var(--radius-full);
    border: 1px solid var(--border-color);
}

.slider::before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    top: 3px;
    background: var(--color-text-primary);
    transition: var(--transition-normal);
    border-radius: var(--radius-full);
}

.switch input:checked + .slider {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.switch input:checked + .slider::before {
    transform: translateX(20px);
    background: var(--color-text-inverse);
}

.switch-label {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
}

/* =====================================
   Statistics Cards (LeetCode Style)
   ===================================== */

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.stat-card {
    background: transparent;
    border: none;
    border-radius: 0;
    padding: var(--space-4);
    transition: none;
    position: relative;
    overflow: visible;
}

.stat-card:hover {
    transform: none;
    box-shadow: none;
    border-color: transparent;
}

.stat-card::before {
    display: none;
}

.stat-card:nth-child(1)::before {
    display: none;
}

.stat-card:nth-child(2)::before {
    display: none;
}

.stat-card:nth-child(3)::before {
    display: none;
}

.stat-card:nth-child(4)::before {
    display: none;
}

.stat-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-2);
}

.stat-icon {
    display: none;
}

.stat-card:nth-child(1) .stat-icon {
    display: none;
}

.stat-card:nth-child(2) .stat-icon {
    display: none;
}

.stat-card:nth-child(3) .stat-icon {
    display: none;
}

.stat-card:nth-child(4) .stat-icon {
    display: none;
}

.stat-number {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    line-height: 1;
    margin-bottom: var(--space-1);
    text-shadow: 0 0 20px currentColor, 0 0 30px rgba(255, 255, 255, 0.1);
}

.stat-card:nth-child(1) .stat-number {
    color: #ffc107;
}

.stat-card:nth-child(2) .stat-number {
    background: var(--gradient-error);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-card:nth-child(3) .stat-number {
    color: #4caf50;
}

.stat-card:nth-child(4) .stat-number {
    color: var(--color-text-primary);
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* =====================================
   Chart Components (LeetCode Style)
   ===================================== */

.charts-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-6);
    margin: var(--space-8) 0;
}

.chart-container {
    background: var(--color-bg-secondary);
    border: none;
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    transition: none;
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
    width: 100%;
}

.chart-container:hover {
    transform: none;
    box-shadow: none;
    border-color: transparent;
}

.chart-container::before {
    display: none;
}

.chart-full-width {
    grid-column: 1 / -1;
}

.charts-side-by-side {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
}

/* Larger gap for Vulnerabilities panel charts */
.vulnerabilities-container .charts-side-by-side {
    gap: var(--space-8);
}

.charts-side-by-side .chart-container {
    margin: 0;
}

/* Larger container padding for Vulnerabilities panel charts */
.vulnerabilities-container .charts-side-by-side .chart-container {
    padding: var(--space-6);
    box-sizing: border-box;
    min-height: 0;
}

.charts-side-by-side .chart-wrapper {
    height: 350px;
}

/* Larger charts specifically for Vulnerabilities panel */
.vulnerabilities-container .charts-side-by-side .chart-wrapper {
    height: 220px;
}

.chart-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
}

.chart-icon {
    width: 40px;
    height: 40px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg);
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--color-text-inverse);
    font-size: var(--text-base);
}

.chart-header h4 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin: 0;
}

.chart-wrapper {
    position: relative;
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    min-height: 0;
}

/* Smaller charts specifically for Scanner panel */
#scannerPanel .chart-wrapper {
    height: 200px;
}

.chart-wrapper canvas {
    max-width: 100% !important;
    max-height: 100% !important;
    width: 100% !important;
    height: auto !important;
}

.chart-full-width .chart-wrapper {
    height: 120px;
}

/* =====================================
   Tab Components
   ===================================== */

.results-tabs {
    margin-top: var(--space-8);
}

.tab-buttons {
    display: flex;
    gap: 0;
    margin-bottom: var(--space-6);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-1);
    border: 1px solid var(--border-color);
}

.tab-button {
    padding: var(--space-3) var(--space-5);
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: var(--font-medium);
    color: var(--color-text-secondary);
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    flex: 1;
    justify-content: center;
}

.tab-button.active {
    background: var(--color-bg-card);
    color: var(--color-text-primary);
    box-shadow: var(--shadow-card);
}

.tab-button:hover:not(.active) {
    color: var(--color-text-primary);
    background: var(--color-bg-hover);
}

.tab-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

/* =====================================
   Issues Components
   ===================================== */

.issues-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
}

.issue-card {
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.issue-card:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-hover);
    border-color: var(--border-hover);
}

.issue-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px;
    background: var(--color-error);
    border-radius: var(--radius-xl) 0 0 var(--radius-xl);
}

.issue-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-5);
    gap: var(--space-4);
    flex-wrap: wrap;
}

.issue-file {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    flex-wrap: wrap;
}

.line-number {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    font-family: var(--font-family-mono);
}

.issue-type {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.issue-badge {
    background: var(--color-error);
    color: var(--color-text-inverse);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.severity-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.severity-critical {
    background: var(--color-hard);
    color: var(--color-text-inverse);
}

.severity-high {
    background: var(--color-warning);
    color: var(--color-text-inverse);
}

.severity-medium {
    background: var(--color-medium);
    color: var(--color-text-inverse);
}

.severity-low {
    background: var(--color-easy);
    color: var(--color-text-inverse);
}

.issue-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
}

.issue-description,
.issue-code,
.issue-solution,
.issue-context {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
}

.issue-description h4,
.issue-code h4,
.issue-solution h4,
.issue-context h4 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
}

.cwe-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-info);
}

/* Code Blocks */
.code-block {
    background: var(--color-bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin: var(--space-3) 0;
    overflow-x: auto;
    font-family: var(--font-family-mono);
}

.code-block pre {
    margin: 0;
    font-size: var(--text-sm);
    line-height: 1.6;
    color: var(--color-text-primary);
}

.exact-match {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-top: var(--space-3);
    font-size: var(--text-sm);
}

.exact-match code {
    background: var(--color-bg-tertiary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
}

.solution-text {
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

/* Code Examples */
.code-examples {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
    margin-top: var(--space-4);
}

.example-bad,
.example-good {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.example-bad::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 3px;
    background: var(--color-error);
}

.example-good::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 3px;
    background: var(--color-success);
}

.example-bad h5,
.example-good h5 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
}

.example-bad h5 {
    color: var(--color-error);
}

.example-good h5 {
    color: var(--color-success);
}

.example-bad pre,
.example-good pre {
    margin: 0;
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    line-height: 1.5;
    color: var(--color-text-primary);
    overflow-x: auto;
}

/* Context Lines */
.context-lines {
    background: var(--color-bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-3);
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    line-height: 1.6;
    overflow-x: auto;
}

.context-line {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-1) 0;
}

.context-line.highlight {
    background: rgba(255, 161, 22, 0.1);
    border-radius: var(--radius-sm);
    padding: var(--space-1) var(--space-2);
    margin: var(--space-1) calc(-1 * var(--space-2));
}

.line-num {
    color: var(--color-text-muted);
    font-weight: var(--font-medium);
    min-width: 40px;
    text-align: right;
    user-select: none;
}

.context-line code {
    color: var(--color-text-primary);
    background: none;
    padding: 0;
}

/* =====================================
   Code Comparison Components
   ===================================== */

.code-comparison {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin: var(--space-5) 0;
}

.code-comparison h4 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-5);
    color: var(--color-text-primary);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
}

.comparison-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.code-column {
    background: var(--color-bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 200px;
}

.code-column.vulnerable::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--color-error);
}

.code-column.secure::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--color-success);
}

.code-header {
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    font-weight: var(--font-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
}

.code-column.vulnerable .code-header {
    color: var(--color-error);
}

.code-column.secure .code-header {
    color: var(--color-success);
}

.code-content {
    flex: 1;
    padding: var(--space-4);
    overflow-x: auto;
}

.code-content pre {
    margin: 0;
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    line-height: 1.6;
    color: var(--color-text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Code Suggestions */
.code-suggestion {
    margin-top: var(--space-4);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-bg-primary);
    border: 1px solid var(--border-color);
}

.code-suggestion pre {
    margin: 0;
    padding: var(--space-5);
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    line-height: 1.6;
    color: var(--color-text-primary);
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* =====================================
   File Components
   ===================================== */

.files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-4);
}

.file-card {
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.file-card:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-card);
    border-color: var(--border-hover);
}

.file-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 3px;
    border-radius: var(--radius-lg) 0 0 var(--radius-lg);
}

.file-card.clean::before {
    background: var(--color-success);
}

.file-card.issue::before {
    background: var(--color-error);
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-lg);
    color: var(--color-text-inverse);
    flex-shrink: 0;
}

.file-card.clean .file-icon {
    background: var(--gradient-success);
}

.file-card.issue .file-icon {
    background: var(--gradient-error);
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
    word-break: break-word;
    font-size: var(--text-base);
}

.file-language {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    text-transform: capitalize;
}

.file-status {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    flex-shrink: 0;
}

.file-card.clean .file-status {
    color: var(--color-success);
}

.file-card.issue .file-status {
    color: var(--color-error);
}

/* =====================================
   No Issues State
   ===================================== */

.no-issues {
    text-align: center;
    padding: var(--space-20) var(--space-8);
    color: var(--color-text-secondary);
}

.no-issues i {
    font-size: var(--text-5xl);
    color: var(--color-success);
    margin-bottom: var(--space-6);
}

.no-issues h3 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-3);
    color: var(--color-text-primary);
    font-weight: var(--font-bold);
}

.no-issues p {
    font-size: var(--text-lg);
    line-height: 1.6;
}

/* =====================================
   Loading Indicators
   ===================================== */

.loading-message {
    text-align: center;
    padding: var(--space-20) var(--space-8);
    color: var(--color-text-secondary);
}

.loading-message i {
    font-size: var(--text-4xl);
    color: var(--color-primary);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.no-files {
    text-align: center;
    padding: var(--space-20) var(--space-8);
    color: var(--color-text-secondary);
}

.no-files i {
    font-size: var(--text-5xl);
    color: var(--color-text-muted);
    margin-bottom: var(--space-6);
}

/* =====================================
   Error Components
   ===================================== */

.error-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
}

.error-card {
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-2xl);
    padding: var(--space-16) var(--space-10);
    box-shadow: var(--shadow-card);
    text-align: center;
    max-width: 500px;
    width: 100%;
}

.error-icon {
    font-size: var(--text-5xl);
    color: var(--color-error);
    margin-bottom: var(--space-8);
}

.error-card h2 {
    font-size: var(--text-2xl);
    color: var(--color-text-primary);
    margin-bottom: var(--space-5);
    font-weight: var(--font-bold);
}

.error-message {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-10);
    line-height: 1.6;
}

.error-actions {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    flex-wrap: wrap;
}

/* Error Notifications */
.error-notification {
    position: fixed;
    top: var(--space-5);
    right: var(--space-5);
    z-index: var(--z-modal);
    animation: slideInRight 0.3s ease-out;
}

.error-notification > div {
    background: var(--color-error);
    color: var(--color-text-inverse);
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    box-shadow: var(--shadow-hover);
    max-width: 400px;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* =====================================
   Summary Components
   ===================================== */

.summary-info,
.summary-recommendations,
.summary-success {
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-5);
}

.summary-info h4,
.summary-recommendations h4,
.summary-success h4 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
}

.summary-details p {
    margin-bottom: var(--space-2);
    color: var(--color-text-secondary);
    line-height: 1.6;
}

.summary-details strong {
    color: var(--color-text-primary);
    font-weight: var(--font-semibold);
}

.summary-recommendations ul {
    list-style: none;
    padding: 0;
}

.summary-recommendations li {
    position: relative;
    padding-left: var(--space-6);
    margin-bottom: var(--space-2);
    color: var(--color-text-secondary);
    line-height: 1.6;
}

.summary-recommendations li::before {
    content: '';
    position: absolute;
    left: 0;
    color: var(--color-primary);
    font-weight: var(--font-bold);
}

.summary-success {
    border-left: 4px solid var(--color-success);
}

.summary-success h4 {
    color: var(--color-success);
}

/* =====================================
   Footer
   ===================================== */

.footer {
    text-align: center;
    padding: var(--space-8) 0;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-top: auto;
    border-top: 1px solid var(--border-color);
}

/* =====================================
   Utility Classes
   ===================================== */

.hidden {
    display: none !important;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* =====================================
   Responsive Design
   ===================================== */

@media (max-width: 768px) {
    .container {
        padding: var(--space-4);
        gap: var(--space-4);
    }
    
    .header {
        padding: var(--space-6);
    }
    
    .header-top {
        flex-direction: column;
        gap: var(--space-4);
        text-align: center;
    }
    
    .logo {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .header-stats {
        flex-direction: column;
        gap: var(--space-4);
        align-items: center;
    }
    
    .input-options {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .input-option {
        padding: var(--space-4);
    }
    
    .file-upload-area {
        padding: var(--space-6);
        min-height: 100px;
    }
    
    .upload-icon {
        font-size: var(--text-2xl);
    }
    
    .upload-text {
        font-size: var(--text-sm);
    }
    
    .upload-subtext {
        font-size: var(--text-xs);
    }
    
    .results-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-4);
    }
    
    .results-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .action-button {
        flex: 1;
        justify-content: center;
    }
    
    .summary-stats {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    
    .charts-section {
        grid-template-columns: 1fr;
        gap: var(--space-5);
    }
    
    .chart-full-width {
        grid-column: 1;
    }
    
    .charts-side-by-side {
        grid-template-columns: 1fr;
    }
    
    .charts-side-by-side .chart-wrapper {
        height: 280px;
    }
    
    /* Larger charts specifically for Vulnerabilities panel on mobile */
    .vulnerabilities-container .charts-side-by-side .chart-wrapper {
        height: 240px;
    }
    
    .chart-wrapper {
        height: 240px;
    }
    
    /* Smaller charts specifically for Scanner panel on mobile */
    #scannerPanel .chart-wrapper {
        height: 170px;
    }
    
    .tab-buttons {
        flex-wrap: wrap;
    }
    
    .files-grid {
        grid-template-columns: 1fr;
    }
    
    .issue-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-3);
    }
    
    .comparison-container {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .code-examples {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .toolbar {
        flex-direction: column;
        gap: var(--space-3);
        padding: var(--space-4);
    }
    
    .toolbar-left,
    .toolbar-right {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--space-2);
    }
    
    .search-group input {
        min-width: 160px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: var(--space-3);
    }
    
    .header {
        padding: var(--space-4);
    }
    
    .logo h1 {
        font-size: var(--text-xl);
    }
    
    .form-header h2 {
        font-size: var(--text-xl);
    }
    
    .summary-stats {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .stat-card {
        padding: var(--space-5);
    }
    
    .stat-number {
        font-size: var(--text-3xl);
    }
    
    .chart-wrapper {
        height: 200px;
    }
    
    .scan-button {
        padding: var(--space-3) var(--space-6);
        font-size: var(--text-base);
        min-height: 48px;
    }
    
    .input-group input {
        padding: var(--space-3);
    }
    
    .issue-card,
    .file-card {
        padding: var(--space-4);
    }
    
    .search-group input {
        min-width: 120px;
    }
    
    .toolbar-left,
    .toolbar-right {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-group,
    .select-group {
        width: 100%;
    }
}

/* =====================================
   Print Styles
   ===================================== */

@media print {
    * {
        background: white !important;
        color: black !important;
        box-shadow: none !important;
    }
    
    .theme-toggle,
    .toolbar,
    .action-button,
    .scan-button {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .header,
    .form-card,
    .progress-section,
    .results-section,
    .issue-card,
    .stat-card,
    .chart-container {
        border: 1px solid #ccc !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        break-inside: avoid;
    }
    
    .charts-section {
        display: none !important;
    }
}

/* =====================================
   Accessibility & Performance
   ===================================== */

@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

@media (prefers-contrast: high) {
    :root {
        --border-color: #ffffff;
        --color-text-secondary: #ffffff;
    }
    
    .input-group input:focus,
    .scan-button:focus,
    .action-button:focus,
    .tab-button:focus {
        outline: 3px solid currentColor;
        outline-offset: 2px;
    }
}

/* Performance optimizations */
.chart-wrapper,
.code-content,
.context-lines {
    contain: layout style;
}

.progress-icon {
    will-change: opacity;
}

.stat-card:hover,
.issue-card:hover,
.file-card:hover,
.chart-container:hover {
    will-change: transform;
}

/* =====================================
   File Upload Interface Styles
   ===================================== */

/* Scan Type Selector */
.scan-type-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
}

.type-option {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-6);
    background: var(--color-bg-card);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.type-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 0;
}

.type-option:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.type-option.active {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.type-option.active::before {
    opacity: 0.1;
}

.type-icon {
    position: relative;
    z-index: 1;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    transition: all 0.3s ease;
}

.type-option.active .type-icon {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    transform: scale(1.1);
}

.type-content {
    position: relative;
    z-index: 1;
    flex: 1;
}

.type-content h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
}

.type-content p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.4;
}

/* File Upload Wrapper */
.file-upload-wrapper {
    position: relative;
    width: 100%;
}

.file-upload-wrapper input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

.file-upload-display {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-6);
    background: var(--color-bg-card);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    transition: all 0.3s ease;
    min-height: 120px;
    position: relative;
    overflow: hidden;
}

.file-upload-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 0;
}

.file-upload-wrapper:hover .file-upload-display {
    border-color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.file-upload-wrapper:hover .file-upload-display::before {
    opacity: 0.05;
}

.file-upload-wrapper.dragover .file-upload-display {
    border-color: var(--color-success);
    background: var(--color-bg-hover);
    transform: scale(1.02);
}

.file-upload-wrapper.dragover .file-upload-display::before {
    opacity: 0.1;
}

.file-upload-icon {
    position: relative;
    z-index: 1;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-lg);
    color: var(--color-text-secondary);
    transition: all 0.3s ease;
    font-size: var(--text-2xl);
}

.file-upload-wrapper:hover .file-upload-icon {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    transform: scale(1.1);
}

.file-upload-text {
    position: relative;
    z-index: 1;
    flex: 1;
}

.file-upload-label {
    display: block;
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.file-upload-info {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.4;
}

/* File Selected State */
.file-upload-wrapper.has-file .file-upload-display {
    border-color: var(--color-success);
    background: var(--color-bg-hover);
}

.file-upload-wrapper.has-file .file-upload-icon {
    background: var(--color-success);
    color: var(--color-text-inverse);
}

.file-upload-wrapper.has-file .file-upload-label {
    color: var(--color-success);
}

/* File Name Display */
.file-name-display {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-primary);
}

.file-name-display .file-icon {
    color: var(--color-primary);
}

.file-name-display .file-size {
    color: var(--color-text-secondary);
    font-size: var(--text-xs);
}

/* Responsive Design for File Upload */
@media (max-width: 768px) {
    .scan-type-selector {
        grid-template-columns: 1fr;
        gap: var(--space-3);
    }
    
    .type-option {
        padding: var(--space-4);
    }
    
    .type-icon {
        width: 40px;
        height: 40px;
    }
    
    .file-upload-display {
        padding: var(--space-4);
        min-height: 100px;
    }
    
    .file-upload-icon {
        width: 48px;
        height: 48px;
        font-size: var(--text-xl);
    }
    
    .file-upload-label {
        font-size: var(--text-base);
    }
    
    .file-upload-info {
        font-size: var(--text-xs);
    }
}

/* Light Mode Adjustments (Cyan Professional Robotic) */
.light-mode .type-option {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .type-option:hover {
    border-color: var(--color-primary);
    background: #e0f2fe;
}

.light-mode .type-option.active {
    background: #b3e5fc;
}

.light-mode .type-icon {
    background: #e0f2fe;
    color: #00acc1;
}

.light-mode .type-option.active .type-icon {
    background: var(--color-primary);
    color: #ffffff;
}

.light-mode .file-upload-display {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .file-upload-wrapper:hover .file-upload-display {
    border-color: var(--color-primary);
    background: #e0f2fe;
}

.light-mode .file-upload-icon {
    background: #e0f2fe;
    color: #00acc1;
}

.light-mode .file-upload-wrapper:hover .file-upload-icon {
    background: var(--color-primary);
    color: #ffffff;
}

.light-mode .file-name-display {
    background: #e0f2fe;
    color: #0a0f1a;
}

/* =====================================
   Expandable Issue Display Styles
   ===================================== */

.issues-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.issue-item {
    background: var(--color-bg-card);
    border-radius: 12px;
    border: 1px solid var(--color-bg-tertiary);
    overflow: hidden;
    transition: all 0.3s ease;
}

.issue-item:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 20px rgba(0, 172, 193, 0.1);
}

.issue-summary {
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.issue-summary:hover {
    background: var(--color-bg-hover);
}

.issue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.issue-file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.issue-file-info i {
    color: var(--color-primary);
    font-size: 1.1rem;
}

.file-name {
    font-weight: 600;
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
}

.line-number {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-family: var(--font-family-mono);
}

.issue-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.severity-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.severity-critical {
    background: linear-gradient(135deg, #ff5722, #d32f2f);
    color: white;
}

.severity-high {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
}

.severity-medium {
    background: linear-gradient(135deg, #ffc107, #ff8f00);
    color: var(--color-text-inverse);
}

.severity-low {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
}

.cwe-badge {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-family: var(--font-family-mono);
}

.expand-icon {
    color: var(--color-text-muted);
    transition: transform 0.3s ease;
    font-size: 1rem;
}

/* Issue Info Grid for Expanded View */
.issue-info-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.severity-info {
    display: flex;
    justify-content: flex-start;
}

.issue-type-info {
    display: flex;
    justify-content: flex-start;
}

.vulnerability-name h4 {
    color: var(--color-text-primary);
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}

.vulnerability-description p {
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
}

.issue-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tag {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tag.category {
    background: linear-gradient(135deg, var(--color-primary), #00bcd4);
    color: white;
}

.tag.module {
    background: linear-gradient(135deg, var(--color-info), #0097a7);
    color: white;
}

.tag.timestamp {
    background: var(--color-bg-secondary);
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
}

/* Issue Details (Expandable) */
.issue-details {
    border-top: 1px solid var(--color-bg-tertiary);
    background: var(--color-bg-secondary);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.details-content {
    padding: 1.5rem;
}

.detail-section {
    margin-bottom: 2rem;
}

.detail-section:last-child {
    margin-bottom: 0;
}

.detail-section h5 {
    color: var(--color-text-primary);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-section h5 i {
    color: var(--color-primary);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-item label {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-item span {
    color: var(--color-text-primary);
    font-weight: 600;
    font-family: var(--font-family-mono);
}

/* Code Location Styles */
.code-location {
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    overflow: hidden;
}

.code-header {
    background: var(--color-bg-card);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--color-bg-tertiary);
}

.code-header span {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-family: var(--font-family-mono);
}

.code-block {
    padding: 1rem;
}

.code-block pre {
    margin: 0;
    background: transparent;
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
    font-size: 0.9rem;
    line-height: 1.5;
}

.exact-match {
    background: var(--color-bg-card);
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--color-bg-tertiary);
}

.exact-match strong {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    margin-right: 0.5rem;
}

.exact-match code {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: var(--font-family-mono);
    font-size: 0.85rem;
}

/* Context Lines */
.context-lines {
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    overflow: hidden;
}

.context-line {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--color-bg-secondary);
    transition: background 0.2s ease;
}

.context-line:last-child {
    border-bottom: none;
}

.context-line.highlight {
    background: var(--color-bg-card);
    border-left: 3px solid var(--color-primary);
}

.line-num {
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
    font-size: 0.8rem;
    min-width: 3rem;
    text-align: right;
    margin-right: 1rem;
}

.context-line code {
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
    font-size: 0.9rem;
    background: transparent;
}

/* Code Context Section */
.code-context-section {
    margin-top: 1.5rem;
}

.code-context-toggle {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-bg-secondary);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--color-text-primary);
    font-size: 0.9rem;
    font-weight: 500;
}

.code-context-toggle:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.code-context-toggle i:first-child {
    color: var(--color-primary);
    margin-right: 0.5rem;
}

.context-expand-icon {
    color: var(--color-text-muted);
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.code-context-content {
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    margin-top: 0.5rem;
    overflow: hidden;
    animation: slideDown 0.3s ease;
}

.code-context-header {
    background: var(--color-bg-card);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--color-bg-secondary);
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
}

.code-context-lines {
    max-height: 300px;
    overflow-y: auto;
}

.context-line {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--color-bg-secondary);
    transition: background 0.2s ease;
}

.context-line:last-child {
    border-bottom: none;
}

.context-line.issue-line {
    background: var(--color-bg-card);
    border-left: 3px solid var(--color-error);
}

.context-line .line-number {
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
    font-size: 0.8rem;
    min-width: 3rem;
    text-align: right;
    margin-right: 1rem;
}

.context-line code {
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
    font-size: 0.9rem;
    background: transparent;
    flex: 1;
}

/* Light Mode Adjustments for Code Context */
.light-mode .code-context-toggle {
    background: #f8f9fa;
    border-color: #b3e5fc;
    color: var(--color-text-inverse);
}

.light-mode .code-context-toggle:hover {
    background: #e0f2fe;
    border-color: var(--color-primary);
}

.light-mode .code-context-content {
    background: #f8f9fa;
}

.light-mode .code-context-header {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .context-line.issue-line {
    background: #ffffff;
    border-color: var(--color-error);
}

/* Solution Content */
.solution-content {
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    padding: 1.5rem;
}

.solution-text {
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.code-examples {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.example-bad,
.example-good {
    background: var(--color-bg-card);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid var(--color-bg-tertiary);
}

.example-bad h6,
.example-good h6 {
    color: var(--color-text-primary);
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.example-bad h6 i {
    color: var(--color-error);
}

.example-good h6 i {
    color: var(--color-success);
}

.example-bad pre,
.example-good pre {
    margin: 0;
    background: transparent;
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
    font-size: 0.85rem;
    line-height: 1.4;
}

/* Light Mode Adjustments for New Issue Display */
.light-mode .issue-item {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .issue-item:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 20px rgba(0, 172, 193, 0.15);
}

.light-mode .issue-summary:hover {
    background: #e0f2fe;
}

.light-mode .issue-details {
    background: #f8f9fa;
    border-color: #b3e5fc;
}

.light-mode .details-content {
    background: transparent;
}

.light-mode .code-location {
    background: #f8f9fa;
}

.light-mode .code-header {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .exact-match {
    background: #ffffff;
    border-color: #b3e5fc;
}

.light-mode .context-lines {
    background: #f8f9fa;
}

.light-mode .context-line.highlight {
    background: #ffffff;
    border-color: var(--color-primary);
}

.light-mode .solution-content {
    background: #f8f9fa;
}

.light-mode .example-bad,
.light-mode .example-good {
    background: #ffffff;
    border-color: #b3e5fc;
}

/* Mobile Responsive Adjustments for New Issue Display */
@media (max-width: 768px) {
    .issue-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .issue-meta {
        width: 100%;
        justify-content: space-between;
    }
    
    .detail-grid {
        grid-template-columns: 1fr;
    }
    
    .code-examples {
        grid-template-columns: 1fr;
    }
    
    .issue-summary {
        padding: 1rem;
    }
    
    .details-content {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .issue-tags {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .issue-summary {
        padding: 0.75rem;
    }
    
    .details-content {
        padding: 0.75rem;
    }
}

/* Auto-fix button styles */
.auto-fix-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    opacity: 0;
    animation: fadeInAutoFix 0.3s ease forwards;
}

.auto-fix-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.auto-fix-btn:active {
    transform: scale(0.95);
}

.auto-fix-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.auto-fix-btn.success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    animation: successPulse 0.6s ease;
}

.auto-fix-btn.error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    animation: errorShake 0.6s ease;
}

@keyframes fadeInAutoFix {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Code actions wrapper */
.code-actions {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
}

/* Code smell button styles */
.code-smell-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    opacity: 0;
    animation: fadeInAutoFix 0.3s ease forwards;
}

.code-smell-btn:hover {
    background: linear-gradient(135deg, #ee5a5a 0%, #dd4a5f 100%);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
}

.code-smell-btn:active {
    transform: scale(0.95);
}

.code-smell-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.code-smell-btn.success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    animation: successPulse 0.6s ease;
}

.code-smell-btn.error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    animation: errorShake 0.6s ease;
}

/* Editor button styles */
.editor-btn {
    background: linear-gradient(135deg, #00acc1 0%, #0097a7 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 172, 193, 0.3);
    opacity: 0;
    animation: fadeInAutoFix 0.3s ease forwards;
}

.editor-btn:hover {
    background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 172, 193, 0.4);
}

.editor-btn:active {
    transform: scale(0.95);
}

.editor-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Code smell modal */
.code-smell-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.code-smell-modal.show {
    opacity: 1;
}

.code-smell-modal .modal-content {
    background: #1e1e2e;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.code-smell-modal.show .modal-content {
    transform: scale(1);
}

.code-smell-modal .modal-header {
    padding: 20px;
    border-bottom: 1px solid #2d2d44;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-smell-modal .modal-header h3 {
    margin: 0;
    color: #f0f0f0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.code-smell-modal .close-modal {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.code-smell-modal .close-modal:hover {
    background: #2d2d44;
}

.code-smell-modal .modal-body {
    padding: 20px;
}

.code-smell-modal .file-info {
    background: #252538;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    color: #ccc;
    font-size: 14px;
}

.code-smell-modal .code-smell-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.code-smell-modal .code-smell-item {
    background: #252538;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #ff6b6b;
}

.code-smell-modal .smell-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.code-smell-modal .smell-header h4 {
    margin: 0;
    color: #fff;
    font-size: 16px;
}

.code-smell-modal .smell-severity {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.code-smell-modal .smell-severity.critical {
    background: #f44336;
    color: white;
}

.code-smell-modal .smell-severity.high {
    background: #ff9800;
    color: white;
}

.code-smell-modal .smell-severity.medium {
    background: #ffc107;
    color: #000;
}

.code-smell-modal .smell-severity.low {
    background: #4CAF50;
    color: white;
}

.code-smell-modal .smell-description {
    color: #ccc;
    margin: 0 0 10px 0;
    line-height: 1.5;
}

.code-smell-modal .smell-example {
    margin-top: 10px;
    padding: 10px;
    background: #1e1e2e;
    border-radius: 6px;
}

.code-smell-modal .smell-example strong {
    color: #fff;
    font-size: 12px;
}

.code-smell-modal .smell-example pre {
    margin: 8px 0 0 0;
    background: #0d1117;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
}

.code-smell-modal .smell-example code {
    color: #c9d1d9;
    font-size: 12px;
}

.code-smell-modal .no-code-smells {
    text-align: center;
    padding: 40px 20px;
}

.code-smell-modal .no-code-smells .success-icon {
    font-size: 64px;
    color: #4CAF50;
    margin-bottom: 20px;
}

.code-smell-modal .no-code-smells h4 {
    color: #fff;
    font-size: 20px;
    margin-bottom: 10px;
}

.code-smell-modal .no-code-smells p {
    color: #ccc;
    font-size: 14px;
}

@keyframes successPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@keyframes errorShake {
    0%, 100% {
        transform: translateX(0);
    }
    25% {
        transform: translateX(-5px);
    }
    75% {
        transform: translateX(5px);
    }
}

/* Auto-fix explanation tooltip */
.fix-explanation-tooltip {
    background: rgba(0, 0, 0, 0.95);
    border-radius: 12px;
    padding: 0;
    max-width: 400px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: tooltipSlideIn 0.3s ease;
}

.tooltip-content {
    padding: 20px;
    position: relative;
}

.tooltip-content h4 {
    color: #00d4aa;
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tooltip-content p {
    color: #e0e0e0;
    margin: 0;
    line-height: 1.5;
    font-size: 14px;
}

.close-tooltip {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #ccc;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.close-tooltip:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

@keyframes tooltipSlideIn {
    from {
        opacity: 0;
        transform: translateX(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}

/* Typing animation cursor */
.context-line code.typing {
    border-right: 2px solid #00d4aa;
    animation: typingCursor 1s infinite;
}

@keyframes typingCursor {
    0%, 50% {
        border-right-color: #00d4aa;
    }
    51%, 100% {
        border-right-color: transparent;
    }
}

/* Light mode adjustments for auto-fix */
.light-mode .auto-fix-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.light-mode .auto-fix-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.light-mode .fix-explanation-tooltip {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.light-mode .tooltip-content h4 {
    color: #2c3e50;
}

.light-mode .tooltip-content p {
    color: #34495e;
}

.light-mode .close-tooltip {
    background: rgba(0, 0, 0, 0.1);
    color: #666;
}

.light-mode .close-tooltip:hover {
    background: rgba(0, 0, 0, 0.2);
    color: #333;
}

/* Ensure context line can accommodate auto-fix button */
.context-line {
    position: relative;
    padding-right: 120px; /* Space for auto-fix button */
}

.context-line.issue-line {
    padding-right: 120px;
}

/* Mobile responsive adjustments for auto-fix */
@media (max-width: 768px) {
    .auto-fix-btn {
        position: static;
        transform: none;
        margin-top: 8px;
        align-self: flex-start;
        opacity: 1;
        animation: none;
    }
    
    .context-line {
        flex-direction: column;
        align-items: flex-start;
        padding-right: 0;
    }
    
    .context-line.issue-line {
        padding-right: 0;
    }
    
    .context-line code {
        margin-bottom: 8px;
    }
    
    .fix-explanation-tooltip {
        max-width: 90vw;
        left: 5vw !important;
        right: 5vw !important;
        top: 50% !important;
        transform: translateY(-50%);
    }
}

/* =====================================
   Main Tab Navigation
   ===================================== */

.main-tabs {
    display: flex;
    gap: var(--space-2);
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-2);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-6);
    position: sticky;
    top: var(--space-4);
    z-index: var(--z-sticky);
}

.main-tab-btn {
    flex: 1;
    padding: var(--space-4) var(--space-6);
    background: transparent;
    border: none;
    border-radius: var(--radius-lg);
    color: var(--color-text-secondary);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.main-tab-btn:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.main-tab-btn.active {
    background: var(--gradient-primary);
    color: var(--color-text-inverse);
    box-shadow: var(--shadow-card);
}

.main-tab-btn i {
    font-size: var(--text-lg);
}

/* =====================================
   Panel System
   ===================================== */

.panel {
    display: none;
}

.panel.hidden {
    display: none !important;
}

.panel.active {
    display: block !important;
}

/* =====================================
   Past Scans Styles
   ===================================== */

.past-scans-container {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.panel-header h2 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.scans-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.scan-item {
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    cursor: pointer;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.scan-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 3px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg) 0 0 var(--radius-lg);
}

.scan-item:hover {
    background: var(--color-bg-tertiary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
    border-color: var(--border-hover);
}

.scan-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.scan-item-header h3 {
    color: var(--color-text-primary);
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-2);
}

.scan-date {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.scan-item-info {
    margin-bottom: var(--space-4);
}

.scan-item-info .info-row {
    display: flex;
    gap: var(--space-6);
    flex-wrap: wrap;
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
}

.scan-item-info .info-row span {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.scan-item-stats {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    margin-top: var(--space-4);
}

.scan-item-actions {
    display: flex;
    gap: var(--space-3);
}

.btn-load {
    padding: var(--space-2) var(--space-5);
    background: var(--gradient-primary);
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-text-inverse);
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.btn-load:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
}

.btn-secondary {
    padding: var(--space-2) var(--space-5);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.btn-secondary:hover {
    background: var(--color-bg-hover);
    border-color: var(--border-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
}

.btn-primary {
    padding: var(--space-2) var(--space-4);
    background: #263244;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: #ffffff;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.btn-primary:hover {
    background: #1a2332;
    border-color: var(--border-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-card);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* =====================================
   Loading, Error, and Empty States
   ===================================== */

.loading-state,
.error-state,
.no-scans-state {
    text-align: center;
    padding: var(--space-16) var(--space-8);
}

.loading-state i,
.error-state i,
.no-scans-state i {
    font-size: var(--text-5xl);
    margin-bottom: var(--space-6);
}

.loading-state i {
    color: var(--color-primary);
    animation: spin 1s linear infinite;
}

.error-state i {
    color: var(--color-error);
}

.no-scans-state i {
    color: var(--color-text-muted);
}

.loading-state p,
.error-state p,
.no-scans-state p {
    color: var(--color-text-secondary);
    font-size: var(--text-lg);
    margin-top: var(--space-4);
}

.no-scans-state h3 {
    color: var(--color-text-primary);
    font-size: var(--text-2xl);
    margin-top: var(--space-4);
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@media (prefers-color-scheme: light) {
    .scan-item { background: var(--color-bg-secondary); border-color: var(--border-color); }
    .scan-item:hover { background: var(--color-bg-tertiary); }
    .btn-secondary { background: var(--color-bg-secondary); border-color: var(--border-color); color: var(--color-text-primary); }
}

/* =====================================
   Vulnerability Table Styling
   ===================================== */

.vulns-table-section {
    margin-top: var(--space-8);
}

.vulns-table-section .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.vulns-table-section .section-header h3 {
    color: var(--color-text-primary);
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.vulns-table-section .table-filters {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.vulns-table-section .table-filters select,
.vulns-table-section .table-filters input {
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
    transition: all var(--transition-normal);
}

.vulns-table-section .table-filters select:focus,
.vulns-table-section .table-filters input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: var(--shadow-focus);
}

.vulns-table-section .table-filters input {
    min-width: 250px;
}

.table-container {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-card);
}

#vulnsTable {
    width: 100%;
    border-collapse: collapse;
    background: var(--color-bg-card);
}

#vulnsTable thead {
    background: var(--color-bg-tertiary);
    border-bottom: 2px solid var(--border-color);
}

#vulnsTable thead th {
    padding: var(--space-4) var(--space-5);
    text-align: left;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 10;
}

#vulnsTable tbody tr.vuln-row {
    border-bottom: 1px solid var(--border-color);
    transition: all var(--transition-normal);
    background: var(--color-bg-card);
}

#vulnsTable tbody tr.vuln-row:hover {
    background: var(--color-bg-hover);
    transform: translateX(4px);
    box-shadow: -4px 0 0 0 var(--color-primary);
}

#vulnsTable tbody tr.vuln-row:last-child {
    border-bottom: none;
}

#vulnsTable tbody td {
    padding: var(--space-5) var(--space-5);
    vertical-align: middle;
}

/* Rank Cell */
.rank-cell {
    width: 80px;
    text-align: center;
}

.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--color-bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    font-weight: var(--font-bold);
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    transition: all var(--transition-normal);
}

.vuln-row:hover .rank-badge {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-text-inverse);
    transform: scale(1.1);
}

/* Type Cell */
.type-cell {
    min-width: 200px;
}

.type-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.type-icon {
    color: var(--color-primary);
    font-size: var(--text-lg);
    width: 24px;
    text-align: center;
}

.type-name {
    font-weight: var(--font-medium);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
    font-family: var(--font-family-mono);
}

/* Severity Cell */
.severity-cell {
    width: 120px;
}

.severity-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all var(--transition-normal);
}

.severity-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.severity-critical {
    background: linear-gradient(135deg, #ff5722 0%, #d32f2f 100%);
    color: #ffffff;
}

.severity-high {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: #ffffff;
}

.severity-medium {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    color: #ffffff;
}

.severity-low {
    background: linear-gradient(135deg, #00e5ff 0%, #00bcd4 100%);
    color: var(--color-text-inverse);
}

/* Category Cell */
.category-cell {
    min-width: 220px;
}

.category-tag {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    transition: all var(--transition-normal);
}

.vuln-row:hover .category-tag {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
    color: var(--color-text-primary);
}

/* Count Cell */
.count-cell {
    width: 100px;
    text-align: right;
}

.count-value {
    font-weight: var(--font-bold);
    font-size: var(--text-lg);
    color: var(--color-text-primary);
    font-family: var(--font-family-mono);
}

/* Percentage Cell */
.percentage-cell {
    width: 180px;
}

.percentage-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.percentage-value {
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    font-family: var(--font-family-mono);
}

.percentage-bar {
    width: 100%;
    height: 6px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
    position: relative;
}

.percentage-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.6s ease;
    position: relative;
    overflow: hidden;
}

.percentage-fill[data-severity="critical"] {
    background: linear-gradient(90deg, #ff5722 0%, #d32f2f 100%);
}

.percentage-fill[data-severity="high"] {
    background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
}

.percentage-fill[data-severity="medium"] {
    background: linear-gradient(90deg, #00bcd4 0%, #0097a7 100%);
}

.percentage-fill[data-severity="low"] {
    background: linear-gradient(90deg, #00e5ff 0%, #00bcd4 100%);
}

.percentage-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Light Mode Adjustments */
.light-mode #vulnsTable {
    background: #ffffff;
}

.light-mode #vulnsTable thead {
    background: #f5f7fa;
}

.light-mode #vulnsTable tbody tr.vuln-row {
    background: #ffffff;
}

.light-mode #vulnsTable tbody tr.vuln-row:hover {
    background: #f5f7fa;
}

.light-mode .rank-badge {
    background: #f5f7fa;
    border-color: #e0e0e0;
    color: #333;
}

.light-mode .category-tag {
    background: #f5f7fa;
    border-color: #e0e0e0;
    color: #666;
}

.light-mode .percentage-bar {
    background: #f5f7fa;
}

/* Responsive Design */
@media (max-width: 768px) {
    .vulns-table-section .section-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .vulns-table-section .table-filters {
        flex-direction: column;
    }
    
    .vulns-table-section .table-filters input {
        min-width: 100%;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    #vulnsTable {
        min-width: 800px;
    }
    
    #vulnsTable thead th,
    #vulnsTable tbody td {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-xs);
    }
}

/* =====================================
   Editor Panel Styles
   ===================================== */

.editor-container {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    min-height: calc(100vh - 300px);
}

.editor-controls {
    display: flex;
    gap: var(--space-4);
    align-items: center;
}

.select-input {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
    min-width: 250px;
}

.select-input:focus {
    outline: none;
    border-color: var(--border-hover);
    box-shadow: var(--shadow-focus);
}

.editor-content {
    margin-top: var(--space-6);
}

.editor-main {
    display: flex;
    gap: var(--space-6);
    margin-top: var(--space-6);
    height: calc(100vh - 400px);
    min-height: 600px;
}

.editor-sidebar {
    width: 300px;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    overflow-y: auto;
    border: 1px solid var(--border-color);
}

.editor-sidebar h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.files-tree {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.file-item {
    padding: var(--space-3);
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-normal);
    border: 1px solid transparent;
}

.file-item:hover {
    background: var(--color-bg-hover);
    border-color: var(--border-hover);
}

.file-item.active {
    background: var(--color-bg-hover);
    border-color: var(--gradient-primary);
}

.file-item .file-name {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
}

.issue-lines-info {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.issue-badge {
    margin-left: auto;
    padding: 2px var(--space-2);
    background: var(--color-error);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    white-space: nowrap;
}

.editor-workspace {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.editor-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--border-color);
}

.file-info {
    display: flex;
    gap: var(--space-4);
    align-items: center;
}

.file-path {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
}

.file-language {
    padding: 2px var(--space-2);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-transform: uppercase;
}

.editor-actions {
    display: flex;
    gap: var(--space-3);
}

.code-editor-container {
    flex: 1;
    overflow: hidden;
    position: relative;
    min-height: 400px;
}

.code-editor-container .CodeMirror {
    height: 100%;
    font-size: 14px;
}

/* Highlight for issue line in CodeMirror */
.code-editor-container .CodeMirror .issue-line-highlight {
    background-color: rgba(255, 87, 34, 0.2) !important;
    border-left: 3px solid var(--color-error);
}

.light-mode .code-editor-container .CodeMirror .issue-line-highlight {
    background-color: rgba(255, 87, 34, 0.15) !important;
}

/* Issue line widget (button) */
.issue-line-widget {
    display: inline-block;
    margin-left: 10px;
    vertical-align: middle;
}

.issue-widget-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
}

.issue-btn {
    background: linear-gradient(135deg, var(--color-error) 0%, #d32f2f 100%);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(255, 87, 34, 0.3);
    white-space: nowrap;
}

.issue-btn:hover {
    background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
    transform: scale(1.05);
    box-shadow: 0 3px 6px rgba(255, 87, 34, 0.4);
}

.issue-btn:active {
    transform: scale(0.95);
}

.issue-btn i {
    font-size: 10px;
}

.auto-fix-editor-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    white-space: nowrap;
}

.auto-fix-editor-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: scale(1.05);
    box-shadow: 0 3px 6px rgba(102, 126, 234, 0.4);
}

.auto-fix-editor-btn:active {
    transform: scale(0.95);
}

.auto-fix-editor-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.auto-fix-editor-btn i {
    font-size: 10px;
}

/* Issue Popup */
.issue-popup {
    position: fixed;
    background: var(--color-bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    min-width: 320px;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    animation: popupFadeIn 0.2s ease;
}

@keyframes popupFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.issue-popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-color);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.issue-popup-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
}

.issue-popup-title h4 {
    margin: 0;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
}

.issue-popup-close {
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.issue-popup-close:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.issue-popup-content {
    padding: var(--space-4);
}

.issue-popup-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-color);
}

.issue-popup-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.issue-popup-meta-item label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: var(--font-medium);
}

.issue-popup-meta-item span {
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    font-weight: var(--font-semibold);
}

.issue-popup-description {
    margin-top: var(--space-4);
}

.issue-popup-description h5 {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.issue-popup-description p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.issue-popup-reason {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
}

.issue-popup-reason h5 {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.issue-popup-reason h5::before {
    content: '';
    font-size: var(--text-base);
}

.issue-popup-reason p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    background: var(--color-bg-secondary);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-error);
}

/* Severity badges in popup */
.issue-popup .severity-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    white-space: nowrap;
}

.issue-popup .severity-badge.severity-critical {
    background: #d32f2f;
    color: white;
}

.issue-popup .severity-badge.severity-high {
    background: #f57c00;
    color: white;
}

.issue-popup .severity-badge.severity-medium {
    background: #fbc02d;
    color: #333;
}

.issue-popup .severity-badge.severity-low {
    background: #388e3c;
    color: white;
}

.light-mode .issue-popup {
    background: #ffffff;
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.light-mode .issue-popup-header {
    background: #f5f5f5;
}

/* Auto-Fix Modal */
.auto-fix-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.auto-fix-modal-content {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auto-fix-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-color);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.auto-fix-modal-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.auto-fix-modal-close {
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.auto-fix-modal-close:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.auto-fix-modal-body {
    padding: var(--space-5);
}

.auto-fix-loading {
    text-align: center;
    padding: var(--space-8);
}

.auto-fix-loading i {
    font-size: 48px;
    color: var(--color-primary);
    margin-bottom: var(--space-4);
}

.auto-fix-loading p {
    font-size: var(--text-base);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.auto-fix-loading-subtext {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
}

.auto-fix-error {
    padding: var(--space-4);
    background: rgba(255, 87, 34, 0.1);
    border-left: 3px solid var(--color-error);
    border-radius: var(--radius-md);
}

.auto-fix-error p {
    color: var(--color-error);
    margin: 0;
}

.auto-fix-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-color);
}

.auto-fix-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.auto-fix-info-item label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: var(--font-medium);
}

.auto-fix-info-item span {
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    font-weight: var(--font-semibold);
}

.auto-fix-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
    margin-bottom: var(--space-5);
}

.code-comparison-item {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    border: 1px solid var(--border-color);
}

.code-comparison-item h4 {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.code-comparison-item h4 i.fa-times-circle {
    color: var(--color-error);
}

.code-comparison-item h4 i.fa-check-circle {
    color: var(--color-success);
}

.code-comparison-item pre {
    margin: 0;
    padding: var(--space-3);
    background: var(--color-bg-primary);
    border-radius: var(--radius-md);
    overflow-x: auto;
}

.code-comparison-item code {
    font-family: var(--font-family-mono);
    font-size: var(--text-sm);
    line-height: 1.6;
}

.auto-fix-explanation {
    margin-bottom: var(--space-5);
    padding: var(--space-4);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    border-left: 3px solid var(--color-info);
}

.auto-fix-explanation h4 {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.auto-fix-explanation p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.auto-fix-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
}

.auto-fix-success-msg {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--color-success);
    color: white;
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    z-index: 10002;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.light-mode .auto-fix-modal-content {
    background: #ffffff;
    border-color: rgba(0, 0, 0, 0.1);
}

.light-mode .auto-fix-modal-header {
    background: #f5f5f5;
}

@media (max-width: 768px) {
    .auto-fix-comparison {
        grid-template-columns: 1fr;
    }
    
    .auto-fix-modal-content {
        width: 95%;
        max-height: 95vh;
    }
}

.code-editor-container textarea {
    width: 100%;
    height: 100%;
    padding: var(--space-4);
    font-family: 'Courier New', monospace;
    font-size: 14px;
    background: var(--color-bg-card);
    color: var(--color-text-primary);
    border: none;
    resize: none;
}

/* Output Panel Styles */
.output-panel {
    border-top: 1px solid var(--border-color);
    background: var(--color-bg-card);
    max-height: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.output-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
}

.output-title i {
    color: var(--gradient-primary);
}

.btn-icon {
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.output-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-4);
}

.output-loading {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
}

.output-loading i {
    color: var(--gradient-primary);
}

.output-success,
.output-error {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.output-status {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    flex-wrap: wrap;
}

.output-success .output-status {
    color: #10b981; /* green */
}

.output-success .output-status i {
    color: #10b981;
}

.output-error .output-status {
    color: var(--color-error);
}

.output-error .output-status i {
    color: var(--color-error);
}

.exit-code {
    margin-left: auto;
    padding: 2px var(--space-2);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-normal);
    color: var(--color-text-secondary);
}

.timeout-badge {
    padding: 2px var(--space-2);
    background: #f59e0b;
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
}

.output-text {
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    color: var(--color-text-primary);
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Success Button */
.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-success:active {
    transform: translateY(0);
}

.btn-success:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Responsive Design for Editor */
@media (max-width: 1024px) {
    .editor-main {
        flex-direction: column;
        height: auto;
    }
    
    .editor-sidebar {
        width: 100%;
        max-height: 300px;
    }
    
    .editor-workspace {
        min-height: 500px;
    }
}

@media (max-width: 768px) {
    .editor-container {
        padding: var(--space-4);
    }
    
    .editor-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .select-input {
        min-width: 100%;
    }
    
    .editor-toolbar {
        flex-direction: column;
        gap: var(--space-3);
        align-items: stretch;
    }
    
    .editor-actions {
        width: 100%;
    }
    
    .editor-actions button {
        flex: 1;
    }
}

/* =====================================
   Framework Performance Dashboard
   ===================================== */

.performance-container {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
}

.performance-content {
    position: relative;
}

.performance-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.performance-stats-grid .stat-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    transition: all var(--transition-normal);
}

.performance-stats-grid .stat-card:hover {
    background: var(--color-bg-tertiary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
    border-color: var(--border-hover);
}

.performance-stats-grid .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    color: var(--color-text-inverse);
    flex-shrink: 0;
}

.performance-stats-grid .stat-icon.sequential {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.performance-stats-grid .stat-icon.langgraph {
    background: linear-gradient(135deg, #00e5ff 0%, #00bcd4 100%);
}

.performance-stats-grid .stat-icon.autogen {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.performance-stats-grid .stat-icon.crewai {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.performance-stats-grid .stat-info {
    flex: 1;
}

.performance-stats-grid .stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
}

.performance-stats-grid .stat-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    line-height: 1;
    margin-bottom: var(--space-1);
}

.performance-stats-grid .stat-sublabel {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.performance-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.chart-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    transition: all var(--transition-normal);
}

.chart-card:hover {
    box-shadow: var(--shadow-card);
    border-color: var(--border-hover);
}

.chart-header {
    margin-bottom: var(--space-6);
}

.chart-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: #00e5ff; /* Cyan accent for chart titles */
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.chart-header p {
    font-size: var(--text-sm);
    color: #81d4fa; /* Lighter cyan for subtitles */
    margin: 0;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.performance-table-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
}

.table-header {
    margin-bottom: var(--space-6);
}

.table-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.table-wrapper {
    overflow-x: auto;
}

.performance-table {
    width: 100%;
    border-collapse: collapse;
}

.performance-table thead {
    background: var(--color-bg-tertiary);
}

.performance-table th {
    padding: var(--space-4);
    text-align: left;
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    font-size: var(--text-sm);
    border-bottom: 2px solid var(--border-color);
}

.performance-table td {
    padding: var(--space-4);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    border-bottom: 1px solid var(--border-color);
}

.performance-table tbody tr {
    transition: all var(--transition-fast);
}

.performance-table tbody tr:hover {
    background: var(--color-bg-tertiary);
}

.performance-table tbody tr:last-child td {
    border-bottom: none;
}

@media (max-width: 768px) {
    .performance-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .performance-charts {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .table-wrapper {
        overflow-x: scroll;
    }
}
````

## File: agentic_fixer/static/js/app.js
````javascript
// Global variables
let currentScanId = null;
let statusInterval = null;
let charts = {};
let cachedResults = null;
let animationFrameId = null;
let currentMode = 'repo'; // 'repo' or 'upload'

// Enhanced Chart.js configuration
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    animation: {
        duration: 2000,
        easing: 'easeInOutQuart'
    },
    plugins: {
        legend: {
            position: 'right',
            labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                    size: 12,
                    family: 'Inter, sans-serif'
                },
                color: '#b3e5fc' // Use secondary text color for legends
            }
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
                family: 'Inter, sans-serif',
                size: 14,
                weight: '600',
                color: '#ffffff'
            },
            bodyFont: {
                family: 'Inter, sans-serif',
                size: 12,
                color: '#ffffff'
            },
            cornerRadius: 8,
            displayColors: true
        }
    }
};

// Dark mode chart colors
const lightColors = {
    primary: ['#27F5CC', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'],
    background: '#ffffff',
    text: '#0f172a'
};

const darkColors = {
    primary: ['#27F5CC', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'],
    background: 'rgba(15, 23, 42, 0.8)',
    text: '#b3e5fc' // Cyan color for better visibility on dark background
};

// DOM elements
const scanForm = document.getElementById('scanForm');
const uploadForm = document.getElementById('uploadForm');
const scanButton = document.getElementById('scanButton');
const uploadButton = document.getElementById('uploadButton');
const progressSection = document.getElementById('progressSection');
const resultsSection = document.getElementById('resultsSection');
const progressFill = document.getElementById('progressFill');
const progressPercent = document.getElementById('progressPercent');
const currentStep = document.getElementById('currentStep');
const scanId = document.getElementById('scanId');
const fileInput = document.getElementById('file');
const fileUploadWrapper = document.querySelector('.file-upload-wrapper');

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Add form submission handlers
    scanForm.addEventListener('submit', handleScanSubmit);
    uploadForm.addEventListener('submit', handleUploadSubmit);
    
    // Load past scans when switching to that tab
    setupMainTabSwitching();
    
    // Check orchestrator availability
    checkOrchestratorAvailability();
    
    // Add input validation with enhanced feedback
    const repositoryInput = document.getElementById('repository');
    repositoryInput.addEventListener('input', validateInput);
    repositoryInput.addEventListener('focus', addInputFocusEffects);
    repositoryInput.addEventListener('blur', removeInputFocusEffects);
    
    // Add button click ripple effect
    scanButton.addEventListener('click', addRippleEffect);
    uploadButton.addEventListener('click', addRippleEffect);
    
    // Initialize file upload functionality
    initializeFileUpload();
    
    // Initialize scan type selector
    initializeScanTypeSelector();
    
    // Initialize theme
    initializeTheme();
    
    // Add scroll animations
    initializeScrollAnimations();
    
    // Add number counting animations
    initializeNumberAnimations();
    
    // Check for scan ID in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const scanIdParam = urlParams.get('scan_id');
    if (scanIdParam) {
        loadExistingScan(scanIdParam);
    }
    
    // Add keyboard shortcuts
    addKeyboardShortcuts();

    // Hook up filters if available (index only)
    wireUpFilters();
}

// File upload functionality
function initializeFileUpload() {
    if (!fileInput || !fileUploadWrapper) return;
    
    // Handle file selection
    fileInput.addEventListener('change', handleFileSelection);
    
    // Handle drag and drop
    fileUploadWrapper.addEventListener('dragover', handleDragOver);
    fileUploadWrapper.addEventListener('dragleave', handleDragLeave);
    fileUploadWrapper.addEventListener('drop', handleDrop);
    
    // Handle click to open file dialog (avoid double-open when clicking the actual input)
    fileUploadWrapper.addEventListener('click', (event) => {
        // If the native input was clicked, let it handle the dialog itself
        if (event.target === fileInput || event.target.closest('input[type="file"]')) {
            return;
        }
        event.preventDefault();
        fileInput.click();
    });
}

function handleFileSelection(event) {
    const file = event.target.files[0];
    if (file) {
        updateFileDisplay(file);
    }
}

function handleDragOver(event) {
    event.preventDefault();
    fileUploadWrapper.classList.add('dragover');
}

function handleDragLeave(event) {
    event.preventDefault();
    fileUploadWrapper.classList.remove('dragover');
}

function handleDrop(event) {
    event.preventDefault();
    fileUploadWrapper.classList.remove('dragover');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        fileInput.files = files;
        updateFileDisplay(file);
    }
}

function updateFileDisplay(file) {
    const fileUploadLabel = document.querySelector('.file-upload-label');
    const fileUploadInfo = document.querySelector('.file-upload-info');
    
    if (fileUploadLabel && fileUploadInfo) {
        fileUploadLabel.textContent = file.name;
        fileUploadInfo.textContent = `Size: ${formatFileSize(file.size)}`;
        fileUploadWrapper.classList.add('has-file');
        
        // Add file name display
        let fileNameDisplay = document.querySelector('.file-name-display');
        if (!fileNameDisplay) {
            fileNameDisplay = document.createElement('div');
            fileNameDisplay.className = 'file-name-display';
            fileUploadWrapper.appendChild(fileNameDisplay);
        }
        
        const fileIcon = getFileIcon(file.name);
        fileNameDisplay.innerHTML = `
            <i class="${fileIcon}"></i>
            <span>${escapeHtml(file.name)}</span>
            <span class="file-size">${formatFileSize(file.size)}</span>
        `;
    }
}

function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'py': 'fab fa-python',
        'js': 'fab fa-js-square',
        'java': 'fab fa-java',
        'html': 'fab fa-html5',
        'css': 'fab fa-css3-alt',
        'php': 'fab fa-php',
        'rb': 'fas fa-gem',
        'go': 'fas fa-code',
        'rs': 'fas fa-code',
        'ts': 'fab fa-js-square',
        'cpp': 'fas fa-code',
        'c': 'fas fa-code',
        'zip': 'fas fa-file-archive',
        'json': 'fas fa-file-code',
        'xml': 'fas fa-file-code',
        'md': 'fab fa-markdown',
        'txt': 'fas fa-file-alt'
    };
    
    return iconMap[extension] || 'fas fa-file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Scan type selector functionality
function initializeScanTypeSelector() {
    const typeOptions = document.querySelectorAll('.type-option');
    
    typeOptions.forEach(option => {
        option.addEventListener('click', () => {
            const type = option.dataset.type;
            switchScanType(type);
        });
    });
}

// Check orchestrator availability and update UI
async function checkOrchestratorAvailability() {
    try {
        const response = await fetch('/orchestrators');
        const data = await response.json();
        
        if (data.status) {
            const orchestratorSelect = document.getElementById('orchestrator');
            const helpText = orchestratorSelect?.parentElement?.querySelector('.input-help small');
            
            if (orchestratorSelect && data.status) {
                // Update options with availability status
                Array.from(orchestratorSelect.options).forEach(option => {
                    const orchestratorName = option.value;
                    const status = data.status[orchestratorName];
                    
                    if (status && !status.available && orchestratorName !== 'sequential') {
                        // Disable unavailable options and add note
                        option.disabled = true;
                        option.textContent = `${option.textContent.split(' (')[0]} (Not Installed)`;
                        
                        // Add title tooltip
                        option.title = `Install with: ${status.install_command || 'pip install ' + orchestratorName}`;
                    } else if (status && status.available) {
                        option.disabled = false;
                        // Remove any "(Not Installed)" text
                        if (option.textContent.includes('(Not Installed)')) {
                            option.textContent = option.textContent.replace(' (Not Installed)', '');
                        }
                    }
                });
                
                // Update help text with availability info
                if (helpText) {
                    const unavailable = Object.entries(data.status)
                        .filter(([name, status]) => !status.available && name !== 'sequential')
                        .map(([name, status]) => name);
                    
                    if (unavailable.length > 0) {
                        const installCmds = unavailable.map(name => {
                            const cmd = data.status[name].install_command;
                            return cmd ? `\`${cmd}\`` : '';
                        }).filter(cmd => cmd).join(' or ');
                        
                        helpText.innerHTML = `
                            Choose the agentic framework to orchestrate the scan workflow.
                            ${unavailable.length > 0 ? `<br><strong style="color: #ff6b6b;">Note:</strong> Some frameworks are not installed. Install with: ${installCmds}` : ''}
                        `;
                    }
                }
            }
        }
    } catch (error) {
        console.error('Failed to check orchestrator availability:', error);
    }
}

function switchScanType(type) {
    // Update active state
    document.querySelectorAll('.type-option').forEach(option => {
        option.classList.toggle('active', option.dataset.type === type);
    });
    
    // Show/hide forms
    if (type === 'repository') {
        scanForm.style.display = 'block';
        uploadForm.style.display = 'none';
    } else if (type === 'upload') {
        scanForm.style.display = 'none';
        uploadForm.style.display = 'block';
    }
}

// Upload form submission handler
async function handleUploadSubmit(e) {
    e.preventDefault();
    currentMode = 'upload';
    
    const formData = new FormData(uploadForm);
    const file = formData.get('file');
    
    if (!file || file.size === 0) {
        showError('Please select a file to upload');
        return;
    }
    
    // Check file size (500MB limit)
    if (file.size > 500 * 1024 * 1024) {
        showError('File size must be less than 500MB');
        return;
    }
    
    // Disable form and show progress
    disableUploadForm();
    showProgress();
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentScanId = data.scan_id;
            scanId.textContent = currentScanId;
            startStatusPolling();
        } else {
            throw new Error(data.error || 'Failed to upload file');
        }
    } catch (error) {
        showError('Failed to upload file: ' + error.message);
        enableUploadForm();
        hideProgress();
    }
}

function disableUploadForm() {
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';
    fileInput.disabled = true;
}

function enableUploadForm() {
    uploadButton.disabled = false;
    uploadButton.innerHTML = '<i class="fas fa-upload"></i><span>Upload & Scan</span>';
    fileInput.disabled = false;
}

// Theme management
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('light-mode', savedTheme === 'light');
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    const theme = isLight ? 'light' : 'dark';
    localStorage.setItem('theme', theme);
    updateThemeIcon(theme);
    
    // Update charts if they exist
    if (Object.keys(charts).length > 0) {
        updateChartsTheme();
    }
}

function updateThemeIcon(theme) {
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.innerHTML = theme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    }
}

function updateChartsTheme() {
    const isLight = document.body.classList.contains('light-mode');
    const colors = isLight ? lightColors : darkColors;
    
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.update === 'function') {
            chart.options.plugins.legend.labels.color = colors.text;
            chart.update();
        }
    });
}

// Input validation and effects
function validateInput(e) {
    const input = e.target;
    const value = input.value.trim();
    
    // Remove any existing validation classes
    input.classList.remove('valid', 'invalid');
    
    if (value.length === 0) {
        return; // Don't show validation for empty input
    }
    
    // Basic validation - check if it looks like a path or URL
    const isValid = value.includes('/') || value.includes('\\') || value.startsWith('http');
    
    if (isValid) {
        input.classList.add('valid');
    } else {
        input.classList.add('invalid');
    }
}

// Form submission handler
async function handleScanSubmit(e) {
    e.preventDefault();
    currentMode = 'repo';
    
    const formData = new FormData(scanForm);
    const repository = formData.get('repository').trim();
    const orchestrator = document.getElementById('orchestrator')?.value || 'sequential';
    
    if (!repository) {
        showError('Please enter a repository path or URL');
        return;
    }
    
    // Check if selected orchestrator is available
    const orchestratorSelect = document.getElementById('orchestrator');
    const selectedOption = orchestratorSelect?.options[orchestratorSelect.selectedIndex];
    if (selectedOption?.disabled) {
        showError(`The selected framework "${selectedOption.textContent}" is not installed. Please install it first or select a different framework.`);
        return;
    }
    
    // Disable form and show progress
    disableForm();
    showProgress();
    
    try {
        const response = await fetch('/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                repository: repository,
                orchestrator: orchestrator
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentScanId = data.scan_id;
            scanId.textContent = currentScanId;
            startStatusPolling();
        } else {
            throw new Error(data.error || 'Failed to start scan');
        }
    } catch (error) {
        showError('Failed to start scan: ' + error.message);
        enableForm();
        hideProgress();
    }
}

function disableForm() {
    scanButton.disabled = true;
    scanButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Starting Scan...</span>';
    document.getElementById('repository').disabled = true;
}

function enableForm() {
    scanButton.disabled = false;
    scanButton.innerHTML = '<i class="fas fa-play"></i><span>Start Security Scan</span>';
    document.getElementById('repository').disabled = false;
}

function createCharts(results) {
    const isLight = document.body.classList.contains('light-mode');
    const colors = isLight ? lightColors : darkColors;
    
    // Issue Type Distribution Chart
    if (results.issues && results.issues.length > 0) {
        createIssueTypeChart(results.issues, colors);
    }
    
    // Language Distribution Chart
    if (results.file_status) {
        createLanguageChart(results.file_status, colors);
    }
    
    // Severity Distribution Chart
    if (results.issues && results.issues.length > 0) {
        createSeverityChart(results.issues, colors);
    }
    
    // File Status Chart
    if (results.file_status) {
        createFileStatusChart(results.file_status, colors);
    }
}

function createIssueTypeChart(issues, colors) {
    const ctx = document.getElementById('issueTypeChart');
    if (!ctx) return;
    
    // Count issue types
    const issueTypes = {};
    issues.forEach(issue => {
        issueTypes[issue.type] = (issueTypes[issue.type] || 0) + 1;
    });
    
    const labels = Object.keys(issueTypes);
    const data = Object.values(issueTypes);
    
    // Destroy existing chart
    if (charts.issueType) {
        charts.issueType.destroy();
    }
    
    charts.issueType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.primary.slice(0, labels.length),
                borderColor: colors.background,
                borderWidth: 0,
                hoverBorderWidth: 0
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

function createLanguageChart(fileStatus, colors) {
    const ctx = document.getElementById('languageChart');
    if (!ctx) return;
    
    // Count files by language, excluding unknown/text buckets
    const languageCounts = {};
    Object.entries(fileStatus).forEach(([language, count]) => {
        if (language !== 'unknown' && language !== 'text') {
            languageCounts[language] = count;
        }
    });
    
    const labels = Object.keys(languageCounts);
    const data = Object.values(languageCounts);
    
    // Destroy existing chart
    if (charts.language) {
        charts.language.destroy();
    }
    
    charts.language = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.primary.slice(0, labels.length),
                borderColor: colors.background,
                borderWidth: 0,
                hoverBorderWidth: 0
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

function createSeverityChart(issues, colors) {
    const ctx = document.getElementById('severityChart');
    if (!ctx) return;
    
    // Categorize issues by provided severity (fallback to heuristic)
    const severityCounts = { high: 0, medium: 0, low: 0 };
    
    issues.forEach(issue => {
        const severity = issue.severity || getSeverityFromType(issue.type);
        severityCounts[severity] = (severityCounts[severity] || 0) + 1;
    });
    
    const labels = Object.keys(severityCounts);
    const data = Object.values(severityCounts);
    
    // Destroy existing chart
    if (charts.severity) {
        charts.severity.destroy();
    }
    
    charts.severity = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    colors.error,
                    colors.warning,
                    colors.success
                ],
                borderColor: colors.background,
                borderWidth: 0,
                hoverBorderWidth: 0
            }]
        },
        options: {
            ...chartConfig,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                },
                x: {
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                }
            },
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    display: false
                }
            }
        }
    });
}

function createFileStatusChart(fileStatus, colors) {
    const ctx = document.getElementById('fileStatusChart');
    if (!ctx) return;
    
    const cleanFiles = fileStatus.filter(f => f.status === 'clean').length;
    const issueFiles = fileStatus.filter(f => f.status === 'issues').length;
    
    // Destroy existing chart
    if (charts.fileStatus) {
        charts.fileStatus.destroy();
    }
    
    charts.fileStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Clean Files', 'Files with Issues'],
            datasets: [{
                data: [cleanFiles, issueFiles],
                backgroundColor: [colors.success, colors.warning],
                borderColor: colors.background,
                borderWidth: 0,
                hoverBorderWidth: 0
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

function displayFiles(files) {
    const filesList = document.getElementById('filesList');
    
    filesList.innerHTML = files.map(file => {
        const languageIcon = getLanguageIcon(file.language);
        const statusClass = file.status === 'clean' ? 'clean' : 'issues';
        const statusText = file.status === 'clean' ? 'Clean' : 'Issues Found';
        
        return `
            <div class="file-item ${statusClass}">
                <div class="file-info">
                    <div class="file-icon">
                        <i class="${languageIcon}"></i>
                    </div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-meta">
                            <span class="file-language">${file.language}</span>
                            <span class="file-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                </div>
                ${file.issues && file.issues.length > 0 ? `
                    <div class="file-issues">
                        <span class="issue-count">${file.issues.length} issue${file.issues.length !== 1 ? 's' : ''}</span>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function getLanguageIcon(language) {
    const icons = {
        'python': '<i class="fab fa-python"></i>',
        'javascript': '<i class="fab fa-js-square"></i>',
        'java': '<i class="fab fa-java"></i>',
        'html': '<i class="fab fa-html5"></i>',
        'css': '<i class="fab fa-css3-alt"></i>',
        'php': '<i class="fab fa-php"></i>',
        'go': '<i class="fas fa-code"></i>',
        'rust': '<i class="fas fa-code"></i>',
        'typescript': '<i class="fab fa-js-square"></i>',
        'cpp': '<i class="fas fa-code"></i>',
        'c': '<i class="fas fa-code"></i>',
        'json': '<i class="fas fa-file-code"></i>',
        'xml': '<i class="fas fa-file-code"></i>',
        'markdown': '<i class="fab fa-markdown"></i>',
        'text': '<i class="fas fa-file-alt"></i>',
        'unknown': '<i class="fas fa-file"></i>'
    };
    
    return icons[language] || icons['unknown'];
}

function getLanguageFromFile(filename) {
    if (filename.endsWith('.py')) {
        return 'python';
    } else if (filename.endsWith('.js')) {
        return 'javascript';
    } else if (filename.endsWith('.java')) {
        return 'java';
    } else if (filename.endsWith('.html') || filename.endsWith('.htm')) {
        return 'html';
    } else if (filename.endsWith('.css')) {
        return 'css';
    } else if (filename.endsWith('.php')) {
        return 'php';
    } else if (filename.endsWith('.go')) {
        return 'go';
    } else if (filename.endsWith('.rs')) {
        return 'rust';
    } else if (filename.endsWith('.ts')) {
        return 'typescript';
    } else if (filename.endsWith('.cpp') || filename.endsWith('.cc') || filename.endsWith('.cxx')) {
        return 'cpp';
    } else if (filename.endsWith('.c')) {
        return 'c';
    } else if (filename.endsWith('.json')) {
        return 'json';
    } else if (filename.endsWith('.xml')) {
        return 'xml';
    } else if (filename.endsWith('.md')) {
        return 'markdown';
    } else if (filename.endsWith('.txt')) {
        return 'text';
    } else {
        return 'unknown';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getSeverityFromType(type) {
    const severityMap = {
        'sql_injection': 'high',
        'xss': 'high',
        'command_injection': 'high',
        'path_traversal': 'high',
        'hardcoded_password': 'high',
        'weak_crypto': 'medium',
        'insecure_random': 'medium',
        'unsafe_deserialization': 'high',
        'xxe': 'high',
        'ssrf': 'high',
        'csrf': 'medium',
        'weak_auth': 'medium',
        'insecure_direct_object_reference': 'medium',
        'security_misconfiguration': 'medium',
        'sensitive_data_exposure': 'high',
        'missing_function_level_access_control': 'medium',
        'unvalidated_redirects': 'low',
        'components_with_known_vulnerabilities': 'high',
        'underprotected_apis': 'medium',
        'excessive_data_exposure': 'medium',
        'improper_asset_management': 'low',
        'insufficient_logging': 'low'
    };
    
    return severityMap[type] || 'medium';
}

function showProgress() {
    progressSection.classList.remove('hidden');
    resultsSection.classList.add('hidden');
}

function hideProgress() {
    progressSection.classList.add('hidden');
}

function showResults() {
    resultsSection.classList.remove('hidden');
    progressSection.classList.add('hidden');
}

// Input focus effects
function addInputFocusEffects(event) {
    const input = event.target;
    input.style.transform = 'translateY(-2px)';
    input.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
}

function removeInputFocusEffects(event) {
    const input = event.target;
    input.style.transform = 'translateY(0)';
    if (input.value.trim().length === 0) {
        input.style.boxShadow = 'none';
    }
}

// Button ripple effect
function addRippleEffect(event) {
    const button = event.currentTarget;
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    const ripple = document.createElement('div');
    ripple.className = 'button-ripple';
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    
    button.appendChild(ripple);
    
    setTimeout(() => {
        ripple.remove();
    }, 600);
}

// Scroll animations
function initializeScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe elements with animation classes
    document.querySelectorAll('[data-aos]').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'all 0.8s ease';
        observer.observe(el);
    });
}

// Number counting animations
function initializeNumberAnimations() {
    const numberElements = document.querySelectorAll('[data-count]');
    
    const animateNumber = (element, target) => {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        const updateNumber = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = Math.floor(start + (target - start) * easeOutQuart);
            
            element.textContent = current;
            
            if (progress < 1) {
                animationFrameId = requestAnimationFrame(updateNumber);
            }
        };
        
        requestAnimationFrame(updateNumber);
    };
    
    // Store the animation function for later use
    window.animateNumbers = animateNumber;
}

// Keyboard shortcuts
function addKeyboardShortcuts() {
    document.addEventListener('keydown', (event) => {
        // Ctrl/Cmd + Enter to submit form
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
            if (!scanButton.disabled) {
                scanForm.dispatchEvent(new Event('submit'));
            }
        }
        
        // Escape to clear form
        if (event.key === 'Escape') {
            if (resultsSection.classList.contains('hidden')) {
                scanForm.reset();
                validateInput();
            }
        }
    });
}

async function handleScanSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(scanForm);
    const repository = formData.get('repository').trim();
    const orchestrator = document.getElementById('orchestrator')?.value || 'sequential';
    
    if (!repository) {
        showError('Please enter a repository path or URL');
        return;
    }
    
    // Check if selected orchestrator is available
    const orchestratorSelect = document.getElementById('orchestrator');
    const selectedOption = orchestratorSelect?.options[orchestratorSelect.selectedIndex];
    if (selectedOption?.disabled) {
        showError(`The selected framework "${selectedOption.textContent}" is not installed. Please install it first or select a different framework.`);
        return;
    }
    
    // Disable form and show progress
    disableForm();
    showProgress();
    
    try {
        const response = await fetch('/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                repository: repository,
                orchestrator: orchestrator
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentScanId = data.scan_id;
            scanId.textContent = currentScanId;
            startStatusPolling();
        } else {
            throw new Error(data.error || 'Failed to start scan');
        }
    } catch (error) {
        showError('Failed to start scan: ' + error.message);
        enableForm();
        hideProgress();
    }
}

function startStatusPolling() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
    
    let retries404 = 0;
    const maxRetries404 = 8; // ~8 seconds grace for backend to register
    statusInterval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${currentScanId}`);
            const status = await response.json();
            
            if (response.ok) {
                updateProgress(status);
                
                if (status.status === 'completed' || status.status === 'error') {
                    clearInterval(statusInterval);
                    
                    if (status.status === 'completed') {
                        await loadResults();
                        // Refresh vulnerabilities panel data after scan completes
                        // This ensures the panel shows updated data when user switches to it
                        loadVulnerabilities();
                    } else {
                        showError('Scan failed: ' + status.current_step);
                        if (currentMode === 'repo') {
                            enableForm();
                        } else {
                            enableUploadForm();
                        }
                        hideProgress();
                    }
                }
            } else if (response.status === 404 && retries404 < maxRetries404) {
                // Gracefully retry for a short time if status not ready yet
                retries404++;
                return;
            } else {
                throw new Error('Failed to get status');
            }
        } catch (error) {
            console.error('Status polling error:', error);
            clearInterval(statusInterval);
            showError('Failed to get scan status');
            if (currentMode === 'repo') {
                enableForm();
            } else {
                enableUploadForm();
            }
            hideProgress();
        }
    }, 1000);
}

function updateProgress(status) {
    progressFill.style.width = status.progress + '%';
    progressPercent.textContent = status.progress + '%';
    currentStep.textContent = status.current_step;
    
    // Update button text based on progress
    if (status.progress < 100) {
        if (currentMode === 'repo') {
            scanButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>Scanning... ${status.progress}%</span>`;
        } else {
            uploadButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>Scanning... ${status.progress}%</span>`;
        }
    }
}

async function loadResults() {
    try {
        const response = await fetch(`/results/${currentScanId}`);
        const results = await response.json();
        
        if (response.ok) {
            cachedResults = results;
            displayResults(results);
            showResults();
            if (currentMode === 'repo') {
                enableForm();
            } else {
                enableUploadForm();
            }
        } else {
            throw new Error('Failed to load results');
        }
    } catch (error) {
        showError('Failed to load results: ' + error.message);
        if (currentMode === 'repo') {
            enableForm();
        } else {
            enableUploadForm();
        }
        hideProgress();
    }
}

function displayResults(results) {
    // Update summary stats with animations
    const totalFilesEl = document.getElementById('totalFiles');
    const totalIssuesEl = document.getElementById('totalIssues');
    const cleanFilesEl = document.getElementById('cleanFiles');
    const languagesEl = document.getElementById('languages');
    
    // Calculate counts
    const totalFilesCount = results.file_status.length;
    const cleanFilesCount = results.file_status.filter(f => f.status === 'clean').length;
    const filesWithIssuesCount = totalFilesCount - cleanFilesCount;

    // Animate numbers
    if (window.animateNumbers) {
        window.animateNumbers(totalFilesEl, totalFilesCount);
        window.animateNumbers(totalIssuesEl, filesWithIssuesCount);
        window.animateNumbers(cleanFilesEl, cleanFilesCount);
        window.animateNumbers(languagesEl, results.languages.length);
    } else {
        // Fallback if animation function not available
        totalFilesEl.textContent = totalFilesCount;
        totalIssuesEl.textContent = filesWithIssuesCount;
        cleanFilesEl.textContent = cleanFilesCount;
        languagesEl.textContent = results.languages.length;
    }
    
    // Create charts with enhanced animations
    createCharts(results);
    
    // Display issues with staggered animations
    displayIssues(results.explanations);
    
    // Display files with animations
    displayFiles(results.file_status);
    
    // Display summary
    displaySummary(results);
    
    // Add success animation to stat cards
    setTimeout(() => {
        document.querySelectorAll('.stat-card').forEach((card, index) => {
            setTimeout(() => {
                card.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    card.style.transform = 'scale(1)';
                }, 200);
            }, index * 100);
        });
    }, 500);
    
    // Ensure the issues tab is active
    const issuesTab = document.getElementById('issuesTab');
    const filesTab = document.getElementById('filesTab');
    const summaryTab = document.getElementById('summaryTab');
    
    // Remove active from all tabs
    if (filesTab) filesTab.classList.remove('active');
    if (summaryTab) summaryTab.classList.remove('active');
    
    // Activate issues tab
    if (issuesTab) {
        issuesTab.classList.add('active');
        console.log('[DEBUG] Activated issuesTab');
    }
    
    // Final debug check
    setTimeout(() => {
        console.log('[DEBUG] Final check - Issues in DOM:', document.querySelectorAll('.issue-item').length);
        console.log('[DEBUG] Final check - Results section visible:', window.getComputedStyle(resultsSection).display);
        console.log('[DEBUG] Final check - IssuesList has content:', document.getElementById('issuesList')?.innerHTML.length > 0);
        console.log('[DEBUG] Final check - IssuesTab active:', issuesTab?.classList.contains('active'));
        console.log('[DEBUG] Final check - IssuesTab display:', window.getComputedStyle(issuesTab).display);
    }, 2000);
}

// Chart creation functions
function createCharts(results) {
    const isLight = document.body.classList.contains('light-mode');
    const colors = isLight ? lightColors : darkColors;
    
    // Issue Type Distribution Chart
    createIssueTypeChart(results.explanations, colors);
    
    // Language Distribution Chart
    createLanguageChart(results.file_status, colors);
    
    // Security Severity Chart
    createSeverityChart(results.explanations, colors);
    
    // File Status Chart
    createFileStatusChart(results.file_status, colors);
}

// ---------- Dashboard Filters ----------
function wireUpFilters() {
    const search = document.getElementById('filterSearch');
    const language = document.getElementById('filterLanguage');
    const severity = document.getElementById('filterSeverity');
    const onlyIssues = document.getElementById('filterOnlyIssues');
    const sortSelect = document.getElementById('sortSelect');
    
    if (!search || !language || !severity || !onlyIssues || !sortSelect) {
        return; // likely on results.html or old template; safely ignore
    }

    // Restore persisted filters
    const saved = JSON.parse(localStorage.getItem('dashboardFilters') || '{}');
    if (saved.search) search.value = saved.search;
    if (saved.language) language.value = saved.language;
    if (saved.severity) severity.value = saved.severity;
    if (saved.onlyIssues != null) onlyIssues.checked = saved.onlyIssues;
    if (saved.sort) sortSelect.value = saved.sort;

    const persist = () => {
        localStorage.setItem('dashboardFilters', JSON.stringify({
            search: search.value.trim(),
            language: language.value,
            severity: severity.value,
            onlyIssues: onlyIssues.checked,
            sort: sortSelect.value
        }));
    };

    const apply = () => {
        if (!cachedResults) return;
        // Filter and render issues
        const filteredIssues = filterIssues(cachedResults.explanations, {
            query: search.value.trim().toLowerCase(),
            language: language.value,
            severity: severity.value
        });
        displayIssues(filteredIssues);

        // Filter and render files
        let files = filterFiles(cachedResults.file_status, {
            query: search.value.trim().toLowerCase(),
            language: language.value,
            onlyIssues: onlyIssues.checked
        });
        files = sortFiles(files, sortSelect.value);
        displayFiles(files);

        // Update charts to reflect filters
        createIssueTypeChart(filteredIssues, document.body.classList.contains('light-mode') ? lightColors : darkColors);
        createLanguageChart(files, document.body.classList.contains('light-mode') ? lightColors : darkColors);
        createSeverityChart(filteredIssues, document.body.classList.contains('light-mode') ? lightColors : darkColors);
        createFileStatusChart(files, document.body.classList.contains('light-mode') ? lightColors : darkColors);
    };

    const populateLanguages = () => {
        if (!cachedResults) return;
        const langs = Array.from(new Set((cachedResults.file_status || []).map(f => (f.language || '').toLowerCase()).filter(l => l && l !== 'unknown' && l !== 'text'))).sort();
        const current = language.value;
        language.innerHTML = '<option value="all">All languages</option>' +
            langs.map(l => `<option value="${l}">${l}</option>`).join('');
        if (current) language.value = current;
    };

    // Event listeners
    [search, language, severity, onlyIssues, sortSelect].forEach(el => {
        el.addEventListener('input', () => { persist(); apply(); });
        el.addEventListener('change', () => { persist(); apply(); });
    });

    // Populate languages when results arrive
    const observer = new MutationObserver(() => {
        if (cachedResults) {
            populateLanguages();
            apply();
            observer.disconnect();
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });
}

function filterIssues(issues, { query, language, severity }) {
    return (issues || []).filter(issue => {
        const lang = getLanguageFromFile(issue.file || '').toLowerCase();
        const sev = (issue.severity || '').toLowerCase();
        const hay = `${issue.file} ${issue.issue} ${issue.description || issue.explanation} ${issue.code} ${issue.suggestion}`.toLowerCase();
        const searchOk = query ? hay.includes(query) : true;
        const langOk = language && language !== 'all' ? lang === language : true;
        const sevOk = severity && severity !== 'all' ? sev.startsWith(severity) : true;
        return searchOk && langOk && sevOk;
    });
}

function filterFiles(files, { query, language, onlyIssues }) {
    return (files || []).filter(f => {
        const lang = (f.language || '').toLowerCase();
        const hay = `${f.file} ${f.language} ${f.status}`.toLowerCase();
        const searchOk = query ? hay.includes(query) : true;
        const langOk = language && language !== 'all' ? lang === language : true;
        const issuesOk = onlyIssues ? f.status !== 'clean' : true;
        return searchOk && langOk && issuesOk;
    });
}

function sortFiles(files, sortKey) {
    const copy = [...files];
    if (sortKey === 'name') {
        copy.sort((a,b) => a.file.localeCompare(b.file));
    } else if (sortKey === 'status') {
        const order = { issue: 0, unknown: 1, clean: 2 };
        copy.sort((a,b) => (order[a.status] ?? 1) - (order[b.status] ?? 1) || a.file.localeCompare(b.file));
    } else if (sortKey === 'severity') {
        // Approximate by mapping presence of any issue in explanations to a severity for that file if available
        if (cachedResults && cachedResults.explanations) {
            const fileMaxSeverity = {};
            const rank = { critical: 0, high: 1, medium: 2, low: 3, '': 4 };
            cachedResults.explanations.forEach(ex => {
                const sev = (ex.severity || '').toLowerCase();
                const key = ex.file;
                const current = fileMaxSeverity[key];
                const r = rank[sev] ?? 4;
                fileMaxSeverity[key] = current == null ? r : Math.min(current, r);
            });
            copy.sort((a,b) => (fileMaxSeverity[a.file] ?? 4) - (fileMaxSeverity[b.file] ?? 4) || a.file.localeCompare(b.file));
        }
    }
    return copy;
}

function createIssueTypeChart(issues, colors) {
    const ctx = document.getElementById('issueTypeChart');
    if (!ctx) return;
    
    // Count issue types
    const issueTypes = {};
    issues.forEach(issue => {
        const type = issue.issue || 'Unknown';
        issueTypes[type] = (issueTypes[type] || 0) + 1;
    });
    
    const labels = Object.keys(issueTypes);
    const data = Object.values(issueTypes);
    
    if (charts.issueType) {
        charts.issueType.destroy();
    }
    
    charts.issueType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.primary.slice(0, labels.length),
                borderWidth: 0,
                hoverBorderWidth: 0,
                borderColor: colors.background
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

function createLanguageChart(fileStatus, colors) {
    const ctx = document.getElementById('languageChart');
    if (!ctx) return;
    
    // Count files by language, excluding unknown/text buckets
    const languageCounts = {};
    fileStatus.forEach(file => {
        const langRaw = file.language || 'Unknown';
        const lang = langRaw.toLowerCase();
        if (lang === 'unknown' || lang === 'text') {
            return;
        }
        languageCounts[langRaw] = (languageCounts[langRaw] || 0) + 1;
    });
    
    const labels = Object.keys(languageCounts);
    const data = Object.values(languageCounts);
    
    // Calculate total and percentages
    const total = data.reduce((sum, val) => sum + val, 0);
    
    if (charts.language) {
        charts.language.destroy();
    }
    
    charts.language = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Languages'],
            datasets: labels.map((label, index) => ({
                label: label,
                data: [data[index]],
                backgroundColor: colors.primary[index % colors.primary.length],
                borderWidth: 0,
                hoverBorderWidth: 0,
                borderRadius: index === 0 
                    ? { topLeft: 8, topRight: 0, bottomLeft: 8, bottomRight: 0 }
                    : index === labels.length - 1
                    ? { topLeft: 0, topRight: 8, bottomLeft: 0, bottomRight: 8 }
                    : 0,
                borderSkipped: false,
                barThickness: 60
            }))
        },
        options: {
            indexAxis: 'y',
            ...chartConfig,
            layout: {
                padding: {
                    left: 0,
                    right: 0
                }
            },
            scales: {
                x: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        display: false
                    },
                    grid: {
                        color: colors.text + '20',
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    ticks: {
                        display: false
                    },
                    grid: {
                        color: colors.text + '20'
                    },
                    maxBarThickness: 60
                }
            },
            categoryPercentage: 1.0,
            barPercentage: 1.0,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    position: 'bottom',  // Languages chart legend at bottom
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text,
                        padding: 15,
                        font: {
                            size: 11
                        },
                        generateLabels: function(chart) {
                            const original = Chart.defaults.plugins.legend.labels.generateLabels;
                            const labels = original.call(this, chart);
                            // Add percentage below each label
                            labels.forEach((label, index) => {
                                const percentage = ((data[index] / total) * 100).toFixed(1);
                                label.text = `${label.text}\n${percentage}%`;
                            });
                            return labels;
                        }
                    }
                }
            }
        }
    });
}

function createSeverityChart(issues, colors) {
    const ctx = document.getElementById('severityChart');
    if (!ctx) return;
    
    // Categorize issues by provided severity (fallback to heuristic)
    const severityCounts = { 'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0 };
    const normalize = (value) => {
        if (!value || typeof value !== 'string') return null;
        const v = value.trim().toLowerCase();
        if (v.startsWith('crit')) return 'Critical';
        if (v.startsWith('hi')) return 'High';
        if (v.startsWith('med')) return 'Medium';
        if (v.startsWith('lo')) return 'Low';
        return null;
    };
    const heuristicBucket = (issueType) => {
        const t = (issueType || '').toLowerCase();
        if (t.includes('sql injection') || t.includes('xss') || t.includes('rce')) return 'Critical';
        if (t.includes('hardcoded') || t.includes('password')) return 'High';
        if (t.includes('deprecated') || t.includes('weak')) return 'Medium';
        return 'Low';
    };
    issues.forEach(issue => {
        const sev = normalize(issue.severity) || heuristicBucket(issue.issue);
        severityCounts[sev]++;
    });
    
    const labels = Object.keys(severityCounts);
    const data = Object.values(severityCounts);
    const severityColors = ['#FF6B6B', '#FFA726', '#66BB6A', '#42A5F5'];
    
    if (charts.severity) {
        charts.severity.destroy();
    }
    
    charts.severity = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: severityColors,
                borderWidth: 0,
                hoverBorderWidth: 0,
                borderColor: colors.background
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

function createFileStatusChart(fileStatus, colors) {
    const ctx = document.getElementById('fileStatusChart');
    if (!ctx) return;
    
    const cleanFiles = fileStatus.filter(f => f.status === 'clean').length;
    const filesWithIssues = fileStatus.length - cleanFiles;
    
    if (charts.fileStatus) {
        charts.fileStatus.destroy();
    }
    
    charts.fileStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Clean Files', 'Files with Issues'],
            datasets: [{
                data: [cleanFiles, filesWithIssues],
                backgroundColor: ['#66BB6A', '#FF6B6B'],
                borderWidth: 0,
                hoverBorderWidth: 0,
                borderColor: colors.background
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: colors.text
                    }
                }
            }
        }
    });
}

// Issue detail toggle functionality
function toggleIssueDetail(issueIndex) {
    console.log('Toggling issue:', issueIndex);
    const detailsElement = document.getElementById(`issueDetails${issueIndex}`);
    
    if (!detailsElement) {
        console.error('Details element not found for issue:', issueIndex);
        return;
    }
    
    const expandIcon = detailsElement.parentElement.querySelector('.expand-icon');
    
    if (detailsElement.style.display === 'none' || detailsElement.style.display === '') {
        detailsElement.style.display = 'block';
        if (expandIcon) expandIcon.style.transform = 'rotate(180deg)';
        console.log('Expanded issue', issueIndex);
    } else {
        detailsElement.style.display = 'none';
        if (expandIcon) expandIcon.style.transform = 'rotate(0deg)';
        console.log('Collapsed issue', issueIndex);
    }
}

// Auto-fix functionality
function autoFixIssue(scanId, issueIndex, issueData, buttonElement) {
    // Get button element - either passed explicitly or from event
    const button = buttonElement || (typeof event !== 'undefined' ? event.target.closest('.auto-fix-btn') : null);
    if (!button) {
        console.error('Could not find button element');
        return;
    }
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Fixing...</span>';
    button.disabled = true;
    
    // Make API call to get AI solution
    fetch('/api/auto-fix', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            scan_id: scanId,
            issue_index: issueIndex,
            issue_data: issueData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success state
            button.innerHTML = '<i class="fas fa-check"></i><span>Fixed!</span>';
            button.classList.add('success');
            
            // Replace the code with typing animation
            const codeElement = button.closest('.context-line').querySelector('code');
            const originalCode = codeElement.textContent;
            
            // Type out the new solution
            typeText(codeElement, data.solution_code, () => {
                // Show explanation tooltip
                showFixExplanation(button, data.explanation);
            });
            
        } else {
            // Show error state
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Error</span>';
            button.classList.add('error');
            console.error('Auto-fix failed:', data.error);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                button.classList.remove('error');
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Auto-fix request failed:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Error</span>';
        button.classList.add('error');
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.classList.remove('error');
        }, 3000);
    });
}

// Typing animation function
function typeText(element, text, onComplete) {
    element.textContent = '';
    let i = 0;
    
    const typeInterval = setInterval(() => {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
        } else {
            clearInterval(typeInterval);
            if (onComplete) onComplete();
        }
    }, 30); // 30ms delay between characters
}

// Show fix explanation tooltip
function showFixExplanation(button, explanation) {
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'fix-explanation-tooltip';
    tooltip.innerHTML = `
        <div class="tooltip-content">
            <h4><i class="fas fa-lightbulb"></i> AI Fix Explanation</h4>
            <p>${explanation}</p>
            <button class="close-tooltip" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Position tooltip near the button
    const rect = button.getBoundingClientRect();
    tooltip.style.position = 'fixed';
    tooltip.style.top = `${rect.top - 10}px`;
    tooltip.style.left = `${rect.right + 10}px`;
    tooltip.style.zIndex = '1000';
    
    // Add to page
    document.body.appendChild(tooltip);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (tooltip.parentElement) {
            tooltip.remove();
        }
    }, 10000);
}

// Code smell detection functionality
function detectCodeSmell(filePath, lineNumber, fileName, buttonElement) {
    const button = buttonElement || (typeof event !== 'undefined' ? event.target.closest('.code-smell-btn') : null);
    if (!button) {
        console.error('Could not find button element');
        return;
    }
    
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Detecting...</span>';
    button.disabled = true;
    
    // Make API call to detect code smells
    fetch('/api/code-smell', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_path: filePath,
            line_number: lineNumber,
            file_name: fileName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Code smell detection response:', data);
        if (data.success) {
            // Show success state
            button.innerHTML = '<i class="fas fa-check"></i><span>Detected!</span>';
            button.classList.add('success');
            
            // Show code smell results
            if (data.code_smells && data.code_smells.length > 0) {
                showCodeSmellResults(button, data.code_smells, filePath, lineNumber);
            } else {
                // Show message if no code smells found
                showCodeSmellResults(button, [], filePath, lineNumber, 'No code smells detected in this file. Great job!');
            }
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('success');
                button.disabled = false;
            }, 3000);
            
        } else {
            // Show error state
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Error</span>';
            button.classList.add('error');
            console.error('Code smell detection failed:', data.error);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                button.classList.remove('error');
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Code smell detection request failed:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Error</span>';
        button.classList.add('error');
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.classList.remove('error');
        }, 3000);
    });
}

// Show code smell results
function showCodeSmellResults(button, codeSmells, filePath, lineNumber, noSmellsMessage = null) {
    // Create modal/panel element
    const modal = document.createElement('div');
    modal.className = 'code-smell-modal';
    
    let contentHtml = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-diagnoses"></i> Code Smell Detection Results</h3>
                <button class="close-modal" onclick="this.closest('.code-smell-modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="file-info">
                    <strong>File:</strong> ${escapeHtml(filePath)}<br>
                    <strong>Line:</strong> ${lineNumber || 'N/A'}
                </div>
    `;
    
    if (codeSmells && codeSmells.length > 0) {
        contentHtml += `
                <div class="code-smell-list">
                    ${codeSmells.map(smell => `
                        <div class="code-smell-item">
                            <div class="smell-header">
                                <span class="smell-severity ${smell.severity.toLowerCase()}">${smell.severity}</span>
                                <h4>${escapeHtml(smell.type)}</h4>
                            </div>
                            <p class="smell-description">${escapeHtml(smell.description)}</p>
                            ${smell.example ? `
                                <div class="smell-example">
                                    <strong>Example:</strong>
                                    <pre><code class="language-javascript">${escapeHtml(smell.example)}</code></pre>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
        `;
    } else {
        // Show no smells message
        contentHtml += `
                <div class="no-code-smells">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4>${noSmellsMessage || 'No Code Smells Detected'}</h4>
                    <p>The code appears to be clean with no significant code smells.</p>
                </div>
        `;
    }
    
    contentHtml += `
            </div>
        </div>
    `;
    
    modal.innerHTML = contentHtml;
    
    // Add to page
    document.body.appendChild(modal);
    
    // Animate in
    setTimeout(() => modal.classList.add('show'), 10);
    
    // Trigger syntax highlighting
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Code context toggle functionality
function toggleCodeContext(issueIndex) {
    console.log('Toggling code context for issue:', issueIndex);
    const contextElement = document.getElementById(`codeContext${issueIndex}`);
    
    if (!contextElement) {
        console.error('Code context element not found for issue:', issueIndex);
        return;
    }
    
    const expandIcon = contextElement.parentElement.querySelector('.context-expand-icon');
    
    if (contextElement.style.display === 'none' || contextElement.style.display === '') {
        contextElement.style.display = 'block';
        if (expandIcon) expandIcon.style.transform = 'rotate(180deg)';
        console.log('Expanded code context for issue', issueIndex);
        
        // Trigger syntax highlighting for newly visible code
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
    } else {
        contextElement.style.display = 'none';
        if (expandIcon) expandIcon.style.transform = 'rotate(0deg)';
        console.log('Collapsed code context for issue', issueIndex);
    }
}

function displayIssues(issues) {
    const issuesList = document.getElementById('issuesList');
    
    if (issues.length === 0) {
        issuesList.innerHTML = `
            <div class="no-issues" data-aos="fade-up">
                <i class="fas fa-check-circle"></i>
                <h3>No Security Issues Found!</h3>
                <p>Your code appears to be secure. Great job!</p>
            </div>
        `;
        return;
    }
    
    issuesList.innerHTML = issues.map((issue, index) => `
        <div class="issue-item" data-severity="${issue.severity}" data-category="${issue.vulnerability_category}">
            <!-- Issue Summary (Only File Path - Always Visible) -->
            <div class="issue-summary" data-issue-index="${index + 1}" onclick="toggleIssueDetail('${index + 1}')">
                <div class="issue-header">
                    <div class="issue-file-info">
                        <i class="fas fa-file-code"></i>
                        <span class="file-name">${escapeHtml(issue.file)}</span>
                    </div>
                    <div class="issue-meta">
                        <i class="fas fa-chevron-down expand-icon"></i>
                    </div>
                </div>
            </div>
            
            <!-- Issue Details (Expandable) -->
            <div class="issue-details" id="issueDetails${index + 1}" style="display: none;">
                <div class="details-content">
                    <!-- Severity and Issue Information -->
                    <div class="detail-section">
                        <div class="issue-info-grid">
                            <div class="severity-info">
                                <span class="severity-badge severity-${issue.severity}">${issue.severity.toUpperCase()}</span>
                            </div>
                            <div class="issue-type-info">
                                <span class="cwe-badge">CWE: ${issue.cwe || 'N/A'}</span>
                            </div>
                            <div class="vulnerability-name">
                                <h4>${escapeHtml(issue.vulnerability_name || issue.issue)}</h4>
                            </div>
                            <div class="vulnerability-description">
                                <p>${escapeHtml(issue.description || issue.explanation)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Details -->
                    <div class="detail-section">
                        <h5><i class="fas fa-info-circle"></i> Additional Information</h5>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>File Path & Location:</label>
                                <span>${escapeHtml(issue.file)}:${issue.line}</span>
                            </div>
                            <div class="detail-item">
                                <label>Issue Type:</label>
                                <span>${escapeHtml(issue.issue)}</span>
                            </div>
                            <div class="detail-item">
                                <label>CWE:</label>
                                <span>${issue.cwe || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>OWASP:</label>
                                <span>${issue.owasp || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Category:</label>
                                <span>${escapeHtml(issue.vulnerability_category)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Module:</label>
                                <span>${escapeHtml(issue.module_category)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Priority Score:</label>
                                <span>${issue.priority_score}/100</span>
                            </div>
                            <div class="detail-item">
                                <label>Detected At:</label>
                                <span>${issue.detected_at ? issue.detected_at.substring(0, 19) : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Full Code Context Section -->
                    <div class="code-context-section">
                        <button class="code-context-toggle" onclick="toggleCodeContext('${index + 1}')">
                            <i class="fas fa-code"></i>
                            <span>Full Code Context</span>
                            <i class="fas fa-chevron-down context-expand-icon"></i>
                        </button>
                        <div class="code-context-content" id="codeContext${index + 1}" style="display: none;">
                            <div class="code-context-header">
                                <span>File: ${escapeHtml(issue.file)}</span>
                                <span>Issue Line: ${issue.line}</span>
                            </div>
                            <div class="code-context-lines">
                                ${issue.context ? issue.context.map((line, i) => {
                                    const lineNum = issue.line - Math.floor(issue.context.length / 2) + i;
                                    const isIssueLine = lineNum === issue.line;
                                    return `
                                        <div class="context-line ${isIssueLine ? 'issue-line' : ''}">
                                            <span class="line-number">${lineNum}</span>
                                            <code class="language-javascript">${escapeHtml(line)}</code>
                                            ${isIssueLine ? `
                                                <div class="code-actions">
                                                    <button class="auto-fix-btn" onclick="autoFixIssue('${currentScanId || ''}', ${index + 1}, ${JSON.stringify(issue).replace(/"/g, '&quot;')}, this)">
                                                        <i class="fas fa-magic"></i>
                                                        <span>Auto-Fix</span>
                                                    </button>
                                                    <button class="code-smell-btn" onclick="detectCodeSmell('${issue.file}', ${issue.line}, '${issue.file}', this)">
                                                        <i class="fas fa-diagnoses"></i>
                                                        <span>Code Smell</span>
                                                    </button>
                                                    <button class="editor-btn" onclick="openInEditor('${currentScanId || ''}', '${issue.file.replace(/'/g, "\\'")}', ${issue.line})">
                                                        <i class="fas fa-edit"></i>
                                                        <span>Open in Editor</span>
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('') : `
                                    <div class="context-line issue-line">
                                        <span class="line-number">${issue.line}</span>
                                        <code class="language-javascript">${escapeHtml(issue.code)}</code>
                                        <div class="code-actions">
                                            <button class="auto-fix-btn" onclick="autoFixIssue('${currentScanId || ''}', ${index + 1}, ${JSON.stringify(issue).replace(/"/g, '&quot;')}, this)">
                                                <i class="fas fa-magic"></i>
                                                <span>Auto-Fix</span>
                                            </button>
                                            <button class="code-smell-btn" onclick="detectCodeSmell('${issue.file}', ${issue.line}, '${issue.file}', this)">
                                                <i class="fas fa-diagnoses"></i>
                                                <span>Code Smell</span>
                                            </button>
                                            <button class="editor-btn" onclick="openInEditor('${currentScanId || ''}', '${issue.file.replace(/'/g, "\\'")}', ${issue.line})">
                                                <i class="fas fa-edit"></i>
                                                <span>Open in Editor</span>
                                            </button>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    // Trigger syntax highlighting after content is loaded
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
    
    // Add staggered entrance animations
    setTimeout(() => {
        document.querySelectorAll('.issue-item').forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 150);
        });
    }, 100);
}

function displayFiles(files) {
    const filesList = document.getElementById('filesList');
    
    filesList.innerHTML = files.map(file => {
        const languageIcon = getLanguageIcon(file.language);
        
        return `
            <div class="file-card ${file.status}">
                <div class="file-icon">
                    ${languageIcon}
                </div>
                <div class="file-info">
                    <div class="file-name">${escapeHtml(file.file)}</div>
                    <div class="file-language">${escapeHtml(file.language)}</div>
                </div>
                <div class="file-status">
                    ${file.status === 'clean' ? 
                        '<i class="fas fa-check-circle"></i><span>Clean</span>' : 
                        '<i class="fas fa-exclamation-triangle"></i><span>Issues</span>'
                    }
                </div>
            </div>
        `;
    }).join('');
}

function displaySummary(results) {
    const summaryContent = document.getElementById('summaryContent');
    
    const languages = results.languages.join(', ');
    const totalFiles = results.file_status.length;
    const cleanFiles = results.file_status.filter(f => f.status === 'clean').length;
    const issuesFound = totalFiles - cleanFiles; // files with issues
    
    summaryContent.innerHTML = `
        <div class="summary-info">
            <h4><i class="fas fa-info-circle"></i> Scan Summary</h4>
            <div class="summary-details">
                <p><strong>Repository:</strong> ${escapeHtml(results.repo_path)}</p>
                <p><strong>Languages Detected:</strong> ${escapeHtml(languages)}</p>
                <p><strong>Total Files Scanned:</strong> ${totalFiles}</p>
                <p><strong>Security Issues Found:</strong> ${issuesFound}</p>
                <p><strong>Clean Files:</strong> ${cleanFiles}</p>
                <p><strong>Scan Completed:</strong> ${new Date(results.completed_at).toLocaleString()}</p>
            </div>
        </div>
        
        ${issuesFound > 0 ? `
            <div class="summary-recommendations">
                <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
                <ul>
                    <li>Review all identified security issues</li>
                    <li>Apply the suggested fixes</li>
                    <li>Consider running additional security tests</li>
                    <li>Implement secure coding practices</li>
                </ul>
            </div>
        ` : `
            <div class="summary-success">
                <h4><i class="fas fa-check-circle"></i> Great Job!</h4>
                <p>No security issues were found in your code. Keep up the good work!</p>
            </div>
        `}
    `;
}

function getLanguageIcon(language) {
    const icons = {
        'python': '<i class="fab fa-python"></i>',
        'javascript': '<i class="fab fa-js-square"></i>',
        'java': '<i class="fab fa-java"></i>',
        'html': '<i class="fab fa-html5"></i>',
        'c': '<i class="fas fa-code"></i>',
        'css': '<i class="fab fa-css3-alt"></i>',
        'php': '<i class="fab fa-php"></i>',
        'ruby': '<i class="fas fa-gem"></i>',
        'go': '<i class="fas fa-code"></i>',
        'rust': '<i class="fas fa-code"></i>',
        'typescript': '<i class="fab fa-js-square"></i>',
        'default': '<i class="fas fa-file"></i>'
    };
    
    return icons[language.toLowerCase()] || icons.default;
}

function getLanguageFromFile(filename) {
    if (filename.endsWith('.py')) {
        return 'python';
    } else if (filename.endsWith('.js')) {
        return 'javascript';
    } else if (filename.endsWith('.java')) {
        return 'java';
    } else if (filename.endsWith('.html')) {
        return 'html';
    } else if (filename.endsWith('.css')) {
        return 'css';
    } else if (filename.endsWith('.c')) {
        return 'c';
    } else if (filename.endsWith('.cpp') || filename.endsWith('.cc')) {
        return 'cpp';
    } else if (filename.endsWith('.php')) {
        return 'php';
    } else if (filename.endsWith('.rb')) {
        return 'ruby';
    } else if (filename.endsWith('.go')) {
        return 'go';
    } else if (filename.endsWith('.rs')) {
        return 'rust';
    } else if (filename.endsWith('.ts')) {
        return 'typescript';
    } else {
        return 'text';
    }
}

// Tab functionality
function showTab(event, tabName) {
    // Hide all tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab panel
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Add active class to clicked button
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    } else if (event && event.target) {
        event.target.classList.add('active');
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    // Create a simple error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-notification';
    errorDiv.innerHTML = `
        <div style="background: #f5576c; color: white; padding: 15px; border-radius: 8px; margin: 20px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-exclamation-triangle"></i>
            <span>${escapeHtml(message)}</span>
        </div>
    `;
    
    // Insert at the top of the main content
    const mainContent = document.querySelector('.main-content');
    mainContent.insertBefore(errorDiv, mainContent.firstChild);
    
    // Remove after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

function startNewScan() {
    // Reset the forms and hide results
    scanForm.reset();
    uploadForm.reset();
    resultsSection.classList.add('hidden');
    progressSection.classList.add('hidden');
    
    // Show the form container again
    const scanFormContainer = document.getElementById('scanFormContainer');
    if (scanFormContainer) {
        scanFormContainer.style.display = 'block';
    }
    
    // Reset file upload display
    if (fileUploadWrapper) {
        fileUploadWrapper.classList.remove('has-file');
        const fileNameDisplay = document.querySelector('.file-name-display');
        if (fileNameDisplay) {
            fileNameDisplay.remove();
        }
        const fileUploadLabel = document.querySelector('.file-upload-label');
        const fileUploadInfo = document.querySelector('.file-upload-info');
        if (fileUploadLabel && fileUploadInfo) {
            fileUploadLabel.textContent = 'Choose file or drag & drop';
            fileUploadInfo.textContent = 'Supports single files and zip archives (max 500MB)';
        }
    }
    
    // Clear any existing scan data
    currentScanId = null;
    if (statusInterval) {
        clearInterval(statusInterval);
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function downloadReport() {
    if (currentScanId) {
        window.open(`/results/${currentScanId}/download.xlsx`, '_blank');
    }
}

async function loadExistingScan(scanId) {
    try {
        const response = await fetch(`/results/${scanId}`);
        const results = await response.json();
        
        if (response.ok) {
            currentScanId = scanId;
            // Update scan ID display
            const scanIdElement = document.getElementById('scanId');
            if (scanIdElement) {
                scanIdElement.textContent = scanId;
            }
            
            // Hide the form container and progress section
            const scanFormContainer = document.getElementById('scanFormContainer');
            if (scanFormContainer) {
                scanFormContainer.style.display = 'none';
            }
            progressSection.classList.add('hidden');
            
            // Display results and show results section
            displayResults(results);
            showResults();
            
            // Enable forms (they're hidden anyway, but good for state consistency)
            enableForm();
            enableUploadForm();
        } else {
            console.error('Failed to load existing scan');
            showError('Failed to load scan results: ' + (results.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading existing scan:', error);
        showError('Failed to load scan results: ' + error.message);
    }
}

// Main tab switching functionality
function setupMainTabSwitching() {
    const scannerPanel = document.getElementById('scannerPanel');
    const pastScansPanel = document.getElementById('pastScansPanel');
    const tabBtns = document.querySelectorAll('.main-tab-btn');
    
    // Add click handlers to tab buttons
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            switchMainTab(target);
        });
    });
}

function switchMainTab(tabName) {
    console.log('Switching to tab:', tabName);
    
    // Update tab buttons
    document.querySelectorAll('.main-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide panels
    const scannerPanel = document.getElementById('scannerPanel');
    const pastScansPanel = document.getElementById('pastScansPanel');
    const vulnerabilitiesPanel = document.getElementById('vulnerabilitiesPanel');
    const editorPanel = document.getElementById('editorPanel');
    const performancePanel = document.getElementById('performancePanel');
    
    // Check if panels exist
    if (!scannerPanel || !pastScansPanel || !vulnerabilitiesPanel || !editorPanel) {
        console.error('One or more panels not found:', {
            scannerPanel: !!scannerPanel,
            pastScansPanel: !!pastScansPanel,
            vulnerabilitiesPanel: !!vulnerabilitiesPanel,
            editorPanel: !!editorPanel,
            performancePanel: !!performancePanel
        });
        return;
    }
    
    // Hide all panels first - remove active and add hidden
    [scannerPanel, pastScansPanel, vulnerabilitiesPanel, editorPanel, performancePanel].forEach(panel => {
        if (panel) {
            panel.classList.remove('active');
            panel.classList.add('hidden');
        }
    });
    
    // Show selected panel - remove hidden FIRST, then add active
    let selectedPanel = null;
    if (tabName === 'scanner') {
        selectedPanel = scannerPanel;
    } else if (tabName === 'past-scans') {
        selectedPanel = pastScansPanel;
        // Load scans when switching to Past Scans tab
        loadPastScans();
    } else if (tabName === 'vulnerabilities') {
        selectedPanel = vulnerabilitiesPanel;
        // Load vulnerabilities when switching to Vulnerabilities tab
        loadVulnerabilities();
    } else if (tabName === 'editor') {
        selectedPanel = editorPanel;
        loadEditorScans();
    } else if (tabName === 'performance') {
        selectedPanel = performancePanel;
        refreshPerformanceData();
    }
    
    if (selectedPanel) {
        // Remove hidden first (important: must remove before adding active)
        selectedPanel.classList.remove('hidden');
        selectedPanel.classList.add('active');
        console.log('Panel activated:', tabName);
    } else {
        console.error('No panel found for tab:', tabName);
    }
}

// Load past scans from API
async function loadPastScans() {
    const scansLoading = document.getElementById('scansLoading');
    const scansError = document.getElementById('scansError');
    const scansList = document.getElementById('scansList');
    const noScans = document.getElementById('noScans');
    
    // Show loading state
    scansLoading.classList.remove('hidden');
    scansError.classList.add('hidden');
    scansList.innerHTML = '';
    noScans.classList.add('hidden');
    
    try {
        const response = await fetch('/api/scans');
        const data = await response.json();
        
        scansLoading.classList.add('hidden');
        
        if (response.ok && data.scans && data.scans.length > 0) {
            displayScansList(data.scans);
            scansList.classList.remove('hidden');
        } else {
            // No scans found
            scansList.classList.add('hidden');
            noScans.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading scans:', error);
        scansLoading.classList.add('hidden');
        scansError.classList.remove('hidden');
    }
}

// Display list of scans
function displayScansList(scans) {
    const scansList = document.getElementById('scansList');
    
    scansList.innerHTML = scans.map(scan => {
        const scanDate = new Date(scan.started_at).toLocaleString();
        const stats = scan.stats || {};
        const severityStats = stats.by_severity || {};
        
        return `
            <div class="scan-item" onclick="loadScan('${scan.scan_id}')">
                <div class="scan-item-header">
                    <div>
                        <h3>${escapeHtml(scan.project_name || 'Unnamed Project')}</h3>
                        <span class="scan-date">
                            <i class="fas fa-calendar"></i> ${scanDate}
                        </span>
                    </div>
                    <div class="scan-item-actions">
                        <button class="btn-load" onclick="event.stopPropagation(); loadScan('${scan.scan_id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn-secondary" onclick="event.stopPropagation(); downloadScanResults('${scan.scan_id}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="scan-item-info">
                    <div class="info-row">
                        <span><i class="fas fa-file-code"></i> ${scan.files_scanned || 0} files</span>
                        <span><i class="fas fa-database"></i> ${formatBytes(scan.bytes_scanned || 0)}</span>
                        <span><i class="fas fa-code-branch"></i> ${scan.ref || 'HEAD'}</span>
                    </div>
                </div>
                ${Object.keys(severityStats).length > 0 ? `
                    <div class="scan-item-stats">
                        ${severityStats.critical ? `<span class="severity-badge severity-critical">Critical: ${severityStats.critical}</span>` : ''}
                        ${severityStats.high ? `<span class="severity-badge severity-high">High: ${severityStats.high}</span>` : ''}
                        ${severityStats.medium ? `<span class="severity-badge severity-medium">Medium: ${severityStats.medium}</span>` : ''}
                        ${severityStats.low ? `<span class="severity-badge severity-low">Low: ${severityStats.low}</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Load a specific scan
async function loadScan(scanId) {
    // Switch back to scanner panel
    const scannerPanel = document.getElementById('scannerPanel');
    const pastScansPanel = document.getElementById('pastScansPanel');
    
    // Update tab buttons
    document.querySelectorAll('.main-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.main-tab-btn[onclick*="scanner"]').classList.add('active');
    
    // Show scanner panel
    scannerPanel.classList.remove('hidden');
    scannerPanel.classList.add('active');
    pastScansPanel.classList.add('hidden');
    pastScansPanel.classList.remove('active');
    
    // Load the scan results
    await loadExistingScan(scanId);
}

// Refresh scans list
function refreshScans() {
    loadPastScans();
}

// Download scan results
function downloadScanResults(scanId) {
    window.open(`/results/${scanId}/download.xlsx`, '_blank');
}

// Format bytes to human readable format
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Load vulnerabilities from all databases
async function loadVulnerabilities() {
    const vulnsLoading = document.getElementById('vulnsLoading');
    const vulnsError = document.getElementById('vulnsError');
    const vulnsContent = document.getElementById('vulnsContent');
    
    // Show loading state
    vulnsLoading.classList.remove('hidden');
    vulnsError.classList.add('hidden');
    vulnsContent.classList.add('hidden');
    
    try {
        const response = await fetch('/api/vulnerabilities/all');
        const data = await response.json();
        
        console.log('[Vulnerabilities] API Response:', response.status, data);
        
        vulnsLoading.classList.add('hidden');
        
        if (response.ok && data.total_vulnerabilities >= 0) {
            displayVulnerabilities(data);
            vulnsContent.classList.remove('hidden');
        } else {
            throw new Error(data.error || 'Failed to load vulnerabilities');
        }
    } catch (error) {
        console.error('Error loading vulnerabilities:', error);
        vulnsLoading.classList.add('hidden');
        vulnsError.classList.remove('hidden');
    }
}

// Display vulnerability data
function displayVulnerabilities(data) {
    const isLight = document.body.classList.contains('light-mode');
    const colors = isLight ? lightColors : darkColors;
    
    // Update summary stats
    if (window.animateNumbers) {
        window.animateNumbers(document.getElementById('totalVulnerabilities'), data.total_vulnerabilities);
        window.animateNumbers(document.getElementById('criticalVulns'), data.by_severity.critical || 0);
        window.animateNumbers(document.getElementById('highVulns'), data.by_severity.high || 0);
        window.animateNumbers(document.getElementById('totalDatabases'), data.total_databases);
    }
    
    // Create charts
    createVulnCharts(data, colors);
    
    // Populate vulnerability table
    populateVulnTable(data);
}

// Create vulnerability charts
function createVulnCharts(data, colors) {
    // Chart 1: By Severity
    const ctx1 = document.getElementById('vulnsBySeverityChart');
    if (ctx1) {
        const severityData = data.by_severity || {};
        const labels = Object.keys(severityData);
        const values = Object.values(severityData);
        const severityColors = {
            'critical': '#FF6B6B',
            'high': '#FFA726',
            'medium': '#66BB6A',
            'low': '#42A5F5',
            'unknown': '#9E9E9E'
        };
        
        if (charts.vulnsBySeverity) {
            charts.vulnsBySeverity.destroy();
        }
        
        charts.vulnsBySeverity = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                datasets: [{
                    label: 'Vulnerabilities',
                    data: values,
                    backgroundColor: labels.map(l => severityColors[l] || '#9E9E9E'),
                    borderColor: labels.map(l => severityColors[l] || '#9E9E9E'),
                    borderWidth: 0
                }]
            },
            options: {
                ...chartConfig,
                indexAxis: 'x',
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Severity',
                            color: document.body.classList.contains('light-mode') ? '#0f172a' : '#00e5ff',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: document.body.classList.contains('light-mode') ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('light-mode') ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count',
                            color: document.body.classList.contains('light-mode') ? '#0f172a' : '#00e5ff',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: document.body.classList.contains('light-mode') ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('light-mode') ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    legend: { display: false }
                }
            }
        });
    }
    
    // Chart 2: By Category
    const ctx2 = document.getElementById('vulnsByCategoryChart');
    if (ctx2) {
        let categoryData = data.by_category || {};
        
        // If category data is empty or only has 'General', compute from types
        if (Object.keys(categoryData).length === 0 || 
            (Object.keys(categoryData).length === 1 && Object.keys(categoryData)[0] === 'General')) {
            const typeData = data.by_type || {};
            categoryData = {};
            
            // Aggregate by category from types
            Object.keys(typeData).forEach(type => {
                const category = getVulnerabilityCategory(type);
                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += typeData[type];
            });
        }
        
        const labels = Object.keys(categoryData);
        const values = Object.values(categoryData);
        
        // Define category-specific colors for better distinction
        const categoryColors = {
            'Injection': '#FF6B6B',
            'Access Control': '#FFA726',
            'Cryptography': '#4ECDC4',
            'Cryptographic Failures': '#45B7D1',
            'Authentication': '#96CEB4',
            'Memory Management': '#FFEAA7',
            'API Misuse': '#DDA0DD',
            'Data Integrity': '#98D8C8',
            'Network Security': '#F7DC6F',
            'Configuration': '#BB8FCE',
            'Concurrency': '#FF9FF3',
            'General': '#9E9E9E'
        };
        
        // Generate colors for labels, use category-specific colors if available
        const backgroundColors = labels.map(label => {
            // Try exact match first
            if (categoryColors[label]) {
                return categoryColors[label];
            }
            // Try to find partial match
            const partialMatch = Object.keys(categoryColors).find(key => 
                label.toLowerCase().includes(key.toLowerCase()) || 
                key.toLowerCase().includes(label.toLowerCase())
            );
            if (partialMatch) {
                return categoryColors[partialMatch];
            }
            // Fall back to color palette
            return colors.primary[labels.indexOf(label) % colors.primary.length];
        });
        
        if (charts.vulnsByCategory) {
            charts.vulnsByCategory.destroy();
        }
        
        const isLight = document.body.classList.contains('light-mode');
        
        charts.vulnsByCategory = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: labels.map(l => {
                    // Format label names for better display
                    return l.replace(/([A-Z])/g, ' $1').trim() || l;
                }),
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColors,
                    borderWidth: 0,
                    hoverBorderWidth: 0,
                    borderColor: 'transparent'
                }]
            },
            options: {
                ...chartConfig,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    legend: {
                        ...chartConfig.plugins.legend,
                        position: 'right',
                        align: 'start',
                        labels: {
                            ...chartConfig.plugins.legend.labels,
                            color: isLight ? '#0f172a' : '#b3e5fc',
                            padding: 8,
                            boxWidth: 12,
                            boxHeight: 12,
                            font: {
                                size: 11,
                                weight: '400',
                                family: 'Inter, sans-serif'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const dataset = data.datasets[0];
                                    const legendTextColor = isLight ? '#0f172a' : '#e6f7ff';
                                    return data.labels.map((label, i) => {
                                        const value = dataset.data[i];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: 'transparent',
                                            lineWidth: 0,
                                            fontColor: legendTextColor,
                                            color: legendTextColor,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        ...chartConfig.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Chart 3: By Language
    const ctx3 = document.getElementById('vulnsByLanguageChart');
    if (ctx3) {
        const langData = data.by_language || {};
        const labels = Object.keys(langData);
        const values = Object.values(langData);
        
        if (charts.vulnsByLanguage) {
            charts.vulnsByLanguage.destroy();
        }
        
        charts.vulnsByLanguage = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Vulnerabilities',
                    data: values,
                    backgroundColor: colors.primary.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                ...chartConfig,
                indexAxis: 'x',
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Language',
                            color: document.body.classList.contains('light-mode') ? '#0f172a' : '#00e5ff',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: document.body.classList.contains('light-mode') ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('light-mode') ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count',
                            color: document.body.classList.contains('light-mode') ? '#0f172a' : '#00e5ff',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: document.body.classList.contains('light-mode') ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('light-mode') ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    legend: { display: false }
                }
            }
        });
    }
    
    // Chart 4: By Type (Ranked)
    const ctx4 = document.getElementById('vulnsByTypeChart');
    if (ctx4) {
        const typeData = data.by_type || {};
        const sortedTypes = Object.entries(typeData)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Top 10
        
        const values = sortedTypes.map(t => t[1]);
        const total = values.reduce((a, b) => a + b, 0);
        
        // Debug: Log the number of types
        console.log(`[Vuln Chart] Processing ${sortedTypes.length} vulnerability types:`, sortedTypes.map(t => t[0]));
        
        // Format labels with percentages (similar to donut chart)
        const labels = sortedTypes.map(t => {
            const typeName = t[0];
            const count = t[1];
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
            // Format type name (replace hyphens with spaces, capitalize words)
            const formattedName = typeName
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
            return `${formattedName} (${percentage}%)`;
        });
        
        console.log(`[Vuln Chart] Created ${labels.length} labels, ${values.length} values`);
        
        const isLight = document.body.classList.contains('light-mode');
        
        if (charts.vulnsByType) {
            charts.vulnsByType.destroy();
        }
        
        charts.vulnsByType = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: values,
                    backgroundColor: colors.primary.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                ...chartConfig,
                indexAxis: 'y',
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count',
                            color: isLight ? '#0f172a' : '#b3e5fc',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: isLight ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            }
                        },
                        grid: {
                            color: isLight ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Vulnerability Type',
                            color: isLight ? '#0f172a' : '#00e5ff',
                            font: {
                                size: 12,
                                weight: '500',
                                family: 'Inter, sans-serif'
                            }
                        },
                        ticks: {
                            color: isLight ? '#64748b' : '#b3e5fc',
                            font: {
                                size: 11,
                                family: 'Inter, sans-serif'
                            },
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            color: isLight ? 'rgba(15, 23, 42, 0.1)' : 'rgba(226, 247, 255, 0.1)'
                        },
                        afterFit: function(scale) {
                            scale.width = scale.width + 20;
                        }
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    legend: { display: false }
                }
            }
        });
    }
}

// Map vulnerability type to category (based on SECURITY_CATEGORIES from security_policies.py)
function getVulnerabilityCategory(issueType) {
    const categoryMap = {
        // Injection vulnerabilities
        'sql-injection': 'Injection',
        'nosql-injection': 'Injection',
        'command-injection': 'Injection',
        'ldap-injection': 'Injection',
        'code-injection': 'Injection',
        'improper-input-validation': 'Injection',
        'missing-output-encoding': 'Injection',
        'unsafe-json-parsing': 'Injection',
        
        // Access Control vulnerabilities
        'path-traversal': 'Access Control',
        'privilege-escalation': 'Access Control',
        'information-exposure': 'Access Control',
        
        // Cryptography vulnerabilities
        'weak-crypto': 'Cryptography',
        'insecure-randomness': 'Cryptography',
        'tls-issues': 'Cryptography',
        'insecure-storage': 'Cryptographic Failures',
        
        // Authentication vulnerabilities
        'hardcoded-secret': 'Authentication',
        
        // Memory Management vulnerabilities
        'buffer-overflow': 'Memory Management',
        'memory-leak': 'Memory Management',
        'unsafe-code': 'Memory Management',
        
        // API Misuse vulnerabilities
        'banned-api': 'API Misuse',
        
        // Data Integrity vulnerabilities
        'insecure-deserialization': 'Data Integrity',
        
        // Network Security vulnerabilities
        'ssrf': 'Network Security',
        
        // Configuration vulnerabilities
        'xxe': 'Configuration',
        
        // Concurrency vulnerabilities
        'race-condition': 'Concurrency',
        
        // Cross-Site Scripting
        'xss': 'Injection'
    };
    return categoryMap[issueType.toLowerCase()] || 'General';
}

// Map vulnerability type to severity
function getVulnerabilitySeverity(issueType) {
    const severityMap = {
        'sql-injection': 'critical',
        'nosql-injection': 'critical',
        'command-injection': 'critical',
        'ldap-injection': 'critical',
        'xss': 'high',
        'path-traversal': 'high',
        'hardcoded-secret': 'critical',
        'code-injection': 'critical',
        'insecure-deserialization': 'high',
        'ssrf': 'high',
        'buffer-overflow': 'high',
        'insecure-storage': 'high',
        'weak-crypto': 'medium',
        'insecure-randomness': 'medium',
        'tls-issues': 'medium',
        'unsafe-code': 'medium',
        'banned-api': 'medium',
        'memory-leak': 'medium',
        'improper-input-validation': 'medium',
        'missing-output-encoding': 'medium',
        'information-exposure': 'medium',
        'unsafe-json-parsing': 'medium'
    };
    return severityMap[issueType.toLowerCase()] || 'medium';
}

// Populate vulnerability table
function populateVulnTable(data) {
    const tbody = document.getElementById('vulnsTableBody');
    const typeData = data.by_type || {};
    const total = data.total_vulnerabilities || 1;
    
    // Sort by count (descending)
    const sortedTypes = Object.entries(typeData).sort((a, b) => b[1] - a[1]);
    
    tbody.innerHTML = sortedTypes.map(([type, count], index) => {
        const percentage = ((count / total) * 100).toFixed(1);
        const category = getVulnerabilityCategory(type);
        const severity = getVulnerabilitySeverity(type);
        const severityLabel = severity.charAt(0).toUpperCase() + severity.slice(1);
        
        return `
            <tr class="vuln-row" data-severity="${severity}" data-category="${category.toLowerCase().replace(/\s+/g, '-')}">
                <td class="rank-cell">
                    <span class="rank-badge">${index + 1}</span>
                </td>
                <td class="type-cell">
                    <div class="type-wrapper">
                        <i class="fas fa-shield-virus type-icon"></i>
                        <span class="type-name">${escapeHtml(type)}</span>
                    </div>
                </td>
                <td class="severity-cell">
                    <span class="severity-badge severity-${severity}">${severityLabel}</span>
                </td>
                <td class="category-cell">
                    <span class="category-tag">${escapeHtml(category)}</span>
                </td>
                <td class="count-cell">
                    <span class="count-value">${count}</span>
                </td>
                <td class="percentage-cell">
                    <div class="percentage-wrapper">
                        <span class="percentage-value">${percentage}%</span>
                        <div class="percentage-bar">
                            <div class="percentage-fill" style="width: ${percentage}%" data-severity="${severity}"></div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // Populate category filter dropdown
    const categoryFilter = document.getElementById('vulnCategoryFilter');
    if (categoryFilter) {
        const categories = [...new Set(sortedTypes.map(([type]) => getVulnerabilityCategory(type)))].sort();
        categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
            categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
    }
    
    // Setup table filtering
    setupVulnTableFilters(data);
}

// Setup vulnerability table filters
function setupVulnTableFilters(data) {
    const severityFilter = document.getElementById('vulnSeverityFilter');
    const categoryFilter = document.getElementById('vulnCategoryFilter');
    const searchInput = document.getElementById('vulnSearch');
    const tbody = document.getElementById('vulnsTableBody');
    
    if (!severityFilter || !categoryFilter || !searchInput || !tbody) return;
    
    const applyFilters = () => {
        const severityValue = severityFilter.value;
        const categoryValue = categoryFilter.value;
        const searchValue = searchInput.value.toLowerCase().trim();
        
        const rows = tbody.querySelectorAll('tr.vuln-row');
        rows.forEach(row => {
            const type = row.querySelector('.type-name')?.textContent.toLowerCase() || '';
            const category = row.querySelector('.category-tag')?.textContent || '';
            const severity = row.dataset.severity || '';
            
            const matchesSeverity = severityValue === 'all' || severity === severityValue;
            const matchesCategory = categoryValue === 'all' || category === categoryValue;
            const matchesSearch = !searchValue || 
                type.includes(searchValue) || 
                category.toLowerCase().includes(searchValue);
            
            row.style.display = (matchesSeverity && matchesCategory && matchesSearch) ? '' : 'none';
        });
    };
    
    severityFilter.addEventListener('change', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
}

// Refresh vulnerabilities
function refreshVulnerabilities() {
    loadVulnerabilities();
}

// =====================================
// Editor Functionality
// =====================================

let currentEditor = null;
let currentEditorScanId = null;
let currentEditorFilePath = null;
let fileIssueLines = {}; // Store issue lines per file: { filePath: [line1, line2, ...] }
let fileIssueDetails = {}; // Store issue details per file: { filePath: { lineNum: { severity, description, ... } } }

// Map language names to CodeMirror modes
function getCodeMirrorMode(language) {
    const modeMap = {
        'python': 'python',
        'javascript': 'javascript',
        'typescript': 'javascript',
        'java': 'clike',
        'cpp': 'clike',
        'c': 'clike',
        'csharp': 'clike',
        'go': 'go',
        'rust': 'rust',
        'ruby': 'ruby',
        'php': 'php',
        'html': 'xml',
        'xml': 'xml',
        'sql': 'sql',
        'shell': 'shell',
        'bash': 'shell',
        'sh': 'shell'
    };
    return modeMap[language.toLowerCase()] || 'text';
}

// Initialize Code Editor
function initCodeEditor(element, language, content, highlightLines = null) {
    // Clean up existing editor if any
    if (currentEditor && currentEditor.toTextArea) {
        const textarea = currentEditor.getTextArea();
        if (textarea && textarea.parentNode) {
            currentEditor.toTextArea();
        }
    }
    
    // Option 1: Use CodeMirror (lightweight)
    if (typeof CodeMirror !== 'undefined') {
        const mode = getCodeMirrorMode(language);
        currentEditor = CodeMirror(element, {
            value: content,
            mode: mode,
            lineNumbers: true,
            theme: 'monokai',
            indentUnit: 4,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentWithTabs: false,
            tabSize: 4
        });
        
        // Highlight specific lines if provided
        if (highlightLines && highlightLines.length > 0) {
            // Convert to array if single number provided
            const linesToHighlight = Array.isArray(highlightLines) ? highlightLines : [highlightLines];
            
            linesToHighlight.forEach(lineNumber => {
                if (lineNumber !== null && lineNumber > 0) {
                    // Convert to 0-based index (CodeMirror uses 0-based line numbers)
                    const lineIndex = lineNumber - 1;
                    
                    // Check if line exists in editor
                    if (lineIndex < currentEditor.lineCount()) {
                        // Add CSS class to highlight the line
                        currentEditor.addLineClass(lineIndex, 'background', 'issue-line-highlight');
                        
                        // Get issue details for this line
                        const issueDetails = fileIssueDetails[currentEditorFilePath]?.[lineNumber];
                        
                        // Add Issue button widget on this line
                        if (issueDetails) {
                            const widgetElement = document.createElement('div');
                            widgetElement.className = 'issue-line-widget';
                            
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'issue-widget-buttons';
                            
                            // Issue button
                            const issueButton = document.createElement('button');
                            issueButton.className = 'issue-btn';
                            issueButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Issue</span>';
                            issueButton.onclick = (e) => {
                                e.stopPropagation();
                                showIssuePopup(e, lineNumber, issueDetails);
                            };
                            
                            // Auto-Fix button
                            const autoFixButton = document.createElement('button');
                            autoFixButton.className = 'auto-fix-editor-btn';
                            autoFixButton.innerHTML = '<i class="fas fa-magic"></i><span>Auto-Fix</span>';
                            autoFixButton.onclick = (e) => {
                                e.stopPropagation();
                                autoFixEditorIssue(lineNumber, issueDetails);
                            };
                            
                            buttonContainer.appendChild(issueButton);
                            buttonContainer.appendChild(autoFixButton);
                            widgetElement.appendChild(buttonContainer);
                            
                            // Add widget to the end of the line
                            const widget = currentEditor.addLineWidget(lineIndex, widgetElement, {
                                coverGutter: false,
                                noHScroll: false,
                                above: false,
                                showIfHidden: false
                            });
                        }
                    }
                }
            });
            
            // Scroll to the first highlighted line
            if (linesToHighlight.length > 0) {
                const firstLine = linesToHighlight[0];
                if (firstLine > 0) {
                    const lineIndex = firstLine - 1;
                    setTimeout(() => {
                        if (lineIndex < currentEditor.lineCount()) {
                            currentEditor.scrollIntoView({ line: lineIndex, ch: 0 }, 100);
                            // Focus the editor and set cursor to the first issue line
                            currentEditor.setCursor(lineIndex, 0);
                        }
                    }, 100);
                }
            }
        }
        
        // Refresh editor on resize
        setTimeout(() => {
            if (currentEditor && currentEditor.refresh) {
                currentEditor.refresh();
            }
        }, 100);
        return;
    }
    
    // Fallback: Simple textarea
    element.innerHTML = `<textarea id="codeTextarea" style="width:100%;height:600px;font-family:monospace;padding:var(--space-4);background:var(--color-bg-card);color:var(--color-text-primary);border:none;resize:none;">${escapeHtml(content)}</textarea>`;
    const textarea = document.getElementById('codeTextarea');
    currentEditor = {
        getValue: () => textarea.value,
        setValue: (val) => { textarea.value = val; },
        refresh: () => {}
    };
}

// Load scans for editor dropdown
async function loadEditorScans() {
    try {
        const response = await fetch('/api/scans');
        const data = await response.json();
        
        const select = document.getElementById('scanSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select a scan...</option>';
        
        if (data.scans && data.scans.length > 0) {
            data.scans.forEach(scan => {
                const option = document.createElement('option');
                option.value = scan.scan_id;
                option.textContent = `${scan.project_name || 'Unnamed'} - ${new Date(scan.started_at).toLocaleDateString()}`;
                select.appendChild(option);
            });
        }
        
        // Remove existing event listener by cloning select
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        
        // Add new event listener
        newSelect.addEventListener('change', async (e) => {
            currentEditorScanId = e.target.value;
            if (currentEditorScanId) {
                await loadFilesForScan(currentEditorScanId);
            } else {
                showEditorEmpty();
            }
        });
    } catch (error) {
        console.error('Error loading scans:', error);
    }
}

// Load files with issues for a scan
async function loadFilesForScan(scanId) {
    const loading = document.getElementById('editorLoading');
    const error = document.getElementById('editorError');
    const main = document.getElementById('editorMain');
    const empty = document.getElementById('editorEmpty');
    
    if (!loading || !error || !main || !empty) return;
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    main.classList.add('hidden');
    empty.classList.add('hidden');
    
    try {
        const response = await fetch(`/api/file/${scanId}/list`);
        const data = await response.json();
        
        loading.classList.add('hidden');
        
        if (data.success && data.files && data.files.length > 0) {
            // Store issue lines and details for each file
            fileIssueLines = {};
            fileIssueDetails = {};
            data.files.forEach(file => {
                fileIssueLines[file.path] = file.issue_lines || [];
                fileIssueDetails[file.path] = file.issue_details || {};
            });
            
            displayFilesList(data.files);
            main.classList.remove('hidden');
        } else {
            empty.classList.remove('hidden');
            const emptyEl = document.getElementById('editorEmpty');
            if (emptyEl) {
                emptyEl.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <h3>No Files with Issues</h3>
                    <p>This scan has no files with security issues to edit</p>
                `;
            }
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        const errorMsg = document.getElementById('editorErrorMessage');
        if (errorMsg) {
            errorMsg.textContent = err.message;
        }
    }
}

// Display files list in sidebar
function displayFilesList(files) {
    const filesList = document.getElementById('editorFilesList');
    if (!filesList) return;
    
    filesList.innerHTML = files.map(file => {
        // Store the file path in a data attribute to ensure it's preserved
        const filePath = file.path;
        const issueLines = file.issue_lines || [];
        
        // Format issue lines for display (show first few, then "and X more")
        let issueLinesDisplay = '';
        if (issueLines.length > 0) {
            const displayLines = issueLines.slice(0, 5);
            issueLinesDisplay = `<div class="issue-lines-info">Lines: ${displayLines.join(', ')}${issueLines.length > 5 ? ` (+${issueLines.length - 5} more)` : ''}</div>`;
        }
        
        return `
        <div class="file-item" data-file-path="${escapeHtml(filePath)}" data-issue-lines="${escapeHtml(JSON.stringify(issueLines))}" onclick="loadFileForEditing(event)">
            <i class="fas fa-file-code"></i>
            <div class="file-item-content">
                <span class="file-name">${escapeHtml(filePath)}</span>
                ${issueLinesDisplay}
            </div>
            <span class="issue-badge">${file.issue_count} issues</span>
        </div>
    `;
    }).join('');
}

// Load file for editing
async function loadFileForEditing(eventOrPath, highlightLine = null) {
    if (!currentEditorScanId) return;
    
    let filePath = null;
    
    // If event is passed, get path from data attribute
    if (eventOrPath && typeof eventOrPath === 'object' && eventOrPath.target) {
        const clickedElement = eventOrPath.target.closest('.file-item');
        if (clickedElement) {
            filePath = clickedElement.dataset.filePath;
        }
    } else if (typeof eventOrPath === 'string') {
        // If string is passed, use it directly
        filePath = eventOrPath;
    } else {
        // Fallback: try to get from event
        const clickedElement = event?.target?.closest('.file-item');
        if (clickedElement) {
            filePath = clickedElement.dataset.filePath || clickedElement.querySelector('.file-name')?.textContent;
        }
    }
    
    if (!filePath) {
        console.error('No file path provided');
        return;
    }
    
    // Get issue lines for this file (if not provided explicitly)
    let issueLinesToHighlight = [];
    if (highlightLine !== null) {
        // Single line highlight (from "Open in Editor" button)
        issueLinesToHighlight = [highlightLine];
    } else {
        // Auto-highlight all issue lines for this file
        issueLinesToHighlight = fileIssueLines[filePath] || [];
    }
    
    console.log('Loading file with path:', filePath, 'Highlight lines:', issueLinesToHighlight);
    
    currentEditorFilePath = filePath;
    
    // Update active file in sidebar
    document.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes(filePath)) {
            item.classList.add('active');
        }
    });
    
    const loading = document.getElementById('editorLoading');
    const error = document.getElementById('editorError');
    const main = document.getElementById('editorMain');
    
    if (!loading || !error || !main) return;
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    
    try {
        // Properly encode the file path for URL
        const encodedPath = encodeURIComponent(filePath);
        console.log('Loading file:', filePath, 'Encoded:', encodedPath);
        
        const response = await fetch(`/api/file/${currentEditorScanId}/content?file_path=${encodedPath}`);
        const data = await response.json();
        
        loading.classList.add('hidden');
        
        if (data.success) {
            const filePathEl = document.getElementById('currentFilePath');
            const fileLangEl = document.getElementById('currentFileLanguage');
            
            if (filePathEl) filePathEl.textContent = data.file_path;
            if (fileLangEl) fileLangEl.textContent = data.language || 'text';
            
            const editorContainer = document.getElementById('codeEditor');
            if (editorContainer) {
                editorContainer.innerHTML = '';
                initCodeEditor(editorContainer, data.language || 'text', data.content, issueLinesToHighlight);
            }
            
            main.classList.remove('hidden');
        } else {
            error.classList.remove('hidden');
            const errorMsg = document.getElementById('editorErrorMessage');
            if (errorMsg) {
                errorMsg.textContent = data.error || 'Failed to load file';
            }
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        const errorMsg = document.getElementById('editorErrorMessage');
        if (errorMsg) {
            errorMsg.textContent = err.message;
        }
    }
}

// Open file in editor with line highlight
async function openInEditor(scanId, filePath, lineNumber) {
    if (!scanId) {
        alert('No scan ID available. Please ensure a scan is active.');
        return;
    }
    
    // Switch to Editor panel
    switchMainTab('editor');
    
    // Wait a bit for the panel to switch
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Ensure scans are loaded
    await loadEditorScans();
    
    // Wait a bit more for scans to populate
    await new Promise(resolve => setTimeout(resolve, 200));
    
    // Set the scan ID in the dropdown
    const scanSelect = document.getElementById('scanSelect');
    if (scanSelect) {
        scanSelect.value = scanId;
        currentEditorScanId = scanId;
        
        // Load files directly instead of relying on event
        await loadFilesForScan(scanId);
        
        // Wait for files to load
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Load the file with line highlight
    await loadFileForEditing(filePath, lineNumber);
}

// Get detailed explanation for security issues
function getSecurityIssueExplanation(issueDetails) {
    const issueType = issueDetails.issue_type || '';
    const title = issueDetails.title || '';
    const description = issueDetails.description || '';
    const snippet = issueDetails.snippet || '';
    const cwe = issueDetails.cwe || '';
    
    // Check if description already contains detailed explanation
    if (description && description.length > 50 && !description.toLowerCase().includes('vulnerability detected')) {
        return description;
    }
    
    // Comprehensive explanations for all security issue types
    const securityIssueExplanations = {
        // Injection vulnerabilities
        'sql-injection': 'SQL Injection occurs when user input is directly concatenated into SQL queries without proper sanitization. Attackers can inject malicious SQL code to manipulate database operations, potentially accessing, modifying, or deleting sensitive data. Always use parameterized queries or prepared statements.',
        'nosql-injection': 'NoSQL Injection occurs when user input is directly used in NoSQL database queries without validation. Attackers can inject malicious operators to bypass authentication or access unauthorized data. Always validate and sanitize user input before using it in database queries.',
        'command-injection': 'Command Injection occurs when user input is directly incorporated into system commands without proper validation. Attackers can execute arbitrary commands on the system, potentially leading to unauthorized access or data breaches. Always validate inputs and use safe alternatives like parameterized commands.',
        'ldap-injection': 'LDAP Injection occurs when user input is directly used in LDAP queries without proper escaping. Attackers can inject malicious LDAP code to bypass authentication or access unauthorized directory information. Always use parameterized LDAP queries or proper escaping mechanisms.',
        'code-injection': 'Code Injection occurs when user input is directly executed as code, allowing attackers to execute arbitrary code on the server. This can lead to complete system compromise. Never execute user input as code. Use safe alternatives and validate all inputs.',
        
        // Cross-Site Scripting
        'xss': 'Cross-Site Scripting (XSS) occurs when untrusted user input is rendered in web pages without proper encoding. Attackers can inject malicious scripts that execute in users\' browsers, potentially stealing session cookies or sensitive information. Always encode user input before rendering it in HTML, JavaScript, or CSS contexts.',
        
        // Access Control vulnerabilities
        'path-traversal': 'Path Traversal occurs when user input is used to construct file paths without proper validation. Attackers can use special characters like "../" to access files outside the intended directory, potentially reading sensitive system files. Always validate file paths and use safe path resolution functions.',
        'information-exposure': 'Information Exposure occurs when sensitive information is exposed in error messages, logs, or responses. This information can help attackers understand the system structure and plan attacks. Avoid exposing sensitive details in error messages and sanitize all output.',
        
        // Cryptographic vulnerabilities
        'weak-crypto': 'Weak Cryptographic algorithms or implementations are vulnerable to attacks. Old algorithms like MD5, SHA-1, or weak ciphers can be broken, allowing attackers to decrypt data or forge signatures. Always use strong, modern cryptographic algorithms like SHA-256, AES-256, or RSA-2048.',
        'insecure-randomness': 'Insecure Random Number Generation uses predictable sources for generating random values. Attackers can predict or guess these values, compromising security features like session tokens or encryption keys. Use cryptographically secure random number generators.',
        'tls-issues': 'TLS/SSL Configuration Issues occur when secure connections are not properly configured, allowing downgrade attacks or man-in-the-middle attacks. Always use the latest TLS versions, disable weak protocols, and properly validate certificates.',
        'insecure-storage': 'Insecure Storage occurs when sensitive data is stored without proper encryption or with weak encryption. This can lead to data breaches if storage is compromised. Always encrypt sensitive data at rest using strong encryption algorithms.',
        
        // Authentication vulnerabilities
        'hardcoded-secret': 'Hardcoded Secrets are credentials, API keys, or passwords embedded directly in source code. These can be easily discovered by anyone with access to the codebase, leading to unauthorized access. Always use secure configuration management and environment variables.',
        
        // Memory Management vulnerabilities
        'buffer-overflow': 'Buffer Overflow occurs when data exceeds the allocated buffer size, potentially overwriting memory and allowing attackers to execute arbitrary code. Always validate input sizes and use safe buffer handling functions.',
        'memory-leak': 'Memory Leaks occur when dynamically allocated memory is not properly freed, leading to gradual memory exhaustion and potential denial of service. Always properly deallocate memory after use.',
        'unsafe-code': 'Unsafe Code uses functions or operations that can lead to memory corruption, undefined behavior, or security vulnerabilities. Always use safe alternatives and validate all operations.',
        
        // API Misuse vulnerabilities
        'banned-api': getBannedApiExplanation(issueDetails), // Use existing function for banned APIs
        
        // Data Integrity vulnerabilities
        'insecure-deserialization': 'Insecure Deserialization occurs when untrusted data is deserialized without proper validation. Attackers can craft malicious serialized objects that execute code during deserialization. Always validate deserialized data and use safe serialization formats.',
        
        // Network Security vulnerabilities
        'ssrf': 'Server-Side Request Forgery (SSRF) occurs when user input is used to make server-side requests without proper validation. Attackers can make requests to internal services or external resources, potentially accessing internal networks or bypassing firewalls. Always validate and whitelist allowed URLs.',
        
        // Input/Output vulnerabilities
        'improper-input-validation': 'Improper Input Validation occurs when user input is not properly validated before processing. This can lead to various injection attacks, data corruption, or denial of service. Always validate all user inputs against expected formats and ranges.',
        'missing-output-encoding': 'Missing Output Encoding occurs when user input is rendered without proper encoding based on the output context. This can lead to XSS attacks or other injection vulnerabilities. Always encode output based on the target context (HTML, JavaScript, URL, etc.).',
        'unsafe-json-parsing': 'Unsafe JSON Parsing occurs when JSON data is parsed without proper validation or when using unsafe parsing methods. This can lead to prototype pollution or code execution vulnerabilities. Always validate JSON structure and use safe parsing methods.',
    };
    
    // Get explanation based on issue type
    if (issueType && securityIssueExplanations[issueType.toLowerCase()]) {
        return securityIssueExplanations[issueType.toLowerCase()];
    }
    
    // Generate explanation based on CWE if available
    if (cwe) {
        const cweExplanations = {
            'CWE-89': 'SQL Injection: User input is directly concatenated into SQL queries without proper sanitization.',
            'CWE-78': 'Command Injection: User input is directly incorporated into system commands without validation.',
            'CWE-79': 'Cross-Site Scripting: Untrusted user input is rendered without proper encoding.',
            'CWE-22': 'Path Traversal: User input is used to construct file paths without proper validation.',
            'CWE-94': 'Code Injection: User input is executed as code, allowing arbitrary code execution.',
            'CWE-327': 'Weak Cryptographic Algorithm: Weak or broken cryptographic algorithms are used.',
            'CWE-330': 'Insecure Randomness: Predictable random number generation is used.',
            'CWE-295': 'TLS/SSL Configuration: Improper certificate validation or weak protocols.',
            'CWE-798': 'Hardcoded Credentials: Credentials are embedded in source code.',
            'CWE-120': 'Buffer Overflow: Data exceeds buffer boundaries, causing memory corruption.',
            'CWE-502': 'Insecure Deserialization: Untrusted data is deserialized without validation.',
            'CWE-918': 'SSRF: Server-side requests are made based on user input without validation.',
            'CWE-676': 'Use of Potentially Dangerous Function: Dangerous functions are used that can be exploited.',
            'CWE-20': 'Improper Input Validation: Input is not properly validated before processing.',
            'CWE-116': 'Missing Output Encoding: Output is not properly encoded for the target context.',
            'CWE-200': 'Information Exposure: Sensitive information is exposed in error messages or logs.',
            'CWE-829': 'Unsafe JSON Parsing: JSON is parsed without proper validation or using unsafe methods.',
        };
        
        if (cweExplanations[cwe]) {
            return cweExplanations[cwe] + ' This vulnerability can be exploited if user input is involved. Always validate and sanitize inputs, and use secure alternatives when possible.';
        }
    }
    
    // Generic explanation
    return 'This security vulnerability can be exploited if used improperly with user-controlled input. It may lead to unauthorized access, data breaches, or system compromise. Always validate inputs and use secure alternatives when possible.';
}

// Get detailed explanation for banned API (used by getSecurityIssueExplanation)
function getBannedApiExplanation(issueDetails) {
    const title = issueDetails.title || '';
    const description = issueDetails.description || '';
    const snippet = issueDetails.snippet || '';
    
    // Map common banned APIs to explanations
    const bannedApiExplanations = {
        'open': 'The `open()` function can be dangerous if used with user-controlled file paths without proper validation. It may lead to path traversal attacks, allowing access to files outside the intended directory. Always validate and sanitize file paths before using `open()`.',
        'eval': 'The `eval()` function executes arbitrary code, which can lead to code injection attacks if user input is involved. It should be avoided entirely.',
        'exec': 'The `exec()` function can execute arbitrary commands, leading to command injection vulnerabilities if user input is used.',
        'system': 'The `os.system()` function executes shell commands, which can be exploited for command injection attacks.',
        'pickle': 'The `pickle.loads()` function can deserialize arbitrary Python objects, potentially executing malicious code.',
        'subprocess': 'Using `subprocess` with `shell=True` can lead to command injection vulnerabilities. Use `shell=False` with argument lists instead.',
        'md5': 'MD5 is cryptographically broken and vulnerable to collision attacks. Use SHA-256 or stronger hashing algorithms.',
        'sha1': 'SHA-1 is cryptographically broken and vulnerable to collision attacks. Use SHA-256 or stronger hashing algorithms.',
        'random': 'The `random` module is not cryptographically secure. Use the `secrets` module for security-sensitive random number generation.'
    };
    
    // Try to extract API name from snippet, title, or description
    let apiName = '';
    
    // First try snippet (most accurate)
    if (snippet) {
        const apiMatch = snippet.match(/(\w+)\s*\(/);
        if (apiMatch) apiName = apiMatch[1].toLowerCase();
    }
    
    // Then try title
    if (!apiName && title) {
        const apiMatch = title.match(/(\w+)\s*\(/);
        if (apiMatch) apiName = apiMatch[1].toLowerCase();
    }
    
    // Finally try description
    if (!apiName && description) {
        const apiMatch = description.match(/(\w+)\s*\(/);
        if (apiMatch) apiName = apiMatch[1].toLowerCase();
    }
    
    // Get explanation based on API name
    if (apiName && bannedApiExplanations[apiName]) {
        return bannedApiExplanations[apiName];
    }
    
    // Generic banned API explanation
    return 'This API is flagged as potentially dangerous because it can be exploited if used improperly with user-controlled input. It may lead to security vulnerabilities such as code injection, command injection, or unauthorized file access. Always validate inputs and use safer alternatives when possible.';
}

// Show issue popup
function showIssuePopup(event, lineNumber, issueDetails) {
    event.stopPropagation();
    
    // Remove existing popup if any
    const existingPopup = document.getElementById('issuePopup');
    if (existingPopup) {
        existingPopup.remove();
    }
    
    // Get detailed explanation
    const detailedExplanation = getSecurityIssueExplanation(issueDetails);
    
    // Create popup element
    const popup = document.createElement('div');
    popup.id = 'issuePopup';
    popup.className = 'issue-popup';
    
    const severity = issueDetails.severity || 'medium';
    const severityClass = `severity-${severity}`;
    
    popup.innerHTML = `
        <div class="issue-popup-header">
            <div class="issue-popup-title">
                <span class="severity-badge ${severityClass}">${severity.toUpperCase()}</span>
                <h4>${escapeHtml(issueDetails.title || issueDetails.issue_type || 'Security Issue')}</h4>
            </div>
            <button class="issue-popup-close" onclick="closeIssuePopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="issue-popup-content">
            <div class="issue-popup-meta">
                <div class="issue-popup-meta-item">
                    <label>Line:</label>
                    <span>${lineNumber}</span>
                </div>
                ${issueDetails.category ? `
                <div class="issue-popup-meta-item">
                    <label>Category:</label>
                    <span>${escapeHtml(issueDetails.category)}</span>
                </div>
                ` : ''}
                ${issueDetails.cwe ? `
                <div class="issue-popup-meta-item">
                    <label>CWE:</label>
                    <span>${escapeHtml(issueDetails.cwe)}</span>
                </div>
                ` : ''}
                ${issueDetails.owasp ? `
                <div class="issue-popup-meta-item">
                    <label>OWASP:</label>
                    <span>${escapeHtml(issueDetails.owasp)}</span>
                </div>
                ` : ''}
            </div>
            <div class="issue-popup-description">
                <h5>Description</h5>
                <p>${escapeHtml(issueDetails.description || 'No description available.')}</p>
            </div>
            <div class="issue-popup-reason">
                <p>${escapeHtml(detailedExplanation)}</p>
            </div>
        </div>
    `;
    
    // Append to body
    document.body.appendChild(popup);
    
    // Position popup near the button
    const button = event.target.closest('.issue-btn');
    if (!button) return;
    
    const buttonRect = button.getBoundingClientRect();
    popup.style.position = 'fixed';
    popup.style.left = `${buttonRect.right + 10}px`;
    popup.style.top = `${buttonRect.top}px`;
    
    // Adjust if popup goes off screen
    setTimeout(() => {
        const popupRect = popup.getBoundingClientRect();
        if (popupRect.right > window.innerWidth) {
            popup.style.left = `${buttonRect.left - popupRect.width - 10}px`;
        }
        if (popupRect.bottom > window.innerHeight) {
            popup.style.top = `${window.innerHeight - popupRect.height - 10}px`;
        }
    }, 0);
    
    // Close on outside click
    setTimeout(() => {
        document.addEventListener('click', closeIssuePopupOnOutsideClick);
    }, 100);
}

function closeIssuePopup() {
    const popup = document.getElementById('issuePopup');
    if (popup) {
        popup.remove();
    }
    document.removeEventListener('click', closeIssuePopupOnOutsideClick);
}

function closeIssuePopupOnOutsideClick(event) {
    const popup = document.getElementById('issuePopup');
    const button = event.target.closest('.issue-btn');
    if (popup && !popup.contains(event.target) && !button) {
        closeIssuePopup();
    }
}

// Auto-Fix issue from editor
async function autoFixEditorIssue(lineNumber, issueDetails) {
    if (!currentEditorScanId || !currentEditorFilePath || !currentEditor) {
        alert('No file selected');
        return;
    }
    
    // Get full file content
    const fullFileContent = currentEditor.getValue();
    const fileLines = fullFileContent.split('\n');
    
    // Get file language
    const language = document.getElementById('currentFileLanguage')?.textContent || 'text';
    
    // Prepare issue data for API
    const issueData = {
        file: currentEditorFilePath,
        line: lineNumber,
        issue: issueDetails.issue_type || 'banned-api',
        vulnerability_name: issueDetails.title || issueDetails.issue_type || 'Security Issue',
        cwe: issueDetails.cwe || '',
        description: issueDetails.description || '',
        code: fileLines[lineNumber - 1] || '', // Get the problematic line
        context: fileLines, // Full file content as context
        severity: issueDetails.severity || 'medium',
        category: issueDetails.category || 'General'
    };
    
    // Show loading modal
    showAutoFixModal(lineNumber, issueDetails, true);
    
    try {
        const response = await fetch('/api/auto-fix-editor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                scan_id: currentEditorScanId,
                file_path: currentEditorFilePath,
                file_content: fullFileContent,
                language: language,
                line_number: lineNumber,
                issue_data: issueData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show fix suggestion
            showAutoFixModal(lineNumber, issueDetails, false, data);
        } else {
            showAutoFixModal(lineNumber, issueDetails, false, null, data.error || 'Failed to generate fix');
        }
    } catch (err) {
        showAutoFixModal(lineNumber, issueDetails, false, null, err.message || 'Failed to generate fix');
    }
}

// Show auto-fix modal
function showAutoFixModal(lineNumber, issueDetails, isLoading, fixData = null, error = null) {
    // Remove existing modal if any
    const existingModal = document.getElementById('autoFixModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal element
    const modal = document.createElement('div');
    modal.id = 'autoFixModal';
    modal.className = 'auto-fix-modal';
    
    if (isLoading) {
        modal.innerHTML = `
            <div class="auto-fix-modal-content">
                <div class="auto-fix-modal-header">
                    <h3><i class="fas fa-magic"></i> Generating Fix...</h3>
                    <button class="auto-fix-modal-close" onclick="closeAutoFixModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="auto-fix-modal-body">
                    <div class="auto-fix-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Analyzing code and generating secure fix...</p>
                    </div>
                </div>
            </div>
        `;
    } else if (error) {
        modal.innerHTML = `
            <div class="auto-fix-modal-content">
                <div class="auto-fix-modal-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Fix Generation Failed</h3>
                    <button class="auto-fix-modal-close" onclick="closeAutoFixModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="auto-fix-modal-body">
                    <div class="auto-fix-error">
                        <p>${escapeHtml(error)}</p>
                    </div>
                </div>
            </div>
        `;
    } else if (fixData) {
        const severity = issueDetails.severity || 'medium';
        const severityClass = `severity-${severity}`;
        
        // Get original code from editor if available
        let originalCode = fixData.original_code || '';
        if (!originalCode && currentEditor) {
            const lineIndex = lineNumber - 1;
            originalCode = currentEditor.getLine(lineIndex) || '';
        }
        
        modal.innerHTML = `
            <div class="auto-fix-modal-content">
                <div class="auto-fix-modal-header">
                    <h3>
                        <i class="fas fa-magic"></i> 
                        Auto-Fix Suggestion
                        <span class="severity-badge ${severityClass}">${severity.toUpperCase()}</span>
                    </h3>
                    <button class="auto-fix-modal-close" onclick="closeAutoFixModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="auto-fix-modal-body">
                    <div class="auto-fix-info">
                        <div class="auto-fix-info-item">
                            <label>File:</label>
                            <span>${escapeHtml(currentEditorFilePath)}</span>
                        </div>
                        <div class="auto-fix-info-item">
                            <label>Line:</label>
                            <span>${lineNumber}</span>
                        </div>
                        <div class="auto-fix-info-item">
                            <label>Issue:</label>
                            <span>${escapeHtml(issueDetails.title || issueDetails.issue_type || 'Security Issue')}</span>
                        </div>
                    </div>
                    
                    <div class="auto-fix-comparison">
                        <div class="code-comparison-item">
                            <h4><i class="fas fa-times-circle"></i> Original Code</h4>
                            <pre><code class="language-${fixData.language || 'text'}">${escapeHtml(originalCode)}</code></pre>
                        </div>
                        <div class="code-comparison-item">
                            <h4><i class="fas fa-check-circle"></i> Suggested Fix</h4>
                            <pre><code class="language-${fixData.language || 'text'}">${escapeHtml(fixData.solution_code || '')}</code></pre>
                        </div>
                    </div>
                    
                    <div class="auto-fix-explanation">
                        <h4><i class="fas fa-info-circle"></i> Explanation</h4>
                        <p>${escapeHtml(fixData.explanation || 'No explanation provided.')}</p>
                    </div>
                    
                    <div class="auto-fix-actions">
                        <button class="btn-primary" onclick="applyAutoFix(${lineNumber}, ${JSON.stringify(fixData).replace(/"/g, '&quot;')})">
                            <i class="fas fa-check"></i> Apply Fix
                        </button>
                        <button class="btn-secondary" onclick="closeAutoFixModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Trigger syntax highlighting
        setTimeout(() => {
            if (typeof Prism !== 'undefined') {
                const codeBlocks = modal.querySelectorAll('code');
                codeBlocks.forEach(block => {
                    Prism.highlightElement(block);
                });
            }
        }, 100);
    }
    
    // Append to body
    document.body.appendChild(modal);
    
    // Close on outside click
    setTimeout(() => {
        document.addEventListener('click', closeAutoFixModalOnOutsideClick);
    }, 100);
}

function closeAutoFixModal() {
    const modal = document.getElementById('autoFixModal');
    if (modal) {
        modal.remove();
    }
    document.removeEventListener('click', closeAutoFixModalOnOutsideClick);
}

function closeAutoFixModalOnOutsideClick(event) {
    const modal = document.getElementById('autoFixModal');
    if (modal && !modal.contains(event.target) && !event.target.closest('.auto-fix-editor-btn')) {
        closeAutoFixModal();
    }
}

// Apply auto-fix to editor
function applyAutoFix(lineNumber, fixData) {
    if (!currentEditor) {
        alert('No editor available');
        return;
    }
    
    const solutionCode = fixData.solution_code;
    if (!solutionCode) {
        alert('No solution code provided');
        return;
    }
    
    // Get the line index (0-based)
    const lineIndex = lineNumber - 1;
    
    // Get current line content
    const currentLine = currentEditor.getLine(lineIndex);
    
    // Replace the line
    const lineStart = { line: lineIndex, ch: 0 };
    const lineEnd = { line: lineIndex, ch: currentLine.length };
    
    currentEditor.replaceRange(solutionCode, lineStart, lineEnd);
    
    // Remove line highlight
    currentEditor.removeLineClass(lineIndex, 'background', 'issue-line-highlight');
    
    // Close modal
    closeAutoFixModal();
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.className = 'auto-fix-success-msg';
    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Fix applied successfully!';
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
        successMsg.remove();
    }, 3000);
}

// Save current file
async function saveCurrentFile() {
    if (!currentEditorScanId || !currentEditorFilePath || !currentEditor) {
        alert('No file selected');
        return;
    }
    
    const content = currentEditor.getValue();
    
    try {
        const response = await fetch(`/api/file/${currentEditorScanId}/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_path: currentEditorFilePath,
                content: content
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('File saved successfully!');
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (err) {
        alert(`Error saving file: ${err.message}`);
    }
}

// Reload current file
function reloadCurrentFile() {
    if (currentEditorFilePath) {
        loadFileForEditing(currentEditorFilePath);
    }
}

// Run current code
async function runCurrentCode() {
    if (!currentEditorScanId || !currentEditorFilePath || !currentEditor) {
        alert('No file selected');
        return;
    }
    
    const code = currentEditor.getValue();
    const language = document.getElementById('currentFileLanguage')?.textContent || 'text';
    
    if (!code.trim()) {
        alert('No code to run');
        return;
    }
    
    // Show output panel
    const outputPanel = document.getElementById('outputPanel');
    const outputContent = document.getElementById('outputContent');
    const runBtn = document.getElementById('runCodeBtn');
    
    if (!outputPanel || !outputContent) {
        alert('Output panel not found');
        return;
    }
    
    // Show output panel and show loading state
    outputPanel.classList.remove('hidden');
    outputContent.innerHTML = `
        <div class="output-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Running code...</span>
        </div>
    `;
    
    // Adjust editor height when output panel is visible
    setTimeout(() => {
        if (currentEditor && currentEditor.refresh) {
            currentEditor.refresh();
        }
    }, 100);
    
    // Disable run button
    if (runBtn) {
        runBtn.disabled = true;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
    }
    
    try {
        const response = await fetch(`/api/file/${currentEditorScanId}/run`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: code,
                language: language,
                file_path: currentEditorFilePath
            })
        });
        
        const data = await response.json();
        
        // Display results
        if (data.success) {
            outputContent.innerHTML = `
                <div class="output-success">
                    <div class="output-status">
                        <i class="fas fa-check-circle"></i>
                        <span>Syntax check passed successfully</span>
                    </div>
                    <pre class="output-text">${escapeHtml(data.output || 'No syntax errors found')}</pre>
                </div>
            `;
        } else {
            const errorMsg = data.error || 'Syntax error detected';
            const output = data.output || '';
            const exitCode = data.exit_code !== undefined ? data.exit_code : -1;
            const timedOut = data.timed_out || false;
            
            outputContent.innerHTML = `
                <div class="output-error">
                    <div class="output-status">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>${escapeHtml(errorMsg)}</span>
                        ${timedOut ? '<span class="timeout-badge">TIMEOUT</span>' : ''}
                    </div>
                    ${output ? `<pre class="output-text">${escapeHtml(output)}</pre>` : ''}
                </div>
            `;
        }
        
        // Scroll output panel into view
        outputPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (err) {
        outputContent.innerHTML = `
            <div class="output-error">
                <div class="output-status">
                    <i class="fas fa-times-circle"></i>
                    <span>Error: ${escapeHtml(err.message)}</span>
                </div>
            </div>
        `;
    } finally {
        // Re-enable run button
        if (runBtn) {
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
        }
    }
}

// Clear output panel
function clearOutput() {
    const outputPanel = document.getElementById('outputPanel');
    const outputContent = document.getElementById('outputContent');
    
    if (outputPanel) {
        outputPanel.classList.add('hidden');
    }
    if (outputContent) {
        outputContent.innerHTML = '';
    }
    
    // Refresh editor after hiding output panel
    setTimeout(() => {
        if (currentEditor && currentEditor.refresh) {
            currentEditor.refresh();
        }
    }, 100);
}

// Refresh editor scan list
function refreshEditorScanList() {
    loadEditorScans();
}

// Show empty state
function showEditorEmpty() {
    const main = document.getElementById('editorMain');
    const empty = document.getElementById('editorEmpty');
    
    if (main) main.classList.add('hidden');
    if (empty) empty.classList.remove('hidden');
}

// =====================================
// Framework Performance Dashboard
// =====================================

let performanceCharts = {};

async function refreshPerformanceData() {
    const loading = document.getElementById('performanceLoading');
    const error = document.getElementById('performanceError');
    const dashboard = document.getElementById('performanceDashboard');
    const noData = document.getElementById('performanceNoData');
    
    // Show loading
    if (loading) loading.classList.remove('hidden');
    if (error) error.classList.add('hidden');
    if (dashboard) dashboard.classList.add('hidden');
    if (noData) noData.classList.add('hidden');
    
    try {
        const response = await fetch('/performance');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const metrics = await response.json();
        
        if (metrics.error) {
            throw new Error(metrics.error);
        }
        
        // Check if we have any data
        const hasData = Object.values(metrics).some(m => m.completed_scans > 0);
        
        if (!hasData) {
            if (loading) loading.classList.add('hidden');
            if (noData) noData.classList.remove('hidden');
            return;
        }
        
        // Hide loading, show dashboard
        if (loading) loading.classList.add('hidden');
        if (dashboard) dashboard.classList.remove('hidden');
        
        // Update summary stats
        updatePerformanceStats(metrics);
        
        // Update charts
        updatePerformanceCharts(metrics);
        
        // Update table
        updatePerformanceTable(metrics);
        
    } catch (err) {
        console.error('Error loading performance data:', err);
        if (loading) loading.classList.add('hidden');
        if (error) {
            error.classList.remove('hidden');
            const errorMsg = document.getElementById('performanceErrorMessage');
            if (errorMsg) errorMsg.textContent = `Failed to load performance data: ${err.message}`;
        }
    }
}

function updatePerformanceStats(metrics) {
    const sequentialScans = document.getElementById('sequentialScans');
    const langgraphScans = document.getElementById('langgraphScans');
    const autogenScans = document.getElementById('autogenScans');
    const crewaiScans = document.getElementById('crewaiScans');
    
    if (sequentialScans) {
        sequentialScans.textContent = metrics.sequential?.completed_scans || 0;
    }
    if (langgraphScans) {
        langgraphScans.textContent = metrics.langgraph?.completed_scans || 0;
    }
    if (autogenScans) {
        autogenScans.textContent = metrics.autogen?.completed_scans || 0;
    }
    if (crewaiScans) {
        crewaiScans.textContent = metrics.crewai?.completed_scans || 0;
    }
}

function updatePerformanceCharts(metrics) {
    const frameworks = ['sequential', 'langgraph', 'autogen', 'crewai'];
    const frameworkLabels = {
        'sequential': 'Sequential',
        'langgraph': 'LangGraph',
        'autogen': 'AutoGen',
        'crewai': 'CrewAI'
    };
    
    // Execution Time Chart
    updateExecutionTimeChart(metrics, frameworks, frameworkLabels);
    
    // Success Rate Chart
    updateSuccessRateChart(metrics, frameworks, frameworkLabels);
    
    // Issues Found Chart
    updateIssuesFoundChart(metrics, frameworks, frameworkLabels);
    
    // Files Scanned Chart
    updateFilesScannedChart(metrics, frameworks, frameworkLabels);
}

function updateExecutionTimeChart(metrics, frameworks, frameworkLabels) {
    const ctx = document.getElementById('executionTimeChart');
    if (!ctx) return;
    
    const labels = frameworks.map(f => frameworkLabels[f]);
    const data = frameworks.map(f => {
        const m = metrics[f] || {};
        return m.avg_execution_time ? parseFloat(m.avg_execution_time.toFixed(2)) : 0;
    });
    
    if (performanceCharts.executionTime) {
        performanceCharts.executionTime.destroy();
    }
    
    performanceCharts.executionTime = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Execution Time (seconds)',
                data: data,
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(0, 229, 255, 0.8)',
                    'rgba(240, 147, 251, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(0, 229, 255, 1)',
                    'rgba(240, 147, 251, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    display: false // No legend for bar charts
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                },
                x: {
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                }
            }
        }
    });
}

function updateSuccessRateChart(metrics, frameworks, frameworkLabels) {
    const ctx = document.getElementById('successRateChart');
    if (!ctx) return;
    
    const labels = frameworks.map(f => frameworkLabels[f]);
    const data = frameworks.map(f => {
        const m = metrics[f] || {};
        return m.success_rate ? parseFloat(m.success_rate.toFixed(2)) : 0;
    });
    
    if (performanceCharts.successRate) {
        performanceCharts.successRate.destroy();
    }
    
    performanceCharts.successRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Success Rate (%)',
                data: data,
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(0, 229, 255, 0.8)',
                    'rgba(240, 147, 251, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(0, 229, 255, 1)',
                    'rgba(240, 147, 251, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            ...chartConfig,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    ...chartConfig.plugins.legend,
                    labels: {
                        ...chartConfig.plugins.legend.labels,
                        color: '#b3e5fc' // Secondary text color for legend
                    }
                }
            }
        }
    });
}

function updateIssuesFoundChart(metrics, frameworks, frameworkLabels) {
    const ctx = document.getElementById('issuesFoundChart');
    if (!ctx) return;
    
    const labels = frameworks.map(f => frameworkLabels[f]);
    const data = frameworks.map(f => {
        const m = metrics[f] || {};
        return m.avg_issues ? parseFloat(m.avg_issues.toFixed(2)) : 0;
    });
    
    if (performanceCharts.issuesFound) {
        performanceCharts.issuesFound.destroy();
    }
    
    performanceCharts.issuesFound = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Issues Found',
                data: data,
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(0, 229, 255, 0.8)',
                    'rgba(240, 147, 251, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(0, 229, 255, 1)',
                    'rgba(240, 147, 251, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    display: false // No legend for bar charts
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                },
                x: {
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                }
            }
        }
    });
}

function updateFilesScannedChart(metrics, frameworks, frameworkLabels) {
    const ctx = document.getElementById('filesScannedChart');
    if (!ctx) return;
    
    const labels = frameworks.map(f => frameworkLabels[f]);
    const data = frameworks.map(f => {
        const m = metrics[f] || {};
        return m.avg_files_scanned ? parseFloat(m.avg_files_scanned.toFixed(2)) : 0;
    });
    
    if (performanceCharts.filesScanned) {
        performanceCharts.filesScanned.destroy();
    }
    
    performanceCharts.filesScanned = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Files Scanned',
                data: data,
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(0, 229, 255, 0.8)',
                    'rgba(240, 147, 251, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(0, 229, 255, 1)',
                    'rgba(240, 147, 251, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                legend: {
                    display: false // No legend for bar charts
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                },
                x: {
                    ticks: {
                        color: '#b3e5fc' // Secondary text color
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                }
            }
        }
    });
}

function updatePerformanceTable(metrics) {
    const tbody = document.getElementById('performanceTableBody');
    if (!tbody) return;
    
    const frameworks = ['sequential', 'langgraph', 'autogen', 'crewai'];
    const frameworkLabels = {
        'sequential': 'Sequential',
        'langgraph': 'LangGraph',
        'autogen': 'AutoGen',
        'crewai': 'CrewAI'
    };
    
    tbody.innerHTML = '';
    
    frameworks.forEach(framework => {
        const m = metrics[framework] || {};
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td><strong>${frameworkLabels[framework]}</strong></td>
            <td>${m.completed_scans || 0}</td>
            <td>${m.avg_execution_time ? m.avg_execution_time.toFixed(2) : 'N/A'}</td>
            <td>${m.success_rate ? m.success_rate.toFixed(2) + '%' : 'N/A'}</td>
            <td>${m.avg_issues ? m.avg_issues.toFixed(2) : 'N/A'}</td>
            <td>${m.avg_files_scanned ? m.avg_files_scanned.toFixed(2) : 'N/A'}</td>
            <td>${m.min_execution_time ? m.min_execution_time.toFixed(2) : 'N/A'}</td>
            <td>${m.max_execution_time ? m.max_execution_time.toFixed(2) : 'N/A'}</td>
        `;
        
        tbody.appendChild(row);
    });
}
````

## File: agentic_fixer/templates/error.html
````html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error - Agentic Code Security Auto-Fixer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-background">
                <div class="floating-shapes">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                    <div class="shape shape-4"></div>
                </div>
            </div>
            <div class="header-content">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-shield-alt"></i>
                            <div class="logo-glow"></div>
                        </div>
                        <h1>Agentic Code Security Auto-Fixer</h1>
                    </div>
                    <div class="header-controls">
                        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>
                <p class="subtitle">Error occurred</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="error-container">
                <div class="error-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="error-icon-bg"></div>
                    </div>
                    <h2>Oops! Something went wrong</h2>
                    <p class="error-message">{{ message }}</p>
                    <div class="error-actions">
                        <button class="action-button primary" onclick="window.location.href='/'">
                            <i class="fas fa-home"></i> 
                            <span>Back to Home</span>
                        </button>
                        <button class="action-button secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> 
                            <span>Go Back</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Agentic Code Security Auto-Fixer. All Rights Reserved</p>
        </footer>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS (Animate On Scroll)
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-mode', savedTheme === 'dark');
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            const theme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            updateThemeIcon(theme);
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }
        }

        // Initialize theme when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>
</body>
</html>
````

## File: agentic_fixer/templates/index.html
````html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Code Security Auto-Fixer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- CodeMirror Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header compact-header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h1>Agentic Code Security Auto-Fixer</h1>
                    </div>
                    <div class="header-controls">
                        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>
                <p class="subtitle">Scan your code repositories to detect security issues and get solution</p>
            </div>
        </header>

        <!-- Top Navigation Tabs -->
        <nav class="main-tabs">
            <button class="main-tab-btn" onclick="switchMainTab('past-scans')">
                <i class="fas fa-history"></i>
                <span>Past Scans</span>
            </button>
            <button class="main-tab-btn active" onclick="switchMainTab('scanner')">
                <i class="fas fa-search"></i>
                <span>Scanner</span>
            </button>
            <button class="main-tab-btn" onclick="switchMainTab('vulnerabilities')">
                <i class="fas fa-shield-virus"></i>
                <span>Vulnerabilities</span>
            </button>
            <button class="main-tab-btn" onclick="switchMainTab('editor')">
                <i class="fas fa-edit"></i>
                <span>Editor</span>
            </button>
            <button class="main-tab-btn" onclick="switchMainTab('performance')">
                <i class="fas fa-chart-line"></i>
                <span>Framework Performance</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Scanner Panel -->
            <div id="scannerPanel" class="panel active">
            <div class="scan-form-container" id="scanFormContainer">
                <div class="form-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="form-header">
                        <h2>Start Security Scan</h2>
                        <p>Choose how to scan your code: repository or file upload</p>
                    </div>
                    
                    <!-- Scan Type Selection -->
                    <div class="scan-type-selector">
                        <div class="type-option active" data-type="repository">
                            <div class="type-icon">
                                <i class="fas fa-code-branch"></i>
                            </div>
                            <div class="type-content">
                                <h3>Repository</h3>
                                <p>Scan a local directory or GitHub repository</p>
                            </div>
                        </div>
                        <div class="type-option" data-type="upload">
                            <div class="type-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="type-content">
                                <h3>File Upload</h3>
                                <p>Upload a single file or zip archive</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Repository Form -->
                    <form id="scanForm" class="scan-form" style="display: block;">
                        <div class="input-group">
                            <label for="repository">
                                <i class="fas fa-code-branch"></i>
                                Repository Path or URL
                            </label>
                            <div class="input-wrapper">
                                <input 
                                    type="text" 
                                    id="repository" 
                                    name="repository" 
                                    placeholder="e.g., /path/to/repo or https://github.com/user/repo"
                                >
                                <div class="input-focus-line"></div>
                            </div>
                            <div class="input-help">
                                <i class="fas fa-info-circle"></i>
                                <small>Supports local directories and GitHub repositories</small>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="orchestrator">
                                <i class="fas fa-project-diagram"></i>
                                Framework
                            </label>
                            <div class="input-wrapper">
                                <select id="orchestrator" name="orchestrator">
                                    <option value="sequential">Sequential (Baseline)</option>
                                    <option value="langgraph">LangGraph</option>
                                    <option value="autogen">AutoGen</option>
                                    <option value="crewai">CrewAI</option>
                                </select>
                                <div class="input-focus-line"></div>
                            </div>
                            <div class="input-help">
                                <i class="fas fa-info-circle"></i>
                                <small>Choose the agentic framework to orchestrate the scan workflow</small>
                            </div>
                        </div>

                        <button type="submit" class="scan-button" id="scanButton">
                            <div class="button-content">
                                <i class="fas fa-play"></i>
                                <span>Start Security Scan</span>
                            </div>
                            <div class="button-ripple"></div>
                        </button>
                    </form>
                    
                    <!-- File Upload Form -->
                    <form id="uploadForm" class="scan-form" style="display: none;" enctype="multipart/form-data">
                        <div class="input-group">
                            <label for="file">
                                <i class="fas fa-file-upload"></i>
                                Select File to Upload
                            </label>
                            <div class="file-upload-wrapper">
                                <input 
                                    type="file" 
                                    id="file" 
                                    name="file" 
                                    accept=".txt,.py,.js,.java,.html,.css,.php,.rb,.go,.rs,.ts,.cpp,.c,.cc,.cxx,.h,.hpp,.json,.xml,.md,.zip"
                                    required
                                >
                                <div class="file-upload-display">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <span class="file-upload-label">Choose file or drag & drop</span>
                                        <span class="file-upload-info">Supports single files and zip archives (max 500MB)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="input-help">
                                <i class="fas fa-info-circle"></i>
                                <small>Supported formats: .py, .js, .java, .html, .css, .php, .rb, .go, .rs, .ts, .cpp, .c, .zip and more</small>
                            </div>
                        </div>

                        <button type="submit" class="scan-button" id="uploadButton">
                            <div class="button-content">
                                <i class="fas fa-upload"></i>
                                <span>Upload & Scan</span>
                            </div>
                            <div class="button-ripple"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="progress-section hidden">
                <div class="progress-card" data-aos="fade-up">
                    <div class="progress-header">
                        <div class="progress-icon">
                            <i class="fas fa-cog fa-spin"></i>
                        </div>
                        <h3>Scanning in Progress</h3>
                        <div class="scan-id">
                            <i class="fas fa-fingerprint"></i>
                            <span>Scan ID: <strong id="scanId"></strong></span>
                        </div>
                    </div>
                    
                    <div class="progress-content">
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill">
                                    <div class="progress-shine"></div>
                                </div>
                                <div class="progress-dots">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </div>
                            <div class="progress-text">
                                <span id="progressPercent">0%</span>
                            </div>
                        </div>
                        
                        <div class="current-step">
                            <div class="step-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="step-content">
                                <span id="currentStep">Initializing...</span>
                                <div class="step-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section hidden">
                <div class="results-card" data-aos="fade-up">
                    <div class="results-header">
                        <div class="results-title">
                            <div class="results-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h3>Scan Results</h3>
                        </div>
                        <div class="results-actions">
                            <button class="action-button secondary" onclick="downloadReport()">
                                <i class="fas fa-download"></i> 
                                <span>Download Report</span>
                            </button>
                            <button class="action-button primary" onclick="startNewScan()">
                                <i class="fas fa-plus"></i> 
                                <span>New Scan</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="results-content">
                        <div class="toolbar" data-aos="fade-up">
                            <div class="toolbar-left">
                                <div class="search-group">
                                    <i class="fas fa-search"></i>
                                    <input id="filterSearch" type="text" placeholder="Search issues and files...">
                                </div>
                                <div class="select-group">
                                    <i class="fas fa-language"></i>
                                    <select id="filterLanguage">
                                        <option value="all">All languages</option>
                                    </select>
                                </div>
                                <div class="select-group">
                                    <i class="fas fa-layer-group"></i>
                                    <select id="filterSeverity">
                                        <option value="all">All severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div class="toolbar-right">
                                <label class="switch">
                                    <input id="filterOnlyIssues" type="checkbox">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label">Only files with issues</span>
                                <div class="select-group">
                                    <i class="fas fa-sort"></i>
                                    <select id="sortSelect">
                                        <option value="severity">Sort by severity</option>
                                        <option value="name">Sort by name</option>
                                        <option value="status">Sort by status</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="summary-stats sticky-summary">
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                                <div class="stat-icon">
                                    <i class="fas fa-file-code"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="totalFiles" data-count="0">0</div>
                                    <div class="stat-label">Total Files</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="totalIssues" data-count="0">0</div>
                                    <div class="stat-label">Files with issues</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="cleanFiles" data-count="0">0</div>
                                    <div class="stat-label">Clean Files</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="400">
                                <div class="stat-icon">
                                    <i class="fas fa-language"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="languages" data-count="0">0</div>
                                    <div class="stat-label">Languages</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                        </div>

                        <!-- Data Visualization Charts -->
                        <div class="charts-section">
                            <div class="chart-container" data-aos="fade-up" data-aos-delay="100">
                                <div class="chart-header">
                                    <div class="chart-icon">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    <h4>Issue Type Distribution</h4>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="issueTypeChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-container" data-aos="fade-up" data-aos-delay="200">
                                <div class="chart-header">
                                    <div class="chart-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h4>Security Severity</h4>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="severityChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-container" data-aos="fade-up" data-aos-delay="300">
                                <div class="chart-header">
                                    <div class="chart-icon">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <h4>File Status Overview</h4>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="fileStatusChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-container chart-full-width" data-aos="fade-up" data-aos-delay="400">
                                <div class="chart-header">
                                    <div class="chart-icon">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <h4>Languages</h4>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="languageChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="results-tabs">
                            <div class="tab-buttons">
                                <button class="tab-button active" onclick="showTab(event, 'issues')">
                                    <div class="tab-icon">
                                        <i class="fas fa-bug"></i>
                                    </div>
                                    <span>Security Issues</span>
                                    <div class="tab-indicator"></div>
                                </button>
                                <button class="tab-button" onclick="showTab(event, 'files')">
                                    <div class="tab-icon">
                                        <i class="fas fa-folder"></i>
                                    </div>
                                    <span>File Status</span>
                                    <div class="tab-indicator"></div>
                                </button>
                                <button class="tab-button" onclick="showTab(event, 'summary')">
                                    <div class="tab-icon">
                                        <i class="fas fa-info"></i>
                                    </div>
                                    <span>Summary</span>
                                    <div class="tab-indicator"></div>
                                </button>
                            </div>
                            
                            <div class="tab-content">
                                <div id="issuesTab" class="tab-panel active">
                                    <div class="issues-list" id="issuesList">
                                        <!-- Issues will be populated here -->
                                    </div>
                                </div>
                                
                                <div id="filesTab" class="tab-panel">
                                    <div class="files-list" id="filesList">
                                        <!-- Files will be populated here -->
                                    </div>
                                </div>
                                
                                <div id="summaryTab" class="tab-panel">
                                    <div class="summary-content" id="summaryContent">
                                        <!-- Summary will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Past Scans Panel -->
            <div id="pastScansPanel" class="panel hidden">
                <div class="past-scans-container">
                    <div class="panel-header">
                        <h2><i class="fas fa-history"></i> Past Scans</h2>
                        <button class="btn-secondary" onclick="refreshScans()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="scansLoading" class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading past scans...</p>
                    </div>
                    
                    <div id="scansError" class="error-state hidden">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load scans</p>
                    </div>
                    
                    <div id="scansList" class="scans-list">
                        <!-- Scans will be populated here -->
                    </div>
                    
                    <div id="noScans" class="no-scans-state hidden">
                        <i class="fas fa-inbox"></i>
                        <h3>No Past Scans</h3>
                        <p>Run your first scan to see results here</p>
                    </div>
                </div>
            </div>

            <!-- Vulnerabilities Panel -->
            <div id="vulnerabilitiesPanel" class="panel hidden">
                <div class="vulnerabilities-container">
                    <div class="panel-header">
                        <h2><i class="fas fa-shield-virus"></i> Vulnerabilities Dashboard</h2>
                        <button class="btn-secondary" onclick="refreshVulnerabilities()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="vulnsLoading" class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading vulnerability data...</p>
                    </div>
                    
                    <div id="vulnsError" class="error-state hidden">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load vulnerability data</p>
                    </div>
                    
                    <div id="vulnsContent" class="vulns-content hidden">
                        <!-- Summary Statistics -->
                        <div class="summary-stats sticky-summary">
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                                <div class="stat-icon">
                                    <i class="fas fa-bug"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="totalVulnerabilities" data-count="0">0</div>
                                    <div class="stat-label">Total Vulnerabilities</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="criticalVulns" data-count="0">0</div>
                                    <div class="stat-label">Critical</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="highVulns" data-count="0">0</div>
                                    <div class="stat-label">High</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                            
                            <div class="stat-card" data-aos="fade-up" data-aos-delay="400">
                                <div class="stat-icon">
                                    <i class="fas fa-shield-alt"></i>
                                    <div class="stat-icon-bg"></div>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="totalDatabases" data-count="0">0</div>
                                    <div class="stat-label">Projects Scanned</div>
                                </div>
                                <div class="stat-glow"></div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="charts-section">
                            <div class="charts-side-by-side chart-full-width" data-aos="fade-up" data-aos-delay="100">
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <div class="chart-icon">
                                            <i class="fas fa-chart-bar"></i>
                                        </div>
                                        <h4>Vulnerabilities by Severity</h4>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="vulnsBySeverityChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <div class="chart-icon">
                                            <i class="fas fa-language"></i>
                                        </div>
                                        <h4>Vulnerabilities by Language</h4>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="vulnsByLanguageChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="charts-side-by-side chart-full-width" data-aos="fade-up" data-aos-delay="200">
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <div class="chart-icon">
                                            <i class="fas fa-layer-group"></i>
                                        </div>
                                        <h4>Vulnerabilities by Category</h4>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="vulnsByCategoryChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <div class="chart-icon">
                                            <i class="fas fa-sitemap"></i>
                                        </div>
                                        <h4>Top Vulnerability Types (Ranked)</h4>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="vulnsByTypeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vulnerability Table -->
                        <div class="vulns-table-section" data-aos="fade-up" data-aos-delay="500">
                            <div class="section-header">
                                <h3><i class="fas fa-list"></i> Detailed Vulnerability Analysis</h3>
                                <div class="table-filters">
                                    <select id="vulnSeverityFilter">
                                        <option value="all">All Severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                    <select id="vulnCategoryFilter">
                                        <option value="all">All Categories</option>
                                    </select>
                                    <input type="text" id="vulnSearch" placeholder="Search vulnerabilities...">
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="vulnsTable">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Type</th>
                                            <th>Severity</th>
                                            <th>Category</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vulnsTableBody">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Editor Panel -->
            <div id="editorPanel" class="panel hidden">
                <div class="editor-container">
                    <div class="panel-header">
                        <h2><i class="fas fa-edit"></i> Code Editor</h2>
                        <div class="editor-controls">
                            <select id="scanSelect" class="select-input">
                                <option value="">Select a scan...</option>
                            </select>
                            <button class="btn-secondary" onclick="refreshEditorScanList()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div id="editorContent" class="editor-content">
                        <div id="editorLoading" class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading editor...</p>
                        </div>
                        
                        <div id="editorError" class="error-state hidden">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p id="editorErrorMessage">Failed to load editor</p>
                        </div>
                        
                        <div id="editorMain" class="editor-main hidden">
                            <div class="editor-sidebar">
                                <h3><i class="fas fa-folder-open"></i> Files with Issues</h3>
                                <div id="editorFilesList" class="files-tree">
                                    <!-- Files will be populated here -->
                                </div>
                            </div>
                            
                            <div class="editor-workspace">
                                <div class="editor-toolbar">
                                    <div class="file-info">
                                        <span id="currentFilePath" class="file-path"></span>
                                        <span id="currentFileLanguage" class="file-language"></span>
                                    </div>
                                    <div class="editor-actions">
                                        <button class="btn-success" id="runCodeBtn" onclick="runCurrentCode()">
                                            <i class="fas fa-play"></i> Run
                                        </button>
                                        <button class="btn-primary" onclick="saveCurrentFile()">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                        <button class="btn-secondary" onclick="reloadCurrentFile()">
                                            <i class="fas fa-redo"></i> Reload
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="codeEditor" class="code-editor-container">
                                    <!-- Code editor will be initialized here -->
                                </div>
                                
                                <!-- Output Panel -->
                                <div id="outputPanel" class="output-panel hidden">
                                    <div class="output-header">
                                        <div class="output-title">
                                            <i class="fas fa-terminal"></i>
                                            <span>Execution Output</span>
                                        </div>
                                        <button class="btn-icon" onclick="clearOutput()" title="Clear output">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div id="outputContent" class="output-content">
                                        <!-- Output will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="editorEmpty" class="empty-state hidden">
                            <i class="fas fa-code"></i>
                            <h3>No Scan Selected</h3>
                            <p>Select a scan from the dropdown above to start editing files</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Framework Performance Panel -->
            <div id="performancePanel" class="panel hidden">
                <div class="performance-container">
                    <div class="panel-header">
                        <h2><i class="fas fa-chart-line"></i> Framework Performance Dashboard</h2>
                        <button class="btn-secondary" onclick="refreshPerformanceData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="performanceContent" class="performance-content">
                        <!-- Loading State -->
                        <div id="performanceLoading" class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading performance data...</p>
                        </div>
                        
                        <!-- Error State -->
                        <div id="performanceError" class="error-state hidden">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p id="performanceErrorMessage">Failed to load performance data</p>
                        </div>
                        
                        <!-- Performance Dashboard -->
                        <div id="performanceDashboard" class="performance-dashboard hidden">
                            <!-- Summary Stats -->
                            <div class="performance-stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon sequential">
                                        <i class="fas fa-list-ol"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">Sequential</div>
                                        <div class="stat-value" id="sequentialScans">0</div>
                                        <div class="stat-sublabel">Total Scans</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon langgraph">
                                        <i class="fas fa-project-diagram"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">LangGraph</div>
                                        <div class="stat-value" id="langgraphScans">0</div>
                                        <div class="stat-sublabel">Total Scans</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon autogen">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">AutoGen</div>
                                        <div class="stat-value" id="autogenScans">0</div>
                                        <div class="stat-sublabel">Total Scans</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon crewai">
                                        <i class="fas fa-users-cog"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">CrewAI</div>
                                        <div class="stat-value" id="crewaiScans">0</div>
                                        <div class="stat-sublabel">Total Scans</div>
                                    </div>
                                </div>
                            </div>
                            <div class="performance-charts">
                                <!-- Execution Time Comparison -->
                                <div class="chart-card">
                                    <div class="chart-header">
                                        <h3><i class="fas fa-clock"></i> Average Execution Time</h3>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="executionTimeChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Success Rate -->
                                <div class="chart-card">
                                    <div class="chart-header">
                                        <h3><i class="fas fa-check-circle"></i> Success Rate</h3>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="successRateChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Issues Found Comparison -->
                                <div class="chart-card">
                                    <div class="chart-header">
                                        <h3><i class="fas fa-bug"></i> Average Issues Found</h3>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="issuesFoundChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Files Scanned Comparison -->
                                <div class="chart-card">
                                    <div class="chart-header">
                                        <h3><i class="fas fa-file-code"></i> Average Files Scanned</h3>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="filesScannedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Performance Table -->
                            <div class="performance-table-card">
                                <div class="table-header">
                                    <h3><i class="fas fa-table"></i> Detailed Performance Metrics</h3>
                                </div>
                                <div class="table-wrapper">
                                    <table id="performanceTable" class="performance-table">
                                        <thead>
                                            <tr>
                                                <th>Framework</th>
                                                <th>Scans</th>
                                                <th>Avg Time (s)</th>
                                                <th>Success Rate</th>
                                                <th>Avg Issues</th>
                                                <th>Avg Files</th>
                                                <th>Fastest Scan (s)</th>
                                                <th>Slowest Scan (s)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="performanceTableBody">
                                            <!-- Table rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- No Data State -->
                            <div id="performanceNoData" class="empty-state hidden">
                                <i class="fas fa-chart-bar"></i>
                                <h3>No Performance Data Available</h3>
                                <p>Run scans using different frameworks to see performance comparisons</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Agentic Code Security Auto-Fixer. All Rights Reserved</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- CodeMirror Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/rust/rust.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Initialize AOS (Animate On Scroll)
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });
    </script>
</body>
</html>
````

## File: agentic_fixer/templates/results.html
````html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - Agentic Code Security Auto-Fixer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header" data-aos="fade-down">
            <div class="header-content">
                <div class="brand">
                    <i class="fas fa-shield-alt"></i>
                    <h1>Agentic Code Security Auto-Fixer</h1>
                </div>
                <div class="scan-meta">
                    <div class="meta-item">
                        <i class="fas fa-hashtag"></i>
                        <span>Scan ID: <strong>{{ scan_id }}</strong></span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>Generated: <strong>{{ generated_at }}</strong></span>
                    </div>
                </div>
            </div>
        </header>

        <nav class="main-nav" data-aos="fade-up">
            <button class="nav-btn active" data-tab="overview">
                <i class="fas fa-chart-pie"></i>
                <span>Overview</span>
            </button>
            <button class="nav-btn" data-tab="issues">
                <i class="fas fa-bug"></i>
                <span>Issues</span>
            </button>
            <button class="nav-btn" data-tab="files">
                <i class="fas fa-file-code"></i>
                <span>Files</span>
            </button>
            <button class="nav-btn" data-tab="report">
                <i class="fas fa-file-export"></i>
                <span>Report</span>
            </button>
        </nav>

        <div class="toolbar" data-aos="fade-up">
            <div class="toolbar-left">
                <div class="search-group">
                    <i class="fas fa-search"></i>
                    <input id="filterSearch" type="text" placeholder="Search issues and files...">
                </div>
                <div class="select-group">
                    <i class="fas fa-language"></i>
                    <select id="languageFilter">
                        <option value="">All Languages</option>
                        {% for lang in languages %}
                        <option value="{{ lang }}">{{ lang }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="select-group">
                    <i class="fas fa-exclamation-triangle"></i>
                    <select id="severityFilter">
                        <option value="">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            <div class="toolbar-right">
                <button id="themeToggle" class="btn-outline" aria-label="Toggle Theme">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <button id="refreshBtn" class="btn-outline">
                    <i class="fas fa-rotate"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <main class="content">
            <!-- OVERVIEW TAB -->
            <section id="overview" class="tab active" data-aos="fade-up">
                <div class="grid">
                    <div class="card stats" data-aos="fade-up" data-aos-delay="0">
                        <div class="card-header">
                            <i class="fas fa-clipboard-list"></i>
                            <h2>Summary</h2>
                        </div>
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-value">{{ results.stats.total_issues }}</div>
                                <div class="stat-label">Total Issues</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ results.stats.files_scanned }}</div>
                                <div class="stat-label">Files Scanned</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ results.stats.auto_fixes }}</div>
                                <div class="stat-label">Auto-Fixes</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ results.stats.manual_reviews }}</div>
                                <div class="stat-label">Manual Reviews</div>
                            </div>
                        </div>
                    </div>

                    <div class="card chart" data-aos="fade-up" data-aos-delay="100">
                        <div class="card-header">
                            <i class="fas fa-bug"></i>
                            <h2>Issues by Type</h2>
                        </div>
                        <canvas id="issueTypeChart"></canvas>
                    </div>

                    <div class="card chart" data-aos="fade-up" data-aos-delay="200">
                        <div class="card-header">
                            <i class="fas fa-exclamation-circle"></i>
                            <h2>Severity Distribution</h2>
                        </div>
                        <canvas id="severityChart"></canvas>
                    </div>

                    <div class="card chart" data-aos="fade-up" data-aos-delay="300">
                        <div class="card-header">
                            <i class="fas fa-code"></i>
                            <h2>Languages</h2>
                        </div>
                        <canvas id="languageChart"></canvas>
                    </div>

                    <div class="card chart" data-aos="fade-up" data-aos-delay="400">
                        <div class="card-header">
                            <i class="fas fa-file"></i>
                            <h2>File Status</h2>
                        </div>
                        <canvas id="fileStatusChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- ISSUES TAB -->
            <section id="issues" class="tab" data-aos="fade-up">
                <div class="issues-list">
                    {% for issue in results.explanations %}
                    <div class="issue-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 25 }}"
                         data-severity="{{ issue.severity }}"
                         data-language="{{ get_language_from_file(issue.file) if get_language_from_file is defined else '' }}"
                         data-keyword="{{ issue.title }} {{ issue.file }} {{ issue.description }}">
                        <div class="issue-header">
                            <div class="issue-title">
                                <span class="severity {{ issue.severity | lower }}">{{ issue.severity }}</span>
                                <h3>{{ issue.title }}</h3>
                            </div>
                            <div class="issue-actions">
                                <button class="btn-outline" onclick="toggleDetails(this)">
                                    <i class="fas fa-chevron-down"></i>
                                    <span>Details</span>
                                </button>
                            </div>
                        </div>
                        <div class="issue-body">
                            <p class="issue-description">{{ issue.description }}</p>

                            <div class="code-context-section">
                                <button class="context-toggle" onclick="toggleCodeContext('{{ loop.index }}')">
                                    <i class="fas fa-code"></i>
                                    <span>Full Code Context</span>
                                    <i class="fas fa-chevron-down context-expand-icon"></i>
                                </button>
                                <div class="code-context-content" id="codeContext{{ loop.index }}" style="display: none;">
                                    <div class="code-context-header">
                                        <span>File: {{ issue.file }}</span>
                                        <span>Issue Line: {{ issue.line }}</span>
                                    </div>
                                    <div class="code-context-lines">
                                        {% if issue.context %}
                                            {% for context_line in issue.context %}
                                            <div class="context-line {% if loop.index == (issue.context|length // 2) + 1 %}issue-line{% endif %}">
                                                <span class="line-number">{{ issue.line - (issue.context|length // 2) + loop.index - 1 }}</span>
                                                <code class="language-{{ get_language_from_file(issue.file) if get_language_from_file is defined else 'markup' }}">{{ context_line }}</code>
                                                {% if loop.index == (issue.context|length // 2) + 1 %}
                                                    <button class="auto-fix-btn" type="button"
                                                            data-scan-id="{{ scan_id }}"
                                                            data-issue-index="{{ loop.parent.index }}"
                                                            data-issue='{{ issue|tojson }}'
                                                            onclick="autoFixIssue(this.dataset.scanId, Number(this.dataset.issueIndex), JSON.parse(this.dataset.issue))">
                                                        <i class="fas fa-magic"></i>
                                                        <span>Auto-Fix</span>
                                                    </button>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="context-line issue-line">
                                                <span class="line-number">{{ issue.line }}</span>
                                                <code class="language-{{ get_language_from_file(issue.file) if get_language_from_file is defined else 'markup' }}">{{ issue.code }}</code>
                                                <button class="auto-fix-btn" type="button"
                                                        data-scan-id="{{ scan_id }}"
                                                        data-issue-index="{{ loop.index }}"
                                                        data-issue='{{ issue|tojson }}'
                                                        onclick="autoFixIssue(this.dataset.scanId, Number(this.dataset.issueIndex), JSON.parse(this.dataset.issue))">
                                                    <i class="fas fa-magic"></i>
                                                    <span>Auto-Fix</span>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- FILES TAB -->
            <section id="files" class="tab" data-aos="fade-up">
                <div class="files-list">
                    {% for file in results.file_status %}
                    <div class="file-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 20 }}"
                         data-language="{{ file.language }}" data-keyword="{{ file.path }} {{ file.status }}">
                        <div class="file-header">
                            <div class="file-title">
                                <i class="fas fa-file-code"></i>
                                <h3>{{ file.path }}</h3>
                            </div>
                            <span class="file-status {{ file.status | lower }}">{{ file.status }}</span>
                        </div>
                        <div class="file-body">
                            <div class="file-meta">
                                <span><i class="fas fa-language"></i> {{ file.language }}</span>
                                <span><i class="fas fa-code-branch"></i> {{ file.changes }} changes</span>
                            </div>
                            {% if file.preview %}
                            <pre class="code-preview"><code class="language-{{ file.language | lower }}">{{ file.preview }}</code></pre>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- REPORT TAB -->
            <section id="report" class="tab" data-aos="fade-up">
                <div class="card" data-aos="fade-up">
                    <div class="card-header">
                        <i class="fas fa-file-export"></i>
                        <h2>Export Report</h2>
                    </div>
                    <div class="card-body">
                        <p>Download a JSON report of all issues and file statuses.</p>
                        <button id="downloadReport" class="btn-primary">
                            <i class="fas fa-download"></i> 
                            <span>Download Report</span>
                        </button>
                    </div>
                </div>

                <div class="toolbar" data-aos="fade-up">
                    <div class="toolbar-left">
                        <div class="search-group">
                            <i class="fas fa-search"></i>
                            <input id="filterSearch" type="text" placeholder="Search issues and files...">
                        </div>
                        <div class="select-group">
                            <i class="fas fa-language"></i>
                            <select id="languageFilter">
                                <option value="">All Languages</option>
                                {% for lang in languages %}
                                <option value="{{ lang }}">{{ lang }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="select-group">
                            <i class="fas fa-exclamation-triangle"></i>
                            <select id="severityFilter">
                                <option value="">All Severities</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer" data-aos="fade-up">
            <p> {{ generated_at[:4] }} Agentic Code Security Auto-Fixer</p>
        </footer>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <script>
        // THEME
        function initializeTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') document.body.classList.add('dark-mode');
        }

        // FILTERS
        function applyFilters() {
            const q = document.getElementById('filterSearch').value.toLowerCase();
            const lang = document.getElementById('languageFilter').value;
            const sever = document.getElementById('severityFilter').value;

            document.querySelectorAll('.issue-card').forEach(card => {
                const kw = (card.getAttribute('data-keyword') || '').toLowerCase();
                const l = card.getAttribute('data-language') || '';
                const s = card.getAttribute('data-severity') || '';
                const ok = (!q || kw.includes(q)) && (!lang || l === lang) && (!sever || s === sever);
                card.style.display = ok ? '' : 'none';
            });

            document.querySelectorAll('.file-card').forEach(card => {
                const kw = (card.getAttribute('data-keyword') || '').toLowerCase();
                const l = card.getAttribute('data-language') || '';
                const ok = (!q || kw.includes(q)) && (!lang || l === lang);
                card.style.display = ok ? '' : 'none';
            });
        }

        document.getElementById('filterSearch').addEventListener('input', applyFilters);
        document.getElementById('languageFilter').addEventListener('change', applyFilters);
        document.getElementById('severityFilter').addEventListener('change', applyFilters);

        // TABS
        document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.main-nav .nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.getAttribute('data-tab');
                document.querySelectorAll('.tab').forEach(s => s.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
            });
        });

        // COLLAPSE DETAILS
        function toggleDetails(btn) {
            const body = btn.closest('.issue-card').querySelector('.issue-body');
            body.classList.toggle('open');
        }

        // CONTEXT TOGGLE
        function toggleCodeContext(id) {
            const panel = document.getElementById('codeContext' + id);
            if (!panel) return;
            const isHidden = panel.style.display === 'none' || panel.style.display === '';
            panel.style.display = isHidden ? 'block' : 'none';
        }

        // REPORT DOWNLOAD
        document.getElementById('downloadReport').addEventListener('click', () => {
            const data = {
                explanations: EXPLANATIONS,
                file_status: FILE_STATUS
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan_{{ scan_id }}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        // CHART COLORS
        const lightColors = {
            text: '#1f2937',
            grid: 'rgba(31,41,55,0.1)',
            fill: 'rgba(59,130,246,0.15)'
        };
        const darkColors = {
            text: '#d1d5db',
            grid: 'rgba(209,213,219,0.15)',
            fill: 'rgba(59,130,246,0.25)'
        };

        let charts = {};
        
        // Data from server (Jinja2 rendered)
        var EXPLANATIONS = {{ results.explanations | tojson | safe if results.explanations else '[]' }};
        var FILE_STATUS = {{ results.file_status | tojson | safe if results.file_status else '[]' }};

        function initializeCharts() {
            const isDark = document.body.classList.contains('dark-mode');
            const colors = isDark ? darkColors : lightColors;
            
            createIssueTypeChart(EXPLANATIONS, colors);
            createLanguageChart(FILE_STATUS, colors);
            createSeverityChart(EXPLANATIONS, colors);
            createFileStatusChart(FILE_STATUS, colors);
        }
        
        function handleAutoFix(button) {
            const scanId = button.getAttribute('data-scan-id');
            const issueIndex = parseInt(button.getAttribute('data-issue-index'));
            const issueData = JSON.parse(button.getAttribute('data-issue'));
            autoFixIssue(scanId, issueIndex, issueData);
        }

        function createIssueTypeChart(issues, colors) {
            const ctx = document.getElementById('issueTypeChart').getContext('2d');
            const counts = {};
            issues.forEach(i => counts[i.type] = (counts[i.type] || 0) + 1);
            const data = {
                labels: Object.keys(counts),
                datasets: [{ data: Object.values(counts), backgroundColor: [
                    'rgba(59,130,246,0.6)', 'rgba(16,185,129,0.6)', 'rgba(245,158,11,0.6)', 'rgba(239,68,68,0.6)'
                ]}]
            };
            charts.issueType = new Chart(ctx, {
                type: 'doughnut',
                data,
                options: { plugins: { legend: { labels: { color: colors.text } } } }
            });
        }

        function createSeverityChart(issues, colors) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            const levels = ['Critical', 'High', 'Medium', 'Low'];
            const counts = levels.map(l => issues.filter(i => i.severity === l).length);
            charts.severity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: levels,
                    datasets: [{ label: 'Count', data: counts }]
                },
                options: {
                    scales: {
                        x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                        y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
                    },
                    plugins: { legend: { labels: { color: colors.text } } }
                }
            });
        }

        function createLanguageChart(files, colors) {
            const ctx = document.getElementById('languageChart').getContext('2d');
            const counts = {};
            files.forEach(f => counts[f.language] = (counts[f.language] || 0) + 1);
            charts.language = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts) }]
                },
                options: { plugins: { legend: { labels: { color: colors.text } } } }
            });
        }

        function createFileStatusChart(files, colors) {
            const ctx = document.getElementById('fileStatusChart').getContext('2d');
            const statuses = ['Unchanged', 'Modified', 'Created', 'Deleted'];
            const counts = statuses.map(s => files.filter(f => f.status === s).length);
            charts.fileStatus = new Chart(ctx, {
                type: 'bar',
                data: { labels: statuses, datasets: [{ label: 'Files', data: counts }] },
                options: {
                    scales: {
                        x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                        y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
                    },
                    plugins: { legend: { labels: { color: colors.text } } }
                }
            });
        }

        // AUTO-FIX API CALL
        async function autoFixIssue(scanId, issueIndex, issueData) {
            const btns = document.querySelectorAll('.auto-fix-btn');
            btns.forEach(b => b.disabled = true);

            try {
                const res = await fetch(`/auto_fix/${scanId}/${issueIndex}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(issueData)
                });
                const json = await res.json();
                alert(json.message || 'Auto-fix completed.');
            } catch (e) {
                console.error(e);
                alert('Auto-fix failed. Please check console for details.');
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            Object.values(charts).forEach(c => c && c.destroy());
            initializeCharts();
        });

        document.addEventListener('DOMContentLoaded', function() {
            if (window.AOS && typeof AOS.init === 'function') {
                AOS.init({ duration: 800, easing: 'ease-in-out', once: true, offset: 100 });
            }
            initializeTheme();
            initializeCharts();
        });
    </script>
</body>
</html>
````

## File: agentic_fixer/app.py
````python
from flask import Flask, render_template, request, jsonify, redirect, url_for, send_file
import os
import tempfile
import shutil
import threading
import time
from datetime import datetime
import json
import zipfile
import re
from werkzeug.utils import secure_filename
from io import BytesIO

try:
    from openpyxl import Workbook
    from openpyxl.styles import Font
except Exception:
    Workbook = None
    Font = None

# Import your existing modules
from code_security_auto_fixer import repo_scanner, language_detector, pattern_detector, patcher, test_runner, reporter
from code_security_auto_fixer.ai_fixer import AIFixer
from code_security_auto_fixer.config import (
    GEMINI_API_BASE_URL,
    GEMINI_MODEL_NAME,
    GEMINI_API_KEY,
    GEMINI_ACCESS_TOKEN,
    GEMINI_TEMPERATURE,
    GEMINI_MAX_OUTPUT_TOKENS,
    GEMINI_CANDIDATE_COUNT
)
from code_security_auto_fixer.db_exporter import export_to_db
from code_security_auto_fixer.db_reader import list_available_scans, get_scan_results, get_scan_aggregates, get_files_by_scan_id

app = Flask(__name__)
app.secret_key = 'your-secret-key-here'

# Configuration for file uploads
UPLOAD_FOLDER = 'uploads'
ALLOWED_EXTENSIONS = {'txt', 'py', 'js', 'java', 'html', 'css', 'php', 'rb', 'go', 'rs', 'ts', 'cpp', 'c', 'cc', 'cxx', 'h', 'hpp', 'json', 'xml', 'md', 'zip'}
MAX_FILE_SIZE = 500 * 1024 * 1024  # 500MB

# Ensure upload directory exists
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['MAX_CONTENT_LENGTH'] = MAX_FILE_SIZE

# Global variable to store scan results
scan_results = {}
scan_status = {}

# Helper function to get language from file extension
def get_language_from_file(filename):
    if filename.endswith('.py'):
        return 'python'
    elif filename.endswith('.js'):
        return 'javascript'
    elif filename.endswith('.java'):
        return 'java'
    elif filename.endswith('.html'):
        return 'html'
    elif filename.endswith('.css'):
        return 'css'
    elif filename.endswith('.c'):
        return 'c'
    elif filename.endswith('.cpp') or filename.endswith('.cc'):
        return 'cpp'
    elif filename.endswith('.php'):
        return 'php'
    elif filename.endswith('.rb'):
        return 'ruby'
    elif filename.endswith('.go'):
        return 'go'
    elif filename.endswith('.rs'):
        return 'rust'
    elif filename.endswith('.ts'):
        return 'typescript'
    else:
        return 'text'

# Make the function available in templates
app.jinja_env.globals.update(get_language_from_file=get_language_from_file)

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def extract_zip_file(zip_path, extract_to):
    """Extract zip file to a directory"""
    try:
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall(extract_to)
        return True
    except Exception as e:
        print(f"Error extracting zip file: {e}")
        return False

def process_uploaded_file(file_path, filename):
    """Process uploaded file and return the directory to scan"""
    print(f"[DEBUG] Processing file: {file_path}, filename: {filename}")
    if filename.endswith('.zip'):
        # Extract zip file to a temporary directory
        temp_dir = tempfile.mkdtemp()
        print(f"[DEBUG] Extracting zip to: {temp_dir}")
        if extract_zip_file(file_path, temp_dir):
            return temp_dir
        else:
            raise Exception("Failed to extract zip file")
    else:
        # For single files, create a temporary directory and copy the file
        temp_dir = tempfile.mkdtemp()
        temp_file_path = os.path.join(temp_dir, filename)
        print(f"[DEBUG] Copying file to: {temp_file_path}")
        shutil.copy2(file_path, temp_file_path)
        return temp_dir


def _build_ai_fixer() -> AIFixer:
    return AIFixer(
        api_base_url=GEMINI_API_BASE_URL,
        model_name=GEMINI_MODEL_NAME,
        api_key=GEMINI_API_KEY,
        access_token=GEMINI_ACCESS_TOKEN,
        temperature=GEMINI_TEMPERATURE,
        max_output_tokens=GEMINI_MAX_OUTPUT_TOKENS,
        candidate_count=GEMINI_CANDIDATE_COUNT
    )

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    if 'file' not in request.files:
        return jsonify({'error': 'No file provided'}), 400
    
    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': 'No file selected'}), 400
    
    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(file_path)
        
        # Generate a unique scan ID
        scan_id = f"scan_{int(time.time())}"
        print(f"[DEBUG] Generated scan ID: {scan_id}")
        
        # Initialize scan status FIRST
        scan_status[scan_id] = {
            'status': 'started',
            'progress': 0,
            'current_step': 'Processing uploaded file...',
            'started_at': datetime.now().isoformat()
        }
        print(f"[DEBUG] Initialized scan status for {scan_id}")
        
        # Start scanning in background
        thread = threading.Thread(target=run_file_scan, args=(scan_id, file_path, filename))
        thread.daemon = True
        thread.start()
        print(f"[DEBUG] Started background thread for {scan_id}")
        
        return jsonify({'scan_id': scan_id})
    else:
        return jsonify({'error': 'Invalid file type'}), 400

@app.route('/scan', methods=['POST'])
def scan_repository():
    data = request.get_json()
    repo_path = data.get('repository')
    auto_fix = data.get('auto_fix', False)
    orchestrator_name = data.get('orchestrator', 'sequential')  # Default to sequential
    
    if not repo_path:
        return jsonify({'error': 'Repository path is required'}), 400
    
    # Validate orchestrator name
    valid_orchestrators = ['sequential', 'langgraph', 'autogen', 'crewai']
    if orchestrator_name not in valid_orchestrators:
        return jsonify({'error': f'Invalid orchestrator. Must be one of: {", ".join(valid_orchestrators)}'}), 400
    
    # Generate a unique scan ID
    scan_id = f"scan_{int(time.time())}"
    
    # Start scanning in background
    thread = threading.Thread(target=run_scan, args=(scan_id, repo_path, auto_fix, None, orchestrator_name))
    thread.daemon = True
    thread.start()
    
    # Initialize scan status
    scan_status[scan_id] = {
        'status': 'started',
        'progress': 0,
        'current_step': f'Initializing {orchestrator_name} orchestrator...',
        'started_at': datetime.now().isoformat(),
        'orchestrator': orchestrator_name
    }
    
    # Track start time for performance metrics
    scan_status[scan_id]['start_time'] = time.time()
    
    return jsonify({'scan_id': scan_id})

def run_file_scan(scan_id, file_path, filename):
    try:
        print(f"[DEBUG] Starting file scan for {filename} with ID {scan_id}")
        
        # Step 1: Process uploaded file into a temporary directory (or extract zip)
        update_status(scan_id, 'processing', 10, 'Processing uploaded file...')
        upload_dir = process_uploaded_file(file_path, filename)
        print(f"[DEBUG] Uploaded content prepared at: {upload_dir}")
        
        # The repository workflow handles scanning comprehensively. Reuse it.
        # Remove the original uploaded file (no longer needed) then delegate.
        try:
            if os.path.exists(file_path):
                os.remove(file_path)
        except Exception:
            pass
        
        # Extract filename without extension for database name
        # Remove extension for cleaner database filename (e.g., app.py -> app)
        filename_base = os.path.splitext(filename)[0] if filename else None
        
        # Delegate to repository scan to ensure identical behavior and reporting
        # Pass the filename as db_name to use it for the database filename
        run_scan(scan_id, upload_dir, auto_fix=False, db_name=filename_base if filename_base else filename)
        
    except Exception as e:
        print(f"[DEBUG] Error in file scan: {str(e)}")
        import traceback
        traceback.print_exc()
        update_status(scan_id, 'error', 0, f'Error: {str(e)}')
        scan_results[scan_id] = {'error': str(e)}
        
        # Clean up on error
        try:
            if 'file_path' in locals() and os.path.exists(file_path):
                os.remove(file_path)
        except:
            pass
        try:
            if 'upload_dir' in locals() and os.path.exists(upload_dir):
                shutil.rmtree(upload_dir)
        except:
            pass

def run_scan(scan_id, repo_path, auto_fix, db_name=None, orchestrator_name='sequential'):
    try:
        # Use orchestrator if available, otherwise fall back to sequential
        try:
            from code_security_auto_fixer.orchestrators import get_orchestrator
            
            update_status(scan_id, 'initializing', 5, f'Initializing {orchestrator_name} orchestrator...')
            orchestrator = get_orchestrator(orchestrator_name)
            
            # Run through orchestrator
            report_path = f"reports/scan_{scan_id}_report.md"
            os.makedirs("reports", exist_ok=True)
            
            # Map progress updates
            def progress_callback(step, progress, message):
                update_status(scan_id, step, progress, message)
            
            # Run orchestrator
            result = orchestrator.run(
                repo=repo_path,
                fix=auto_fix,
                report_path=report_path,
                progress_callback=progress_callback
            )
            
            # Extract results from orchestrator output
            repo_location = result.get('repo_path') or repo_scanner.scan(repo_path)
            file_languages = language_detector.detect_per_file(repo_location)
            languages = result.get('languages', [])
            findings = result.get('findings', [])
            prioritized = result.get('prioritized', [])
            explanations = result.get('explanations', [])
            file_status = result.get('file_status', [])
            patch_results = result.get('patched', []) if auto_fix else None
            
            # Calculate all_files for stats
            all_files = set(file_languages.keys())
            
        except Exception as e:
            # Fall back to sequential if orchestrator not available or fails
            import traceback
            error_msg = str(e)
            if isinstance(e, (ImportError, ModuleNotFoundError)):
                print(f"[WARNING] Orchestrator '{orchestrator_name}' package not installed, using sequential: {e}")
                install_cmd = {
                    'autogen': 'pyautogen',
                    'langgraph': 'langgraph>=0.6.8',
                    'crewai': 'crewai'
                }.get(orchestrator_name, 'the required package')
                print(f"[INFO] To install: pip install {install_cmd}")
            else:
                print(f"[WARNING] Orchestrator '{orchestrator_name}' failed, using sequential: {e}")
                print(f"[DEBUG] Traceback: {traceback.format_exc()}")
            orchestrator_name = 'sequential'
            # Continue with sequential workflow below
            repo_location = repo_scanner.scan(repo_path)
            
            if not repo_location or not os.path.exists(repo_location):
                raise Exception(f"Repository not found or invalid: {repo_path}")
            
            # Step 2: Detecting languages
            update_status(scan_id, 'detecting_languages', 25, 'Detecting programming languages...')
            file_languages = language_detector.detect_per_file(repo_location)
            languages = [
                lang for lang in sorted(set(file_languages.values()))
                if lang and lang.lower() not in {'unknown', 'text'}
            ]
            
            # Step 3: Scanning for patterns
            update_status(scan_id, 'scanning_patterns', 40, 'Scanning for insecure patterns...')
            findings = pattern_detector.scan(repo_location, languages)
            
            # Step 4: Normalizing findings
            update_status(scan_id, 'normalizing', 55, 'Normalizing and prioritizing findings...')
            prioritized = pattern_detector.normalize_and_prioritize(findings)
            
            # Step 5: Generating explanations
            update_status(scan_id, 'generating_explanations', 70, 'Generating explanations and suggestions...')
            explanations = pattern_detector.explain_and_suggest(prioritized, detailed=True)
            
            # Step 6: Building file status
            update_status(scan_id, 'building_status', 80, 'Building file status...')
            all_files = set(file_languages.keys())
            files_with_issues = set(f['file'] for f in prioritized)
            file_status = []
            for f in all_files:
                status = 'issue' if f in files_with_issues else 'clean'
                lang = file_languages.get(f, 'unknown')
                file_status.append({'file': f, 'status': status, 'language': lang})
            
            # Step 7: Auto-fix if requested
            patch_results = None
            if auto_fix:
                update_status(scan_id, 'applying_patches', 85, 'Applying patches...')
                patch_results = patcher.apply(repo_location, prioritized)
                
                update_status(scan_id, 'running_tests', 90, 'Running tests...')
                test_ok = test_runner.run(repo_location)
                if not test_ok:
                    update_status(scan_id, 'reverting', 95, 'Tests failed, reverting patches...')
                    patcher.revert(repo_location)
            
            # Step 8: Generate report
            update_status(scan_id, 'generating_report', 95, 'Generating final report...')
            report_path = f"reports/scan_{scan_id}_report.md"
            os.makedirs("reports", exist_ok=True)
            reporter.generate(report_path, explanations, prioritized, file_status)
        
        # Common final steps (database export, etc.)
        
        # Extract repo name for database export - use provided db_name if available, otherwise extract from repo_path
        if db_name:
            repo_name = db_name
        else:
            repo_name = os.path.basename(repo_path.rstrip('/\\'))
            if not repo_name or repo_name == '.':
                repo_name = 'scan_' + scan_id
        
        # Prepare data for database export
        db_export_data = {
            'repo_path': repo_location,  # Use actual cloned directory, not the original URL
            'completed_at': datetime.now().isoformat(),
            'languages': languages,
            'file_status': file_status,
            'explanations': explanations,
            'prioritized': prioritized,
            'findings': findings
        }
        
        # Calculate stats
        auto_fixes_count = len([e for e in explanations if e.get('auto_fixable', False)])
        manual_reviews_count = len(explanations) - auto_fixes_count
        
        # Calculate execution time
        execution_time = None
        if 'start_time' in scan_status.get(scan_id, {}):
            execution_time = time.time() - scan_status[scan_id]['start_time']
        
        # Export to SQLite database (with performance metrics)
        update_status(scan_id, 'exporting_db', 98, 'Exporting data to SQLite database...')
        db_path = export_to_db(
            db_export_data, 
            repo_name,
            scan_id=scan_id,
            orchestrator=orchestrator_name,
            execution_time=execution_time,
            total_issues=len(explanations),
            success=True
        )
        
        # Store results
        scan_results[scan_id] = {
            'repo_path': repo_path,
            'repo_location': repo_location,
            'file_languages': file_languages,
            'languages': languages,
            'findings': findings,
            'prioritized': prioritized,
            'explanations': explanations,
            'file_status': file_status,
            'patch_results': patch_results,
            'report_path': report_path,
            'db_path': db_path,
            'stats': {
                'total_issues': len(explanations),
                'files_scanned': len(all_files),
                'auto_fixes': auto_fixes_count,
                'manual_reviews': manual_reviews_count
            },
            'completed_at': datetime.now().isoformat(),
            'execution_time': execution_time,
            'orchestrator': orchestrator_name
        }
        
        # Update scan_status with completion info
        if scan_id in scan_status:
            scan_status[scan_id].update({
                'completed_at': datetime.now().isoformat(),
                'execution_time': execution_time,
                'success': True
            })
        
        # Clean up temporary directory if it was created
        if repo_location != repo_path and os.path.exists(repo_location):
            try:
                shutil.rmtree(repo_location)
            except:
                pass
        
        update_status(scan_id, 'completed', 100, 'Scan completed successfully!')
        
    except Exception as e:
        execution_time = None
        if 'start_time' in scan_status.get(scan_id, {}):
            execution_time = time.time() - scan_status[scan_id]['start_time']
        
        update_status(scan_id, 'error', 0, f'Error: {str(e)}')
        scan_results[scan_id] = {'error': str(e)}
        
        # Update scan_status with error info
        if scan_id in scan_status:
            orchestrator_name = scan_status[scan_id].get('orchestrator', 'sequential')
            scan_status[scan_id].update({
                'completed_at': datetime.now().isoformat(),
                'execution_time': execution_time,
                'success': False,
                'error': str(e),
                'orchestrator': orchestrator_name
            })
            
            # Try to save performance metrics to database even on error
            try:
                # Get repo name from scan_status if available
                repo_name = scan_status[scan_id].get('repository', 'error_scan')
                if repo_name and os.path.exists(repo_name):
                    repo_name = os.path.basename(repo_name.rstrip('/\\'))
                if not repo_name or repo_name == '.':
                    repo_name = 'scan_' + scan_id
                
                # Create minimal data for error case
                error_data = {
                    'repo_path': repo_name,
                    'completed_at': datetime.now().isoformat(),
                    'languages': [],
                    'file_status': [],
                    'explanations': [],
                    'prioritized': [],
                    'findings': []
                }
                
                # Export error scan to database with performance metrics
                export_to_db(
                    error_data,
                    repo_name,
                    scan_id=scan_id,
                    orchestrator=orchestrator_name,
                    execution_time=execution_time,
                    total_issues=0,
                    success=False
                )
            except Exception as db_error:
                print(f"[WARNING] Failed to save error scan to database: {db_error}")

def update_status(scan_id, status, progress, current_step):
    print(f"[DEBUG] update_status called: {scan_id}, {status}, {progress}, {current_step}")
    print(f"[DEBUG] Current scan_status keys: {list(scan_status.keys())}")
    
    if scan_id in scan_status:
        scan_status[scan_id].update({
            'status': status,
            'progress': progress,
            'current_step': current_step
        })
        print(f"[DEBUG] Updated existing status for {scan_id}")
    else:
        # Initialize the scan status if it doesn't exist
        scan_status[scan_id] = {
            'status': status,
            'progress': progress,
            'current_step': current_step,
            'started_at': datetime.now().isoformat()
        }
        print(f"[DEBUG] Created new status for {scan_id}")
    
    print(f"[DEBUG] Final scan_status keys: {list(scan_status.keys())}")
    print(f"[DEBUG] Status for {scan_id}: {scan_status.get(scan_id)}")

@app.route('/orchestrators', methods=['GET'])
def list_orchestrators():
    """List available orchestrators with their availability status"""
    try:
        from code_security_auto_fixer.orchestrators import list_available_orchestrators
        orchestrators = list_available_orchestrators()
        result = {
            'orchestrators': orchestrators,
            'available': list(orchestrators.keys())
        }
        
        # Check if each framework is actually available
        status = {}
        for name in ['sequential', 'langgraph', 'autogen', 'crewai']:
            try:
                from code_security_auto_fixer.orchestrators import get_orchestrator
                get_orchestrator(name)
                status[name] = {'available': True, 'error': None}
            except Exception as e:
                install_commands = {
                    'autogen': 'pyautogen>=0.2.0',
                    'langgraph': 'langgraph>=0.6.8',
                    'crewai': 'crewai',
                    'sequential': ''
                }
                status[name] = {
                    'available': False, 
                    'error': str(e),
                    'install_command': f"pip install {install_commands.get(name, '')}" if install_commands.get(name) else ''
                }
        
        result['status'] = status
        return jsonify(result)
    except Exception as e:
        return jsonify({
            'error': str(e), 
            'orchestrators': {'sequential': 'Sequential execution baseline'},
            'status': {
                'sequential': {'available': True, 'error': None}
            }
        }), 500

@app.route('/performance', methods=['GET'])
def get_performance_metrics():
    """Get performance metrics for all frameworks from database"""
    try:
        import sqlite3
        frameworks = ['sequential', 'langgraph', 'autogen', 'crewai']
        metrics = {}
        
        # Get all scan databases
        repo_storage_dir = "repo_storage"
        if not os.path.exists(repo_storage_dir):
            # Return empty metrics for all frameworks
            for framework in frameworks:
                metrics[framework] = {
                    'total_scans': 0,
                    'completed_scans': 0,
                    'successful_scans': 0,
                    'success_rate': 0,
                    'avg_execution_time': 0,
                    'min_execution_time': 0,
                    'max_execution_time': 0,
                    'avg_issues': 0,
                    'avg_files_scanned': 0,
                    'scans': []
                }
            return jsonify(metrics)
        
        # Collect all scans from databases
        all_scans = []
        
        for item in os.listdir(repo_storage_dir):
            if item.endswith('.db'):
                db_path = os.path.join(repo_storage_dir, item)
                try:
                    conn = sqlite3.connect(db_path)
                    conn.row_factory = sqlite3.Row
                    cursor = conn.cursor()
                    
                    # Check if it has the scans table
                    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='scans'")
                    if cursor.fetchone():
                        # Check if orchestrator column exists (for backward compatibility)
                        cursor.execute("PRAGMA table_info(scans)")
                        columns = [row[1] for row in cursor.fetchall()]
                        has_orchestrator = 'orchestrator' in columns
                        has_execution_time = 'execution_time' in columns
                        has_total_issues = 'total_issues' in columns
                        has_success = 'success' in columns
                        has_files_scanned = 'files_scanned' in columns
                        
                        # Build query based on available columns
                        select_cols = ['scan_id', 'started_at', 'finished_at']
                        if has_orchestrator:
                            select_cols.append('orchestrator')
                        if has_execution_time:
                            select_cols.append('execution_time')
                        if has_total_issues:
                            select_cols.append('total_issues')
                        if has_files_scanned:
                            select_cols.append('files_scanned')
                        if has_success:
                            select_cols.append('success')
                        
                        query = f'''
                            SELECT {', '.join(select_cols)}
                            FROM scans
                            WHERE finished_at IS NOT NULL
                        '''
                        
                        cursor.execute(query)
                        
                        for row in cursor.fetchall():
                            scan_data = {
                                'scan_id': row['scan_id'],
                                'orchestrator': (row['orchestrator'] or 'sequential') if has_orchestrator else 'sequential',
                                'started_at': row['started_at'],
                                'completed_at': row['finished_at'],
                                'execution_time': row['execution_time'] if has_execution_time else None,
                                'total_issues': (row['total_issues'] or 0) if has_total_issues else 0,
                                'files_scanned': (row['files_scanned'] or 0) if has_files_scanned else 0,
                                'success': bool(row['success']) if has_success and row['success'] is not None else True
                            }
                            all_scans.append(scan_data)
                    
                    conn.close()
                except Exception as e:
                    print(f"[WARNING] Error reading scan from {db_path}: {e}")
                    continue
        
        # Group scans by framework
        for framework in frameworks:
            framework_scans = [s for s in all_scans if s.get('orchestrator') == framework]
            
            # Calculate metrics
            completed_scans = [s for s in framework_scans if s.get('completed_at')]
            successful_scans = [s for s in completed_scans if s.get('success', False)]
            
            execution_times = [s['execution_time'] for s in completed_scans if s.get('execution_time') is not None]
            total_issues = [s.get('total_issues', 0) for s in completed_scans]
            files_scanned = [s.get('files_scanned', 0) for s in completed_scans]
            
            metrics[framework] = {
                'total_scans': len(framework_scans),
                'completed_scans': len(completed_scans),
                'successful_scans': len(successful_scans),
                'success_rate': (len(successful_scans) / len(completed_scans) * 100) if completed_scans else 0,
                'avg_execution_time': sum(execution_times) / len(execution_times) if execution_times else 0,
                'min_execution_time': min(execution_times) if execution_times else 0,
                'max_execution_time': max(execution_times) if execution_times else 0,
                'avg_issues': sum(total_issues) / len(total_issues) if total_issues else 0,
                'avg_files_scanned': sum(files_scanned) / len(files_scanned) if files_scanned else 0,
                'scans': completed_scans
            }
        
        return jsonify(metrics)
    except Exception as e:
        import traceback
        print(f"[ERROR] Error fetching performance metrics: {e}")
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/status/<scan_id>')
def get_status(scan_id):
    print(f"[DEBUG] Status request for scan_id: {scan_id}")
    print(f"[DEBUG] Available scan_ids: {list(scan_status.keys())}")
    if scan_id not in scan_status:
        print(f"[DEBUG] Scan ID {scan_id} not found in scan_status")
        return jsonify({'error': 'Scan not found'}), 404
    
    status = scan_status[scan_id]
    print(f"[DEBUG] Returning status: {status}")
    return jsonify(status)

@app.route('/results/<scan_id>')
def get_results(scan_id):
    # First, check if results are in memory
    if scan_id in scan_results:
        results = scan_results[scan_id]
        
        # Check if there was an error during scanning
        if 'error' in results:
            return jsonify({'error': results['error']}), 500
        
        return jsonify(results)
    
    # If not in memory, try to load from database
    try:
        print(f"[DEBUG] Attempting to load scan results for scan_id: {scan_id}")
        db_path = get_files_by_scan_id(scan_id)
        print(f"[DEBUG] Database path returned: {db_path}")
        
        if db_path and os.path.exists(db_path):
            print(f"[DEBUG] Loading results from database: {db_path}")
            results = get_scan_results(db_path, scan_id)
            print(f"[DEBUG] Results loaded. Issues: {len(results.get('explanations', []))}, Files: {len(results.get('file_status', []))}")
            
            # Verify results have required fields
            if not results.get('explanations'):
                results['explanations'] = []
            if not results.get('file_status'):
                results['file_status'] = []
            if not results.get('languages'):
                results['languages'] = []
                
            # Cache it in memory for quick access
            scan_results[scan_id] = results
            return jsonify(results)
        else:
            print(f"[ERROR] Database path not found or doesn't exist: {db_path}")
    except Exception as e:
        import traceback
        print(f"[ERROR] Error loading from database: {e}")
        traceback.print_exc()
    
    return jsonify({'error': 'Results not found'}), 404

@app.route('/results/<scan_id>/view')
def view_results(scan_id):
    if scan_id not in scan_results:
        return render_template('error.html', message='Results not found')
    
    return render_template('results.html', scan_id=scan_id, results=scan_results[scan_id])

def _auto_fit_columns(ws):
    try:
        for column_cells in ws.columns:
            max_length = 0
            column = column_cells[0].column_letter
            for cell in column_cells:
                try:
                    value = str(cell.value) if cell.value is not None else ""
                except Exception:
                    value = ""
                if len(value) > max_length:
                    max_length = len(value)
            adjusted_width = min(max_length + 2, 60)
            ws.column_dimensions[column].width = adjusted_width
    except Exception:
        pass

def _build_excel(results):
    if Workbook is None:
        raise RuntimeError("Excel export requires openpyxl. Please install dependencies.")
    wb = Workbook()
    ws_summary = wb.active
    ws_summary.title = 'Summary'
    bold = Font(bold=True) if Font else None

    # Summary sheet
    summary_rows = [
        ['Repository', results.get('repo_path')],
        ['Completed At', results.get('completed_at')],
        ['Languages Detected', ', '.join(results.get('languages') or [])],
        ['Total Files', len(results.get('file_status') or [])],
        ['Files with Issues', (len(results.get('file_status') or []) - sum(1 for f in (results.get('file_status') or []) if f.get('status') == 'clean'))]
    ]
    ws_summary.append(['Field', 'Value'])
    if bold:
        ws_summary['A1'].font = bold
        ws_summary['B1'].font = bold
    for row in summary_rows:
        ws_summary.append(row)
    _auto_fit_columns(ws_summary)

    # Issues sheet
    ws_issues = wb.create_sheet('Issues')
    ws_issues.append(['File', 'Line', 'Issue', 'Severity', 'CWE', 'OWASP', 'Category', 'Priority', 'Description', 'Code', 'Suggestion'])
    if bold:
        for cell in ws_issues[1]:
            cell.font = bold
    for issue in results.get('explanations') or []:
        ws_issues.append([
            issue.get('file'),
            issue.get('line'),
            issue.get('issue'),
            issue.get('severity'),
            issue.get('cwe'),
            issue.get('owasp'),
            issue.get('category'),
            issue.get('priority_score'),
            issue.get('description') or issue.get('explanation'),
            issue.get('code'),
            issue.get('suggestion')
        ])
    _auto_fit_columns(ws_issues)

    # Files sheet
    ws_files = wb.create_sheet('Files')
    ws_files.append(['File', 'Status', 'Language'])
    if bold:
        for cell in ws_files[1]:
            cell.font = bold
    for f in results.get('file_status') or []:
        ws_files.append([f.get('file'), f.get('status'), f.get('language')])
    _auto_fit_columns(ws_files)

    # Languages sheet
    ws_lang = wb.create_sheet('Languages')
    ws_lang.append(['Language'])
    if bold:
        ws_lang['A1'].font = bold
    for l in results.get('languages') or []:
        ws_lang.append([l])
    _auto_fit_columns(ws_lang)

    bio = BytesIO()
    wb.save(bio)
    bio.seek(0)
    return bio

@app.route('/results/<scan_id>/download.xlsx')
def download_results_excel(scan_id):
    if scan_id not in scan_results:
        return render_template('error.html', message='Results not found')
    try:
        bio = _build_excel(scan_results[scan_id])
    except Exception as e:
        return render_template('error.html', message=f'Failed to build Excel: {str(e)}')
    filename = f"{scan_id}_report.xlsx"
    return send_file(bio, as_attachment=True, download_name=filename, mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')

@app.route('/results/<scan_id>/download')
def download_results_default(scan_id):
    # Backward-compatible endpoint used by existing UI; serve Excel by default
    return download_results_excel(scan_id)

@app.route('/api/auto-fix', methods=['POST'])
def auto_fix_issue():
    """API endpoint to generate AI-powered code fixes for security issues"""
    try:
        data = request.get_json()
        
        # Validate required fields
        required_fields = ['scan_id', 'issue_index', 'issue_data']
        for field in required_fields:
            if field not in data:
                return jsonify({'success': False, 'error': f'Missing required field: {field}'}), 400
        
        scan_id = data['scan_id']
        issue_index = data['issue_index']
        issue_data = data['issue_data']
        
        ai_fixer = _build_ai_fixer()
        
        # Generate secure solution
        result = ai_fixer.generate_secure_solution(issue_data)
        
        if result['success']:
            return jsonify({
                'success': True,
                'solution_code': result['solution_code'],
                'explanation': result['explanation'],
                'language': result['language'],
                'original_code': result['original_code'],
                'line_number': result['line_number'],
                'file_path': result['file_path']
            })
        else:
            return jsonify({
                'success': False,
                'error': result['error']
            }), 500
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/auto-fix-editor', methods=['POST'])
def auto_fix_editor_issue():
    """API endpoint to generate AI-powered code fixes for security issues in editor with full file context"""
    try:
        data = request.get_json()
        
        # Validate required fields
        required_fields = ['scan_id', 'file_path', 'file_content', 'line_number', 'issue_data']
        for field in required_fields:
            if field not in data:
                return jsonify({'success': False, 'error': f'Missing required field: {field}'}), 400
        
        scan_id = data['scan_id']
        file_path = data['file_path']
        file_content = data['file_content']
        line_number = data['line_number']
        issue_data = data['issue_data']
        
        ai_fixer = _build_ai_fixer()
        
        # Generate secure solution with full file context
        result = ai_fixer.generate_secure_solution_with_full_context(
            file_path=file_path,
            file_content=file_content,
            line_number=line_number,
            issue_data=issue_data
        )
        
        if result['success']:
            return jsonify({
                'success': True,
                'solution_code': result['solution_code'],
                'explanation': result['explanation'],
                'language': result['language'],
                'original_code': result['original_code'],
                'line_number': result['line_number'],
                'file_path': result['file_path']
            })
        else:
            return jsonify({
                'success': False,
                'error': result['error']
            }), 500
            
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/code-smell', methods=['POST'])
def detect_code_smell():
    """API endpoint to detect code smells in a specific file"""
    try:
        data = request.get_json()
        print(f"[DEBUG] Code smell detection request: {data}")
        
        # Validate required fields
        if 'file_path' not in data:
            return jsonify({'success': False, 'error': 'Missing required field: file_path'}), 400
        
        file_path = data['file_path']
        line_number = data.get('line_number', 0)
        
        print(f"[DEBUG] Analyzing code smells for file: {file_path}")
        
        # Get code smell detector
        code_smells = analyze_code_smells(file_path, line_number)
        
        print(f"[DEBUG] Found {len(code_smells)} code smells")
        
        return jsonify({
            'success': True,
            'code_smells': code_smells,
            'file_path': file_path,
            'line_number': line_number
        })
            
    except Exception as e:
        import traceback
        print(f"[DEBUG] Error in code smell detection: {str(e)}")
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500

def analyze_code_smells(file_path, line_number):
    """Analyze a file for common code smells - scans the ENTIRE file"""
    code_smells = []
    
    try:
        print(f"[DEBUG] Checking file path: {file_path}")
        original_path = file_path
        
        # Check if file exists
        if not os.path.exists(file_path):
            print(f"[DEBUG] File not found at {file_path}, searching in scan results...")
            # Try to find the file in any scan result
            for scan_id, results in scan_results.items():
                if 'repo_location' in results:
                    # Try relative path first
                    full_path = os.path.join(results['repo_location'], file_path)
                    if os.path.exists(full_path):
                        file_path = full_path
                        print(f"[DEBUG] Found file at: {file_path}")
                        break
                    
                    # Try with the base name if the path has separators
                    if '/' in file_path or '\\' in file_path:
                        base_name = os.path.basename(file_path)
                        full_path = os.path.join(results['repo_location'], base_name)
                        if os.path.exists(full_path):
                            file_path = full_path
                            print(f"[DEBUG] Found file by basename at: {file_path}")
                            break
        
        if not os.path.exists(file_path):
            print(f"[DEBUG] File still not found: {file_path}")
            # If we have results, try to search for any file with similar name
            if original_path and any('.py' in original_path.lower() for ext in ['.py', '.js', '.java']):
                print(f"[DEBUG] Attempting to return empty results for missing file")
            return code_smells
        
        print(f"[DEBUG] Reading file: {file_path}")
        
        # Read the ENTIRE file
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            lines = f.readlines()
            file_content = ''.join(lines)
        
        print(f"[DEBUG] File read successfully. Lines: {len(lines)}, Content length: {len(file_content)}")
        
        # Get language
        language = get_language_from_file(file_path)
        print(f"[DEBUG] Detected language: {language}")
        
        # Analyze the ENTIRE file for code smells
        if language == 'python':
            code_smells = analyze_python_smells(lines, file_content, file_path)
        elif language == 'javascript':
            code_smells = analyze_javascript_smells(lines, file_content, file_path)
        elif language == 'java':
            code_smells = analyze_java_smells(lines, file_content, file_path)
        else:
            code_smells = analyze_generic_smells(lines, file_content, language, file_path)
        
        print(f"[DEBUG] Analysis complete. Found {len(code_smells)} code smells")
            
    except FileNotFoundError as e:
        print(f"[DEBUG] File not found error: {e}")
        return code_smells
    except Exception as e:
        print(f"[DEBUG] Error analyzing code smells: {e}")
        import traceback
        traceback.print_exc()
    
    return code_smells

def analyze_python_smells(lines, file_content, file_path):
    """Detect Python-specific code smells in the entire file"""
    smells = []
    
    # 1. Check for magic numbers
    magic_numbers = re.findall(r'\b\d{3,}\b', file_content)
    if len(magic_numbers) > 5:
        smells.append({
            'type': 'Magic Numbers',
            'severity': 'medium',
            'description': f'Found {len(magic_numbers)} magic numbers. Extract large numeric literals into named constants for better maintainability.',
            'example': '# Bad: if user.age > 18:\n# Good: ADULT_AGE = 18\nif user.age > ADULT_AGE:'
        })
    
    # 2. Check for long files
    if len(lines) > 500:
        smells.append({
            'type': 'Long File',
            'severity': 'medium',
            'description': f'File contains {len(lines)} lines. Consider breaking it into smaller, focused modules.',
            'example': 'Split file into multiple modules with single responsibility'
        })
    
    # 3. Check for long functions
    current_function = None
    function_start = 0
    for i, line in enumerate(lines):
        if re.match(r'^\s*def\s+\w+', line):
            if current_function is not None:
                function_length = i - function_start
                if function_length > 50:
                    smells.append({
                        'type': 'Long Function',
                        'severity': 'high',
                        'description': f'Function "{current_function}" has {function_length} lines. Break down into smaller functions.',
                        'example': 'Extract logic into helper functions (Single Responsibility Principle)'
                    })
            current_function = re.search(r'def\s+(\w+)', line).group(1)
            function_start = i
    
    # 4. Check for commented code
    commented_lines = sum(1 for line in lines if line.strip().startswith('#') and len(line.strip()) > 5)
    if commented_lines > len(lines) * 0.2:  # More than 20% commented
        smells.append({
            'type': 'Excessive Commented Code',
            'severity': 'low',
            'description': f'{commented_lines} lines of commented code found. Remove old/commented code.',
            'example': 'Use version control (git) instead of commenting out code'
        })
    
    # 5. Check for deeply nested code
    max_indent = 0
    for line in lines:
        if line.strip():
            indent = len(line) - len(line.lstrip())
            max_indent = max(max_indent, indent)
    
    if max_indent > 20:  # More than 5 levels
        smells.append({
            'type': 'Deep Nesting',
            'severity': 'high',
            'description': f'Code has {max_indent//4} levels of nesting. Use early returns or extract methods.',
            'example': '# Use early returns:\ndef process(data):\n    if not data: return None\n    # ... rest of logic'
        })
    
    # 6. Check for TODO/FIXME/HACK comments
    technical_debt = re.findall(r'(TODO|FIXME|HACK|XXX)', file_content, re.IGNORECASE)
    if technical_debt:
        smells.append({
            'type': 'Technical Debt',
            'severity': 'medium',
            'description': f'Found {len(technical_debt)} technical debt markers (TODO/FIXME/HACK). Address these items.',
            'example': 'Replace TODO comments with actual implementation'
        })
    
    # 7. Check for duplicate code patterns
    if len(file_content.split('\n')) > 50:
        # Look for repeated patterns
        function_calls = re.findall(r'(\w+)\([^)]*\)', file_content)
        call_counts = {}
        for call in function_calls:
            call_counts[call] = call_counts.get(call, 0) + 1
        
        # Check for excessive repeated patterns
        for call, count in call_counts.items():
            if count > 10 and len(call) > 5:
                smells.append({
                    'type': 'Code Duplication',
                    'severity': 'medium',
                    'description': f'Pattern "{call}" appears {count} times. Consider refactoring into reusable functions.',
                    'example': 'Extract repeated logic into helper functions'
                })
                break
    
    # 8. Check for missing docstrings
    functions = re.findall(r'^\s*def\s+(\w+)', file_content, re.MULTILINE)
    classes = re.findall(r'^\s*class\s+(\w+)', file_content, re.MULTILINE)
    docstrings = len(re.findall(r'"""[^"]*"""', file_content, re.DOTALL))
    
    if len(functions) + len(classes) > docstrings * 2:  # Should have at least some docstrings
        if len(functions) + len(classes) > 5:  # Only check if significant code
            smells.append({
                'type': 'Missing Documentation',
                'severity': 'low',
                'description': f'File has {len(functions)} functions and {len(classes)} classes but limited docstrings. Add docstrings for better maintainability.',
                'example': 'def process_data(data):\n    """Process and return cleaned data.\n    \n    Args:\n        data: Input data to process\n    \n    Returns:\n        Cleaned data\n    """'
            })
    
    # 9. Check for bare except clauses
    if re.search(r'^\s*except\s*:', file_content, re.MULTILINE):
        smells.append({
            'type': 'Bare Except Clause',
            'severity': 'high',
            'description': 'Bare except clauses catch all exceptions, including system exits. Be specific about exceptions.',
            'example': '# Bad: except:\n# Good: except ValueError:\n# Better: except (ValueError, KeyError) as e:'
        })
    
    # 10. Check for global variables
    global_vars = len(re.findall(r'^\s*global\s+\w+', file_content, re.MULTILINE))
    if global_vars > 3:
        smells.append({
            'type': 'Excessive Global Variables',
            'severity': 'high',
            'description': f'Found {global_vars} global variable declarations. Use dependency injection instead.',
            'example': 'Pass variables as parameters instead of using global state'
        })
    
    return smells

def analyze_javascript_smells(lines, file_content, file_path):
    """Detect JavaScript-specific code smells in the entire file"""
    smells = []
    
    # Check for console.log statements
    console_logs = len(re.findall(r'console\.(log|debug|info|warn|error)', file_content))
    if console_logs > 0:
        smells.append({
            'type': 'Debug Code',
            'severity': 'low',
            'description': f'Found {console_logs} console statements. Remove console.* calls from production code.',
            'example': '// Use proper logging:\nimport logger from "./logger";\nlogger.info("Message");'
        })
    
    # Check for var declarations
    var_count = len(re.findall(r'\bvar\s+', file_content))
    if var_count > 5:
        smells.append({
            'type': 'Deprecated var',
            'severity': 'medium',
            'description': f'Found {var_count} var declarations. Use let/const for block scoping.',
            'example': 'const x = 5; // preferred over var x = 5;'
        })
    
    # Check for == comparisons
    loose_equals = len(re.findall(r'[!=]==[^=]', file_content))
    if loose_equals > 3:
        smells.append({
            'type': 'Loose Comparison',
            'severity': 'high',
            'description': f'Found {loose_equals} loose equality comparisons (==). Use strict equality (===).',
            'example': 'if (x === 5) // not =='
        })
    
    # Check for eval usage
    if re.search(r'\beval\s*\(', file_content):
        smells.append({
            'type': 'Use of eval()',
            'severity': 'critical',
            'description': 'Use of eval() is dangerous and can lead to code injection vulnerabilities.',
            'example': 'Use JSON.parse() or proper parsing methods instead'
        })
    
    # Check for nested callbacks (callback hell)
    arrow_functions = len(re.findall(r'=>\s*\{', file_content))
    if arrow_functions > 20:
        smells.append({
            'type': 'Callback Hell',
            'severity': 'high',
            'description': 'Too many nested callbacks detected. Use async/await or Promises.',
            'example': '// Use async/await:\nasync function process() {\n  const data = await fetch(url);\n  return data;\n}'
        })
    
    # Check for missing semicolons
    line_endings = len(re.findall(r'[^;\s{}]\s*$', file_content, re.MULTILINE))
    statements = len(re.findall(r'[;}]', file_content))
    if statements > 0 and line_endings / (statements + 1) > 0.3:
        smells.append({
            'type': 'Missing Semicolons',
            'severity': 'low',
            'description': 'Some statements missing semicolons. Be consistent for better code reliability.',
            'example': 'const x = 5; // Always use semicolons'
        })
    
    # Check for magic strings
    magic_strings = len(re.findall(r'(GET|POST|PUT|DELETE|localhost|127\.0\.0\.1|\'[A-Z_]{10,}\')', file_content))
    if magic_strings > 10:
        smells.append({
            'type': 'Magic Strings',
            'severity': 'medium',
            'description': 'String literals used directly. Extract into constants.',
            'example': 'const API_URL = "https://api.example.com";'
        })
    
    return smells

def analyze_java_smells(lines, file_content, file_path):
    """Detect Java-specific code smells in the entire file"""
    smells = []
    
    # Check for System.out.println
    println_count = len(re.findall(r'System\.out\.println', file_content))
    if println_count > 0:
        smells.append({
            'type': 'Debug Code',
            'severity': 'low',
            'description': f'Found {println_count} System.out.println calls. Use proper logging framework.',
            'example': 'Logger logger = Logger.getLogger(ClassName.class);\nlogger.info("Message");'
        })
    
    # Check for raw types
    raw_types = len(re.findall(r'List\s*[<\(]|Map\s*[<\(]|Set\s*[<\(]', file_content))
    if raw_types > 5:
        smells.append({
            'type': 'Raw Types',
            'severity': 'medium',
            'description': 'Using raw types (without generics) reduces type safety.',
            'example': 'List<String> list = new ArrayList<>(); // not List list'
        })
    
    # Check for empty catch blocks
    empty_catches = len(re.findall(r'catch\s*\([^)]+\)\s*\{\s*\}', file_content))
    if empty_catches > 0:
        smells.append({
            'type': 'Empty Catch Blocks',
            'severity': 'high',
            'description': f'Found {empty_catches} empty catch blocks. Log or handle exceptions.',
            'example': 'catch (Exception e) {\n    logger.error("Error occurred", e);\n}'
        })
    
    # Check for public fields
    public_fields = len(re.findall(r'public\s+(int|String|boolean|double)\s+\w+\s*;', file_content))
    if public_fields > 5:
        smells.append({
            'type': 'Public Fields',
            'severity': 'medium',
            'description': f'Found {public_fields} public fields. Encapsulate with getters/setters.',
            'example': 'private int value;\npublic int getValue() { return value; }'
        })
    
    # Check for long parameter lists
    methods = re.findall(r'public\s+\w+\s+\w+\([^)]+\)', file_content)
    for method in methods:
        params = method.split('(')[1].split(')')[0]
        if len(params.split(',')) > 5:
            smells.append({
                'type': 'Too Many Parameters',
                'severity': 'medium',
                'description': 'Methods with > 5 parameters are hard to maintain. Use parameter objects.',
                'example': 'Use a configuration object instead of many parameters'
            })
            break
    
    return smells

def analyze_generic_smells(lines, file_content, language, file_path):
    """Detect generic code smells in the entire file"""
    smells = []
    
    # Check for TODO/FIXME comments
    technical_debt = re.findall(r'(TODO|FIXME|HACK|XXX)', file_content, re.IGNORECASE)
    if technical_debt:
        smells.append({
            'type': 'Technical Debt',
            'severity': 'medium',
            'description': f'Found {len(technical_debt)} technical debt markers. Address these items.',
            'example': 'Replace TODO comments with actual implementation'
        })
    
    # Check for long files
    if len(lines) > 1000:
        smells.append({
            'type': 'Very Long File',
            'severity': 'high',
            'description': f'File contains {len(lines)} lines. Break into smaller modules.',
            'example': 'Apply Single Responsibility Principle - split into focused modules'
        })
    
    # Check for hardcoded IPs/URLs
    hardcoded_ips = len(re.findall(r'\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b', file_content))
    if hardcoded_ips > 0:
        smells.append({
            'type': 'Hardcoded IP Addresses',
            'severity': 'critical',
            'description': f'Found {hardcoded_ips} hardcoded IP addresses. Use configuration files.',
            'example': 'Use environment variables or config files for host addresses'
        })
    
    # Check for hardcoded credentials
    if re.search(r'(password|pwd|passwd)\s*[:=]\s*["\'][^"\']{4,}["\']', file_content, re.IGNORECASE):
        smells.append({
            'type': 'Hardcoded Credentials',
            'severity': 'critical',
            'description': 'Hardcoded passwords found. Use secure credential storage.',
            'example': 'Use environment variables or secure vault for credentials'
        })
    
    # Check for commented code blocks
    commented_blocks = len(re.findall(r'//.*code|/\*.*?\*/', file_content, re.DOTALL))
    if commented_blocks > 10:
        smells.append({
            'type': 'Commented Code',
            'severity': 'low',
            'description': 'Large blocks of commented code. Remove dead code.',
            'example': 'Use version control instead of commenting out code'
        })
    
    return smells

@app.route('/api/scans')
def list_scans():
    """List all available scans from database storage."""
    try:
        scans = list_available_scans()
        return jsonify({'scans': scans})
    except Exception as e:
        print(f"[ERROR] Error listing scans: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/scans/<scan_id>/aggregates')
def get_scan_aggregates_api(scan_id):
    """Get aggregated statistics for a specific scan."""
    try:
        db_path = get_files_by_scan_id(scan_id)
        if db_path and os.path.exists(db_path):
            aggregates = get_scan_aggregates(db_path)
            return jsonify(aggregates)
        return jsonify({'error': 'Scan not found'}), 404
    except Exception as e:
        print(f"[ERROR] Error getting aggregates: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/vulnerabilities/all')
def get_all_vulnerabilities():
    """Get aggregated vulnerability data from all databases."""
    try:
        import sqlite3
        from collections import defaultdict
        
        repo_storage_dir = 'repo_storage'
        vulnerabilities_data = {
            'total_vulnerabilities': 0,
            'total_databases': 0,
            'by_severity': defaultdict(int),
            'by_category': defaultdict(int),
            'by_language': defaultdict(int),
            'by_type': defaultdict(int),
            'database_details': []
        }
        
        if not os.path.exists(repo_storage_dir):
            return jsonify(vulnerabilities_data)
        
        # Find all database files
        db_count = 0
        for item in os.listdir(repo_storage_dir):
            if item.endswith('.db'):
                db_path = os.path.join(repo_storage_dir, item)
                
                try:
                    conn = sqlite3.connect(db_path)
                    conn.row_factory = sqlite3.Row
                    cursor = conn.cursor()
                    
                    # Check if it has the necessary tables
                    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='findings'")
                    if not cursor.fetchone():
                        conn.close()
                        continue
                    
                    db_count += 1
                    
                    # Get all findings from this database
                    cursor.execute('''
                        SELECT 
                            f.severity,
                            COALESCE(r.category, 'Unknown') as category,
                            COALESCE(f.path, '') as path,
                            f.rule_id
                        FROM findings f
                        LEFT JOIN rules r ON f.rule_id = r.rule_id
                    ''')
                    
                    findings = cursor.fetchall()
                    
                    # Get language information from files table
                    cursor.execute('''
                        SELECT DISTINCT language, path
                        FROM files
                        WHERE language IS NOT NULL AND language != ''
                    ''')
                    files_data = cursor.fetchall()
                    files_lang = {row['path']: row['language'] for row in files_data}
                    
                    # Aggregate findings from this database
                    is_first = True
                    for finding in findings:
                        try:
                            severity = finding['severity'] if 'severity' in finding.keys() else None
                            category = finding['category'] if 'category' in finding.keys() else 'Unknown'
                            path = finding['path'] if 'path' in finding.keys() else ''
                            rule_id = finding['rule_id'] if 'rule_id' in finding.keys() else ''
                            
                            # Debug: Print finding keys only once
                            if is_first:
                                print(f"[DEBUG] First finding keys: {finding.keys()}")
                                print(f"[DEBUG] First finding values: severity={severity}, category={category}, rule_id={rule_id}")
                                is_first = False
                        except Exception as e:
                            print(f"[ERROR] Error accessing finding: {e}")
                            continue
                        
                        vulnerabilities_data['by_severity'][severity.lower() if severity else 'unknown'] += 1
                        vulnerabilities_data['by_category'][category] += 1
                        
                        # Get language from file path
                        if path in files_lang:
                            vulnerabilities_data['by_language'][files_lang[path]] += 1
                        else:
                            vulnerabilities_data['by_language']['unknown'] += 1
                        
                        # Track by rule type
                        if rule_id:
                            vulnerabilities_data['by_type'][rule_id] += 1
                        
                        vulnerabilities_data['total_vulnerabilities'] += 1
                    
                    # Store database info
                    cursor.execute('SELECT * FROM scans ORDER BY started_at DESC LIMIT 1')
                    scan_info = cursor.fetchone()
                    cursor.execute('SELECT name FROM projects LIMIT 1')
                    project_info = cursor.fetchone()
                    
                    vulnerabilities_data['database_details'].append({
                        'database': item,
                        'project_name': project_info['name'] if project_info else 'Unknown',
                        'findings_count': len(findings),
                        'scan_date': scan_info['started_at'] if scan_info else None
                    })
                    
                    conn.close()
                except Exception as e:
                    print(f"[ERROR] Error processing database {item}: {e}")
                    print(f"[ERROR] Exception type: {type(e).__name__}")
                    import traceback
                    traceback.print_exc()
                    continue
        
        vulnerabilities_data['total_databases'] = db_count
        
        # Convert defaultdicts to regular dicts for JSON serialization
        vulnerabilities_data['by_severity'] = dict(vulnerabilities_data['by_severity'])
        vulnerabilities_data['by_category'] = dict(vulnerabilities_data['by_category'])
        vulnerabilities_data['by_language'] = dict(vulnerabilities_data['by_language'])
        vulnerabilities_data['by_type'] = dict(vulnerabilities_data['by_type'])
        
        print(f"[Vulnerabilities API] Returning data: {len(vulnerabilities_data)} keys, {vulnerabilities_data['total_vulnerabilities']} total vulns")
        
        return jsonify(vulnerabilities_data)
    except Exception as e:
        print(f"[ERROR] Error getting all vulnerabilities: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/api/file/<scan_id>/content')
def get_file_content(scan_id):
    """Get file content from database for editing"""
    try:
        file_path = request.args.get('file_path')
        if not file_path:
            return jsonify({'error': 'file_path parameter required'}), 400
        
        # Decode URL-encoded characters (like %09 for tabs)
        import urllib.parse
        file_path = urllib.parse.unquote(file_path)
        
        # Normalize path: replace tabs with /, normalize separators
        # Keep both backslash and forward slash versions for matching
        normalized_path_forward = file_path.replace('\t', '/').replace('\\', '/')
        normalized_path_backslash = file_path.replace('\t', '\\').replace('/', '\\')
        
        # Also try replacing tabs with nothing (in case it's a typo)
        path_without_tabs = file_path.replace('\t', '')
        
        print(f"[DEBUG] File request - Original: {request.args.get('file_path')}, Decoded: {file_path}")
        print(f"[DEBUG] Normalized forward: {normalized_path_forward}, Normalized backslash: {normalized_path_backslash}")
        
        # Get database path
        db_path = get_files_by_scan_id(scan_id)
        if not db_path or not os.path.exists(db_path):
            return jsonify({'error': 'Scan not found'}), 404
        
        # Retrieve file content from database
        import sqlite3
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # Try exact match first
        cursor.execute('''
            SELECT blob_sha256, language, path
            FROM files
            WHERE scan_id = ? AND path = ?
        ''', (scan_id, file_path))
        
        row = cursor.fetchone()
        
        # If not found, try normalized paths (both forward and backslash)
        if not row or not row['blob_sha256']:
            cursor.execute('''
                SELECT blob_sha256, language, path
                FROM files
                WHERE scan_id = ? AND (path = ? OR path = ?)
            ''', (scan_id, normalized_path_forward, normalized_path_backslash))
            row = cursor.fetchone()
        
        # If still not found, try path without tabs
        if not row or not row['blob_sha256']:
            cursor.execute('''
                SELECT blob_sha256, language, path
                FROM files
                WHERE scan_id = ? AND path = ?
            ''', (scan_id, path_without_tabs))
            row = cursor.fetchone()
        
        # If still not found, try case-insensitive match or partial match
        if not row or not row['blob_sha256']:
            # Get all files for this scan
            cursor.execute('''
                SELECT blob_sha256, language, path
                FROM files
                WHERE scan_id = ?
            ''', (scan_id,))
            all_files = cursor.fetchall()
            
            print(f"[DEBUG] Searching through {len(all_files)} files for: {file_path}")
            
            # Try to find matching file by basename or similar path
            file_basename = os.path.basename(file_path)
            normalized_basename_forward = os.path.basename(normalized_path_forward)
            normalized_basename_backslash = os.path.basename(normalized_path_backslash)
            basename_without_tabs = os.path.basename(path_without_tabs)
            
            # PRIORITY 1: Match by basename only (works for files in any directory)
            # This is the most important match - if basenames match, use it regardless of directory structure
            print(f"[DEBUG] File basename: {file_basename}")
            for f in all_files:
                db_path_value = f['path']
                db_basename = os.path.basename(db_path_value)
                
                # Match by basename - this should catch files in subdirectories
                if (db_basename.lower() == file_basename.lower() or 
                    db_basename.lower() == normalized_basename_forward.lower() or
                    db_basename.lower() == normalized_basename_backslash.lower() or
                    db_basename.lower() == basename_without_tabs.lower()):
                    print(f"[DEBUG]  Matched by basename: {db_path_value} (basename: {db_basename}) -> {file_path}")
                    row = f
                    break
            
            # PRIORITY 2: Try full path matching if basename didn't work
            if not row or not row['blob_sha256']:
                for f in all_files:
                    db_path_value = f['path']
                    db_normalized_forward = db_path_value.replace('\\', '/')
                    db_normalized_backslash = db_path_value.replace('/', '\\')
                    
                    # Try matching the full path with normalized separators (both directions)
                    if (db_normalized_forward == normalized_path_forward or
                        db_normalized_backslash == normalized_path_backslash or
                        db_path_value == file_path):
                        print(f"[DEBUG]  Matched by full path: {db_path_value}")
                        row = f
                        break
                    # Try matching without tabs
                    elif db_path_value.replace('\t', '') == path_without_tabs:
                        print(f"[DEBUG]  Matched by path without tabs: {db_path_value}")
                        row = f
                        break
            
            # PRIORITY 3: Try compound name splitting
            if not row or not row['blob_sha256']:
                # Try matching if the requested path (without separators) matches the db basename
                for f in all_files:
                    db_path_value = f['path']
                    db_basename = os.path.basename(db_path_value)
                    
                    if file_path.replace('/', '').replace('\\', '').lower() == db_basename.lower():
                        print(f"[DEBUG] Matched by removing separators: {db_path_value}")
                        row = f
                        break
            
            # If still not found, try splitting compound names like "componentsassignment.py"
            if not row or not row['blob_sha256']:
                import re
                # Try to split compound names (componentsassignment -> components/assignment)
                # Look for patterns like: word1word2.py -> word1/word2.py
                # Try camelCase first: componentsAssignment.py
                match = re.match(r'^([a-z]+)([A-Z][a-z]+)\.(.+)$', file_basename)
                if not match:
                    # Try all lowercase: componentsassignment.py
                    # Try to find where a word boundary might be (common words: components, assignment, etc.)
                    common_words = ['component', 'components', 'assignment', 'assignments', 'test', 'tests', 
                                   'lecture', 'lectures', 'quiz', 'quizzes', 'summary', 'summaries']
                    for word in common_words:
                        if file_basename.lower().startswith(word.lower()) and len(file_basename) > len(word):
                            remaining = file_basename[len(word):]
                            if remaining.endswith('.py'):
                                part2 = remaining[:-3]  # Remove .py
                                potential_paths = [
                                    f"{word}/{part2}.py",
                                    f"{word}s/{part2}.py",
                                    f"{word}_{part2}.py",
                                    f"{word}s_{part2}.py"
                                ]
                                
                                for f in all_files:
                                    db_path_value = f['path']
                                    db_basename = os.path.basename(db_path_value)
                                    db_normalized = db_path_value.replace('\\', '/')
                                    
                                    for potential_path in potential_paths:
                                        if (db_basename.lower() == potential_path.lower() or 
                                            db_normalized.lower().endswith('/' + potential_path.lower()) or
                                            db_normalized.lower().endswith('\\' + potential_path.lower())):
                                            print(f"[DEBUG] Matched by split compound name: {db_path_value} -> {potential_path}")
                                            row = f
                                            break
                                    if row:
                                        break
                                if row:
                                    break
                
                if match:
                    part1, part2, ext = match.groups()
                    potential_paths = [
                        f"{part1}/{part2}.{ext}",
                        f"{part1}_{part2}.{ext}",
                        f"{part1}/{part2}.{ext}".lower(),
                        f"{part1}_{part2}.{ext}".lower()
                    ]
                    
                    for f in all_files:
                        db_path_value = f['path']
                        db_basename = os.path.basename(db_path_value)
                        db_normalized = db_path_value.replace('\\', '/')
                        
                        for potential_path in potential_paths:
                            if (db_basename.lower() == potential_path.lower() or 
                                db_normalized.lower().endswith('/' + potential_path.lower()) or
                                db_normalized.lower().endswith('\\' + potential_path.lower())):
                                print(f"[DEBUG] Matched by split compound name: {db_path_value} -> {potential_path}")
                                row = f
                                break
                        if row:
                            break
        
        if not row or not row['blob_sha256']:
            # Attempt filesystem fallback using scan repo path stored in scans.ref
            try:
                cursor.execute('SELECT ref FROM scans WHERE scan_id = ? ORDER BY started_at DESC LIMIT 1', (scan_id,))
                ref_row = cursor.fetchone()
                repo_base = ref_row['ref'] if ref_row and ref_row['ref'] else None
            except Exception:
                repo_base = None

            fs_candidates = []
            # Prefer the DB path if available
            if row and 'path' in row.keys() and row['path']:
                fs_candidates.append(row['path'])
            # Requested variants
            fs_candidates.extend([
                file_path,
                normalized_path_forward,
                normalized_path_backslash,
                path_without_tabs,
                os.path.basename(file_path)
            ])
            fs_candidates = [p for p in fs_candidates if p]

            if repo_base and os.path.exists(repo_base):
                import itertools
                # Build unique candidate full paths
                for candidate in itertools.chain(fs_candidates):
                    # Try as relative to repo
                    full1 = os.path.join(repo_base, candidate)
                    # Also try basename at repo root
                    full2 = os.path.join(repo_base, os.path.basename(candidate))
                    for full in [full1, full2]:
                        if os.path.exists(full) and os.path.isfile(full):
                            try:
                                with open(full, 'rb') as f:
                                    content_bytes = f.read()
                                # Try decode (mirror exporter behavior)
                                try:
                                    content_text = content_bytes.decode('utf-8')
                                    encoding = 'utf-8'
                                except UnicodeDecodeError:
                                    try:
                                        content_text = content_bytes.decode('latin-1')
                                        encoding = 'latin-1'
                                    except Exception:
                                        # Binary; cannot edit
                                        conn.close()
                                        return jsonify({'error': 'Binary files cannot be edited'}), 400

                                conn.close()
                                return jsonify({
                                    'success': True,
                                    'content': content_text,
                                    'encoding': encoding,
                                    'line_count': len(content_text.splitlines()),
                                    'language': row['language'] if row and 'language' in row.keys() else get_language_from_file(candidate),
                                    'file_path': candidate
                                })
                            except Exception as read_err:
                                print(f"[DEBUG] Filesystem fallback read error: {read_err}")
                                break

            # If still not found, return available files for debugging
            cursor.execute('''
                SELECT path FROM files WHERE scan_id = ? LIMIT 10
            ''', (scan_id,))
            sample_files = [f['path'] for f in cursor.fetchall()]
            conn.close()
            
            print(f"[DEBUG] Requested: {file_path}, Available files:")
            for sf in sample_files:
                print(f"[DEBUG]   - {sf}")
            
            return jsonify({
                'error': 'File not found',
                'requested_path': file_path,
                'normalized_path_forward': normalized_path_forward,
                'normalized_path_backslash': normalized_path_backslash,
                'sample_files': sample_files
            }), 404
        
        # Use the actual path from database (might be different from requested)
        actual_path = row['path']
        blob_sha256 = row['blob_sha256']
        
        # Get actual content
        cursor.execute('''
            SELECT content, encoding, line_count
            FROM blobs
            WHERE blob_sha256 = ?
        ''', (blob_sha256,))
        
        blob_row = cursor.fetchone()
        conn.close()
        
        if not blob_row:
            return jsonify({'error': 'File content not found'}), 404
        
        content = blob_row['content']
        encoding = blob_row['encoding']
        
        # Decode text files
        if encoding != 'binary':
            content_text = content.decode(encoding)
        else:
            return jsonify({'error': 'Binary files cannot be edited'}), 400
        
        return jsonify({
            'success': True,
            'content': content_text,
            'encoding': encoding,
            'line_count': blob_row['line_count'],
            'language': row['language'],
            'file_path': actual_path  # Return the actual path from database
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/api/file/<scan_id>/save', methods=['POST'])
def save_file_content(scan_id):
    """Save edited file content back to database"""
    try:
        data = request.get_json()
        file_path = data.get('file_path')
        content = data.get('content')
        
        if not file_path or content is None:
            return jsonify({'error': 'file_path and content required'}), 400
        
        # Normalize path
        import urllib.parse
        file_path = urllib.parse.unquote(file_path)
        normalized_path = file_path.replace('\t', '/').replace('\\', '/')
        
        # Get database path
        db_path = get_files_by_scan_id(scan_id)
        if not db_path or not os.path.exists(db_path):
            return jsonify({'error': 'Scan not found'}), 404
        
        # Save to database (update blob)
        import sqlite3
        import hashlib
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Try to find the file with path normalization
        cursor.execute('''
            SELECT path FROM files WHERE scan_id = ? AND (path = ? OR path = ?)
        ''', (scan_id, file_path, normalized_path))
        file_row = cursor.fetchone()
        actual_path = file_path  # Default to requested path
        
        # If not found, try case-insensitive basename match
        if not file_row:
            file_basename = os.path.basename(file_path)
            cursor.execute('''
                SELECT path FROM files WHERE scan_id = ?
            ''', (scan_id,))
            all_files = cursor.fetchall()
            for f in all_files:
                if os.path.basename(f[0]).lower() == file_basename.lower():
                    actual_path = f[0]  # Use the actual path from database
                    file_row = f  # Mark as found
                    break
        else:
            actual_path = file_row[0]  # Use the path from database
        
        # Encode content
        content_bytes = content.encode('utf-8')
        blob_sha256 = hashlib.sha256(content_bytes).hexdigest()
        line_count = len(content.splitlines())
        
        # Check if blob already exists
        cursor.execute('SELECT blob_sha256 FROM blobs WHERE blob_sha256 = ?', (blob_sha256,))
        if not cursor.fetchone():
            # Insert new blob
            cursor.execute('''
                INSERT INTO blobs (blob_sha256, size_bytes, is_binary, encoding, line_count, content)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (blob_sha256, len(content_bytes), 0, 'utf-8', line_count, content_bytes))
        
        # Update file reference - use the actual path from database
        cursor.execute('''
            UPDATE files
            SET blob_sha256 = ?
            WHERE scan_id = ? AND path = ?
        ''', (blob_sha256, scan_id, actual_path))
        
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': 'File saved successfully',
            'file_path': actual_path
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/api/file/<scan_id>/run', methods=['POST'])
def run_code(scan_id):
    """Check code syntax only - does not execute code"""
    print(f"[DEBUG] Syntax check endpoint called for scan_id: {scan_id}")
    try:
        import subprocess
        import tempfile
        
        data = request.get_json()
        code = data.get('code')
        language = data.get('language', 'python')
        file_path = data.get('file_path', '')
        
        print(f"[DEBUG] Language: {language}, File path: {file_path}, Code length: {len(code) if code else 0}")
        
        if not code:
            print("[DEBUG] No code provided")
            return jsonify({'error': 'Code is required'}), 400
        
        # Security: Limit code length (prevent DOS attacks)
        if len(code) > 100000:  # 100KB limit
            print(f"[DEBUG] Code too long: {len(code)} bytes")
            return jsonify({'error': 'Code too long (max 100KB)'}), 400
        
        # Syntax checking timeout (5 seconds)
        timeout = 5
        print(f"[DEBUG] Syntax check timeout set to {timeout} seconds")
        
        # Create temporary file for code
        file_extension = {
            'python': '.py',
            'javascript': '.js',
            'java': '.java',
            'cpp': '.cpp',
            'c': '.c',
            'go': '.go',
            'rust': '.rs',
            'ruby': '.rb',
            'php': '.php',
            'shell': '.sh',
            'bash': '.sh',
            'typescript': '.ts'
        }.get(language.lower(), '.txt')
        
        # Create temp file
        with tempfile.NamedTemporaryFile(mode='w', suffix=file_extension, delete=False) as f:
            f.write(code)
            temp_file_path = f.name
        
        print(f"[DEBUG] Created temp file: {temp_file_path}")
        
        try:
            # Prepare syntax check command based on language
            if language.lower() == 'python':
                # Use Python's compile() function for syntax checking
                try:
                    # Try to compile the code to check syntax
                    compile(code, temp_file_path, 'exec')
                    print("[DEBUG] Python syntax check passed")
                    return jsonify({
                        'success': True,
                        'output': 'Syntax check passed successfully',
                        'exit_code': 0,
                        'language': language,
                        'file_path': file_path
                    })
                except SyntaxError as e:
                    error_msg = f"Syntax error at line {e.lineno}: {e.msg}\n"
                    if e.text:
                        error_msg += f"  {e.text.strip()}\n"
                        if e.offset:
                            error_msg += f"  {' ' * (e.offset - 1)}^\n"
                    print(f"[DEBUG] Python syntax error: {error_msg}")
                    return jsonify({
                        'success': False,
                        'error': 'Syntax error detected',
                        'output': error_msg,
                        'exit_code': 1,
                        'language': language,
                        'file_path': file_path
                    })
                except Exception as e:
                    print(f"[DEBUG] Python check error: {str(e)}")
                    return jsonify({
                        'success': False,
                        'error': f'Syntax check error: {str(e)}',
                        'output': str(e),
                        'exit_code': 1
                    })
                    
            elif language.lower() in ['javascript', 'js']:
                # Use node --check for JavaScript syntax checking
                cmd = ['node', '--check', temp_file_path]
            elif language.lower() == 'typescript':
                # For TypeScript, try tsc if available, otherwise fall back to node
                cmd = ['tsc', '--noEmit', temp_file_path]
            elif language.lower() == 'java':
                # Use javac to check syntax (compile only, no execution)
                # Redirect output to null device (works on both Windows and Unix)
                if os.name == 'nt':  # Windows
                    cmd = ['javac', '-Xstdout', 'nul', temp_file_path]
                else:  # Unix/Linux/Mac
                    cmd = ['javac', '-Xstdout', '/dev/null', temp_file_path]
            elif language.lower() in ['cpp', 'c']:
                # Use gcc/g++ to check syntax (compile only, no linking)
                compiler = 'g++' if language.lower() == 'cpp' else 'gcc'
                cmd = [compiler, '-fsyntax-only', temp_file_path]
            elif language.lower() == 'go':
                # Use go build to check syntax (compile but don't link)
                if os.name == 'nt':  # Windows
                    null_output = 'nul'
                else:  # Unix/Linux/Mac
                    null_output = '/dev/null'
                cmd = ['go', 'build', '-o', null_output, temp_file_path]
            elif language.lower() == 'rust':
                # Use rustc to check syntax (compile only)
                cmd = ['rustc', '--crate-type', 'lib', temp_file_path]
            elif language.lower() == 'ruby':
                # Use ruby -c for syntax checking
                cmd = ['ruby', '-c', temp_file_path]
            elif language.lower() == 'php':
                # Use php -l for syntax checking
                cmd = ['php', '-l', temp_file_path]
            elif language.lower() in ['shell', 'bash', 'sh']:
                # Use bash -n for syntax checking
                cmd = ['bash', '-n', temp_file_path]
            else:
                return jsonify({
                    'success': False,
                    'error': f'Language "{language}" is not supported for syntax checking',
                    'output': '',
                    'exit_code': 1
                }), 400
            
            print(f"[DEBUG] Running syntax check command: {' '.join(cmd)}")
            
            # Execute syntax check with timeout
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                cwd=tempfile.gettempdir()
            )
            
            try:
                stdout, stderr = process.communicate(timeout=timeout)
            except subprocess.TimeoutExpired:
                process.kill()
                stdout, stderr = process.communicate()
                return jsonify({
                    'success': False,
                    'error': f'Syntax check timed out after {timeout} seconds',
                    'output': '',
                    'exit_code': -1,
                    'timed_out': True
                }), 200
            
            exit_code = process.returncode
            print(f"[DEBUG] Syntax check completed. Exit code: {exit_code}")
            
            # Combine stdout and stderr for error messages
            error_output = stderr if stderr else stdout
            
            if exit_code == 0:
                # Syntax is valid
                print("[DEBUG] Syntax check passed")
                return jsonify({
                    'success': True,
                    'output': 'Syntax check passed successfully',
                    'exit_code': 0,
                    'language': language,
                    'file_path': file_path
                })
            else:
                # Syntax errors found
                print(f"[DEBUG] Syntax errors found: {error_output[:200]}")
                return jsonify({
                    'success': False,
                    'error': 'Syntax error detected',
                    'output': error_output,
                    'exit_code': exit_code,
                    'language': language,
                    'file_path': file_path
                })
            
        finally:
            # Clean up temp file
            try:
                os.unlink(temp_file_path)
                print(f"[DEBUG] Cleaned up temp file: {temp_file_path}")
            except:
                pass
                
    except FileNotFoundError as e:
        interpreter = {
            'python': 'python',
            'javascript': 'node',
            'typescript': 'tsc',
            'ruby': 'ruby',
            'php': 'php',
            'go': 'go',
            'shell': 'bash',
            'java': 'javac',
            'cpp': 'g++',
            'c': 'gcc',
            'rust': 'rustc'
        }.get(language.lower(), 'interpreter')
        
        print(f"[DEBUG] Interpreter/compiler not found: {interpreter}")
        return jsonify({
            'success': False,
            'error': f'{interpreter} not found. Please install it to check {language} syntax.',
            'output': '',
            'exit_code': -1
        }), 200
    except Exception as e:
        import traceback
        print(f"[DEBUG] Exception occurred: {str(e)}")
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': str(e),
            'output': '',
            'exit_code': -1
        }), 500

@app.route('/api/file/<scan_id>/list')
def list_files_with_issues(scan_id):
    """List all files with security issues for editing"""
    try:
        # Get database path
        db_path = get_files_by_scan_id(scan_id)
        if not db_path or not os.path.exists(db_path):
            return jsonify({'error': 'Scan not found'}), 404
        
        # Get files with issues
        import sqlite3
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT DISTINCT f.path, f.language, COUNT(fnd.finding_id) as issue_count
            FROM files f
            INNER JOIN findings fnd ON f.scan_id = fnd.scan_id AND f.path = fnd.path
            WHERE f.scan_id = ?
            GROUP BY f.path, f.language
            ORDER BY issue_count DESC, f.path
        ''', (scan_id,))
        
        files = []
        for row in cursor.fetchall():
            file_path = row['path']
            
            # Get issue details for this file - group by line
            cursor.execute('''
                SELECT 
                    f.line_start,
                    f.line_end,
                    f.severity,
                    f.message,
                    f.rule_id,
                    f.snippet,
                    r.title as rule_title,
                    r.category,
                    r.cwe,
                    r.owasp
                FROM findings f
                LEFT JOIN rules r ON f.rule_id = r.rule_id
                WHERE f.scan_id = ? AND f.path = ?
                ORDER BY f.line_start
            ''', (scan_id, file_path))
            
            issue_lines = []
            issue_details = {}  # { line_number: { severity, description, issue_type, ... } }
            
            for line_row in cursor.fetchall():
                line_start = line_row['line_start']
                line_end = line_row['line_end'] if line_row['line_end'] else line_start
                
                # Create issue detail object
                issue_detail = {
                    'severity': line_row['severity'] or 'medium',
                    'description': line_row['message'] or '',
                    'issue_type': line_row['rule_id'] or 'Security Issue',
                    'title': line_row['rule_title'] or line_row['rule_id'] or 'Security Issue',
                    'category': line_row['category'] or 'General',
                    'cwe': line_row['cwe'] or '',
                    'owasp': line_row['owasp'] or '',
                    'snippet': line_row['snippet'] or ''  # Include code snippet
                }
                
                # Add all lines from line_start to line_end (inclusive)
                for line_num in range(line_start, line_end + 1):
                    if line_num not in issue_lines:
                        issue_lines.append(line_num)
                    # Store issue details for this line (if multiple issues on same line, keep the most severe)
                    if line_num not in issue_details:
                        issue_details[line_num] = issue_detail
                    else:
                        # If multiple issues on same line, prefer critical > high > medium > low
                        severity_order = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1}
                        current_severity = severity_order.get(issue_details[line_num]['severity'], 0)
                        new_severity = severity_order.get(issue_detail['severity'], 0)
                        if new_severity > current_severity:
                            issue_details[line_num] = issue_detail
            
            files.append({
                'path': file_path,
                'language': row['language'] or 'unknown',
                'issue_count': row['issue_count'],
                'issue_lines': sorted(issue_lines),  # Sorted list of line numbers with issues
                'issue_details': issue_details  # Map of line_number -> issue details
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'files': files
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    # Disable the reloader to ensure a single process holds in-memory scan state
    app.run(debug=True, use_reloader=False, host='0.0.0.0', port=5000)
````

## File: agentic_fixer/batch_scan_repos.py
````python
#!/usr/bin/env python3
"""
Batch repository scanner - Scans multiple GitHub repositories and generates Excel reports.
"""

import os
import sys
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment

# Import the scanning modules
from code_security_auto_fixer import repo_scanner, language_detector, pattern_detector, reporter
from code_security_auto_fixer.db_exporter import export_to_db

def scan_single_repo(repo_url, output_dir="."):
    """
    Scan a single repository and generate an Excel report.
    
    Args:
        repo_url: GitHub repository URL
        output_dir: Directory to save the report
    
    Returns:
        dict: Summary of the scan results
    """
    print(f"\n{'=' * 70}")
    print(f"Scanning: {repo_url}")
    print(f"{'=' * 70}")
    
    try:
        # Step 1: Scan the repository
        print("[1/6] Scanning repository...")
        repo_path = repo_scanner.scan(repo_url)
        print(f" Repository cloned")
        
        # Step 2: Detect programming languages
        print("[2/6] Detecting programming languages...")
        file_languages = language_detector.detect_per_file(repo_path)
        languages = [
            lang for lang in sorted(set(file_languages.values()))
            if lang and lang.lower() not in {'unknown', 'text'}
        ]
        print(f" Languages: {', '.join(languages)}")
        print(f" Total files: {len(file_languages)}")
        
        # Step 3: Scan for security patterns
        print("[3/6] Scanning for insecure patterns...")
        findings = pattern_detector.scan(repo_path, languages)
        print(f" Found {len(findings)} security issues")
        
        # Step 4: Normalize and prioritize
        print("[4/6] Normalizing and prioritizing findings...")
        prioritized = pattern_detector.normalize_and_prioritize(findings)
        
        # Step 5: Generate explanations
        print("[5/6] Generating explanations and suggestions...")
        explanations = pattern_detector.explain_and_suggest(prioritized, detailed=True)
        
        # Step 6: Build file status
        all_files = set(file_languages.keys())
        files_with_issues = set(f['file'] for f in prioritized)
        file_status = []
        for f in all_files:
            status = 'issue' if f in files_with_issues else 'clean'
            lang = file_languages.get(f, 'unknown')
            file_status.append({'file': f, 'status': status, 'language': lang})
        
        # Generate Excel report
        print("[6/6] Generating Excel report...")
        repo_name = repo_url.split('/')[-1].replace('.git', '')
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        excel_filename = f'{repo_name}_security_report_{timestamp}.xlsx'
        excel_path = os.path.join(output_dir, excel_filename)
        
        excel_data = {
            'repo_path': repo_path,  # Use actual cloned directory, not the original URL
            'completed_at': datetime.now().isoformat(),
            'languages': languages,
            'file_status': file_status,
            'explanations': explanations,
            'prioritized': prioritized,
            'findings': findings
        }
        
        build_excel(excel_data, excel_path)
        
        # Export to SQLite database in repo_storage folder
        print("[7/8] Exporting data to SQLite database...")
        db_path = export_to_db(excel_data, repo_name, output_dir="repo_storage")
        print(f" Database exported: {db_path}")
        
        # Also generate markdown report
        md_filename = f'{repo_name}_security_report_{timestamp}.md'
        md_path = os.path.join(output_dir, md_filename)
        os.makedirs(output_dir, exist_ok=True)
        reporter.generate(md_path, explanations, prioritized, file_status)
        
        # Summary
        summary = {
            'repo_url': repo_url,
            'repo_name': repo_name,
            'status': 'success',
            'total_issues': len(explanations),
            'files_scanned': len(all_files),
            'languages': languages,
            'excel_file': excel_filename,
            'md_file': md_filename,
            'db_file': os.path.basename(db_path)
        }
        
        print(f"\n Excel report: {excel_filename}")
        print(f" Markdown report: {md_filename}")
        print(f" Database: {os.path.basename(db_path)}")
        print(f" Total issues: {len(explanations)}")
        
        return summary
        
    except Exception as e:
        print(f"\n Error scanning repository: {str(e)}")
        import traceback
        traceback.print_exc()
        return {
            'repo_url': repo_url,
            'status': 'error',
            'error': str(e)
        }


def build_excel(data, output_file):
    """Build Excel workbook from scan data."""
    wb = Workbook()
    wb.remove(wb.active)
    
    # Create all sheets
    ws_summary = wb.create_sheet('Summary')
    create_summary_sheet(ws_summary, data)
    
    ws_issues = wb.create_sheet('Security Issues')
    create_issues_sheet(ws_issues, data)
    
    ws_files = wb.create_sheet('Files')
    create_files_sheet(ws_files, data)
    
    ws_lang = wb.create_sheet('Languages')
    create_languages_sheet(ws_lang, data)
    
    ws_severity = wb.create_sheet('Severity Breakdown')
    create_severity_sheet(ws_severity, data)
    
    ws_cwe = wb.create_sheet('CWE Analysis')
    create_cwe_sheet(ws_cwe, data)
    
    ws_category = wb.create_sheet('Category Analysis')
    create_category_sheet(ws_category, data)
    
    wb.save(output_file)


def create_summary_sheet(ws, data):
    """Create summary sheet with key metrics."""
    ws.merge_cells('A1:B1')
    ws['A1'] = 'Security Scan Summary'
    ws['A1'].font = Font(bold=True, size=14)
    
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    files_with_issues = len([f for f in data.get('file_status', []) if f.get('status') == 'issue'])
    total_files = len(data.get('file_status', []))
    
    summary_data = [
        ['Repository', data.get('repo_path', 'N/A')],
        ['Scan Date', data.get('completed_at', 'N/A')],
        ['Total Issues Found', total_issues],
        ['Files Scanned', total_files],
        ['Files with Issues', files_with_issues],
        ['Clean Files', total_files - files_with_issues],
        ['Languages Detected', ', '.join(data.get('languages', []))],
    ]
    
    row_num = 3
    for label, value in summary_data:
        cell_label = ws.cell(row=row_num, column=1)
        cell_value = ws.cell(row=row_num, column=2)
        cell_label.value = label
        cell_label.font = Font(bold=True)
        cell_value.value = value
        row_num += 1
    
    # Severity counts
    row_num += 1
    ws.cell(row=row_num, column=1).value = 'Severity Breakdown:'
    ws.cell(row=row_num, column=1).font = Font(bold=True)
    row_num += 1
    
    for col_num, header in enumerate(['Severity', 'Count', 'Percentage'], 1):
        cell = ws.cell(row=row_num, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
    
    row_num += 1
    severity_counts = {}
    for issue in explanations:
        severity = issue.get('severity', 'medium')
        severity_counts[severity] = severity_counts.get(severity, 0) + 1
    
    for severity in ['critical', 'high', 'medium', 'low', 'info']:
        count = severity_counts.get(severity, 0)
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = severity.title()
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
        row_num += 1
    
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 40


def create_issues_sheet(ws, data):
    """Create detailed issues sheet."""
    headers = ['File', 'Line', 'Issue', 'Severity', 'CWE', 'OWASP', 'Category', 'Priority', 'Description', 'Code', 'Suggestion']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    for row_num, issue in enumerate(data.get('explanations', []), 2):
        ws.cell(row=row_num, column=1).value = issue.get('file', '')
        ws.cell(row=row_num, column=2).value = issue.get('line', 0)
        ws.cell(row=row_num, column=3).value = issue.get('issue', '')
        ws.cell(row=row_num, column=4).value = issue.get('severity', '')
        ws.cell(row=row_num, column=5).value = issue.get('cwe', '')
        ws.cell(row=row_num, column=6).value = issue.get('owasp', '')
        ws.cell(row=row_num, column=7).value = issue.get('category', '')
        ws.cell(row=row_num, column=8).value = issue.get('priority_score', 0)
        ws.cell(row=row_num, column=9).value = issue.get('description') or issue.get('explanation', '')
        ws.cell(row=row_num, column=10).value = str(issue.get('code', ''))[:500]
        ws.cell(row=row_num, column=11).value = str(issue.get('suggestion', ''))[:500]
    
    ws.column_dimensions['A'].width = 30
    ws.column_dimensions['B'].width = 8
    ws.column_dimensions['C'].width = 25
    ws.column_dimensions['D'].width = 12
    ws.column_dimensions['E'].width = 12
    ws.column_dimensions['F'].width = 30
    ws.column_dimensions['G'].width = 20
    ws.column_dimensions['H'].width = 10
    ws.column_dimensions['I'].width = 50
    ws.column_dimensions['J'].width = 40
    ws.column_dimensions['K'].width = 50


def create_files_sheet(ws, data):
    """Create files status sheet."""
    headers = ['File', 'Status', 'Language', 'Issues Count']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    issues_by_file = {}
    for issue in data.get('explanations', []):
        file_path = issue.get('file', '')
        if file_path not in issues_by_file:
            issues_by_file[file_path] = 0
        issues_by_file[file_path] += 1
    
    for row_num, file_info in enumerate(sorted(data.get('file_status', []), key=lambda x: issues_by_file.get(x.get('file', ''), 0), reverse=True), 2):
        file_path = file_info.get('file', '')
        ws.cell(row=row_num, column=1).value = file_path
        ws.cell(row=row_num, column=2).value = file_info.get('status', '')
        ws.cell(row=row_num, column=3).value = file_info.get('language', '')
        ws.cell(row=row_num, column=4).value = issues_by_file.get(file_path, 0)
    
    ws.column_dimensions['A'].width = 50
    ws.column_dimensions['B'].width = 12
    ws.column_dimensions['C'].width = 15
    ws.column_dimensions['D'].width = 12


def create_languages_sheet(ws, data):
    """Create languages breakdown sheet."""
    headers = ['Language', 'File Count', 'Percentage']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    lang_counts = {}
    total_files = len(data.get('file_status', []))
    
    for file_info in data.get('file_status', []):
        lang = file_info.get('language', 'unknown')
        lang_counts[lang] = lang_counts.get(lang, 0) + 1
    
    for row_num, (lang, count) in enumerate(sorted(lang_counts.items(), key=lambda x: x[1], reverse=True), 2):
        percentage = (count / total_files * 100) if total_files > 0 else 0
        ws.cell(row=row_num, column=1).value = lang
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
    
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 15
    ws.column_dimensions['C'].width = 15


def create_severity_sheet(ws, data):
    """Create severity analysis sheet."""
    headers = ['Severity', 'Count', 'Percentage', 'Risk Level']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    severity_counts = {}
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    
    for issue in explanations:
        severity = issue.get('severity', 'medium')
        severity_counts[severity] = severity_counts.get(severity, 0) + 1
    
    risk_levels = {
        'critical': 'Immediate Action Required',
        'high': 'Urgent - Fix Within 48 Hours',
        'medium': 'Fix Within 1 Week',
        'low': 'Fix When Convenient',
        'info': 'Informational'
    }
    
    for row_num, severity in enumerate(['critical', 'high', 'medium', 'low', 'info'], 2):
        count = severity_counts.get(severity, 0)
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = severity.title()
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
        ws.cell(row=row_num, column=4).value = risk_levels.get(severity, '')
    
    ws.column_dimensions['A'].width = 15
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 12
    ws.column_dimensions['D'].width = 30


def create_cwe_sheet(ws, data):
    """Create CWE vulnerability analysis sheet."""
    headers = ['CWE', 'Count', 'Description']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    cwe_counts = {}
    cwe_descriptions = {
        'CWE-89': 'SQL Injection',
        'CWE-78': 'Command Injection',
        'CWE-79': 'Cross-site Scripting',
        'CWE-22': 'Path Traversal',
        'CWE-94': 'Code Injection',
        'CWE-327': 'Broken Cryptographic Algorithm',
        'CWE-330': 'Insufficient Randomness',
    }
    
    for issue in data.get('explanations', []):
        cwe = issue.get('cwe', 'CWE-000')
        cwe_counts[cwe] = cwe_counts.get(cwe, 0) + 1
    
    for row_num, (cwe, count) in enumerate(sorted(cwe_counts.items(), key=lambda x: x[1], reverse=True), 2):
        desc = cwe_descriptions.get(cwe, 'Security vulnerability')
        ws.cell(row=row_num, column=1).value = cwe
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = desc
    
    ws.column_dimensions['A'].width = 15
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 40


def create_category_sheet(ws, data):
    """Create category analysis sheet."""
    headers = ['Category', 'Count', 'Percentage']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    category_counts = {}
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    
    for issue in explanations:
        category = issue.get('category', 'General')
        category_counts[category] = category_counts.get(category, 0) + 1
    
    for row_num, (category, count) in enumerate(sorted(category_counts.items(), key=lambda x: x[1], reverse=True), 2):
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = category
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
    
    ws.column_dimensions['A'].width = 30
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 12


if __name__ == '__main__':
    # List of repositories to scan
    repositories = [
        'https://github.com/R44VC0RP/agenda.dev.git',
        'https://github.com/SujalXplores/v0.diy.git',
        'https://github.com/dharmendra912/PairPizzazz-GenAI-App.git',
        'https://github.com/edungee/chineduokeke.com.git',
        'https://github.com/onlook-dev/onlook.git',
        'https://github.com/vietanhbui2000/web-apps.git'
    ]
    
    print("\n" + "=" * 70)
    print("  BATCH REPOSITORY SECURITY SCAN")
    print("=" * 70)
    print(f"\nTotal repositories to scan: {len(repositories)}\n")
    
    summaries = []
    start_time = datetime.now()
    
    for i, repo_url in enumerate(repositories, 1):
        print(f"\n>>> Repository {i}/{len(repositories)}")
        summary = scan_single_repo(repo_url)
        summaries.append(summary)
    
    # Print final summary
    end_time = datetime.now()
    duration = end_time - start_time
    
    print("\n" + "=" * 70)
    print("  BATCH SCAN SUMMARY")
    print("=" * 70)
    
    for summary in summaries:
        if summary.get('status') == 'success':
            print(f"\n {summary['repo_name']}")
            print(f"  - Issues: {summary['total_issues']}")
            print(f"  - Files: {summary['files_scanned']}")
            print(f"  - Excel: {summary['excel_file']}")
        else:
            print(f"\n {summary['repo_url']}: {summary.get('error', 'Unknown error')}")
    
    print(f"\n\nTotal time: {duration}")
    print("=" * 70)
````

## File: agentic_fixer/debug_large_scan.py
````python
#!/usr/bin/env python3
"""
Debug script to test scanning of large ZIP files
"""
import os
import time
import tempfile
import zipfile
from datetime import datetime
from code_security_auto_fixer import repo_scanner, language_detector, pattern_detector, reporter

def scan_large_file(zip_path):
    """Scan a large ZIP file and report progress"""
    print("=" * 80)
    print("Large File Scanning Debug")
    print("=" * 80)
    
    # Check file size
    if not os.path.exists(zip_path):
        print(f"[ERROR] File not found: {zip_path}")
        return
    
    file_size = os.path.getsize(zip_path) / (1024 * 1024)
    print(f"File: {zip_path}")
    print(f"Size: {file_size:.2f} MB")
    print()
    
    # Step 1: Extract ZIP
    print("Step 1: Extracting ZIP file...")
    start_time = time.time()
    
    temp_dir = tempfile.mkdtemp()
    print(f"Extracting to: {temp_dir}")
    
    try:
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall(temp_dir)
        extract_time = time.time() - start_time
        print(f"Extraction completed in {extract_time:.2f} seconds")
        
        # Calculate extracted size
        total_size = 0
        file_count = 0
        for root, dirs, files in os.walk(temp_dir):
            for f in files:
                fp = os.path.join(root, f)
                if os.path.exists(fp):
                    total_size += os.path.getsize(fp)
                    file_count += 1
        
        print(f"Extracted size: {total_size / (1024 * 1024):.2f} MB")
        print(f"Total files: {file_count}")
        print()
        
    except Exception as e:
        print(f"[ERROR] Failed to extract: {e}")
        return
    
    # Step 2: Scan repository
    print("Step 2: Scanning repository...")
    start_time = time.time()
    
    try:
        repo_location = repo_scanner.scan(temp_dir)
        scan_time = time.time() - start_time
        print(f"Repository scan completed in {scan_time:.2f} seconds")
        print(f"Repository location: {repo_location}")
        print()
    except Exception as e:
        print(f"[ERROR] Repository scan failed: {e}")
        return
    
    # Step 3: Detect languages
    print("Step 3: Detecting languages...")
    start_time = time.time()
    
    try:
        file_languages = language_detector.detect_per_file(repo_location)
        detect_time = time.time() - start_time
        print(f"Language detection completed in {detect_time:.2f} seconds")
        
        # Get unique languages
        languages = [
            lang for lang in sorted(set(file_languages.values()))
            if lang and lang.lower() not in {'unknown', 'text'}
        ]
        print(f"Detected languages: {languages}")
        print(f"Total files: {len(file_languages)}")
        print()
    except Exception as e:
        print(f"[ERROR] Language detection failed: {e}")
        return
    
    # Step 4: Scan for patterns
    print("Step 4: Scanning for insecure patterns...")
    start_time = time.time()
    
    try:
        findings = pattern_detector.scan(repo_location, languages)
        pattern_time = time.time() - start_time
        print(f"Pattern detection completed in {pattern_time:.2f} seconds")
        print(f"Found {len(findings)} potential issues")
        print()
    except Exception as e:
        print(f"[ERROR] Pattern detection failed: {e}")
        return
    
    # Step 5: Normalize and prioritize
    print("Step 5: Normalizing and prioritizing findings...")
    start_time = time.time()
    
    try:
        prioritized = pattern_detector.normalize_and_prioritize(findings)
        normalize_time = time.time() - start_time
        print(f"Normalization completed in {normalize_time:.2f} seconds")
        print(f"Prioritized issues: {len(prioritized)}")
        print()
    except Exception as e:
        print(f"[ERROR] Normalization failed: {e}")
        return
    
    # Step 6: Generate explanations
    print("Step 6: Generating explanations...")
    start_time = time.time()
    
    try:
        explanations = pattern_detector.explain_and_suggest(prioritized, detailed=True)
        explain_time = time.time() - start_time
        print(f"Explanation generation completed in {explain_time:.2f} seconds")
        print(f"Total explanations: {len(explanations)}")
        print()
    except Exception as e:
        print(f"[ERROR] Explanation generation failed: {e}")
        return
    
    # Step 7: Build file status
    print("Step 7: Building file status...")
    
    all_files = set(file_languages.keys())
    files_with_issues = set(f['file'] for f in prioritized)
    file_status = []
    
    for f in all_files:
        status = 'issue' if f in files_with_issues else 'clean'
        lang = file_languages.get(f, 'unknown')
        file_status.append({'file': f, 'status': status, 'language': lang})
    
    print(f"File status built: {len(file_status)} files")
    print(f"Files with issues: {len(files_with_issues)}")
    print(f"Clean files: {len(all_files) - len(files_with_issues)}")
    print()
    
    # Summary
    total_time = extract_time + scan_time + detect_time + pattern_time + normalize_time + explain_time
    print("=" * 80)
    print("SUMMARY")
    print("=" * 80)
    print(f"Total time: {total_time:.2f} seconds ({total_time / 60:.2f} minutes)")
    print(f"Total files scanned: {len(all_files)}")
    print(f"Total issues found: {len(explanations)}")
    print(f"Languages detected: {len(languages)}")
    print(f"Clean files: {len(all_files) - len(files_with_issues)}")
    print()
    
    if len(explanations) == 0:
        print(" No security issues found! Your code appears to be secure.")
    
    # Clean up
    try:
        import shutil
        shutil.rmtree(temp_dir)
        print(f"Cleaned up temporary directory: {temp_dir}")
    except Exception as e:
        print(f"[WARNING] Failed to clean up: {e}")

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python debug_large_scan.py <path_to_zip_file>")
        sys.exit(1)
    
    zip_path = sys.argv[1]
    scan_large_file(zip_path)
````

## File: agentic_fixer/debug_scan.py
````python
#!/usr/bin/env python3
"""
Debug script to test the scan process
"""

import os
import tempfile
import shutil
from code_security_auto_fixer import language_detector, pattern_detector

def test_scan_process():
    """Test the scan process with a simple file"""
    
    # Create a temporary test file
    test_content = '''
# Test file with security issues
password = "admin123"  # Hardcoded password
query = f"SELECT * FROM users WHERE id = {user_id}"  # SQL injection
'''
    
    # Create temporary directory and file
    temp_dir = tempfile.mkdtemp()
    test_file = os.path.join(temp_dir, "test.py")
    
    try:
        with open(test_file, 'w') as f:
            f.write(test_content)
        
        print(f"Created test file: {test_file}")
        
        # Test language detection
        print("Testing language detection...")
        file_languages = language_detector.detect_per_file(temp_dir)
        print(f"Detected languages: {file_languages}")
        
        # Get unique languages
        languages = [
            lang for lang in sorted(set(file_languages.values()))
            if lang and lang.lower() not in {'unknown', 'text'}
        ]
        print(f"Unique languages: {languages}")
        
        # Test pattern detection
        print("Testing pattern detection...")
        findings = pattern_detector.scan(temp_dir, languages)
        print(f"Found {len(findings)} findings")
        
        # Test normalization
        print("Testing normalization...")
        prioritized = pattern_detector.normalize_and_prioritize(findings)
        print(f"Prioritized findings: {len(prioritized)}")
        
        # Test explanations
        print("Testing explanations...")
        explanations = pattern_detector.explain_and_suggest(prioritized, detailed=True)
        print(f"Explanations: {len(explanations)}")
        
        print(" Scan process test completed successfully!")
        return True
        
    except Exception as e:
        print(f" Scan process test failed: {e}")
        import traceback
        traceback.print_exc()
        return False
        
    finally:
        # Clean up
        if os.path.exists(temp_dir):
            shutil.rmtree(temp_dir)
            print(f"Cleaned up: {temp_dir}")

if __name__ == "__main__":
    print(" Testing scan process...")
    print("=" * 40)
    
    success = test_scan_process()
    
    print("=" * 40)
    if success:
        print(" Scan process test passed!")
    else:
        print(" Scan process test failed!")
````

## File: agentic_fixer/direct_test.py
````python
#!/usr/bin/env python3
"""
Direct test of the status endpoint
"""

import requests
import time

def test_direct_status():
    """Test status endpoint directly"""
    
    # Start Flask app
    import subprocess
    flask_process = subprocess.Popen(['python', 'app.py'], 
                                   stdout=subprocess.PIPE, 
                                   stderr=subprocess.PIPE,
                                   text=True)
    
    # Wait for app to start
    time.sleep(3)
    
    try:
        # Test status endpoint with a fake scan_id
        fake_scan_id = "scan_1234567890"
        status_url = f"http://localhost:5000/status/{fake_scan_id}"
        status_response = requests.get(status_url)
        print(f"Status response for fake ID: {status_response.status_code}")
        print(f"Response: {status_response.text}")
        
        # Now test upload
        test_file = "test_simple.py"
        url = "http://localhost:5000/upload"
        
        with open(test_file, 'rb') as f:
            files = {'file': (test_file, f, 'text/x-python')}
            response = requests.post(url, files=files)
        
        if response.status_code == 200:
            data = response.json()
            scan_id = data.get('scan_id')
            print(f"Upload successful! Scan ID: {scan_id}")
            
            # Test status immediately
            status_url = f"http://localhost:5000/status/{scan_id}"
            status_response = requests.get(status_url)
            print(f"Status response: {status_response.status_code}")
            print(f"Response: {status_response.text}")
            
        else:
            print(f"Upload failed: {response.status_code} - {response.text}")
            
    finally:
        # Clean up
        flask_process.terminate()
        flask_process.wait()

if __name__ == "__main__":
    test_direct_status()
````

## File: agentic_fixer/minimal_test.py
````python
#!/usr/bin/env python3
"""
Minimal test to isolate the issue
"""

import requests
import time
import threading
import os

def test_minimal_upload():
    """Test minimal upload functionality"""
    
    # Start Flask app
    import subprocess
    flask_process = subprocess.Popen(['python', 'app.py'], 
                                   stdout=subprocess.PIPE, 
                                   stderr=subprocess.PIPE,
                                   text=True)
    
    # Wait for app to start
    time.sleep(3)
    
    try:
        # Test upload
        test_file = "test_simple.py"
        url = "http://localhost:5000/upload"
        
        with open(test_file, 'rb') as f:
            files = {'file': (test_file, f, 'text/x-python')}
            response = requests.post(url, files=files)
        
        if response.status_code == 200:
            data = response.json()
            scan_id = data.get('scan_id')
            print(f"Upload successful! Scan ID: {scan_id}")
            
            # Test status immediately
            status_url = f"http://localhost:5000/status/{scan_id}"
            status_response = requests.get(status_url)
            print(f"Status response: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
                
            # Wait a bit and test again
            time.sleep(2)
            status_response = requests.get(status_url)
            print(f"Status response after 2s: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
        else:
            print(f"Upload failed: {response.status_code} - {response.text}")
            
    finally:
        # Clean up
        flask_process.terminate()
        flask_process.wait()

if __name__ == "__main__":
    test_minimal_upload()
````

## File: agentic_fixer/README.md
````markdown
# Agentic Code Security Auto-Fixer

A comprehensive security scanning and auto-fixing tool that analyzes code repositories, detects insecure coding patterns, and provides AI-powered remediation suggestions. The tool supports multiple programming languages and offers both CLI and web-based interfaces.

## Features

### Core Capabilities
- **Multi-language Support**: Scans Python, Java, JavaScript, TypeScript, C/C++, Go, Rust, Ruby, PHP, and more
- **Security Pattern Detection**: Identifies vulnerabilities including:
  - SQL/NoSQL Injection
  - Cross-Site Scripting (XSS)
  - Path Traversal
  - Command Injection
  - Insecure Deserialization
  - Hardcoded Secrets
  - Banned API Usage
  - Cryptographic Weaknesses
  - And many more...

- **CWE/OWASP Classification**: Automatically maps findings to CWE (Common Weakness Enumeration) and OWASP Top 10 categories
- **AI-Powered Fixes**: Generates secure code solutions using AI models
- **AST-Based Patching**: Applies fixes using Abstract Syntax Tree manipulation
- **Test Integration**: Runs tests after applying fixes and reverts if tests fail
- **Comprehensive Reporting**: Generates detailed markdown reports and Excel exports
- **Database Storage**: Stores scan results in SQLite databases for historical analysis
- **Multiple Orchestration Frameworks**: Supports sequential, LangGraph, AutoGen, and CrewAI orchestration

### Web Interface
- Interactive web dashboard for scanning repositories
- Real-time scan progress tracking
- File upload support (single files or ZIP archives)
- Code editor with syntax highlighting
- Inline code smell detection
- Performance metrics and analytics
- Vulnerability aggregation across all scans

## Installation

### Prerequisites
- Python 3.8 or higher
- pip (Python package manager)
- Git (for cloning repositories)
- Optional: Node.js (for JavaScript/TypeScript syntax checking)
- Optional: Java JDK (for Java syntax checking)
- Optional: GCC/G++ (for C/C++ syntax checking)

### Step 1: Clone the Repository
```bash
git clone <repository-url>
cd Agentic-Code-Security-Auto-Fixer
```

### Step 2: Install Dependencies
```bash
pip install -r requirements.txt
```

### Step 3: Configure Environment Variables
Create a `.env` file in the project root directory:

```env
# Google Gemini Configuration (Required)
GEMINI_API_KEY=your_google_api_key_here
GEMINI_ACCESS_TOKEN=optional_oauth_access_token
GEMINI_API_BASE_URL=https://generativelanguage.googleapis.com/v1beta/models
GEMINI_MODEL_NAME=gemini-3-pro-preview
GEMINI_TEMPERATURE=0.2
GEMINI_MAX_OUTPUT_TOKENS=1024
GEMINI_CANDIDATE_COUNT=1

# Optional: Legacy OpenAI Configuration (for backward compatibility)
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=1000
```

**Note**: Replace the placeholder values with your actual API configuration. The API URLs and keys should be kept private and not committed to version control.

### Step 4: Verify Installation
```bash
python -m code_security_auto_fixer.cli --help
```

## Usage

### Web Interface

#### Starting the Web Server
```bash
python app.py
```

### Command Line Interface (CLI)

#### Basic Usage
```bash
# Scan a local repository
python -m code_security_auto_fixer.cli /path/to/repository

# Scan a GitHub repository
python -m code_security_auto_fixer.cli https://github.com/user/repo

# Scan with auto-fix enabled
python -m code_security_auto_fixer.cli /path/to/repository --fix

# Specify output report file
python -m code_security_auto_fixer.cli /path/to/repository --report my_report.md

# Use a specific orchestrator
python -m code_security_auto_fixer.cli /path/to/repository --orchestrator langgraph
```

#### Available Orchestrators
- `sequential`: Default sequential execution (always available)
- `langgraph`: LangGraph-based orchestration (requires `langgraph>=0.6.8`)
- `autogen`: AutoGen-based orchestration (requires `pyautogen>=0.2.0`)
- `crewai`: CrewAI-based orchestration (requires `crewai`)

#### CLI Options
```
positional arguments:
  repo                  Path to local repo or GitHub URL

optional arguments:
  --fix                 Auto-fix detected issues
  --report REPORT       Output report file (default: remediation_report.md)
  --orchestrator {sequential,langgraph,autogen,crewai}
                        Orchestration framework to use (default: sequential)
  --graph               [DEPRECATED] Use LangGraph orchestration
  -h, --help            Show help message
```



The web interface will be available at `http://localhost:5000`

#### Web Interface Features
1. **Repository Scanning**: Enter a local path or GitHub URL to scan
2. **File Upload**: Upload single files or ZIP archives for analysis
3. **Real-time Progress**: Monitor scan progress with live updates
4. **Results Viewing**: Browse findings with detailed explanations
5. **Code Editor**: Edit files directly in the browser with syntax highlighting
6. **Code Smell Detection**: Get code quality suggestions
7. **Export Options**: Download results as Excel files
8. **Performance Analytics**: Compare performance across different orchestrators

#### Web API Endpoints
- `POST /scan` - Start a repository scan
- `POST /upload` - Upload files for scanning
- `GET /status/<scan_id>` - Get scan status
- `GET /results/<scan_id>` - Get scan results
- `GET /results/<scan_id>/download.xlsx` - Download Excel report
- `GET /orchestrators` - List available orchestrators
- `GET /performance` - Get performance metrics
- `GET /api/scans` - List all scans
- `POST /api/auto-fix` - Generate AI-powered fixes
- `GET /api/file/<scan_id>/content` - Get file content for editing
- `POST /api/file/<scan_id>/save` - Save edited file
- `POST /api/file/<scan_id>/run` - Check code syntax


## Configuration

### Security Policies
Security policies can be configured in `code_security_auto_fixer/config.py`. The configuration includes:

- **Severity Thresholds**: Define priority scores for different severity levels
- **Enabled Checks**: Toggle specific security check types
- **Language-Specific Policies**: Configure banned imports, required imports, and severity overrides per language
- **CWE Configuration**: Enable/disable specific CWE checks and set priorities
- **OWASP Configuration**: Configure OWASP Top 10 category weights

### File Processing
- Maximum file size: 10MB (configurable)
- Supported file extensions: Extensive list of programming languages
- Excluded directories: `node_modules`, `venv`, `__pycache__`, etc.
- Excluded files: Lock files, dependency manifests

### Scan Configuration
- Parallel processing: Enabled by default
- Max workers: 4 (configurable)
- Timeout: 300 seconds
- Memory limit: 1024MB
- Analysis modes: AST analysis, regex analysis, semantic analysis (optional)

## How It Works

1. **Repository Scanning**: Clones or accesses the repository
2. **Language Detection**: Identifies programming languages in each file
3. **Pattern Detection**: Scans for insecure coding patterns using:
   - AST (Abstract Syntax Tree) analysis
   - Regex pattern matching
   - Semgrep rules
   - Custom security policies
4. **Normalization**: Maps findings to CWE and OWASP categories
5. **Prioritization**: Calculates priority scores based on severity, CWE, and OWASP weights
6. **Explanation Generation**: Uses AI to generate detailed explanations and remediation suggestions
7. **Auto-Fixing** (optional): Applies AST-based patches to fix issues
8. **Testing**: Runs tests to verify fixes don't break functionality
9. **Reporting**: Generates comprehensive reports and stores results in database

## Technologies Used

- **Python 3.8+**: Core language
- **Flask**: Web framework
- **Semgrep**: Static analysis engine
- **Tree-sitter**: AST parsing
- **GitPython**: Git repository handling
- **PyGithub**: GitHub API integration
- **LangGraph**: Workflow orchestration
- **AutoGen**: Multi-agent orchestration
- **CrewAI**: Agent orchestration
- **SQLite**: Database storage
- **OpenPyXL**: Excel export
- **Rich**: CLI formatting

## Database Schema

The tool stores scan results in SQLite databases located in the `repo_storage/` directory. Each repository gets its own database file. The schema includes:

- **scans**: Scan metadata and performance metrics
- **projects**: Project information
- **files**: File metadata and content references
- **blobs**: File content storage (deduplicated)
- **findings**: Security findings
- **rules**: Security rule definitions
- **explanations**: AI-generated explanations

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure all dependencies are installed:
   ```bash
   pip install -r requirements.txt
   ```

2. **API Connection Errors**: Verify your `.env` file has correct API configuration

3. **Orchestrator Not Available**: Install the required package:
   ```bash
   pip install langgraph>=0.6.8  # For LangGraph
   pip install pyautogen>=0.2.0  # For AutoGen
   pip install crewai            # For CrewAI
   ```

4. **File Not Found Errors**: Ensure repository paths are correct and accessible

5. **Syntax Check Failures**: Install the appropriate language interpreter/compiler:
   - Python: Usually pre-installed
   - JavaScript: Install Node.js
   - Java: Install JDK
   - C/C++: Install GCC/G++

## Security Considerations

- **API Keys**: Never commit API keys or URLs to version control
- **Uploaded Files**: Files uploaded through the web interface may contain sensitive data
- **Database Storage**: Scan databases may contain code content - handle with care
- **Network Access**: The tool may clone repositories from the internet - ensure network security

## Contributing

When contributing to this project:

1. Follow Python PEP 8 style guidelines
2. Add tests for new features
3. Update documentation as needed
4. Keep API URLs and keys private
5. Test with multiple programming languages


## Support

For issues, questions, or contributions, please refer to the project's issue tracker.

---

**Note**: This tool is designed to assist with security analysis but should not be the only security measure. Always perform comprehensive security reviews and follow security best practices.
````

## File: agentic_fixer/requirements.txt
````
tree_sitter
semgrep
gitpython
pygithub
openai
pytest
rich
flask
python-dotenv
openpyxl
langgraph>=0.6.8
pyautogen>=0.2.0
crewai
requests
````

## File: agentic_fixer/scan_onlook_repo.py
````python
#!/usr/bin/env python3
"""
Standalone script to scan the onlook GitHub repository and generate an Excel report.
"""

import os
import sys
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils import get_column_letter

# Import the scanning modules
from code_security_auto_fixer import repo_scanner, language_detector, pattern_detector, reporter

def scan_and_report(repo_url, output_file):
    """
    Scan a repository and generate an Excel report.
    
    Args:
        repo_url: GitHub repository URL
        output_file: Output Excel file path
    """
    print(f"Scanning repository: {repo_url}")
    
    # Step 1: Scan the repository
    print("[1/6] Scanning repository...")
    repo_path = repo_scanner.scan(repo_url)
    print(f"Repository cloned to: {repo_path}")
    
    # Step 2: Detect programming languages
    print("[2/6] Detecting programming languages...")
    file_languages = language_detector.detect_per_file(repo_path)
    languages = [
        lang for lang in sorted(set(file_languages.values()))
        if lang and lang.lower() not in {'unknown', 'text'}
    ]
    print(f"Languages detected: {', '.join(languages)}")
    print(f"Total files: {len(file_languages)}")
    
    # Step 3: Scan for security patterns
    print("[3/6] Scanning for insecure patterns...")
    findings = pattern_detector.scan(repo_path, languages)
    print(f"Found {len(findings)} security issues")
    
    # Step 4: Normalize and prioritize
    print("[4/6] Normalizing and prioritizing findings...")
    prioritized = pattern_detector.normalize_and_prioritize(findings)
    
    # Step 5: Generate explanations
    print("[5/6] Generating explanations and suggestions...")
    explanations = pattern_detector.explain_and_suggest(prioritized, detailed=True)
    
    # Step 6: Build file status
    all_files = set(file_languages.keys())
    files_with_issues = set(f['file'] for f in prioritized)
    file_status = []
    for f in all_files:
        status = 'issue' if f in files_with_issues else 'clean'
        lang = file_languages.get(f, 'unknown')
        file_status.append({'file': f, 'status': status, 'language': lang})
    
    # Generate Excel report
    print("[6/6] Generating Excel report...")
    excel_data = {
        'repo_path': repo_url,
        'completed_at': datetime.now().isoformat(),
        'languages': languages,
        'file_status': file_status,
        'explanations': explanations,
        'prioritized': prioritized,
        'findings': findings
    }
    
    build_excel(excel_data, output_file)
    print(f"\n Excel report generated: {output_file}")
    print(f"  - Total issues: {len(explanations)}")
    print(f"  - Files scanned: {len(all_files)}")
    print(f"  - Languages: {', '.join(languages)}")
    
    # Also generate a markdown report for reference
    markdown_file = output_file.replace('.xlsx', '.md')
    os.makedirs("reports", exist_ok=True)
    reporter.generate(markdown_file, explanations, prioritized, file_status)
    print(f" Markdown report generated: {markdown_file}")
    
    return excel_data


def build_excel(data, output_file):
    """Build Excel workbook from scan data."""
    wb = Workbook()
    
    # Remove default sheet
    wb.remove(wb.active)
    
    # 1. Summary Sheet
    ws_summary = wb.create_sheet('Summary')
    create_summary_sheet(ws_summary, data)
    
    # 2. Issues Sheet
    ws_issues = wb.create_sheet('Security Issues')
    create_issues_sheet(ws_issues, data)
    
    # 3. Files Sheet
    ws_files = wb.create_sheet('Files')
    create_files_sheet(ws_files, data)
    
    # 4. Languages Sheet
    ws_lang = wb.create_sheet('Languages')
    create_languages_sheet(ws_lang, data)
    
    # 5. Severity Breakdown
    ws_severity = wb.create_sheet('Severity Breakdown')
    create_severity_sheet(ws_severity, data)
    
    # 6. CWE Vulnerabilities
    ws_cwe = wb.create_sheet('CWE Analysis')
    create_cwe_sheet(ws_cwe, data)
    
    # 7. Category Analysis
    ws_category = wb.create_sheet('Category Analysis')
    create_category_sheet(ws_category, data)
    
    # Save the workbook
    wb.save(output_file)


def create_summary_sheet(ws, data):
    """Create summary sheet with key metrics."""
    # Header
    ws.merge_cells('A1:B1')
    ws['A1'] = 'Security Scan Summary'
    ws['A1'].font = Font(bold=True, size=14)
    
    # Summary data
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    files_with_issues = len([f for f in data.get('file_status', []) if f.get('status') == 'issue'])
    total_files = len(data.get('file_status', []))
    
    summary_data = [
        ['Repository', data.get('repo_path', 'N/A')],
        ['Scan Date', data.get('completed_at', 'N/A')],
        ['Total Issues Found', total_issues],
        ['Files Scanned', total_files],
        ['Files with Issues', files_with_issues],
        ['Clean Files', total_files - files_with_issues],
        ['Languages Detected', ', '.join(data.get('languages', []))],
    ]
    
    row_num = 3
    for label, value in summary_data:
        cell_label = ws.cell(row=row_num, column=1)
        cell_value = ws.cell(row=row_num, column=2)
        cell_label.value = label
        cell_label.font = Font(bold=True)
        cell_value.value = value
        row_num += 1
    
    # Severity counts
    row_num += 1
    ws.cell(row=row_num, column=1).value = 'Severity Breakdown:'
    ws.cell(row=row_num, column=1).font = Font(bold=True)
    row_num += 1
    
    ws.cell(row=row_num, column=1).value = 'Severity'
    ws.cell(row=row_num, column=2).value = 'Count'
    ws.cell(row=row_num, column=3).value = 'Percentage'
    for cell in ws[row_num]:
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
    row_num += 1
    
    severity_counts = {}
    for issue in explanations:
        severity = issue.get('severity', 'medium')
        severity_counts[severity] = severity_counts.get(severity, 0) + 1
    
    for severity in ['critical', 'high', 'medium', 'low', 'info']:
        count = severity_counts.get(severity, 0)
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = severity.title()
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
        row_num += 1
    
    # Auto-fit columns
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 40


def create_issues_sheet(ws, data):
    """Create detailed issues sheet."""
    headers = ['File', 'Line', 'Issue', 'Severity', 'CWE', 'OWASP', 'Category', 'Priority', 'Description', 'Code', 'Suggestion']
    
    # Write headers
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    # Write data
    for row_num, issue in enumerate(data.get('explanations', []), 2):
        ws.cell(row=row_num, column=1).value = issue.get('file', '')
        ws.cell(row=row_num, column=2).value = issue.get('line', 0)
        ws.cell(row=row_num, column=3).value = issue.get('issue', '')
        ws.cell(row=row_num, column=4).value = issue.get('severity', '')
        ws.cell(row=row_num, column=5).value = issue.get('cwe', '')
        ws.cell(row=row_num, column=6).value = issue.get('owasp', '')
        ws.cell(row=row_num, column=7).value = issue.get('category', '')
        ws.cell(row=row_num, column=8).value = issue.get('priority_score', 0)
        ws.cell(row=row_num, column=9).value = issue.get('description') or issue.get('explanation', '')
        ws.cell(row=row_num, column=10).value = str(issue.get('code', ''))[:500]  # Limit length
        ws.cell(row=row_num, column=11).value = str(issue.get('suggestion', ''))[:500]
    
    # Auto-fit columns
    ws.column_dimensions['A'].width = 30  # File
    ws.column_dimensions['B'].width = 8   # Line
    ws.column_dimensions['C'].width = 25  # Issue
    ws.column_dimensions['D'].width = 12  # Severity
    ws.column_dimensions['E'].width = 12  # CWE
    ws.column_dimensions['F'].width = 30  # OWASP
    ws.column_dimensions['G'].width = 20  # Category
    ws.column_dimensions['H'].width = 10  # Priority
    ws.column_dimensions['I'].width = 50  # Description
    ws.column_dimensions['J'].width = 40  # Code
    ws.column_dimensions['K'].width = 50  # Suggestion


def create_files_sheet(ws, data):
    """Create files status sheet."""
    headers = ['File', 'Status', 'Language', 'Issues Count']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    # Group issues by file
    issues_by_file = {}
    for issue in data.get('explanations', []):
        file_path = issue.get('file', '')
        if file_path not in issues_by_file:
            issues_by_file[file_path] = 0
        issues_by_file[file_path] += 1
    
    for row_num, file_info in enumerate(sorted(data.get('file_status', []), key=lambda x: issues_by_file.get(x.get('file', ''), 0), reverse=True), 2):
        file_path = file_info.get('file', '')
        ws.cell(row=row_num, column=1).value = file_path
        ws.cell(row=row_num, column=2).value = file_info.get('status', '')
        ws.cell(row=row_num, column=3).value = file_info.get('language', '')
        ws.cell(row=row_num, column=4).value = issues_by_file.get(file_path, 0)
    
    ws.column_dimensions['A'].width = 50
    ws.column_dimensions['B'].width = 12
    ws.column_dimensions['C'].width = 15
    ws.column_dimensions['D'].width = 12


def create_languages_sheet(ws, data):
    """Create languages breakdown sheet."""
    headers = ['Language', 'File Count', 'Percentage']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    # Count files by language
    lang_counts = {}
    total_files = len(data.get('file_status', []))
    
    for file_info in data.get('file_status', []):
        lang = file_info.get('language', 'unknown')
        lang_counts[lang] = lang_counts.get(lang, 0) + 1
    
    for row_num, (lang, count) in enumerate(sorted(lang_counts.items(), key=lambda x: x[1], reverse=True), 2):
        percentage = (count / total_files * 100) if total_files > 0 else 0
        ws.cell(row=row_num, column=1).value = lang
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
    
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 15
    ws.column_dimensions['C'].width = 15


def create_severity_sheet(ws, data):
    """Create severity analysis sheet."""
    headers = ['Severity', 'Count', 'Percentage', 'Risk Level']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    severity_counts = {}
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    
    for issue in explanations:
        severity = issue.get('severity', 'medium')
        severity_counts[severity] = severity_counts.get(severity, 0) + 1
    
    risk_levels = {
        'critical': 'Immediate Action Required',
        'high': 'Urgent - Fix Within 48 Hours',
        'medium': 'Fix Within 1 Week',
        'low': 'Fix When Convenient',
        'info': 'Informational'
    }
    
    for row_num, severity in enumerate(['critical', 'high', 'medium', 'low', 'info'], 2):
        count = severity_counts.get(severity, 0)
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = severity.title()
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
        ws.cell(row=row_num, column=4).value = risk_levels.get(severity, '')
    
    ws.column_dimensions['A'].width = 15
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 12
    ws.column_dimensions['D'].width = 30


def create_cwe_sheet(ws, data):
    """Create CWE vulnerability analysis sheet."""
    headers = ['CWE', 'Count', 'Description']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    # Count CWE occurrences
    cwe_counts = {}
    cwe_descriptions = {
        'CWE-89': 'SQL Injection',
        'CWE-78': 'Command Injection',
        'CWE-79': 'Cross-site Scripting',
        'CWE-22': 'Path Traversal',
        'CWE-94': 'Code Injection',
        'CWE-327': 'Broken Cryptographic Algorithm',
        'CWE-330': 'Insufficient Randomness',
    }
    
    for issue in data.get('explanations', []):
        cwe = issue.get('cwe', 'CWE-000')
        cwe_counts[cwe] = cwe_counts.get(cwe, 0) + 1
    
    for row_num, (cwe, count) in enumerate(sorted(cwe_counts.items(), key=lambda x: x[1], reverse=True), 2):
        desc = cwe_descriptions.get(cwe, 'Security vulnerability')
        ws.cell(row=row_num, column=1).value = cwe
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = desc
    
    ws.column_dimensions['A'].width = 15
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 40


def create_category_sheet(ws, data):
    """Create category analysis sheet."""
    headers = ['Category', 'Count', 'Percentage']
    
    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num)
        cell.value = header
        cell.font = Font(bold=True)
        cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        cell.font = Font(bold=True, color="FFFFFF")
        cell.alignment = Alignment(horizontal="center")
    
    category_counts = {}
    explanations = data.get('explanations', [])
    total_issues = len(explanations)
    
    for issue in explanations:
        category = issue.get('category', 'General')
        category_counts[category] = category_counts.get(category, 0) + 1
    
    for row_num, (category, count) in enumerate(sorted(category_counts.items(), key=lambda x: x[1], reverse=True), 2):
        percentage = (count / total_issues * 100) if total_issues > 0 else 0
        ws.cell(row=row_num, column=1).value = category
        ws.cell(row=row_num, column=2).value = count
        ws.cell(row=row_num, column=3).value = f"{percentage:.1f}%"
    
    ws.column_dimensions['A'].width = 30
    ws.column_dimensions['B'].width = 10
    ws.column_dimensions['C'].width = 12


if __name__ == '__main__':
    import sys
    
    # Parse command-line arguments
    if len(sys.argv) > 1:
        repo_url = sys.argv[1]
    else:
        # Default repository
        repo_url = 'https://github.com/DaveSimoes/VercelZero.git'
    
    # Extract repo name for output file naming
    repo_name = repo_url.split('/')[-1].replace('.git', '')
    
    # Output file
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    output_file = f'{repo_name}_security_report_{timestamp}.xlsx'
    
    print(f"=" * 70)
    print(f"  Security Scan: {repo_url}")
    print(f"=" * 70)
    print()
    
    try:
        data = scan_and_report(repo_url, output_file)
        print()
        print("=" * 70)
        print("  Scan completed successfully!")
        print("=" * 70)
    except Exception as e:
        print(f"\n Error during scan: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
````

## File: agentic_fixer/test_analytics.py
````python
#!/usr/bin/env python3
"""
Test script to verify analytics functionality
"""

import requests
import json
import time

def test_analytics():
    base_url = "http://localhost:5000"
    
    print("Testing Analytics Panel Functionality...")
    print("=" * 50)
    
    # Test 1: Check if the main page loads
    try:
        response = requests.get(base_url)
        if response.status_code == 200:
            print("[OK] Main page loads successfully")
        else:
            print(f"[ERROR] Main page failed to load: {response.status_code}")
            return
    except Exception as e:
        print(f"[ERROR] Cannot connect to server: {e}")
        return
    
    # Test 2: Check analytics API endpoint
    try:
        response = requests.get(f"{base_url}/api/analytics")
        if response.status_code == 200:
            data = response.json()
            print("[OK] Analytics API endpoint responds")
            print(f"  - Security Score: {data['metrics']['overallSecurityScore']}%")
            print(f"  - Total Vulnerabilities: {data['metrics']['totalVulnerabilities']}")
            print(f"  - Critical Issues: {data['metrics']['criticalIssues']}")
        else:
            print(f"[ERROR] Analytics API failed: {response.status_code}")
    except Exception as e:
        print(f"[ERROR] Analytics API error: {e}")
    
    # Test 3: Check metrics API endpoint
    try:
        response = requests.get(f"{base_url}/api/metrics")
        if response.status_code == 200:
            data = response.json()
            print("[OK] Metrics API endpoint responds")
            print(f"  - Security Scans: {data['security_scans']}")
            print(f"  - Active Scans: {data['active_scans']}")
            print(f"  - Critical Alerts: {data['critical_alerts']}")
        else:
            print(f"[ERROR] Metrics API failed: {response.status_code}")
    except Exception as e:
        print(f"[ERROR] Metrics API error: {e}")
    
    # Test 4: Check compliance API endpoint
    try:
        response = requests.get(f"{base_url}/api/compliance")
        if response.status_code == 200:
            data = response.json()
            print("[OK] Compliance API endpoint responds")
            print(f"  - Overall Compliance: {data['overall_compliance']}%")
            print(f"  - Standards Met: {data['standards_met']}")
        else:
            print(f"[ERROR] Compliance API failed: {response.status_code}")
    except Exception as e:
        print(f"[ERROR] Compliance API error: {e}")
    
    print("\n" + "=" * 50)
    print("Analytics Panel Test Summary:")
    print("- The analytics panel should now show data after uploading/scanning")
    print("- All API endpoints are responding correctly")
    print("- Charts and metrics should populate automatically")
    print("\nTo test manually:")
    print("1. Open http://localhost:5000 in your browser")
    print("2. Upload a file or scan a repository")
    print("3. Navigate to the Analytics tab")
    print("4. Verify that charts and metrics are displayed")

if __name__ == "__main__":
    test_analytics()
````

## File: agentic_fixer/test_comprehensive_storage.py
````python
"""
Test script for the comprehensive database storage system.

This demonstrates how the new database schema stores detailed scan information.
"""

import os
import tempfile
import sys

# Add project root to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from code_security_auto_fixer.db_exporter import export_to_db


def test_comprehensive_storage():
    """Test the comprehensive database storage system."""
    
    # Sample scan data
    sample_data = {
        'repo_path': '/tmp/test_repo',
        'completed_at': '2025-01-15T10:30:00',
        'languages': ['python', 'javascript'],
        'file_status': [
            {'file': 'app.py', 'status': 'issue', 'language': 'python'},
            {'file': 'index.js', 'status': 'clean', 'language': 'javascript'},
        ],
        'explanations': [
            {
                'file': 'app.py',
                'line': 42,
                'issue': 'SQL_INJECTION',
                'severity': 'high',
                'cwe': 'CWE-89',
                'owasp': 'A03:2021',
                'category': 'injection',
                'description': 'SQL injection vulnerability detected',
                'code': "query = f\"SELECT * FROM users WHERE id = {user_input}\"",
                'suggestion': 'Use parameterized queries: cursor.execute("SELECT * FROM users WHERE id = ?", (user_input,))',
                'context': ['# Line 40', 'user_input = request.get("id")', 'query = f"SELECT * FROM users WHERE id = {user_input}"', '# Line 43']
            },
            {
                'file': 'app.py',
                'line': 100,
                'issue': 'XSS_VULNERABILITY',
                'severity': 'medium',
                'cwe': 'CWE-79',
                'owasp': 'A03:2021',
                'category': 'xss',
                'description': 'Cross-site scripting vulnerability detected',
                'code': 'return render(request, "user.html", {"name": user_input})',
                'suggestion': 'Sanitize output: return render(request, "user.html", {"name": escape(user_input)})',
                'context': ['# Line 98', 'user_input = request.get("name")', 'return render(request, "user.html", {"name": user_input})']
            }
        ],
        'findings': []
    }
    
    # Export to database
    print("Creating comprehensive database storage...")
    db_path = export_to_db(sample_data, "test-project")
    
    print(f"\n Database created at: {db_path}")
    
    # Verify the database structure
    import sqlite3
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Get table names
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    tables = [row[0] for row in cursor.fetchall()]
    print(f"\n Tables created: {', '.join(sorted(tables))}")
    
    # Query findings
    cursor.execute("SELECT COUNT(*) as count FROM findings")
    finding_count = cursor.fetchone()[0]
    print(f" Findings stored: {finding_count}")
    
    # Query files
    cursor.execute("SELECT COUNT(*) as count FROM files")
    file_count = cursor.fetchone()[0]
    print(f" Files recorded: {file_count}")
    
    # Query rules
    cursor.execute("SELECT COUNT(*) as count FROM rules")
    rule_count = cursor.fetchone()[0]
    print(f" Rules registered: {rule_count}")
    
    # Query aggregates
    cursor.execute("SELECT kind, key, count FROM aggregates")
    aggregates = cursor.fetchall()
    print(f"\n Aggregates computed:")
    for agg in aggregates:
        print(f"  - {agg[0]}: {agg[1]} = {agg[2]}")
    
    # Query project info
    cursor.execute("SELECT * FROM projects")
    projects = cursor.fetchall()
    print(f"\n Projects: {len(projects)}")
    for p in projects:
        print(f"  - {p[1]} (ID: {p[0]})")
    
    # Query scan info
    cursor.execute("SELECT * FROM scans")
    scans = cursor.fetchall()
    print(f"\n Scans: {len(scans)}")
    for s in scans:
        print(f"  - Started: {s[3]}, Files scanned: {s[5]}")
    
    conn.close()
    
    print("\n Comprehensive database storage test passed!")
    return db_path


if __name__ == '__main__':
    test_comprehensive_storage()
````

## File: agentic_fixer/test_globals.py
````python
#!/usr/bin/env python3
"""
Test global variables
"""

import requests
import time
import threading

def test_global_variables():
    """Test if global variables are working"""
    
    # Start Flask app
    import subprocess
    flask_process = subprocess.Popen(['python', 'app.py'], 
                                   stdout=subprocess.PIPE, 
                                   stderr=subprocess.PIPE,
                                   text=True)
    
    # Wait for app to start
    time.sleep(3)
    
    try:
        # Test upload
        test_file = "test_simple.py"
        url = "http://localhost:5000/upload"
        
        with open(test_file, 'rb') as f:
            files = {'file': (test_file, f, 'text/x-python')}
            response = requests.post(url, files=files)
        
        if response.status_code == 200:
            data = response.json()
            scan_id = data.get('scan_id')
            print(f"Upload successful! Scan ID: {scan_id}")
            
            # Test status immediately
            status_url = f"http://localhost:5000/status/{scan_id}"
            status_response = requests.get(status_url)
            print(f"Status response: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
                
            # Wait a bit and test again
            time.sleep(2)
            status_response = requests.get(status_url)
            print(f"Status response after 2s: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
        else:
            print(f"Upload failed: {response.status_code} - {response.text}")
            
    finally:
        # Clean up
        flask_process.terminate()
        flask_process.wait()

if __name__ == "__main__":
    test_global_variables()
````

## File: agentic_fixer/test_side_by_side.py
````python
#!/usr/bin/env python3
"""
Test file to demonstrate side-by-side report format
"""

import os
import subprocess
import hashlib

# Command injection vulnerability
def run_command(user_input):
    # VULNERABLE: Using os.system with user input
    os.system(f"ls {user_input}")
    
    # VULNERABLE: subprocess with shell=True
    subprocess.run(f"echo {user_input}", shell=True)

# Hardcoded secret
api_key = "sk-1234567890abcdef"  # VULNERABLE: Hardcoded secret

# Weak crypto
def hash_password(password):
    # VULNERABLE: Using MD5
    return hashlib.md5(password.encode()).hexdigest()

# Code injection
def process_user_input(user_input):
    # VULNERABLE: Using eval
    result = eval(user_input)
    return result

if __name__ == "__main__":
    # Test the vulnerable functions
    username = input("Enter username: ")
    run_command(username)
    
    password = input("Enter password: ")
    hashed = hash_password(password)
    print(f"Hashed: {hashed}")
    
    user_code = input("Enter code to execute: ")
    result = process_user_input(user_code)
    print(f"Result: {result}")
````

## File: agentic_fixer/test_simple.py
````python
# Simple test file
password = "admin123"
````

## File: agentic_fixer/test_status.py
````python
#!/usr/bin/env python3
"""
Test status tracking
"""

import requests
import time
import threading
import os

def test_status_tracking():
    """Test if status tracking works"""
    
    # Start Flask app in background
    import subprocess
    flask_process = subprocess.Popen(['python', 'app.py'], 
                                   stdout=subprocess.PIPE, 
                                   stderr=subprocess.PIPE,
                                   text=True)
    
    # Wait for app to start
    time.sleep(3)
    
    try:
        # Test upload
        test_file = "test_simple.py"
        url = "http://localhost:5000/upload"
        
        with open(test_file, 'rb') as f:
            files = {'file': (test_file, f, 'text/x-python')}
            response = requests.post(url, files=files)
        
        if response.status_code == 200:
            data = response.json()
            scan_id = data.get('scan_id')
            print(f"Upload successful! Scan ID: {scan_id}")
            
            # Test status immediately
            status_url = f"http://localhost:5000/status/{scan_id}"
            status_response = requests.get(status_url)
            print(f"Status response: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
                
            # Wait a bit and test again
            time.sleep(2)
            status_response = requests.get(status_url)
            print(f"Status response after 2s: {status_response.status_code}")
            if status_response.status_code == 200:
                print(f"Status: {status_response.json()}")
            else:
                print(f"Status error: {status_response.text}")
        else:
            print(f"Upload failed: {response.status_code} - {response.text}")
            
    finally:
        # Clean up
        flask_process.terminate()
        flask_process.wait()

if __name__ == "__main__":
    test_status_tracking()
````

## File: agentic_fixer/test_upload_debug.py
````python
#!/usr/bin/env python3
"""
Debug upload test
"""

import requests
import time

def test_upload_with_debug():
    """Test upload and monitor debug output"""
    
    test_file = "test_simple.py"
    url = "http://localhost:5000/upload"
    
    try:
        with open(test_file, 'rb') as f:
            files = {'file': (test_file, f, 'text/x-python')}
            response = requests.post(url, files=files)
        
        if response.status_code == 200:
            data = response.json()
            scan_id = data.get('scan_id')
            print(f" Upload successful! Scan ID: {scan_id}")
            
            # Monitor status for a few seconds
            for i in range(10):
                status_url = f"http://localhost:5000/status/{scan_id}"
                try:
                    status_response = requests.get(status_url)
                    if status_response.status_code == 200:
                        status = status_response.json()
                        print(f"Status: {status.get('status')} - {status.get('current_step')} ({status.get('progress')}%)")
                        
                        if status.get('status') in ['completed', 'error']:
                            break
                    else:
                        print(f"Status request failed: {status_response.status_code}")
                except Exception as e:
                    print(f"Status request error: {e}")
                
                time.sleep(1)
            
            return True
        else:
            print(f" Upload failed: {response.status_code} - {response.text}")
            return False
            
    except Exception as e:
        print(f" Error: {e}")
        return False

if __name__ == "__main__":
    print(" Testing upload with debug...")
    test_upload_with_debug()
````

## File: electron/services/analysis.ts
````typescript
import { exec } from 'child_process'
import { promisify } from 'util'
import fs from 'fs/promises'
import path from 'path'

const execAsync = promisify(exec)

export interface LargeFile {
  path: string
  size: number
  sizeFormatted: string
  type: 'current' | 'git-history'
}

export interface OversizedComponent {
  path: string
  lines: number
  type: string
}

export interface CleanupReport {
  largeFiles: LargeFile[]
  gitHistoryFiles: LargeFile[]
  oversizedComponents: OversizedComponent[]
  totalWastedSpace: number
  totalWastedSpaceFormatted: string
}

function formatSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
  if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
  return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`
}

// Find largest files in the repository
export async function findLargeFiles(repoPath: string, minSizeBytes: number = 1024 * 1024): Promise<LargeFile[]> {
  const largeFiles: LargeFile[] = []

  async function scanDir(dir: string) {
    try {
      const entries = await fs.readdir(dir, { withFileTypes: true })

      for (const entry of entries) {
        const fullPath = path.join(dir, entry.name)

        // Skip node_modules, .git, vendor, deps, etc.
        if (['node_modules', '.git', 'vendor', 'deps', '_build', '.bundle', '__pycache__', '.venv', 'venv'].includes(entry.name)) {
          continue
        }

        if (entry.isDirectory()) {
          await scanDir(fullPath)
        } else {
          try {
            const stats = await fs.stat(fullPath)
            if (stats.size >= minSizeBytes) {
              largeFiles.push({
                path: path.relative(repoPath, fullPath),
                size: stats.size,
                sizeFormatted: formatSize(stats.size),
                type: 'current'
              })
            }
          } catch {}
        }
      }
    } catch {}
  }

  await scanDir(repoPath)

  return largeFiles.sort((a, b) => b.size - a.size)
}

// Find large files in git history (blobs that are large but may have been deleted)
export async function findGitHistoryBlobs(repoPath: string, minSizeBytes: number = 5 * 1024 * 1024): Promise<LargeFile[]> {
  const largeFiles: LargeFile[] = []

  try {
    // Get all blobs with their sizes
    const { stdout } = await execAsync(
      `git rev-list --objects --all | git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' | awk '/^blob/ {print $2, $3, $4}'`,
      { cwd: repoPath, timeout: 60000, maxBuffer: 50 * 1024 * 1024 }
    )

    const lines = stdout.split('\n').filter(l => l.trim())

    for (const line of lines) {
      const parts = line.split(' ')
      if (parts.length >= 2) {
        const size = parseInt(parts[1], 10)
        const filePath = parts.slice(2).join(' ') || parts[0]

        if (size >= minSizeBytes) {
          largeFiles.push({
            path: filePath,
            size,
            sizeFormatted: formatSize(size),
            type: 'git-history'
          })
        }
      }
    }
  } catch (e) {
    console.error('Git history scan failed:', e)
  }

  return largeFiles.sort((a, b) => b.size - a.size).slice(0, 50)
}

// Find oversized components (files with too many lines)
export async function findOversizedComponents(repoPath: string, maxLines: number = 150): Promise<OversizedComponent[]> {
  const oversized: OversizedComponent[] = []

  const codeExtensions = ['.js', '.jsx', '.ts', '.tsx', '.vue', '.svelte', '.py', '.rb', '.ex', '.exs', '.go', '.rs', '.java', '.kt', '.swift']

  async function scanDir(dir: string) {
    try {
      const entries = await fs.readdir(dir, { withFileTypes: true })

      for (const entry of entries) {
        const fullPath = path.join(dir, entry.name)

        if (['node_modules', '.git', 'vendor', 'deps', '_build', '.bundle', '__pycache__', '.venv', 'venv', 'dist', 'build'].includes(entry.name)) {
          continue
        }

        if (entry.isDirectory()) {
          await scanDir(fullPath)
        } else {
          const ext = path.extname(entry.name).toLowerCase()

          if (codeExtensions.includes(ext)) {
            try {
              const content = await fs.readFile(fullPath, 'utf-8')
              const lines = content.split('\n').length

              if (lines > maxLines) {
                let type = 'file'

                // Try to detect component type
                if (ext === '.tsx' || ext === '.jsx') {
                  type = 'React Component'
                } else if (ext === '.vue') {
                  type = 'Vue Component'
                } else if (ext === '.svelte') {
                  type = 'Svelte Component'
                } else if (content.includes('class ') && content.includes('def ')) {
                  type = 'Class'
                }

                oversized.push({
                  path: path.relative(repoPath, fullPath),
                  lines,
                  type
                })
              }
            } catch {}
          }
        }
      }
    } catch {}
  }

  await scanDir(repoPath)

  return oversized.sort((a, b) => b.lines - a.lines)
}

// Get file size statistics for a repository
export async function getFileSizeStats(repoPath: string): Promise<{
  totalSize: number
  totalSizeFormatted: string
  fileCount: number
  largestFiles: LargeFile[]
}> {
  let totalSize = 0
  let fileCount = 0
  const files: LargeFile[] = []

  async function scanDir(dir: string) {
    try {
      const entries = await fs.readdir(dir, { withFileTypes: true })

      for (const entry of entries) {
        const fullPath = path.join(dir, entry.name)

        if (['node_modules', '.git', 'vendor', 'deps', '_build', '.bundle'].includes(entry.name)) {
          continue
        }

        if (entry.isDirectory()) {
          await scanDir(fullPath)
        } else {
          try {
            const stats = await fs.stat(fullPath)
            totalSize += stats.size
            fileCount++

            files.push({
              path: path.relative(repoPath, fullPath),
              size: stats.size,
              sizeFormatted: formatSize(stats.size),
              type: 'current'
            })
          } catch {}
        }
      }
    } catch {}
  }

  await scanDir(repoPath)

  // Sort and get top 20
  files.sort((a, b) => b.size - a.size)

  return {
    totalSize,
    totalSizeFormatted: formatSize(totalSize),
    fileCount,
    largestFiles: files.slice(0, 20)
  }
}

// Generate full cleanup report
export async function generateCleanupReport(repoPath: string): Promise<CleanupReport> {
  const [largeFiles, gitHistoryFiles, oversizedComponents] = await Promise.all([
    findLargeFiles(repoPath, 500 * 1024), // 500KB+
    findGitHistoryBlobs(repoPath, 5 * 1024 * 1024), // 5MB+ in git history
    findOversizedComponents(repoPath, 150)
  ])

  const totalWastedSpace = gitHistoryFiles.reduce((sum, f) => sum + f.size, 0)

  return {
    largeFiles,
    gitHistoryFiles,
    oversizedComponents,
    totalWastedSpace,
    totalWastedSpaceFormatted: formatSize(totalWastedSpace)
  }
}
````

## File: electron/services/fileSystem.ts
````typescript
import fs from 'fs/promises'
import path from 'path'
import { detectLanguages, Language } from './languages'

export interface Repository {
  path: string
  name: string
  languages: Language[]
  hasGit: boolean
  addedAt: string
  exists: boolean
}

export interface FileEntry {
  name: string
  path: string
  isDirectory: boolean
  size?: number
  modified?: string
}

export async function scanRepository(repoPath: string): Promise<Repository> {
  const name = path.basename(repoPath)

  let hasGit = false
  let exists = true

  try {
    await fs.access(repoPath)
  } catch {
    exists = false
  }

  try {
    await fs.access(path.join(repoPath, '.git'))
    hasGit = true
  } catch {}

  const languages = exists ? await detectLanguages(repoPath) : []

  return {
    path: repoPath,
    name,
    languages,
    hasGit,
    addedAt: new Date().toISOString(),
    exists
  }
}

export async function checkRepositoryExists(repoPath: string): Promise<boolean> {
  try {
    await fs.access(repoPath)
    return true
  } catch {
    return false
  }
}

export async function validateRepositories(repos: Repository[]): Promise<Repository[]> {
  const validated: Repository[] = []

  for (const repo of repos) {
    const exists = await checkRepositoryExists(repo.path)
    validated.push({ ...repo, exists })
  }

  return validated
}

export async function cleanupMissingRepositories(repos: Repository[]): Promise<Repository[]> {
  const validated = await validateRepositories(repos)
  return validated.filter(r => r.exists)
}

export async function readDirectory(dirPath: string): Promise<FileEntry[]> {
  const entries = await fs.readdir(dirPath, { withFileTypes: true })

  const files: FileEntry[] = []

  for (const entry of entries) {
    // Skip hidden files and node_modules
    if (entry.name.startsWith('.') || entry.name === 'node_modules') {
      continue
    }

    const fullPath = path.join(dirPath, entry.name)

    try {
      const stats = await fs.stat(fullPath)

      files.push({
        name: entry.name,
        path: fullPath,
        isDirectory: entry.isDirectory(),
        size: entry.isDirectory() ? undefined : stats.size,
        modified: stats.mtime.toISOString()
      })
    } catch {
      // Skip files we can't access
    }
  }

  // Sort: directories first, then alphabetically
  return files.sort((a, b) => {
    if (a.isDirectory && !b.isDirectory) return -1
    if (!a.isDirectory && b.isDirectory) return 1
    return a.name.localeCompare(b.name)
  })
}

export async function readFile(filePath: string): Promise<string> {
  const content = await fs.readFile(filePath, 'utf-8')
  return content
}

// Get total size of a directory (excluding node_modules, .git, etc.)
export async function getDirectorySize(dirPath: string): Promise<number> {
  let totalSize = 0

  async function scanDir(dir: string) {
    try {
      const entries = await fs.readdir(dir, { withFileTypes: true })

      for (const entry of entries) {
        if (['node_modules', '.git', 'vendor', 'deps', '_build'].includes(entry.name)) {
          continue
        }

        const fullPath = path.join(dir, entry.name)

        if (entry.isDirectory()) {
          await scanDir(fullPath)
        } else {
          try {
            const stats = await fs.stat(fullPath)
            totalSize += stats.size
          } catch {}
        }
      }
    } catch {}
  }

  await scanDir(dirPath)
  return totalSize
}
````

## File: electron/services/languages.ts
````typescript
import { exec } from 'child_process'
import { promisify } from 'util'
import fs from 'fs/promises'
import path from 'path'

const execAsync = promisify(exec)

export type Language = 'javascript' | 'python' | 'ruby' | 'elixir' | 'unknown'

export interface LanguageInfo {
  language: Language
  packageManager: string
  lockFile: string | null
  configFile: string
}

export interface OutdatedPackage {
  name: string
  current: string
  wanted: string
  latest: string
  type: 'dependencies' | 'devDependencies'
  hasPatchUpdate: boolean
  language: Language
}

const LANGUAGE_CONFIG: Record<Language, LanguageInfo> = {
  javascript: {
    language: 'javascript',
    packageManager: 'npm',
    lockFile: 'package-lock.json',
    configFile: 'package.json'
  },
  python: {
    language: 'python',
    packageManager: 'pip',
    lockFile: null,
    configFile: 'requirements.txt'
  },
  ruby: {
    language: 'ruby',
    packageManager: 'bundler',
    lockFile: 'Gemfile.lock',
    configFile: 'Gemfile'
  },
  elixir: {
    language: 'elixir',
    packageManager: 'mix',
    lockFile: 'mix.lock',
    configFile: 'mix.exs'
  },
  unknown: {
    language: 'unknown',
    packageManager: '',
    lockFile: null,
    configFile: ''
  }
}

export async function detectLanguages(repoPath: string): Promise<Language[]> {
  const languages: Language[] = []

  const checks = [
    { file: 'package.json', lang: 'javascript' as Language },
    { file: 'requirements.txt', lang: 'python' as Language },
    { file: 'Pipfile', lang: 'python' as Language },
    { file: 'pyproject.toml', lang: 'python' as Language },
    { file: 'Gemfile', lang: 'ruby' as Language },
    { file: 'mix.exs', lang: 'elixir' as Language }
  ]

  for (const check of checks) {
    try {
      await fs.access(path.join(repoPath, check.file))
      if (!languages.includes(check.lang)) {
        languages.push(check.lang)
      }
    } catch {}
  }

  return languages
}

export function getLanguageConfig(lang: Language): LanguageInfo {
  return LANGUAGE_CONFIG[lang]
}

// Python: Parse requirements.txt and get outdated packages
export async function getPythonOutdated(repoPath: string): Promise<OutdatedPackage[]> {
  const packages: OutdatedPackage[] = []

  try {
    // Check for requirements.txt
    const reqPath = path.join(repoPath, 'requirements.txt')
    const content = await fs.readFile(reqPath, 'utf-8')

    // Parse requirements.txt
    const lines = content.split('\n').filter(l => l.trim() && !l.startsWith('#'))
    const installed: Map<string, string> = new Map()

    for (const line of lines) {
      const match = line.match(/^([a-zA-Z0-9_-]+)==([0-9.]+)/)
      if (match) {
        installed.set(match[1].toLowerCase(), match[2])
      }
    }

    // Get outdated packages using pip
    try {
      const { stdout } = await execAsync('pip list --outdated --format=json', {
        cwd: repoPath,
        timeout: 60000
      })

      const outdated = JSON.parse(stdout || '[]')

      for (const pkg of outdated) {
        const name = pkg.name.toLowerCase()
        if (installed.has(name)) {
          const current = pkg.version
          const latest = pkg.latest_version

          // Parse versions for patch detection
          const currentParts = current.split('.').map(Number)
          const latestParts = latest.split('.').map(Number)

          const hasPatchUpdate =
            currentParts[0] === latestParts[0] &&
            currentParts[1] === latestParts[1] &&
            (currentParts[2] || 0) < (latestParts[2] || 0)

          packages.push({
            name: pkg.name,
            current,
            wanted: latest,
            latest,
            type: 'dependencies',
            hasPatchUpdate,
            language: 'python'
          })
        }
      }
    } catch (e) {
      console.error('pip list failed:', e)
    }
  } catch {}

  return packages
}

// Ruby: Parse Gemfile.lock and get outdated gems
export async function getRubyOutdated(repoPath: string): Promise<OutdatedPackage[]> {
  const packages: OutdatedPackage[] = []

  try {
    await fs.access(path.join(repoPath, 'Gemfile'))

    // Run bundle outdated
    try {
      const { stdout } = await execAsync('bundle outdated --parseable', {
        cwd: repoPath,
        timeout: 120000
      })

      // Parse output: gem_name (newest x.x.x, installed x.x.x)
      const lines = stdout.split('\n').filter(l => l.trim())

      for (const line of lines) {
        const match = line.match(/^(\S+)\s+\(newest\s+([0-9.]+),\s+installed\s+([0-9.]+)/)
        if (match) {
          const [, name, latest, current] = match

          const currentParts = current.split('.').map(Number)
          const latestParts = latest.split('.').map(Number)

          const hasPatchUpdate =
            currentParts[0] === latestParts[0] &&
            currentParts[1] === latestParts[1] &&
            (currentParts[2] || 0) < (latestParts[2] || 0)

          packages.push({
            name,
            current,
            wanted: latest,
            latest,
            type: 'dependencies',
            hasPatchUpdate,
            language: 'ruby'
          })
        }
      }
    } catch (e: any) {
      // bundle outdated exits with 1 when there are outdated gems
      if (e.stdout) {
        const lines = e.stdout.split('\n').filter((l: string) => l.trim())
        for (const line of lines) {
          const match = line.match(/^(\S+)\s+\(newest\s+([0-9.]+),\s+installed\s+([0-9.]+)/)
          if (match) {
            const [, name, latest, current] = match
            const currentParts = current.split('.').map(Number)
            const latestParts = latest.split('.').map(Number)
            const hasPatchUpdate =
              currentParts[0] === latestParts[0] &&
              currentParts[1] === latestParts[1] &&
              (currentParts[2] || 0) < (latestParts[2] || 0)

            packages.push({
              name,
              current,
              wanted: latest,
              latest,
              type: 'dependencies',
              hasPatchUpdate,
              language: 'ruby'
            })
          }
        }
      }
    }
  } catch {}

  return packages
}

// Elixir: Parse mix.lock and get outdated deps
export async function getElixirOutdated(repoPath: string): Promise<OutdatedPackage[]> {
  const packages: OutdatedPackage[] = []

  try {
    await fs.access(path.join(repoPath, 'mix.exs'))

    // Run mix hex.outdated
    try {
      const { stdout } = await execAsync('mix hex.outdated', {
        cwd: repoPath,
        timeout: 120000
      })

      // Parse output
      const lines = stdout.split('\n').filter(l => l.trim())

      for (const line of lines) {
        // Format: dependency    current  latest
        const match = line.match(/^(\S+)\s+([0-9.]+)\s+([0-9.]+)/)
        if (match) {
          const [, name, current, latest] = match

          const currentParts = current.split('.').map(Number)
          const latestParts = latest.split('.').map(Number)

          const hasPatchUpdate =
            currentParts[0] === latestParts[0] &&
            currentParts[1] === latestParts[1] &&
            (currentParts[2] || 0) < (latestParts[2] || 0)

          packages.push({
            name,
            current,
            wanted: latest,
            latest,
            type: 'dependencies',
            hasPatchUpdate,
            language: 'elixir'
          })
        }
      }
    } catch (e) {
      console.error('mix hex.outdated failed:', e)
    }
  } catch {}

  return packages
}

// Update functions for each language
export async function updatePythonPackages(repoPath: string, packages: string[]): Promise<{ updated: string[], failed: string[] }> {
  const updated: string[] = []
  const failed: string[] = []

  const reqPath = path.join(repoPath, 'requirements.txt')

  try {
    let content = await fs.readFile(reqPath, 'utf-8')

    for (const pkg of packages) {
      try {
        // Update single package
        await execAsync(`pip install --upgrade ${pkg}`, { cwd: repoPath, timeout: 60000 })

        // Get new version
        const { stdout } = await execAsync(`pip show ${pkg} | grep Version`, { cwd: repoPath })
        const version = stdout.match(/Version:\s*([0-9.]+)/)?.[1]

        if (version) {
          // Update requirements.txt
          const regex = new RegExp(`^${pkg}==.+$`, 'mi')
          content = content.replace(regex, `${pkg}==${version}`)
          updated.push(pkg)
        }
      } catch {
        failed.push(pkg)
      }
    }

    await fs.writeFile(reqPath, content)
  } catch (e) {
    console.error('Python update failed:', e)
  }

  return { updated, failed }
}

export async function updateRubyPackages(repoPath: string, packages: string[]): Promise<{ updated: string[], failed: string[] }> {
  const updated: string[] = []
  const failed: string[] = []

  for (const pkg of packages) {
    try {
      await execAsync(`bundle update ${pkg} --patch`, { cwd: repoPath, timeout: 120000 })
      updated.push(pkg)
    } catch {
      failed.push(pkg)
    }
  }

  return { updated, failed }
}

export async function updateElixirPackages(repoPath: string, packages: string[]): Promise<{ updated: string[], failed: string[] }> {
  const updated: string[] = []
  const failed: string[] = []

  for (const pkg of packages) {
    try {
      await execAsync(`mix deps.update ${pkg}`, { cwd: repoPath, timeout: 120000 })
      updated.push(pkg)
    } catch {
      failed.push(pkg)
    }
  }

  return { updated, failed }
}

// Get clean install command for language
export function getCleanInstallCommand(lang: Language): string {
  switch (lang) {
    case 'javascript':
      return 'rm -rf node_modules package-lock.json && npm install && npm update && rm -rf node_modules package-lock.json && npm install'
    case 'python':
      return 'pip install -r requirements.txt --upgrade'
    case 'ruby':
      return 'rm -rf .bundle vendor/bundle && bundle install'
    case 'elixir':
      return 'rm -rf deps _build && mix deps.get && mix compile'
    default:
      return ''
  }
}

// Get test command for language
export function getTestCommand(lang: Language): string | null {
  switch (lang) {
    case 'javascript':
      return 'npm test'
    case 'python':
      return 'pytest || python -m pytest || python -m unittest discover'
    case 'ruby':
      return 'bundle exec rspec || bundle exec rake test'
    case 'elixir':
      return 'mix test'
    default:
      return null
  }
}

// Get lint command for language
export function getLintCommand(lang: Language): string | null {
  switch (lang) {
    case 'javascript':
      return 'npm run lint || npx eslint .'
    case 'python':
      return 'flake8 || pylint . || ruff check .'
    case 'ruby':
      return 'bundle exec rubocop'
    case 'elixir':
      return 'mix credo'
    default:
      return null
  }
}

// Get files to commit after update
export function getFilesToCommit(lang: Language): string[] {
  switch (lang) {
    case 'javascript':
      return ['package.json', 'package-lock.json']
    case 'python':
      return ['requirements.txt', 'Pipfile.lock', 'poetry.lock']
    case 'ruby':
      return ['Gemfile', 'Gemfile.lock']
    case 'elixir':
      return ['mix.exs', 'mix.lock']
    default:
      return []
  }
}
````

## File: electron/services/patchBatch.ts
````typescript
import { exec } from 'child_process'
import { promisify } from 'util'
import fs from 'fs/promises'
import path from 'path'
import * as semver from 'semver'

const execAsync = promisify(exec)

export interface OutdatedPackage {
  name: string
  current: string
  wanted: string
  latest: string
  type: 'dependencies' | 'devDependencies'
  hasPatchUpdate: boolean
}

export interface PatchBatchResult {
  updated: string[]
  failed: string[]
}

export async function getOutdatedPackages(repoPath: string): Promise<OutdatedPackage[]> {
  try {
    // Read package.json to know which are dev dependencies
    const packageJsonPath = path.join(repoPath, 'package.json')
    const packageJsonContent = await fs.readFile(packageJsonPath, 'utf-8')
    const packageJson = JSON.parse(packageJsonContent)

    const devDeps = new Set(Object.keys(packageJson.devDependencies || {}))

    // Run npm outdated
    let outdatedJson: string
    try {
      const { stdout } = await execAsync('npm outdated --json', { cwd: repoPath })
      outdatedJson = stdout
    } catch (error: any) {
      // npm outdated exits with code 1 when there are outdated packages
      outdatedJson = error.stdout || '{}'
    }

    const outdated = JSON.parse(outdatedJson || '{}')

    const packages: OutdatedPackage[] = []

    for (const [name, info] of Object.entries(outdated) as [string, any][]) {
      const current = info.current || '0.0.0'
      const wanted = info.wanted || current
      const latest = info.latest || wanted

      // Check if there's a patch update available
      const currentParsed = semver.parse(current)
      const wantedParsed = semver.parse(wanted)

      let hasPatchUpdate = false
      if (currentParsed && wantedParsed) {
        hasPatchUpdate = currentParsed.major === wantedParsed.major &&
                         currentParsed.minor === wantedParsed.minor &&
                         currentParsed.patch < wantedParsed.patch
      }

      packages.push({
        name,
        current,
        wanted,
        latest,
        type: devDeps.has(name) ? 'devDependencies' : 'dependencies',
        hasPatchUpdate
      })
    }

    // Sort: packages with patch updates first
    return packages.sort((a, b) => {
      if (a.hasPatchUpdate && !b.hasPatchUpdate) return -1
      if (!a.hasPatchUpdate && b.hasPatchUpdate) return 1
      return a.name.localeCompare(b.name)
    })
  } catch (error) {
    console.error('Error getting outdated packages:', error)
    return []
  }
}

export async function runPatchBatch(
  repoPath: string,
  packages: string[]
): Promise<PatchBatchResult> {
  const updated: string[] = []
  const failed: string[] = []

  // Read current package.json
  const packageJsonPath = path.join(repoPath, 'package.json')
  const packageJsonContent = await fs.readFile(packageJsonPath, 'utf-8')
  const packageJson = JSON.parse(packageJsonContent)

  // Get current versions of requested packages
  const outdated = await getOutdatedPackages(repoPath)
  const outdatedMap = new Map(outdated.map(p => [p.name, p]))

  // Update package.json with patch versions
  for (const pkgName of packages) {
    const pkg = outdatedMap.get(pkgName)
    if (!pkg || !pkg.hasPatchUpdate) {
      failed.push(pkgName)
      continue
    }

    // Update the version in package.json
    if (packageJson.dependencies?.[pkgName]) {
      // Preserve the version prefix (^, ~, etc)
      const currentVersion = packageJson.dependencies[pkgName]
      const prefix = currentVersion.match(/^[^0-9]*/)?.[0] || '^'
      packageJson.dependencies[pkgName] = `${prefix}${pkg.wanted}`
      updated.push(pkgName)
    } else if (packageJson.devDependencies?.[pkgName]) {
      const currentVersion = packageJson.devDependencies[pkgName]
      const prefix = currentVersion.match(/^[^0-9]*/)?.[0] || '^'
      packageJson.devDependencies[pkgName] = `${prefix}${pkg.wanted}`
      updated.push(pkgName)
    } else {
      failed.push(pkgName)
    }
  }

  // Write updated package.json
  await fs.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2) + '\n')

  // Run the clean install script
  const cleanInstallScript = 'rm -rf node_modules package-lock.json && npm install && npm update && rm -rf node_modules package-lock.json && npm install'

  try {
    await execAsync(cleanInstallScript, {
      cwd: repoPath,
      timeout: 300000 // 5 minute timeout
    })
  } catch (error) {
    console.error('Clean install failed:', error)
    throw new Error('Clean install script failed')
  }

  return { updated, failed }
}
````

## File: electron/services/scheduler.ts
````typescript
import Store from 'electron-store'
import { BrowserWindow } from 'electron'

const store = new Store()

export type ScheduleFrequency = 'daily' | 'weekly' | 'monthly'

export interface ScheduledJob {
  id: string
  repoPath: string
  repoName: string
  frequency: ScheduleFrequency
  enabled: boolean
  lastRun: string | null
  nextRun: string
  language: string
  createPR: boolean
  runTests: boolean
  createdAt: string
}

export interface JobResult {
  jobId: string
  success: boolean
  timestamp: string
  updatedPackages: string[]
  prUrl?: string
  error?: string
  testsPassed?: boolean
}

const JOBS_KEY = 'scheduled-jobs'
const RESULTS_KEY = 'job-results'

// Timer references for cleanup
const jobTimers: Map<string, NodeJS.Timeout> = new Map()

export function getScheduledJobs(): ScheduledJob[] {
  return store.get(JOBS_KEY, []) as ScheduledJob[]
}

export function saveScheduledJobs(jobs: ScheduledJob[]): void {
  store.set(JOBS_KEY, jobs)
}

export function addScheduledJob(job: Omit<ScheduledJob, 'id' | 'createdAt' | 'lastRun' | 'nextRun'>): ScheduledJob {
  const jobs = getScheduledJobs()

  const newJob: ScheduledJob = {
    ...job,
    id: `job-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    createdAt: new Date().toISOString(),
    lastRun: null,
    nextRun: calculateNextRun(job.frequency)
  }

  jobs.push(newJob)
  saveScheduledJobs(jobs)

  // Start timer for this job
  scheduleJobTimer(newJob)

  return newJob
}

export function updateScheduledJob(jobId: string, updates: Partial<ScheduledJob>): ScheduledJob | null {
  const jobs = getScheduledJobs()
  const index = jobs.findIndex(j => j.id === jobId)

  if (index === -1) return null

  jobs[index] = { ...jobs[index], ...updates }

  if (updates.frequency) {
    jobs[index].nextRun = calculateNextRun(updates.frequency)
  }

  saveScheduledJobs(jobs)

  // Reschedule timer
  clearJobTimer(jobId)
  if (jobs[index].enabled) {
    scheduleJobTimer(jobs[index])
  }

  return jobs[index]
}

export function deleteScheduledJob(jobId: string): boolean {
  const jobs = getScheduledJobs()
  const filtered = jobs.filter(j => j.id !== jobId)

  if (filtered.length === jobs.length) return false

  saveScheduledJobs(filtered)
  clearJobTimer(jobId)

  return true
}

export function getJobResults(jobId?: string): JobResult[] {
  const results = store.get(RESULTS_KEY, []) as JobResult[]

  if (jobId) {
    return results.filter(r => r.jobId === jobId)
  }

  return results
}

export function addJobResult(result: JobResult): void {
  const results = getJobResults()
  results.unshift(result)

  // Keep only last 100 results
  if (results.length > 100) {
    results.splice(100)
  }

  store.set(RESULTS_KEY, results)
}

function calculateNextRun(frequency: ScheduleFrequency): string {
  const now = new Date()
  let next: Date

  switch (frequency) {
    case 'daily':
      next = new Date(now.getTime() + 24 * 60 * 60 * 1000)
      next.setHours(3, 0, 0, 0) // 3 AM
      break
    case 'weekly':
      next = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000)
      next.setHours(3, 0, 0, 0)
      break
    case 'monthly':
      next = new Date(now.getFullYear(), now.getMonth() + 1, 1, 3, 0, 0, 0)
      break
  }

  return next.toISOString()
}

function scheduleJobTimer(job: ScheduledJob): void {
  if (!job.enabled) return

  const nextRun = new Date(job.nextRun)
  const now = new Date()
  const delay = Math.max(0, nextRun.getTime() - now.getTime())

  // Don't schedule if more than 24 hours away (will reschedule on app restart)
  if (delay > 24 * 60 * 60 * 1000) {
    return
  }

  const timer = setTimeout(() => {
    executeJob(job.id)
  }, delay)

  jobTimers.set(job.id, timer)
}

function clearJobTimer(jobId: string): void {
  const timer = jobTimers.get(jobId)
  if (timer) {
    clearTimeout(timer)
    jobTimers.delete(jobId)
  }
}

// Called on app startup to initialize all job timers
export function initializeScheduler(): void {
  const jobs = getScheduledJobs()

  for (const job of jobs) {
    if (job.enabled) {
      // Check if job was missed and should run now
      const nextRun = new Date(job.nextRun)
      const now = new Date()

      if (nextRun < now) {
        // Missed job - run it now
        setTimeout(() => executeJob(job.id), 5000)
      } else {
        scheduleJobTimer(job)
      }
    }
  }
}

// Main job execution function
async function executeJob(jobId: string): Promise<void> {
  const jobs = getScheduledJobs()
  const job = jobs.find(j => j.id === jobId)

  if (!job || !job.enabled) return

  // Notify renderer that job is starting
  const windows = BrowserWindow.getAllWindows()
  for (const win of windows) {
    win.webContents.send('scheduler-job-started', { jobId, repoName: job.repoName })
  }

  // The actual job execution will be handled by the main process
  // This is a placeholder that will be called from main.ts
  for (const win of windows) {
    win.webContents.send('scheduler-execute-job', job)
  }

  // Update job with new next run time
  const index = jobs.findIndex(j => j.id === jobId)
  if (index !== -1) {
    jobs[index].lastRun = new Date().toISOString()
    jobs[index].nextRun = calculateNextRun(job.frequency)
    saveScheduledJobs(jobs)

    // Schedule next run
    scheduleJobTimer(jobs[index])
  }
}

// Check if any jobs are due (called periodically)
export function checkDueJobs(): ScheduledJob[] {
  const jobs = getScheduledJobs()
  const now = new Date()
  const dueJobs: ScheduledJob[] = []

  for (const job of jobs) {
    if (job.enabled) {
      const nextRun = new Date(job.nextRun)
      if (nextRun <= now) {
        dueJobs.push(job)
      }
    }
  }

  return dueJobs
}

// Get next scheduled job
export function getNextScheduledJob(): ScheduledJob | null {
  const jobs = getScheduledJobs().filter(j => j.enabled)

  if (jobs.length === 0) return null

  jobs.sort((a, b) => new Date(a.nextRun).getTime() - new Date(b.nextRun).getTime())

  return jobs[0]
}

// Cleanup on app quit
export function cleanupScheduler(): void {
  for (const timer of jobTimers.values()) {
    clearTimeout(timer)
  }
  jobTimers.clear()
}
````

## File: electron/services/securityScanner.ts
````typescript
import { exec, spawn, ChildProcess } from 'child_process'
import { promisify } from 'util'
import path from 'path'
import fs from 'fs/promises'

const execAsync = promisify(exec)

export interface SecurityFinding {
  file: string
  line: number
  issue: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  code: string
  description: string
  cwe: string
  owasp: string
  solution?: string
  fixedCode?: string
}

export interface ScanResult {
  scanId: string
  repoPath: string
  totalFindings: number
  criticalCount: number
  highCount: number
  mediumCount: number
  lowCount: number
  findings: SecurityFinding[]
  scannedAt: string
  duration: number
}

export interface ScanProgress {
  status: 'scanning' | 'analyzing' | 'generating-fixes' | 'complete' | 'error'
  progress: number
  message: string
  currentFile?: string
}

// Path to the agentic_fixer module
const AGENTIC_FIXER_PATH = path.join(__dirname, '../../agentic_fixer')

let pythonProcess: ChildProcess | null = null

export async function checkAgenticFixerAvailable(): Promise<boolean> {
  try {
    await fs.access(AGENTIC_FIXER_PATH)
    // Check if Python and required modules are available
    await execAsync('python3 -c "import flask"', { timeout: 5000 })
    return true
  } catch {
    return false
  }
}

export async function runSecurityScan(
  repoPath: string,
  onProgress?: (progress: ScanProgress) => void
): Promise<ScanResult> {
  const scanId = `scan-${Date.now()}`
  const startTime = Date.now()

  onProgress?.({
    status: 'scanning',
    progress: 0,
    message: 'Initializing security scan...'
  })

  try {
    // Check if agentic_fixer is available
    const available = await checkAgenticFixerAvailable()

    if (!available) {
      // Fall back to basic pattern detection
      return await runBasicSecurityScan(repoPath, scanId, onProgress)
    }

    // Run the Python security scanner
    return await runPythonSecurityScan(repoPath, scanId, startTime, onProgress)
  } catch (error) {
    console.error('Security scan failed:', error)
    throw error
  }
}

async function runPythonSecurityScan(
  repoPath: string,
  scanId: string,
  startTime: number,
  onProgress?: (progress: ScanProgress) => void
): Promise<ScanResult> {
  return new Promise((resolve, reject) => {
    const pythonScript = `
import sys
import json
sys.path.insert(0, '${AGENTIC_FIXER_PATH}')

from code_security_auto_fixer import repo_scanner, language_detector, pattern_detector

try:
    repo_path = '${repoPath.replace(/'/g, "\\'")}'

    # Detect languages
    languages = language_detector.detect(repo_path)
    print(json.dumps({'type': 'progress', 'status': 'scanning', 'progress': 20, 'message': f'Detected languages: {", ".join(languages)}'}))
    sys.stdout.flush()

    # Scan for patterns
    print(json.dumps({'type': 'progress', 'status': 'analyzing', 'progress': 40, 'message': 'Analyzing code patterns...'}))
    sys.stdout.flush()

    findings = pattern_detector.scan(repo_path, languages)

    print(json.dumps({'type': 'progress', 'status': 'complete', 'progress': 100, 'message': f'Found {len(findings)} security issues'}))
    sys.stdout.flush()

    # Output results
    result = {
        'type': 'result',
        'findings': findings
    }
    print(json.dumps(result))
    sys.stdout.flush()

except Exception as e:
    print(json.dumps({'type': 'error', 'message': str(e)}))
    sys.stdout.flush()
    sys.exit(1)
`

    const python = spawn('python3', ['-c', pythonScript], {
      cwd: AGENTIC_FIXER_PATH,
      env: { ...process.env, PYTHONUNBUFFERED: '1' }
    })

    let output = ''
    let findings: SecurityFinding[] = []

    python.stdout.on('data', (data) => {
      const lines = data.toString().split('\n').filter((l: string) => l.trim())

      for (const line of lines) {
        try {
          const parsed = JSON.parse(line)

          if (parsed.type === 'progress') {
            onProgress?.({
              status: parsed.status,
              progress: parsed.progress,
              message: parsed.message
            })
          } else if (parsed.type === 'result') {
            findings = parsed.findings.map((f: any) => ({
              file: f.file,
              line: f.line,
              issue: f.issue,
              severity: normalizeSeverity(f.severity),
              code: f.code,
              description: f.description || f.issue,
              cwe: f.cwe || 'CWE-Unknown',
              owasp: f.owasp || 'Unknown',
              solution: f.solution
            }))
          } else if (parsed.type === 'error') {
            reject(new Error(parsed.message))
          }
        } catch {
          output += line
        }
      }
    })

    python.stderr.on('data', (data) => {
      console.error('Python stderr:', data.toString())
    })

    python.on('close', (code) => {
      if (code === 0 || findings.length > 0) {
        const result: ScanResult = {
          scanId,
          repoPath,
          totalFindings: findings.length,
          criticalCount: findings.filter(f => f.severity === 'critical').length,
          highCount: findings.filter(f => f.severity === 'high').length,
          mediumCount: findings.filter(f => f.severity === 'medium').length,
          lowCount: findings.filter(f => f.severity === 'low').length,
          findings,
          scannedAt: new Date().toISOString(),
          duration: Date.now() - startTime
        }
        resolve(result)
      } else {
        reject(new Error('Security scan failed'))
      }
    })

    python.on('error', (error) => {
      reject(error)
    })
  })
}

// Basic pattern-based security scan (fallback when Python is not available)
async function runBasicSecurityScan(
  repoPath: string,
  scanId: string,
  onProgress?: (progress: ScanProgress) => void
): Promise<ScanResult> {
  const startTime = Date.now()
  const findings: SecurityFinding[] = []

  // Security patterns to detect
  const patterns: { pattern: RegExp; issue: string; severity: 'critical' | 'high' | 'medium' | 'low'; cwe: string; owasp: string }[] = [
    // SQL Injection
    { pattern: /execute\s*\(\s*['"`].*\$|%s|{.*}.*['"`]/i, issue: 'sql-injection', severity: 'critical', cwe: 'CWE-89', owasp: 'A03:2021' },
    { pattern: /query\s*\(\s*['"`].*\+.*['"`]/i, issue: 'sql-injection', severity: 'critical', cwe: 'CWE-89', owasp: 'A03:2021' },

    // XSS
    { pattern: /innerHTML\s*=|document\.write\s*\(/i, issue: 'xss', severity: 'high', cwe: 'CWE-79', owasp: 'A03:2021' },
    { pattern: /dangerouslySetInnerHTML/i, issue: 'xss', severity: 'medium', cwe: 'CWE-79', owasp: 'A03:2021' },

    // Command Injection
    { pattern: /exec\s*\(|system\s*\(|shell_exec\s*\(/i, issue: 'command-injection', severity: 'critical', cwe: 'CWE-78', owasp: 'A03:2021' },
    { pattern: /subprocess\.call.*shell\s*=\s*True/i, issue: 'command-injection', severity: 'critical', cwe: 'CWE-78', owasp: 'A03:2021' },

    // Hardcoded Secrets
    { pattern: /password\s*=\s*['"][^'"]+['"]/i, issue: 'hardcoded-secret', severity: 'high', cwe: 'CWE-798', owasp: 'A07:2021' },
    { pattern: /api[_-]?key\s*=\s*['"][^'"]+['"]/i, issue: 'hardcoded-secret', severity: 'high', cwe: 'CWE-798', owasp: 'A07:2021' },
    { pattern: /secret\s*=\s*['"][^'"]+['"]/i, issue: 'hardcoded-secret', severity: 'high', cwe: 'CWE-798', owasp: 'A07:2021' },

    // Path Traversal
    { pattern: /\.\.\/|\.\.\\|path\.join.*\.\./i, issue: 'path-traversal', severity: 'high', cwe: 'CWE-22', owasp: 'A01:2021' },

    // Insecure Deserialization
    { pattern: /pickle\.loads|yaml\.load\s*\([^,)]+\)/i, issue: 'insecure-deserialization', severity: 'critical', cwe: 'CWE-502', owasp: 'A08:2021' },
    { pattern: /eval\s*\(|Function\s*\(/i, issue: 'code-injection', severity: 'critical', cwe: 'CWE-94', owasp: 'A03:2021' },

    // Weak Crypto
    { pattern: /md5\s*\(|sha1\s*\(/i, issue: 'weak-crypto', severity: 'medium', cwe: 'CWE-327', owasp: 'A02:2021' },

    // SSRF
    { pattern: /requests\.get\s*\(.*request\.|fetch\s*\(.*req\./i, issue: 'ssrf', severity: 'high', cwe: 'CWE-918', owasp: 'A10:2021' }
  ]

  const codeExtensions = ['.js', '.jsx', '.ts', '.tsx', '.py', '.rb', '.php', '.java', '.go', '.rs', '.c', '.cpp']

  async function scanDir(dir: string) {
    try {
      const entries = await fs.readdir(dir, { withFileTypes: true })

      for (const entry of entries) {
        if (['node_modules', '.git', 'vendor', 'deps', '_build', '__pycache__', 'venv', '.venv'].includes(entry.name)) {
          continue
        }

        const fullPath = path.join(dir, entry.name)

        if (entry.isDirectory()) {
          await scanDir(fullPath)
        } else {
          const ext = path.extname(entry.name).toLowerCase()
          if (codeExtensions.includes(ext)) {
            try {
              const content = await fs.readFile(fullPath, 'utf-8')
              const lines = content.split('\n')
              const relPath = path.relative(repoPath, fullPath)

              for (let i = 0; i < lines.length; i++) {
                const line = lines[i]

                for (const { pattern, issue, severity, cwe, owasp } of patterns) {
                  if (pattern.test(line)) {
                    findings.push({
                      file: relPath,
                      line: i + 1,
                      issue,
                      severity,
                      code: line.trim(),
                      description: `Potential ${issue.replace(/-/g, ' ')} vulnerability detected`,
                      cwe,
                      owasp
                    })
                  }
                }
              }
            } catch {}
          }
        }
      }
    } catch {}
  }

  onProgress?.({ status: 'scanning', progress: 10, message: 'Scanning files...' })
  await scanDir(repoPath)

  onProgress?.({ status: 'complete', progress: 100, message: `Found ${findings.length} security issues` })

  return {
    scanId,
    repoPath,
    totalFindings: findings.length,
    criticalCount: findings.filter(f => f.severity === 'critical').length,
    highCount: findings.filter(f => f.severity === 'high').length,
    mediumCount: findings.filter(f => f.severity === 'medium').length,
    lowCount: findings.filter(f => f.severity === 'low').length,
    findings,
    scannedAt: new Date().toISOString(),
    duration: Date.now() - startTime
  }
}

function normalizeSeverity(severity: string): 'critical' | 'high' | 'medium' | 'low' {
  const s = severity.toLowerCase()
  if (s === 'critical' || s === 'error') return 'critical'
  if (s === 'high' || s === 'warning') return 'high'
  if (s === 'medium' || s === 'info') return 'medium'
  return 'low'
}

export async function generateSecurityFix(finding: SecurityFinding): Promise<string | null> {
  // Try to use the AI fixer from agentic_fixer if available
  const available = await checkAgenticFixerAvailable()

  if (!available) {
    return null
  }

  return new Promise((resolve) => {
    const pythonScript = `
import sys
import json
sys.path.insert(0, '${AGENTIC_FIXER_PATH}')

try:
    from code_security_auto_fixer.ai_fixer import AIFixer
    from code_security_auto_fixer.config import (
        GEMINI_API_BASE_URL, GEMINI_MODEL_NAME, GEMINI_API_KEY,
        GEMINI_ACCESS_TOKEN, GEMINI_TEMPERATURE, GEMINI_MAX_OUTPUT_TOKENS, GEMINI_CANDIDATE_COUNT
    )

    fixer = AIFixer(
        api_base_url=GEMINI_API_BASE_URL,
        model_name=GEMINI_MODEL_NAME,
        api_key=GEMINI_API_KEY,
        access_token=GEMINI_ACCESS_TOKEN,
        temperature=GEMINI_TEMPERATURE,
        max_output_tokens=GEMINI_MAX_OUTPUT_TOKENS,
        candidate_count=GEMINI_CANDIDATE_COUNT
    )

    issue_data = ${JSON.stringify(finding)}
    result = fixer.generate_secure_solution(issue_data)
    print(json.dumps({'success': True, 'fix': result.get('fixed_code', '')}))
except Exception as e:
    print(json.dumps({'success': False, 'error': str(e)}))
`

    const python = spawn('python3', ['-c', pythonScript], {
      cwd: AGENTIC_FIXER_PATH
    })

    let output = ''

    python.stdout.on('data', (data) => {
      output += data.toString()
    })

    python.on('close', () => {
      try {
        const result = JSON.parse(output.trim())
        if (result.success) {
          resolve(result.fix)
        } else {
          resolve(null)
        }
      } catch {
        resolve(null)
      }
    })

    python.on('error', () => {
      resolve(null)
    })
  })
}
````

## File: electron/main.ts
````typescript
import { app, BrowserWindow, ipcMain, dialog } from 'electron'
import path from 'path'
import Store from 'electron-store'
import { scanRepository, readDirectory, readFile, validateRepositories, cleanupMissingRepositories } from './services/fileSystem'
import { getFileSizeStats, generateCleanupReport } from './services/analysis'
import {
  detectLanguages,
  getPythonOutdated,
  getRubyOutdated,
  getElixirOutdated,
  updatePythonPackages,
  updateRubyPackages,
  updateElixirPackages,
  getCleanInstallCommand,
  getTestCommand,
  getLintCommand,
  getFilesToCommit,
  Language
} from './services/languages'
import {
  getScheduledJobs,
  addScheduledJob,
  updateScheduledJob,
  deleteScheduledJob,
  getJobResults,
  addJobResult,
  initializeScheduler,
  cleanupScheduler,
  ScheduledJob
} from './services/scheduler'
import {
  createBranch,
  commitChanges,
  pushBranch,
  createPullRequest,
  getRepoInfo,
  isOnProtectedBranch,
  runTests,
  runLint,
  abortChanges,
  deleteBranch
} from './services/git'
import {
  runSecurityScan,
  generateSecurityFix,
  checkAgenticFixerAvailable
} from './services/securityScanner'
import { exec } from 'child_process'
import { promisify } from 'util'
import fs from 'fs/promises'
import * as semver from 'semver'

const execAsync = promisify(exec)
const store = new Store()

let mainWindow: BrowserWindow | null = null

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    minWidth: 1000,
    minHeight: 700,
    titleBarStyle: 'hiddenInset',
    trafficLightPosition: { x: 20, y: 20 },
    backgroundColor: '#0a0a0a',
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      contextIsolation: true,
      nodeIntegration: false
    }
  })

  // Vite dev server URL - check multiple possible env vars
  const devServerUrl = process.env.VITE_DEV_SERVER_URL ||
                       process.env['VITE_DEV_SERVER_URL'] ||
                       (process.env.NODE_ENV !== 'production' ? 'http://localhost:5173' : null)

  if (devServerUrl) {
    console.log('Loading dev server:', devServerUrl)
    mainWindow.loadURL(devServerUrl)
    mainWindow.webContents.openDevTools()

    // Handle load failures
    mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDesc) => {
      console.error('Failed to load:', errorCode, errorDesc)
      // Retry after a short delay
      setTimeout(() => {
        mainWindow?.loadURL(devServerUrl)
      }, 1000)
    })
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'))
  }
}

app.whenReady().then(() => {
  createWindow()
  initializeScheduler()

  // Validate repos on startup
  setTimeout(async () => {
    const repos = store.get('repositories', []) as any[]
    const cleaned = await cleanupMissingRepositories(repos)
    store.set('repositories', cleaned)
  }, 2000)

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow()
    }
  })
})

app.on('window-all-closed', () => {
  cleanupScheduler()
  if (process.platform !== 'darwin') {
    app.quit()
  }
})

app.on('before-quit', () => {
  cleanupScheduler()
})

// IPC Handlers

// Repository management
ipcMain.handle('select-directory', async () => {
  const result = await dialog.showOpenDialog(mainWindow!, {
    properties: ['openDirectory'],
    title: 'Select Repository'
  })

  if (result.canceled || result.filePaths.length === 0) {
    return null
  }

  return result.filePaths[0]
})

ipcMain.handle('scan-repository', async (_, repoPath: string) => {
  return await scanRepository(repoPath)
})

ipcMain.handle('read-directory', async (_, dirPath: string) => {
  return await readDirectory(dirPath)
})

ipcMain.handle('read-file', async (_, filePath: string) => {
  return await readFile(filePath)
})

ipcMain.handle('detect-languages', async (_, repoPath: string) => {
  return await detectLanguages(repoPath)
})

// Persistence
ipcMain.handle('get-repositories', async () => {
  const repos = store.get('repositories', []) as any[]
  return await validateRepositories(repos)
})

ipcMain.handle('save-repositories', (_, repositories: any[]) => {
  store.set('repositories', repositories)
  return true
})

ipcMain.handle('remove-repository', (_, repoPath: string) => {
  const repos = store.get('repositories', []) as any[]
  const filtered = repos.filter((r: any) => r.path !== repoPath)
  store.set('repositories', filtered)
  return filtered
})

ipcMain.handle('cleanup-missing-repos', async () => {
  const repos = store.get('repositories', []) as any[]
  const cleaned = await cleanupMissingRepositories(repos)
  store.set('repositories', cleaned)
  return cleaned
})

// Analysis
ipcMain.handle('get-file-stats', async (_, repoPath: string) => {
  return await getFileSizeStats(repoPath)
})

ipcMain.handle('get-cleanup-report', async (_, repoPath: string) => {
  return await generateCleanupReport(repoPath)
})

// Get outdated packages for any language
ipcMain.handle('get-outdated-packages', async (_, repoPath: string, language?: Language) => {
  const languages = language ? [language] : await detectLanguages(repoPath)
  const allPackages: any[] = []

  for (const lang of languages) {
    switch (lang) {
      case 'javascript':
        const jsPackages = await getJsOutdatedPackages(repoPath)
        allPackages.push(...jsPackages)
        break
      case 'python':
        const pyPackages = await getPythonOutdated(repoPath)
        allPackages.push(...pyPackages)
        break
      case 'ruby':
        const rbPackages = await getRubyOutdated(repoPath)
        allPackages.push(...rbPackages)
        break
      case 'elixir':
        const exPackages = await getElixirOutdated(repoPath)
        allPackages.push(...exPackages)
        break
    }
  }

  return allPackages
})

// JavaScript outdated packages helper
async function getJsOutdatedPackages(repoPath: string) {
  try {
    const packageJsonPath = path.join(repoPath, 'package.json')
    const packageJsonContent = await fs.readFile(packageJsonPath, 'utf-8')
    const packageJson = JSON.parse(packageJsonContent)

    const devDeps = new Set(Object.keys(packageJson.devDependencies || {}))

    let outdatedJson: string
    try {
      const { stdout } = await execAsync('npm outdated --json', { cwd: repoPath })
      outdatedJson = stdout
    } catch (error: any) {
      outdatedJson = error.stdout || '{}'
    }

    const outdated = JSON.parse(outdatedJson || '{}')
    const packages: any[] = []

    for (const [name, info] of Object.entries(outdated) as [string, any][]) {
      const current = info.current || '0.0.0'
      const wanted = info.wanted || current
      const latest = info.latest || wanted

      const currentParsed = semver.parse(current)
      const wantedParsed = semver.parse(wanted)

      let hasPatchUpdate = false
      if (currentParsed && wantedParsed) {
        hasPatchUpdate = currentParsed.major === wantedParsed.major &&
                         currentParsed.minor === wantedParsed.minor &&
                         currentParsed.patch < wantedParsed.patch
      }

      packages.push({
        name,
        current,
        wanted,
        latest,
        type: devDeps.has(name) ? 'devDependencies' : 'dependencies',
        hasPatchUpdate,
        language: 'javascript'
      })
    }

    return packages.sort((a, b) => {
      if (a.hasPatchUpdate && !b.hasPatchUpdate) return -1
      if (!a.hasPatchUpdate && b.hasPatchUpdate) return 1
      return a.name.localeCompare(b.name)
    })
  } catch {
    return []
  }
}

// Run patch batch with full pipeline
ipcMain.handle('run-patch-batch', async (event, config: {
  repoPath: string
  branchName: string
  packages: { name: string; language: Language }[]
  createPR: boolean
  runTests: boolean
  prTitle?: string
  prBody?: string
}) => {
  const { repoPath, branchName, packages, createPR, runTests: shouldRunTests, prTitle, prBody } = config

  const sendProgress = (message: string, step: number, total: number) => {
    event.sender.send('patch-batch-progress', { message, step, total })
  }

  const totalSteps = shouldRunTests ? 8 : 6
  let currentStep = 0

  try {
    // Step 1: Check branch safety
    sendProgress('Checking branch safety...', ++currentStep, totalSteps)
    const repoInfo = await getRepoInfo(repoPath)
    const originalBranch = repoInfo.branch

    if (repoInfo.hasChanges) {
      return { success: false, error: 'Repository has uncommitted changes. Please commit or stash first.' }
    }

    // Step 2: Create branch (this handles protected branch check)
    sendProgress('Creating git branch...', ++currentStep, totalSteps)
    await createBranch(repoPath, branchName)

    // Step 3: Update packages by language
    sendProgress('Updating packages...', ++currentStep, totalSteps)

    const byLanguage = new Map<Language, string[]>()
    for (const pkg of packages) {
      const list = byLanguage.get(pkg.language) || []
      list.push(pkg.name)
      byLanguage.set(pkg.language, list)
    }

    const allUpdated: string[] = []
    const allFailed: string[] = []

    for (const [lang, pkgNames] of byLanguage) {
      let result: { updated: string[]; failed: string[] }

      switch (lang) {
        case 'javascript':
          result = await updateJsPackages(repoPath, pkgNames)
          break
        case 'python':
          result = await updatePythonPackages(repoPath, pkgNames)
          break
        case 'ruby':
          result = await updateRubyPackages(repoPath, pkgNames)
          break
        case 'elixir':
          result = await updateElixirPackages(repoPath, pkgNames)
          break
        default:
          result = { updated: [], failed: pkgNames }
      }

      allUpdated.push(...result.updated)
      allFailed.push(...result.failed)
    }

    // Step 4: Run clean install
    sendProgress('Running clean install...', ++currentStep, totalSteps)
    const primaryLang = packages[0]?.language || 'javascript'
    const cleanCmd = getCleanInstallCommand(primaryLang)
    if (cleanCmd) {
      await execAsync(cleanCmd, { cwd: repoPath, timeout: 300000 })
    }

    // Step 5: Run tests if requested
    let testsPassed = true
    if (shouldRunTests) {
      sendProgress('Running tests...', ++currentStep, totalSteps)
      const testCmd = getTestCommand(primaryLang)
      if (testCmd) {
        const testResult = await runTests(repoPath, testCmd)
        testsPassed = testResult.success

        if (!testsPassed) {
          // Abort and cleanup
          sendProgress('Tests failed, reverting changes...', ++currentStep, totalSteps)
          await abortChanges(repoPath, originalBranch)
          await deleteBranch(repoPath, branchName)
          return {
            success: false,
            error: 'Tests failed. Changes reverted.',
            testOutput: testResult.output
          }
        }
      }

      // Run lint
      sendProgress('Running linter...', ++currentStep, totalSteps)
      const lintCmd = getLintCommand(primaryLang)
      if (lintCmd) {
        const lintResult = await runLint(repoPath, lintCmd)
        if (!lintResult.success) {
          // Lint failures are warnings, not blockers
          event.sender.send('patch-batch-warning', { message: 'Linter found issues', output: lintResult.output })
        }
      }
    }

    // Step 6: Commit changes
    sendProgress('Committing changes...', ++currentStep, totalSteps)
    const files = getFilesToCommit(primaryLang)
    await commitChanges(repoPath, `chore(deps): update ${allUpdated.length} packages to latest patch versions

Updated packages:
${allUpdated.map(p => `- ${p}`).join('\n')}`, files)

    // Step 7: Push branch
    sendProgress('Pushing branch...', ++currentStep, totalSteps)
    await pushBranch(repoPath, branchName)

    // Step 8: Create PR if requested
    let prUrl: string | null = null
    if (createPR) {
      sendProgress('Creating pull request...', ++currentStep, totalSteps)
      prUrl = await createPullRequest(
        repoPath,
        prTitle || `chore(deps): update ${allUpdated.length} packages`,
        prBody || `## Summary
Automated patch version updates via Bridge.

### Updated packages
${allUpdated.map(p => `- ${p}`).join('\n')}

${shouldRunTests ? '### Checks\n- [x] Tests passed\n- [x] Lint checked' : ''}`
      )
    }

    return {
      success: true,
      updatedPackages: allUpdated,
      failedPackages: allFailed,
      prUrl,
      testsPassed
    }
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    }
  }
})

// JavaScript package update helper
async function updateJsPackages(repoPath: string, packages: string[]) {
  const updated: string[] = []
  const failed: string[] = []

  const packageJsonPath = path.join(repoPath, 'package.json')
  const packageJsonContent = await fs.readFile(packageJsonPath, 'utf-8')
  const packageJson = JSON.parse(packageJsonContent)

  const outdated = await getJsOutdatedPackages(repoPath)
  const outdatedMap = new Map(outdated.map((p: any) => [p.name, p]))

  for (const pkgName of packages) {
    const pkg = outdatedMap.get(pkgName)
    if (!pkg || !pkg.hasPatchUpdate) {
      failed.push(pkgName)
      continue
    }

    if (packageJson.dependencies?.[pkgName]) {
      const currentVersion = packageJson.dependencies[pkgName]
      const prefix = currentVersion.match(/^[^0-9]*/)?.[0] || '^'
      packageJson.dependencies[pkgName] = `${prefix}${pkg.wanted}`
      updated.push(pkgName)
    } else if (packageJson.devDependencies?.[pkgName]) {
      const currentVersion = packageJson.devDependencies[pkgName]
      const prefix = currentVersion.match(/^[^0-9]*/)?.[0] || '^'
      packageJson.devDependencies[pkgName] = `${prefix}${pkg.wanted}`
      updated.push(pkgName)
    } else {
      failed.push(pkgName)
    }
  }

  await fs.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2) + '\n')

  return { updated, failed }
}

// Git info
ipcMain.handle('get-repo-info', async (_, repoPath: string) => {
  return await getRepoInfo(repoPath)
})

ipcMain.handle('check-protected-branch', async (_, repoPath: string) => {
  return await isOnProtectedBranch(repoPath)
})

// Scheduler
ipcMain.handle('get-scheduled-jobs', () => {
  return getScheduledJobs()
})

ipcMain.handle('add-scheduled-job', (_, job: any) => {
  return addScheduledJob(job)
})

ipcMain.handle('update-scheduled-job', (_, jobId: string, updates: any) => {
  return updateScheduledJob(jobId, updates)
})

ipcMain.handle('delete-scheduled-job', (_, jobId: string) => {
  return deleteScheduledJob(jobId)
})

ipcMain.handle('get-job-results', (_, jobId?: string) => {
  return getJobResults(jobId)
})

// Handle scheduler job execution
ipcMain.on('scheduler-job-complete', (_, result: any) => {
  addJobResult(result)
})

// Security Scanner
ipcMain.handle('check-security-scanner-available', async () => {
  return await checkAgenticFixerAvailable()
})

ipcMain.handle('run-security-scan', async (event, repoPath: string) => {
  return await runSecurityScan(repoPath, (progress) => {
    event.sender.send('security-scan-progress', progress)
  })
})

ipcMain.handle('generate-security-fix', async (_, finding: any) => {
  return await generateSecurityFix(finding)
})
````

## File: src/components/Cleanup/Cleanup.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { CleanupReport, FileSizeStats } from '../../types'

export default function Cleanup() {
  const { selectedRepo } = useRepositories()
  const [loading, setLoading] = useState(false)
  const [stats, setStats] = useState<FileSizeStats | null>(null)
  const [report, setReport] = useState<CleanupReport | null>(null)
  const [activeTab, setActiveTab] = useState<'files' | 'git-history' | 'components'>('files')

  useEffect(() => {
    if (selectedRepo) {
      loadStats()
    }
  }, [selectedRepo])

  const loadStats = async () => {
    if (!selectedRepo) return
    setLoading(true)
    try {
      const [statsResult, reportResult] = await Promise.all([
        window.bridge.getFileStats(selectedRepo.path),
        window.bridge.getCleanupReport(selectedRepo.path)
      ])
      setStats(statsResult)
      setReport(reportResult)
    } catch (error) {
      console.error('Failed to load stats:', error)
    } finally {
      setLoading(false)
    }
  }

  if (!selectedRepo) {
    return (
      <div className="empty-state fade-in">
        <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
        </svg>
        <h3 className="empty-state-title">No repository selected</h3>
        <p className="empty-state-desc">Select a repository from the sidebar to analyze</p>
      </div>
    )
  }

  return (
    <div className="fade-in">
      <div style={{ marginBottom: '24px' }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
          <div>
            <h2 style={{ marginBottom: '4px' }}>Cleanup Analysis</h2>
            <p style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
              Find hidden bloat, large files in git history, and oversized components.
            </p>
          </div>
          <button
            className="btn btn-secondary btn-sm"
            onClick={loadStats}
            disabled={loading}
          >
            {loading ? <div className="spinner" style={{ width: '14px', height: '14px' }} /> : (
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 4v6h-6M1 20v-6h6" />
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
              </svg>
            )}
            Refresh
          </button>
        </div>
      </div>

      {loading ? (
        <div style={{ display: 'flex', justifyContent: 'center', padding: '60px' }}>
          <div className="spinner" />
        </div>
      ) : stats && report ? (
        <>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
            <div className="card">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Total Size</div>
              <div style={{ fontSize: '24px', fontWeight: 600 }}>{stats.totalSizeFormatted}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>{stats.fileCount} files</div>
            </div>
            <div className="card">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Git History Bloat</div>
              <div style={{ fontSize: '24px', fontWeight: 600, color: report.totalWastedSpace > 0 ? 'var(--warning)' : 'var(--success)' }}>
                {report.totalWastedSpaceFormatted}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>{report.gitHistoryFiles.length} large blobs</div>
            </div>
            <div className="card">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Large Files</div>
              <div style={{ fontSize: '24px', fontWeight: 600 }}>{report.largeFiles.length}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>files over 500KB</div>
            </div>
            <div className="card">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Oversized Components</div>
              <div style={{ fontSize: '24px', fontWeight: 600, color: report.oversizedComponents.length > 0 ? 'var(--warning)' : 'var(--success)' }}>
                {report.oversizedComponents.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>files over 150 lines</div>
            </div>
          </div>

          <div className="card">
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
              <button
                className={`btn ${activeTab === 'files' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
                onClick={() => setActiveTab('files')}
              >
                Largest Files ({stats.largestFiles.length})
              </button>
              <button
                className={`btn ${activeTab === 'git-history' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
                onClick={() => setActiveTab('git-history')}
              >
                Git History ({report.gitHistoryFiles.length})
              </button>
              <button
                className={`btn ${activeTab === 'components' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
                onClick={() => setActiveTab('components')}
              >
                Oversized Components ({report.oversizedComponents.length})
              </button>
            </div>

            {activeTab === 'files' && (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                {stats.largestFiles.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                    No large files found
                  </div>
                ) : (
                  stats.largestFiles.map((file, i) => (
                    <div
                      key={file.path}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        padding: '10px 12px',
                        background: 'var(--bg-tertiary)',
                        borderRadius: 'var(--radius-md)'
                      }}
                    >
                      <span style={{ color: 'var(--text-tertiary)', fontSize: '12px', width: '24px' }}>
                        #{i + 1}
                      </span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" strokeWidth="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                      </svg>
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {file.path}
                      </span>
                      <span style={{ fontWeight: 500, color: file.size > 1024 * 1024 ? 'var(--warning)' : 'var(--text-secondary)' }}>
                        {file.sizeFormatted}
                      </span>
                    </div>
                  ))
                )}
              </div>
            )}

            {activeTab === 'git-history' && (
              <div>
                {report.gitHistoryFiles.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ margin: '0 auto 16px', opacity: 0.5 }}>
                      <circle cx="12" cy="12" r="10" />
                      <path d="M9 12l2 2 4-4" />
                    </svg>
                    <div>No large blobs in git history!</div>
                  </div>
                ) : (
                  <>
                    <div style={{ padding: '12px', background: 'rgba(245, 158, 11, 0.1)', borderRadius: 'var(--radius-md)', marginBottom: '16px', fontSize: '13px', color: 'var(--warning)' }}>
                      <strong>Tip:</strong> These files are stored in your git history even if deleted. Use <code style={{ background: 'var(--bg-tertiary)', padding: '2px 6px', borderRadius: '4px' }}>git filter-branch</code> or <code style={{ background: 'var(--bg-tertiary)', padding: '2px 6px', borderRadius: '4px' }}>BFG Repo-Cleaner</code> to remove them.
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                      {report.gitHistoryFiles.map((file, i) => (
                        <div
                          key={`${file.path}-${i}`}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            padding: '10px 12px',
                            background: 'var(--bg-tertiary)',
                            borderRadius: 'var(--radius-md)'
                          }}
                        >
                          <span style={{ color: 'var(--text-tertiary)', fontSize: '12px', width: '24px' }}>
                            #{i + 1}
                          </span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" strokeWidth="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />
                          </svg>
                          <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                            {file.path}
                          </span>
                          <span style={{ fontWeight: 500, color: 'var(--warning)' }}>
                            {file.sizeFormatted}
                          </span>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            )}

            {activeTab === 'components' && (
              <div>
                {report.oversizedComponents.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ margin: '0 auto 16px', opacity: 0.5 }}>
                      <circle cx="12" cy="12" r="10" />
                      <path d="M9 12l2 2 4-4" />
                    </svg>
                    <div>All components are under 150 lines!</div>
                  </div>
                ) : (
                  <>
                    <div style={{ padding: '12px', background: 'rgba(245, 158, 11, 0.1)', borderRadius: 'var(--radius-md)', marginBottom: '16px', fontSize: '13px', color: 'var(--warning)' }}>
                      <strong>Tip:</strong> Components over 150 lines are harder to maintain. Consider breaking them into smaller, focused components.
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                      {report.oversizedComponents.map((comp, i) => (
                        <div
                          key={comp.path}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            padding: '10px 12px',
                            background: 'var(--bg-tertiary)',
                            borderRadius: 'var(--radius-md)'
                          }}
                        >
                          <span style={{ color: 'var(--text-tertiary)', fontSize: '12px', width: '24px' }}>
                            #{i + 1}
                          </span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <line x1="3" y1="9" x2="21" y2="9" />
                            <line x1="9" y1="21" x2="9" y2="9" />
                          </svg>
                          <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                            {comp.path}
                          </span>
                          <span className="badge" style={{ background: 'var(--bg-secondary)', color: 'var(--text-secondary)', fontSize: '10px' }}>
                            {comp.type}
                          </span>
                          <span style={{ fontWeight: 500, color: comp.lines > 300 ? 'var(--error)' : 'var(--warning)' }}>
                            {comp.lines} lines
                          </span>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </>
      ) : null}
    </div>
  )
}
````

## File: src/components/Dashboard/Dashboard.tsx
````typescript
import { useRepositories } from '../../contexts/RepositoryContext'
import type { View, Language } from '../../types'

interface DashboardProps {
  onNavigate: (view: View) => void
}

const LANGUAGE_LABELS: Record<Language, string> = {
  javascript: 'JavaScript/Node',
  python: 'Python',
  ruby: 'Ruby',
  elixir: 'Elixir',
  unknown: 'Unknown'
}

export default function Dashboard({ onNavigate }: DashboardProps) {
  const { repositories, selectedRepo, addRepository, removeRepository } = useRepositories()

  const handleImport = async () => {
    const path = await window.bridge.selectDirectory()
    if (path) {
      await addRepository(path)
    }
  }

  const features = [
    {
      id: 'patch-batch',
      icon: (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
          <path d="M21 12a9 9 0 11-9-9" />
          <path d="M21 3v6h-6" />
        </svg>
      ),
      title: 'Patch Batch',
      subtitle: 'Update packages safely',
      description: 'Update all packages to their latest patch versions with tests.',
      view: 'patch-batch' as View
    },
    {
      id: 'cleanup',
      icon: (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
        </svg>
      ),
      title: 'Cleanup',
      subtitle: 'Find hidden bloat',
      description: 'Find large files in git history and oversized components.',
      view: 'cleanup' as View
    },
    {
      id: 'scheduler',
      icon: (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      ),
      title: 'Scheduler',
      subtitle: 'Set it and forget it',
      description: 'Automate updates daily, weekly, or monthly across repos.',
      view: 'scheduler' as View
    },
    {
      id: 'security',
      icon: (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
      ),
      title: 'Security Scanner',
      subtitle: 'Find vulnerabilities',
      description: 'Scan for SQL injection, XSS, secrets, and more with AI-powered fixes.',
      view: 'security' as View
    },
    {
      id: 'files',
      icon: (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" strokeWidth="2">
          <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
        </svg>
      ),
      title: 'File Browser',
      subtitle: 'Explore your repos',
      description: 'Browse files with size info, find the biggest files.',
      view: 'files' as View
    }
  ]

  return (
    <div className="fade-in">
      <div style={{ marginBottom: '32px' }}>
        <h2 style={{ marginBottom: '8px' }}>Welcome to Bridge</h2>
        <p style={{ color: 'var(--text-secondary)' }}>
          Manage tech debt and keep your dependencies up to date. Works with JavaScript, Python, Ruby, and Elixir.
        </p>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px', marginBottom: '32px' }}>
        {features.map(feature => (
          <div key={feature.id} className="card" style={{ cursor: 'pointer' }} onClick={() => onNavigate(feature.view)}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
              <div style={{ width: '40px', height: '40px', borderRadius: '10px', background: 'var(--accent-light)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                {feature.icon}
              </div>
              <div>
                <h3 style={{ fontSize: '16px' }}>{feature.title}</h3>
                <p style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{feature.subtitle}</p>
              </div>
            </div>
            <p style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
              {feature.description}
            </p>
          </div>
        ))}
      </div>

      <div className="card">
        <div className="card-header">
          <h3 className="card-title">Repositories</h3>
          <button className="btn btn-primary btn-sm" onClick={handleImport}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Import
          </button>
        </div>

        {repositories.length === 0 ? (
          <div className="empty-state">
            <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
              <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
            </svg>
            <h3 className="empty-state-title">No repositories yet</h3>
            <p className="empty-state-desc">Import a repository to get started</p>
            <button className="btn btn-primary" onClick={handleImport}>
              Import Repository
            </button>
          </div>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
            {repositories.map(repo => (
              <div
                key={repo.path}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  padding: '12px',
                  background: selectedRepo?.path === repo.path ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                  borderRadius: 'var(--radius-md)',
                  border: selectedRepo?.path === repo.path ? '1px solid var(--accent)' : '1px solid transparent',
                  opacity: repo.exists ? 1 : 0.5
                }}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" strokeWidth="2">
                  <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                </svg>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontWeight: 500, marginBottom: '2px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {repo.name}
                    {!repo.exists && <span className="badge" style={{ background: 'var(--error)', color: '#fff', fontSize: '10px' }}>Missing</span>}
                  </div>
                  <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{repo.path}</div>
                </div>
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  {(repo.languages ?? []).map(lang => (
                    <span key={lang} className="badge badge-success" style={{ fontSize: '10px' }}>
                      {LANGUAGE_LABELS[lang]}
                    </span>
                  ))}
                  {repo.hasGit && <span className="badge badge-accent" style={{ fontSize: '10px' }}>git</span>}
                </div>
                <button
                  className="btn btn-ghost btn-icon"
                  onClick={(e) => { e.stopPropagation(); removeRepository(repo.path) }}
                  title="Remove repository"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: src/components/FileBrowser/FileBrowser.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { FileEntry, FileSizeStats } from '../../types'

export default function FileBrowser() {
  const { selectedRepo } = useRepositories()
  const [currentPath, setCurrentPath] = useState<string>('')
  const [files, setFiles] = useState<FileEntry[]>([])
  const [loading, setLoading] = useState(false)
  const [fileContent, setFileContent] = useState<string | null>(null)
  const [selectedFile, setSelectedFile] = useState<string | null>(null)
  const [stats, setStats] = useState<FileSizeStats | null>(null)
  const [showStats, setShowStats] = useState(false)

  useEffect(() => {
    if (selectedRepo) {
      setCurrentPath(selectedRepo.path)
      loadDirectory(selectedRepo.path)
      loadStats()
    }
  }, [selectedRepo])

  const loadStats = async () => {
    if (!selectedRepo) return
    try {
      const statsResult = await window.bridge.getFileStats(selectedRepo.path)
      setStats(statsResult)
    } catch (error) {
      console.error('Failed to load stats:', error)
    }
  }

  const loadDirectory = async (path: string) => {
    setLoading(true)
    setFileContent(null)
    setSelectedFile(null)
    try {
      const entries = await window.bridge.readDirectory(path)
      setFiles(entries)
      setCurrentPath(path)
    } catch (error) {
      console.error('Failed to read directory:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleFileClick = async (file: FileEntry) => {
    if (file.isDirectory) {
      await loadDirectory(file.path)
    } else {
      try {
        const content = await window.bridge.readFile(file.path)
        setFileContent(content)
        setSelectedFile(file.name)
      } catch (error) {
        console.error('Failed to read file:', error)
      }
    }
  }

  const navigateUp = () => {
    const parent = currentPath.split('/').slice(0, -1).join('/')
    if (parent && selectedRepo && parent.startsWith(selectedRepo.path.split('/').slice(0, -1).join('/'))) {
      loadDirectory(parent)
    }
  }

  const formatSize = (bytes?: number) => {
    if (!bytes) return ''
    if (bytes < 1024) return `${bytes} B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
  }

  const getSizeColor = (bytes?: number) => {
    if (!bytes) return 'var(--text-tertiary)'
    if (bytes > 1024 * 1024) return 'var(--error)' // > 1MB
    if (bytes > 500 * 1024) return 'var(--warning)' // > 500KB
    if (bytes > 100 * 1024) return 'var(--accent)' // > 100KB
    return 'var(--text-tertiary)'
  }

  if (!selectedRepo) {
    return (
      <div className="empty-state fade-in">
        <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
          <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
        </svg>
        <h3 className="empty-state-title">No repository selected</h3>
        <p className="empty-state-desc">Select a repository from the sidebar to browse its files</p>
      </div>
    )
  }

  return (
    <div className="file-browser fade-in">
      <div className="file-browser-header">
        <button
          className="btn btn-secondary btn-icon"
          onClick={navigateUp}
          disabled={currentPath === selectedRepo.path}
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        <div className="file-path">{currentPath}</div>
        <button
          className={`btn ${showStats ? 'btn-primary' : 'btn-secondary'} btn-sm`}
          onClick={() => setShowStats(!showStats)}
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M18 20V10M12 20V4M6 20v-6" />
          </svg>
          Stats
        </button>
        <button className="btn btn-secondary btn-sm" onClick={() => loadDirectory(currentPath)}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M23 4v6h-6M1 20v-6h6" />
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
          </svg>
          Refresh
        </button>
      </div>

      {showStats && stats && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '16px' }}>
          <div className="card" style={{ padding: '12px' }}>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Total Size</div>
            <div style={{ fontSize: '18px', fontWeight: 600 }}>{stats.totalSizeFormatted}</div>
          </div>
          <div className="card" style={{ padding: '12px' }}>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Files</div>
            <div style={{ fontSize: '18px', fontWeight: 600 }}>{stats.fileCount}</div>
          </div>
          <div className="card" style={{ padding: '12px' }}>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Largest File</div>
            <div style={{ fontSize: '14px', fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
              {stats.largestFiles[0]?.sizeFormatted || ''}
            </div>
          </div>
        </div>
      )}

      <div style={{ display: 'flex', gap: '16px', height: showStats ? 'calc(100% - 120px)' : 'calc(100% - 60px)' }}>
        <div className="file-list" style={{ flex: 1 }}>
          {loading ? (
            <div style={{ display: 'flex', justifyContent: 'center', padding: '40px' }}>
              <div className="spinner" />
            </div>
          ) : files.length === 0 ? (
            <div style={{ color: 'var(--text-secondary)', textAlign: 'center', padding: '40px' }}>
              Empty directory
            </div>
          ) : (
            files.map(file => (
              <div
                key={file.path}
                className="file-item"
                onClick={() => handleFileClick(file)}
                style={{ background: selectedFile === file.name ? 'var(--bg-secondary)' : undefined }}
              >
                {file.isDirectory ? (
                  <svg className="file-icon folder" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                  </svg>
                ) : (
                  <svg className="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                  </svg>
                )}
                <span className="file-name">{file.name}</span>
                {!file.isDirectory && file.size && (
                  <span className="file-size" style={{ color: getSizeColor(file.size), fontWeight: file.size && file.size > 100 * 1024 ? 500 : 400 }}>
                    {formatSize(file.size)}
                  </span>
                )}
              </div>
            ))
          )}
        </div>

        {fileContent !== null && (
          <div style={{ flex: 1, background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
            <div style={{ padding: '12px 16px', borderBottom: '1px solid var(--border-color)', fontWeight: 500, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span>{selectedFile}</span>
              <button
                className="btn btn-ghost btn-sm"
                onClick={() => { setFileContent(null); setSelectedFile(null) }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
            </div>
            <pre style={{
              flex: 1,
              padding: '16px',
              margin: 0,
              overflow: 'auto',
              fontSize: '13px',
              lineHeight: 1.6,
              color: 'var(--text-secondary)'
            }}>
              {fileContent}
            </pre>
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: src/components/Layout/Header.tsx
````typescript
import { useTheme } from '../../contexts/ThemeContext'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { View } from '../../types'

interface HeaderProps {
  currentView: View
}

const viewTitles: Record<View, string> = {
  dashboard: 'Dashboard',
  files: 'File Browser',
  'patch-batch': 'Patch Batch',
  cleanup: 'Cleanup',
  scheduler: 'Scheduler',
  security: 'Security Scanner'
}

export default function Header({ currentView }: HeaderProps) {
  const { theme, toggleTheme } = useTheme()
  const { selectedRepo } = useRepositories()

  return (
    <header className="app-header">
      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
        <h1 style={{ fontSize: '18px', fontWeight: 600 }}>{viewTitles[currentView]}</h1>
        {selectedRepo && (
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
            <span className="badge badge-accent">{selectedRepo.name}</span>
            {(selectedRepo.languages ?? []).map(lang => (
              <span key={lang} className="badge" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', fontSize: '10px' }}>
                {lang}
              </span>
            ))}
          </div>
        )}
      </div>

      <button className="theme-toggle" onClick={toggleTheme} title={`Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`}>
        {theme === 'dark' ? (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="5" />
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
          </svg>
        ) : (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
          </svg>
        )}
      </button>
    </header>
  )
}
````

## File: src/components/Scheduler/Scheduler.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { ScheduledJob, ScheduleFrequency, JobResult } from '../../types'

const FREQUENCY_LABELS: Record<ScheduleFrequency, string> = {
  daily: 'Daily',
  weekly: 'Weekly',
  monthly: 'Monthly'
}

export default function Scheduler() {
  const { repositories } = useRepositories()
  const [jobs, setJobs] = useState<ScheduledJob[]>([])
  const [results, setResults] = useState<JobResult[]>([])
  const [loading, setLoading] = useState(true)
  const [showAddModal, setShowAddModal] = useState(false)

  // New job form state
  const [selectedRepo, setSelectedRepo] = useState('')
  const [frequency, setFrequency] = useState<ScheduleFrequency>('weekly')
  const [createPR, setCreatePR] = useState(true)
  const [runTests, setRunTests] = useState(true)

  useEffect(() => {
    loadJobs()
  }, [])

  const loadJobs = async () => {
    setLoading(true)
    try {
      const [jobsData, resultsData] = await Promise.all([
        window.bridge.getScheduledJobs(),
        window.bridge.getJobResults()
      ])
      setJobs(jobsData)
      setResults(resultsData)
    } catch (error) {
      console.error('Failed to load jobs:', error)
    } finally {
      setLoading(false)
    }
  }

  const addJob = async () => {
    if (!selectedRepo) return

    const repo = repositories.find(r => r.path === selectedRepo)
    if (!repo) return

    try {
      await window.bridge.addScheduledJob({
        repoPath: repo.path,
        repoName: repo.name,
        frequency,
        enabled: true,
        language: repo.languages?.[0] || 'javascript',
        createPR,
        runTests
      })
      await loadJobs()
      setShowAddModal(false)
      setSelectedRepo('')
    } catch (error) {
      console.error('Failed to add job:', error)
    }
  }

  const toggleJob = async (jobId: string, enabled: boolean) => {
    try {
      await window.bridge.updateScheduledJob(jobId, { enabled })
      await loadJobs()
    } catch (error) {
      console.error('Failed to toggle job:', error)
    }
  }

  const deleteJob = async (jobId: string) => {
    try {
      await window.bridge.deleteScheduledJob(jobId)
      await loadJobs()
    } catch (error) {
      console.error('Failed to delete job:', error)
    }
  }

  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return 'Never'
    const date = new Date(dateStr)
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  }

  const getJobResults = (jobId: string) => {
    return results.filter(r => r.jobId === jobId).slice(0, 5)
  }

  return (
    <div className="fade-in">
      <div style={{ marginBottom: '24px' }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
          <div>
            <h2 style={{ marginBottom: '4px' }}>Scheduler</h2>
            <p style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
              Set it and forget it. Automate package updates on a schedule.
            </p>
          </div>
          <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Add Schedule
          </button>
        </div>
      </div>

      {loading ? (
        <div style={{ display: 'flex', justifyContent: 'center', padding: '60px' }}>
          <div className="spinner" />
        </div>
      ) : jobs.length === 0 ? (
        <div className="card">
          <div className="empty-state">
            <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
            <h3 className="empty-state-title">No scheduled jobs</h3>
            <p className="empty-state-desc">Create a schedule to automatically update packages</p>
            <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
              Add Schedule
            </button>
          </div>
        </div>
      ) : (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          {jobs.map(job => (
            <div key={job.id} className="card">
              <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                <div
                  style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: '10px',
                    background: job.enabled ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={job.enabled ? 'var(--accent)' : 'var(--text-tertiary)'} strokeWidth="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                  </svg>
                </div>

                <div style={{ flex: 1 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: 600 }}>{job.repoName}</h3>
                    <span className={`badge ${job.enabled ? 'badge-success' : ''}`} style={{ background: job.enabled ? undefined : 'var(--bg-tertiary)', color: job.enabled ? undefined : 'var(--text-tertiary)' }}>
                      {job.enabled ? 'Active' : 'Paused'}
                    </span>
                    <span className="badge badge-accent">{FREQUENCY_LABELS[job.frequency]}</span>
                  </div>
                  <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
                    {job.repoPath}
                  </div>

                  <div style={{ display: 'flex', gap: '24px', fontSize: '12px', color: 'var(--text-tertiary)' }}>
                    <div>
                      <span style={{ color: 'var(--text-secondary)' }}>Last run:</span> {formatDate(job.lastRun)}
                    </div>
                    <div>
                      <span style={{ color: 'var(--text-secondary)' }}>Next run:</span> {formatDate(job.nextRun)}
                    </div>
                    <div>
                      <span style={{ color: 'var(--text-secondary)' }}>Options:</span>{' '}
                      {job.createPR ? 'Create PR' : 'No PR'}, {job.runTests ? 'Run tests' : 'Skip tests'}
                    </div>
                  </div>

                  {/* Recent results */}
                  {getJobResults(job.id).length > 0 && (
                    <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--border-color)' }}>
                      <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>Recent runs:</div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        {getJobResults(job.id).map((result, i) => (
                          <div
                            key={i}
                            title={result.success ? `Updated ${result.updatedPackages.length} packages` : result.error}
                            style={{
                              width: '24px',
                              height: '24px',
                              borderRadius: '4px',
                              background: result.success ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}
                          >
                            {result.success ? (
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--success)" strokeWidth="3">
                                <polyline points="20 6 9 17 4 12" />
                              </svg>
                            ) : (
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--error)" strokeWidth="3">
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                              </svg>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    className="btn btn-secondary btn-sm"
                    onClick={() => toggleJob(job.id, !job.enabled)}
                  >
                    {job.enabled ? 'Pause' : 'Resume'}
                  </button>
                  <button
                    className="btn btn-ghost btn-icon"
                    onClick={() => deleteJob(job.id)}
                    title="Delete schedule"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Add Schedule Modal */}
      {showAddModal && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000
          }}
          onClick={() => setShowAddModal(false)}
        >
          <div
            className="card"
            style={{ width: '100%', maxWidth: '480px', margin: '20px' }}
            onClick={e => e.stopPropagation()}
          >
            <h3 style={{ marginBottom: '20px' }}>Add Schedule</h3>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                  Repository
                </label>
                <select
                  className="input"
                  value={selectedRepo}
                  onChange={e => setSelectedRepo(e.target.value)}
                  style={{ cursor: 'pointer' }}
                >
                  <option value="">Select a repository...</option>
                  {repositories.filter(r => r.exists && r.hasGit).map(repo => (
                    <option key={repo.path} value={repo.path}>
                      {repo.name} ({(repo.languages ?? []).join(', ') || 'unknown'})
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                  Frequency
                </label>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {(['daily', 'weekly', 'monthly'] as ScheduleFrequency[]).map(freq => (
                    <button
                      key={freq}
                      className={`btn ${frequency === freq ? 'btn-primary' : 'btn-secondary'} btn-sm`}
                      onClick={() => setFrequency(freq)}
                      style={{ flex: 1 }}
                    >
                      {FREQUENCY_LABELS[freq]}
                    </button>
                  ))}
                </div>
              </div>

              <div style={{ display: 'flex', gap: '24px' }}>
                <label className="checkbox-wrapper">
                  <div
                    className={`checkbox ${createPR ? 'checked' : ''}`}
                    onClick={() => setCreatePR(!createPR)}
                  >
                    {createPR && (
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="3">
                        <polyline points="20 6 9 17 4 12" />
                      </svg>
                    )}
                  </div>
                  <span className="checkbox-label">Create PR</span>
                </label>

                <label className="checkbox-wrapper">
                  <div
                    className={`checkbox ${runTests ? 'checked' : ''}`}
                    onClick={() => setRunTests(!runTests)}
                  >
                    {runTests && (
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="3">
                        <polyline points="20 6 9 17 4 12" />
                      </svg>
                    )}
                  </div>
                  <span className="checkbox-label">Run tests</span>
                </label>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '8px', marginTop: '24px', justifyContent: 'flex-end' }}>
              <button className="btn btn-secondary" onClick={() => setShowAddModal(false)}>
                Cancel
              </button>
              <button
                className="btn btn-primary"
                onClick={addJob}
                disabled={!selectedRepo}
              >
                Add Schedule
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
````

## File: src/components/Security/Security.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { ScanResult, SecurityFinding, ScanProgress } from '../../types'

const SEVERITY_COLORS = {
  critical: { bg: 'rgba(239, 68, 68, 0.15)', color: '#ef4444' },
  high: { bg: 'rgba(249, 115, 22, 0.15)', color: '#f97316' },
  medium: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
  low: { bg: 'rgba(34, 197, 94, 0.15)', color: '#22c55e' }
}

export default function Security() {
  const { selectedRepo } = useRepositories()
  const [scanning, setScanning] = useState(false)
  const [progress, setProgress] = useState<ScanProgress | null>(null)
  const [result, setResult] = useState<ScanResult | null>(null)
  const [selectedFinding, setSelectedFinding] = useState<SecurityFinding | null>(null)
  const [generatingFix, setGeneratingFix] = useState(false)
  const [filterSeverity, setFilterSeverity] = useState<string>('all')
  const [scannerAvailable, setScannerAvailable] = useState<boolean | null>(null)

  useEffect(() => {
    checkScanner()
  }, [])

  useEffect(() => {
    if (scanning) {
      const cleanup = window.bridge.onSecurityScanProgress(setProgress)
      return cleanup
    }
  }, [scanning])

  const checkScanner = async () => {
    const available = await window.bridge.checkSecurityScannerAvailable()
    setScannerAvailable(available)
  }

  const runScan = async () => {
    if (!selectedRepo) return

    setScanning(true)
    setProgress(null)
    setResult(null)
    setSelectedFinding(null)

    try {
      const scanResult = await window.bridge.runSecurityScan(selectedRepo.path)
      setResult(scanResult)
    } catch (error) {
      console.error('Security scan failed:', error)
    } finally {
      setScanning(false)
      setProgress(null)
    }
  }

  const generateFix = async (finding: SecurityFinding) => {
    setGeneratingFix(true)
    try {
      const fix = await window.bridge.generateSecurityFix(finding)
      if (fix) {
        setSelectedFinding({ ...finding, fixedCode: fix })
      }
    } catch (error) {
      console.error('Failed to generate fix:', error)
    } finally {
      setGeneratingFix(false)
    }
  }

  const filteredFindings = result?.findings.filter(f =>
    filterSeverity === 'all' || f.severity === filterSeverity
  ) || []

  if (!selectedRepo) {
    return (
      <div className="empty-state fade-in">
        <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
        <h3 className="empty-state-title">No repository selected</h3>
        <p className="empty-state-desc">Select a repository from the sidebar to scan for security issues</p>
      </div>
    )
  }

  return (
    <div className="fade-in">
      <div style={{ marginBottom: '24px' }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
          <div>
            <h2 style={{ marginBottom: '4px' }}>Security Scanner</h2>
            <p style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
              Scan for vulnerabilities: SQL injection, XSS, command injection, hardcoded secrets, and more.
            </p>
          </div>
          <button
            className="btn btn-primary"
            onClick={runScan}
            disabled={scanning}
          >
            {scanning ? (
              <>
                <div className="spinner" style={{ width: '14px', height: '14px', borderTopColor: '#000' }} />
                Scanning...
              </>
            ) : (
              <>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                Scan Repository
              </>
            )}
          </button>
        </div>

        {scannerAvailable === false && (
          <div className="card" style={{ marginBottom: '16px', borderColor: 'var(--warning)', background: 'rgba(245, 158, 11, 0.1)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: 'var(--warning)' }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
              </svg>
              <span>Using basic scanner. Install agentic_fixer dependencies for AI-powered fixes.</span>
            </div>
          </div>
        )}

        {scanning && progress && (
          <div className="card" style={{ marginBottom: '16px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
              <div className="spinner" />
              <span>{progress.message}</span>
            </div>
            <div className="progress-bar">
              <div className="progress-fill" style={{ width: `${progress.progress}%` }} />
            </div>
          </div>
        )}
      </div>

      {result && (
        <>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px', marginBottom: '24px' }}>
            <div className="card" style={{ padding: '16px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700 }}>{result.totalFindings}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Total Issues</div>
            </div>
            <div className="card" style={{ padding: '16px', textAlign: 'center', borderColor: SEVERITY_COLORS.critical.color }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: SEVERITY_COLORS.critical.color }}>{result.criticalCount}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Critical</div>
            </div>
            <div className="card" style={{ padding: '16px', textAlign: 'center', borderColor: SEVERITY_COLORS.high.color }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: SEVERITY_COLORS.high.color }}>{result.highCount}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>High</div>
            </div>
            <div className="card" style={{ padding: '16px', textAlign: 'center', borderColor: SEVERITY_COLORS.medium.color }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: SEVERITY_COLORS.medium.color }}>{result.mediumCount}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Medium</div>
            </div>
            <div className="card" style={{ padding: '16px', textAlign: 'center', borderColor: SEVERITY_COLORS.low.color }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: SEVERITY_COLORS.low.color }}>{result.lowCount}</div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Low</div>
            </div>
          </div>

          <div style={{ display: 'flex', gap: '24px' }}>
            <div style={{ flex: 1 }}>
              <div className="card">
                <div className="card-header">
                  <h3 className="card-title">Findings</h3>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {['all', 'critical', 'high', 'medium', 'low'].map(sev => (
                      <button
                        key={sev}
                        className={`btn ${filterSeverity === sev ? 'btn-primary' : 'btn-ghost'} btn-sm`}
                        onClick={() => setFilterSeverity(sev)}
                        style={{ textTransform: 'capitalize' }}
                      >
                        {sev}
                      </button>
                    ))}
                  </div>
                </div>

                {filteredFindings.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                    {result.totalFindings === 0 ? (
                      <>
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" strokeWidth="1.5" style={{ margin: '0 auto 16px' }}>
                          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                          <path d="M9 12l2 2 4-4" />
                        </svg>
                        <div>No security issues found!</div>
                      </>
                    ) : (
                      <div>No issues matching this filter</div>
                    )}
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '500px', overflow: 'auto' }}>
                    {filteredFindings.map((finding, i) => (
                      <div
                        key={`${finding.file}-${finding.line}-${i}`}
                        onClick={() => setSelectedFinding(finding)}
                        style={{
                          padding: '12px',
                          background: selectedFinding === finding ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                          borderRadius: 'var(--radius-md)',
                          cursor: 'pointer',
                          border: selectedFinding === finding ? '1px solid var(--accent)' : '1px solid transparent'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                          <span
                            className="badge"
                            style={{
                              background: SEVERITY_COLORS[finding.severity].bg,
                              color: SEVERITY_COLORS[finding.severity].color,
                              textTransform: 'uppercase',
                              fontSize: '10px'
                            }}
                          >
                            {finding.severity}
                          </span>
                          <span style={{ fontWeight: 500 }}>{finding.issue.replace(/-/g, ' ')}</span>
                        </div>
                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '4px' }}>
                          {finding.file}:{finding.line}
                        </div>
                        <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', display: 'flex', gap: '8px' }}>
                          <span>{finding.cwe}</span>
                          <span></span>
                          <span>{finding.owasp}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {selectedFinding && (
              <div style={{ width: '450px' }}>
                <div className="card">
                  <div className="card-header">
                    <h3 className="card-title">Finding Details</h3>
                    <button
                      className="btn btn-ghost btn-sm"
                      onClick={() => setSelectedFinding(null)}
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                      </svg>
                    </button>
                  </div>

                  <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    <div>
                      <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Issue Type</div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span
                          className="badge"
                          style={{
                            background: SEVERITY_COLORS[selectedFinding.severity].bg,
                            color: SEVERITY_COLORS[selectedFinding.severity].color
                          }}
                        >
                          {selectedFinding.severity}
                        </span>
                        <span style={{ fontWeight: 500 }}>{selectedFinding.issue.replace(/-/g, ' ')}</span>
                      </div>
                    </div>

                    <div>
                      <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Location</div>
                      <div>{selectedFinding.file}:{selectedFinding.line}</div>
                    </div>

                    <div>
                      <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Classification</div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <span className="badge badge-accent">{selectedFinding.cwe}</span>
                        <span className="badge" style={{ background: 'var(--bg-tertiary)' }}>{selectedFinding.owasp}</span>
                      </div>
                    </div>

                    <div>
                      <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Description</div>
                      <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{selectedFinding.description}</div>
                    </div>

                    <div>
                      <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Vulnerable Code</div>
                      <pre style={{
                        padding: '12px',
                        background: 'var(--bg-tertiary)',
                        borderRadius: 'var(--radius-md)',
                        overflow: 'auto',
                        fontSize: '12px',
                        margin: 0
                      }}>
                        {selectedFinding.code}
                      </pre>
                    </div>

                    {selectedFinding.solution && (
                      <div>
                        <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Solution</div>
                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{selectedFinding.solution}</div>
                      </div>
                    )}

                    {selectedFinding.fixedCode && (
                      <div>
                        <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '4px' }}>Fixed Code</div>
                        <pre style={{
                          padding: '12px',
                          background: 'rgba(34, 197, 94, 0.1)',
                          border: '1px solid var(--success)',
                          borderRadius: 'var(--radius-md)',
                          overflow: 'auto',
                          fontSize: '12px',
                          margin: 0
                        }}>
                          {selectedFinding.fixedCode}
                        </pre>
                      </div>
                    )}

                    {scannerAvailable && !selectedFinding.fixedCode && (
                      <button
                        className="btn btn-primary"
                        onClick={() => generateFix(selectedFinding)}
                        disabled={generatingFix}
                      >
                        {generatingFix ? (
                          <>
                            <div className="spinner" style={{ width: '14px', height: '14px', borderTopColor: '#000' }} />
                            Generating Fix...
                          </>
                        ) : (
                          <>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <path d="M12 2a10 10 0 1010 10H12V2z" />
                            </svg>
                            Generate AI Fix
                          </>
                        )}
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        </>
      )}

      {!result && !scanning && (
        <div className="card">
          <div className="empty-state">
            <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            <h3 className="empty-state-title">Ready to scan</h3>
            <p className="empty-state-desc">Click "Scan Repository" to check for security vulnerabilities</p>
          </div>
        </div>
      )}
    </div>
  )
}
````

## File: src/contexts/ThemeContext.tsx
````typescript
import React, { createContext, useContext, useEffect, useState } from 'react'

type Theme = 'light' | 'dark'

interface ThemeContextType {
  theme: Theme
  toggleTheme: () => void
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined)

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  const [theme, setTheme] = useState<Theme>(() => {
    const saved = localStorage.getItem('bridge-theme')
    if (saved === 'light' || saved === 'dark') {
      return saved
    }
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  })

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme)
    localStorage.setItem('bridge-theme', theme)
  }, [theme])

  const toggleTheme = () => {
    setTheme(prev => prev === 'dark' ? 'light' : 'dark')
  }

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  )
}

export function useTheme() {
  const context = useContext(ThemeContext)
  if (!context) {
    throw new Error('useTheme must be used within a ThemeProvider')
  }
  return context
}
````

## File: src/types/global.d.ts
````typescript
import type {
  Repository,
  FileEntry,
  Language,
  FileSizeStats,
  CleanupReport,
  OutdatedPackage,
  PatchBatchConfig,
  PatchBatchResult,
  RepoInfo,
  ScheduledJob,
  JobResult,
  ScanResult,
  ScanProgress,
  SecurityFinding
} from './index'

declare global {
  interface Window {
    bridge: {
      selectDirectory: () => Promise<string | null>
      scanRepository: (path: string) => Promise<Repository>
      readDirectory: (path: string) => Promise<FileEntry[]>
      readFile: (path: string) => Promise<string>
      detectLanguages: (path: string) => Promise<Language[]>
      getRepositories: () => Promise<Repository[]>
      saveRepositories: (repos: Repository[]) => Promise<boolean>
      removeRepository: (path: string) => Promise<Repository[]>
      cleanupMissingRepos: () => Promise<Repository[]>
      getFileStats: (repoPath: string) => Promise<FileSizeStats>
      getCleanupReport: (repoPath: string) => Promise<CleanupReport>
      getOutdatedPackages: (repoPath: string, language?: Language) => Promise<OutdatedPackage[]>
      runPatchBatch: (config: PatchBatchConfig) => Promise<PatchBatchResult>
      onPatchBatchProgress: (callback: (progress: { message: string; step: number; total: number }) => void) => () => void
      onPatchBatchWarning: (callback: (warning: { message: string; output: string }) => void) => () => void
      getRepoInfo: (repoPath: string) => Promise<RepoInfo>
      checkProtectedBranch: (repoPath: string) => Promise<boolean>
      getScheduledJobs: () => Promise<ScheduledJob[]>
      addScheduledJob: (job: Omit<ScheduledJob, 'id' | 'createdAt' | 'lastRun' | 'nextRun'>) => Promise<ScheduledJob>
      updateScheduledJob: (jobId: string, updates: Partial<ScheduledJob>) => Promise<ScheduledJob | null>
      deleteScheduledJob: (jobId: string) => Promise<boolean>
      getJobResults: (jobId?: string) => Promise<JobResult[]>
      onSchedulerJobStarted: (callback: (data: { jobId: string; repoName: string }) => void) => () => void
      checkSecurityScannerAvailable: () => Promise<boolean>
      runSecurityScan: (repoPath: string) => Promise<ScanResult>
      generateSecurityFix: (finding: SecurityFinding) => Promise<string | null>
      onSecurityScanProgress: (callback: (progress: ScanProgress) => void) => () => void
    }
  }
}

export {}
````

## File: src/App.tsx
````typescript
import { useState } from 'react'
import Sidebar from './components/Layout/Sidebar'
import Header from './components/Layout/Header'
import Dashboard from './components/Dashboard/Dashboard'
import FileBrowser from './components/FileBrowser/FileBrowser'
import PatchBatch from './components/PatchBatch/PatchBatch'
import Cleanup from './components/Cleanup/Cleanup'
import Scheduler from './components/Scheduler/Scheduler'
import Security from './components/Security/Security'
import type { View } from './types'

export default function App() {
  const [currentView, setCurrentView] = useState<View>('dashboard')

  const renderView = () => {
    switch (currentView) {
      case 'dashboard':
        return <Dashboard onNavigate={setCurrentView} />
      case 'files':
        return <FileBrowser />
      case 'patch-batch':
        return <PatchBatch />
      case 'cleanup':
        return <Cleanup />
      case 'scheduler':
        return <Scheduler />
      case 'security':
        return <Security />
      default:
        return <Dashboard onNavigate={setCurrentView} />
    }
  }

  return (
    <div className="app-layout">
      <Sidebar currentView={currentView} onNavigate={setCurrentView} />
      <main className="app-main">
        <Header currentView={currentView} />
        <div className="app-content">
          {renderView()}
        </div>
      </main>
    </div>
  )
}
````

## File: src/index.css
````css
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #ebebeb;
  --text-primary: #000000;
  --text-secondary: #666666;
  --text-tertiary: #999999;
  --border-color: #e0e0e0;
  --accent: #F5A700;
  --accent-hover: #d99200;
  --accent-light: rgba(245, 167, 0, 0.1);
  --success: #22c55e;
  --error: #ef4444;
  --warning: #f59e0b;

  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;

  --sidebar-width: 260px;
  --header-height: 60px;
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;

  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] {
  --bg-primary: #0a0a0a;
  --bg-secondary: #141414;
  --bg-tertiary: #1f1f1f;
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --text-tertiary: #666666;
  --border-color: #2a2a2a;
  --accent-light: rgba(245, 167, 0, 0.15);

  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
}

html, body {
  height: 100%;
  font-family: var(--font-mono);
  font-size: 14px;
  line-height: 1.5;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#root {
  height: 100%;
}

h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-sans);
  font-weight: 600;
  letter-spacing: -0.02em;
}

h1 {
  font-size: 28px;
  line-height: 1.2;
}

h2 {
  font-size: 22px;
  line-height: 1.3;
}

h3 {
  font-size: 18px;
  line-height: 1.4;
}

button {
  font-family: var(--font-mono);
  cursor: pointer;
  border: none;
  background: none;
  font-size: inherit;
}

input, textarea {
  font-family: var(--font-mono);
  font-size: inherit;
}

a {
  color: var(--accent);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-tertiary);
}

/* Selection */
::selection {
  background: var(--accent);
  color: #000;
}

/* App Layout */
.app-layout {
  display: flex;
  height: 100%;
}

.app-sidebar {
  width: var(--sidebar-width);
  height: 100%;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.app-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.app-header {
  height: var(--header-height);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-primary);
  -webkit-app-region: drag;
}

.app-header > * {
  -webkit-app-region: no-drag;
}

.app-content {
  flex: 1;
  overflow: auto;
  padding: 24px;
}

/* Sidebar */
.sidebar-header {
  padding: 20px;
  padding-top: 52px; /* Account for traffic lights */
}

.sidebar-logo {
  font-family: var(--font-sans);
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-logo-icon {
  width: 28px;
  height: 28px;
  background: var(--accent);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-weight: 700;
  font-size: 16px;
}

.sidebar-nav {
  flex: 1;
  padding: 12px;
}

.nav-section {
  margin-bottom: 24px;
}

.nav-section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-tertiary);
  padding: 0 12px;
  margin-bottom: 8px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  transition: all 0.15s ease;
  width: 100%;
  text-align: left;
}

.nav-item:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.nav-item.active {
  background: var(--accent-light);
  color: var(--accent);
}

.nav-icon {
  width: 18px;
  height: 18px;
  opacity: 0.7;
}

.nav-item.active .nav-icon {
  opacity: 1;
}

/* Repository List */
.repo-list {
  margin-top: 8px;
}

.repo-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.repo-item:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.repo-item.active {
  background: var(--accent-light);
  color: var(--accent);
}

.repo-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-tertiary);
}

.repo-item.active .repo-dot {
  background: var(--accent);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: var(--radius-md);
  font-weight: 500;
  transition: all 0.15s ease;
}

.btn-primary {
  background: var(--accent);
  color: #000;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--border-color);
}

.btn-ghost {
  color: var(--text-secondary);
}

.btn-ghost:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-icon {
  width: 36px;
  height: 36px;
  padding: 0;
  border-radius: var(--radius-md);
}

/* Cards */
.card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 20px;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
}

/* Input */
.input {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  transition: all 0.15s ease;
}

.input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.input::placeholder {
  color: var(--text-tertiary);
}

/* Checkbox */
.checkbox-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.checkbox {
  width: 18px;
  height: 18px;
  border: 2px solid var(--border-color);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
}

.checkbox.checked {
  background: var(--accent);
  border-color: var(--accent);
}

.checkbox-label {
  color: var(--text-secondary);
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 500;
}

.badge-warning {
  background: rgba(245, 158, 11, 0.15);
  color: #f59e0b;
}

.badge-success {
  background: rgba(34, 197, 94, 0.15);
  color: #22c55e;
}

.badge-accent {
  background: var(--accent-light);
  color: var(--accent);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 16px;
  opacity: 0.3;
}

.empty-state-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-state-desc {
  margin-bottom: 24px;
}

/* Progress */
.progress-bar {
  height: 4px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
  transition: width 0.3s ease;
}

/* File Browser */
.file-browser {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.file-browser-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 16px;
}

.file-path {
  flex: 1;
  font-size: 13px;
  color: var(--text-secondary);
  background: var(--bg-secondary);
  padding: 8px 12px;
  border-radius: var(--radius-md);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-list {
  flex: 1;
  overflow: auto;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
}

.file-item:hover {
  background: var(--bg-secondary);
}

.file-icon {
  width: 20px;
  height: 20px;
  color: var(--text-tertiary);
}

.file-icon.folder {
  color: var(--accent);
}

.file-name {
  flex: 1;
}

.file-size {
  font-size: 12px;
  color: var(--text-tertiary);
}

/* Package List */
.package-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.package-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
}

.package-item:hover {
  border-color: var(--accent);
}

.package-item.selected {
  border-color: var(--accent);
  background: var(--accent-light);
}

.package-info {
  flex: 1;
}

.package-name {
  font-weight: 500;
  margin-bottom: 4px;
}

.package-versions {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text-secondary);
}

.version-arrow {
  color: var(--text-tertiary);
}

.version-new {
  color: var(--success);
}

/* Theme Toggle */
.theme-toggle {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: all 0.15s ease;
}

.theme-toggle:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

/* Animations */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.3s ease;
}
````

## File: src/main.tsx
````typescript
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import { ThemeProvider } from './contexts/ThemeContext'
import { RepositoryProvider } from './contexts/RepositoryContext'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ThemeProvider>
      <RepositoryProvider>
        <App />
      </RepositoryProvider>
    </ThemeProvider>
  </React.StrictMode>
)
````

## File: index.html
````html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Bridge</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
````

## File: package.json
````json
{
  "name": "bridge-desktop",
  "version": "0.1.0",
  "description": "Tech debt management tool for developers",
  "main": "dist-electron/main.js",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build && electron-builder",
    "preview": "vite preview",
    "electron:dev": "vite"
  },
  "dependencies": {
    "electron-store": "^8.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "semver": "^7.5.4"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@types/semver": "^7.5.6",
    "@vitejs/plugin-react": "^4.2.1",
    "electron": "^28.1.0",
    "electron-builder": "^24.9.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.10",
    "vite-plugin-electron": "^0.28.0",
    "vite-plugin-electron-renderer": "^0.14.5"
  },
  "build": {
    "appId": "com.bridge.desktop",
    "productName": "Bridge",
    "mac": {
      "category": "public.app-category.developer-tools",
      "target": "dmg"
    }
  }
}
````

## File: README.md
````markdown
# Bridge

Dependency updates you can actually trust. Bridge validates patch updates locally before creating PRs.

## Quick Start (macOS)

1. Download `Bridge-0.1.0-arm64.dmg` from [releases/](./releases/)
2. Open the DMG and drag Bridge to Applications
3. Right-click Bridge > Open (first time only, to bypass Gatekeeper)
4. Import a repository and start updating

## What It Does

- **Patch Batch**: Select patch updates, Bridge runs your tests locally, then creates a PR only if everything passes
- **Security Scanner**: Scan for vulnerabilities with one click
- **Scheduler**: Automate patch updates on a schedule
- **Cleanup**: Find large files and oversized components

## Why Bridge?

Dependabot says "100% compatible" but breaks things. Bridge runs actual lint/build/tests locally before pushing anything.

## Supported Languages

- JavaScript (npm)
- Python (pip)
- Ruby (bundler)
- Elixir (mix)

## Development

```bash
npm install
npm run dev          # Dev server
npm run build        # Production build + DMG
```

## Requirements

- macOS (Apple Silicon)
- Node.js 18+
- Git
- `gh` CLI (for PR creation)
````

## File: tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
````

## File: tsconfig.node.json
````json
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "outDir": "dist-electron",
    "rootDir": ".",
    "esModuleInterop": true
  },
  "include": ["vite.config.ts", "electron/**/*"]
}
````

## File: vite.config.ts
````typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import electron from 'vite-plugin-electron'
import renderer from 'vite-plugin-electron-renderer'
import path from 'path'

export default defineConfig({
  plugins: [
    react(),
    electron([
      {
        entry: 'electron/main.ts',
        onstart(args) {
          args.startup()
        },
        vite: {
          build: {
            outDir: 'dist-electron',
            rollupOptions: {
              external: ['electron', 'electron-store']
            }
          }
        }
      },
      {
        entry: 'electron/preload.ts',
        onstart(args) {
          args.reload()
        },
        vite: {
          build: {
            outDir: 'dist-electron',
            rollupOptions: {
              external: ['electron']
            }
          }
        }
      }
    ]),
    renderer()
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src')
    }
  }
})
````

## File: electron/services/git.ts
````typescript
import { exec } from 'child_process'
import { promisify } from 'util'

const execAsync = promisify(exec)

export interface RepoInfo {
  branch: string
  remote: string | null
  hasChanges: boolean
  isProtectedBranch: boolean
  defaultBranch: string
  ahead: number
  behind: number
}

const PROTECTED_BRANCHES = ['main', 'master', 'develop', 'production', 'staging']

async function runGitCommand(repoPath: string, command: string): Promise<string> {
  const { stdout } = await execAsync(command, { cwd: repoPath, timeout: 30000 })
  return stdout.trim()
}

export async function getRepoInfo(repoPath: string): Promise<RepoInfo> {
  try {
    const branch = await runGitCommand(repoPath, 'git rev-parse --abbrev-ref HEAD')

    let remote: string | null = null
    try {
      remote = await runGitCommand(repoPath, 'git remote get-url origin')
    } catch {}

    let hasChanges = false
    try {
      const status = await runGitCommand(repoPath, 'git status --porcelain')
      hasChanges = status.length > 0
    } catch {}

    // Detect default branch
    let defaultBranch = 'main'
    try {
      const remoteInfo = await runGitCommand(repoPath, 'git remote show origin 2>/dev/null | grep "HEAD branch"')
      const match = remoteInfo.match(/HEAD branch:\s*(\S+)/)
      if (match) {
        defaultBranch = match[1]
      }
    } catch {
      // Check if main or master exists
      try {
        await runGitCommand(repoPath, 'git rev-parse --verify main')
        defaultBranch = 'main'
      } catch {
        try {
          await runGitCommand(repoPath, 'git rev-parse --verify master')
          defaultBranch = 'master'
        } catch {}
      }
    }

    const isProtectedBranch = PROTECTED_BRANCHES.includes(branch.toLowerCase())

    // Get ahead/behind counts relative to remote tracking branch
    let ahead = 0
    let behind = 0
    try {
      // First try to get upstream tracking branch
      const upstream = await runGitCommand(repoPath, `git rev-parse --abbrev-ref ${branch}@{upstream} 2>/dev/null`)
      if (upstream) {
        const counts = await runGitCommand(repoPath, `git rev-list --left-right --count ${upstream}...HEAD`)
        const [behindStr, aheadStr] = counts.split(/\s+/)
        behind = parseInt(behindStr, 10) || 0
        ahead = parseInt(aheadStr, 10) || 0
      }
    } catch {
      // No upstream configured or other error - leave as 0
    }

    return { branch, remote, hasChanges, isProtectedBranch, defaultBranch, ahead, behind }
  } catch (error) {
    return {
      branch: 'unknown',
      remote: null,
      hasChanges: false,
      isProtectedBranch: false,
      defaultBranch: 'main',
      ahead: 0,
      behind: 0
    }
  }
}

export async function isOnProtectedBranch(repoPath: string): Promise<boolean> {
  const info = await getRepoInfo(repoPath)
  return info.isProtectedBranch
}

export async function ensureSafeBranch(repoPath: string, targetBranch: string): Promise<void> {
  const info = await getRepoInfo(repoPath)

  if (info.isProtectedBranch) {
    throw new Error(`Cannot work on protected branch '${info.branch}'. Bridge will create a new branch.`)
  }

  if (info.hasChanges) {
    throw new Error('Repository has uncommitted changes. Please commit or stash them first.')
  }
}

export async function createBranch(repoPath: string, branchName: string): Promise<void> {
  const info = await getRepoInfo(repoPath)

  // If on protected branch, switch to default first
  if (info.isProtectedBranch) {
    try {
      await runGitCommand(repoPath, 'git fetch origin')
    } catch {}

    // Make sure we're up to date with default branch
    await runGitCommand(repoPath, `git checkout ${info.defaultBranch}`)
    try {
      await runGitCommand(repoPath, `git pull origin ${info.defaultBranch}`)
    } catch {}
  }

  // Create and checkout new branch
  await runGitCommand(repoPath, `git checkout -b ${branchName}`)
}

export async function commitChanges(repoPath: string, message: string, files?: string[]): Promise<void> {
  if (files && files.length > 0) {
    // Add specific files
    for (const file of files) {
      try {
        await runGitCommand(repoPath, `git add "${file}"`)
      } catch {}
    }
  } else {
    // Add common dependency files
    const commonFiles = [
      'package.json', 'package-lock.json',
      'requirements.txt', 'Pipfile.lock',
      'Gemfile', 'Gemfile.lock',
      'mix.exs', 'mix.lock'
    ]
    for (const file of commonFiles) {
      try {
        await runGitCommand(repoPath, `git add "${file}"`)
      } catch {}
    }
  }

  await runGitCommand(repoPath, `git commit -m "${message.replace(/"/g, '\\"')}"`)
}

export async function pushBranch(repoPath: string, branchName: string): Promise<void> {
  await runGitCommand(repoPath, `git push -u origin ${branchName}`)
}

export async function createPullRequest(
  repoPath: string,
  title: string,
  body: string
): Promise<string> {
  const result = await runGitCommand(
    repoPath,
    `gh pr create --title "${title.replace(/"/g, '\\"')}" --body "${body.replace(/"/g, '\\"')}"`
  )
  return result
}

export async function runTests(repoPath: string, command: string): Promise<{ success: boolean; output: string }> {
  try {
    const { stdout, stderr } = await execAsync(command, {
      cwd: repoPath,
      timeout: 300000, // 5 min timeout for tests
      maxBuffer: 10 * 1024 * 1024
    })
    return { success: true, output: stdout + stderr }
  } catch (error: any) {
    return { success: false, output: error.stdout + error.stderr || error.message }
  }
}

export async function runLint(repoPath: string, command: string): Promise<{ success: boolean; output: string }> {
  try {
    const { stdout, stderr } = await execAsync(command, {
      cwd: repoPath,
      timeout: 120000,
      maxBuffer: 10 * 1024 * 1024
    })
    return { success: true, output: stdout + stderr }
  } catch (error: any) {
    return { success: false, output: error.stdout + error.stderr || error.message }
  }
}

// Stash changes temporarily
export async function stashChanges(repoPath: string): Promise<boolean> {
  try {
    await runGitCommand(repoPath, 'git stash')
    return true
  } catch {
    return false
  }
}

// Pop stashed changes
export async function popStash(repoPath: string): Promise<boolean> {
  try {
    await runGitCommand(repoPath, 'git stash pop')
    return true
  } catch {
    return false
  }
}

// Abort and cleanup on failure
export async function abortChanges(repoPath: string, originalBranch: string): Promise<void> {
  try {
    // Discard all changes
    await runGitCommand(repoPath, 'git checkout -- .')
    await runGitCommand(repoPath, 'git clean -fd')

    // Go back to original branch
    await runGitCommand(repoPath, `git checkout ${originalBranch}`)
  } catch (e) {
    console.error('Failed to abort changes:', e)
  }
}

// Delete a branch
export async function deleteBranch(repoPath: string, branchName: string): Promise<void> {
  try {
    await runGitCommand(repoPath, `git branch -D ${branchName}`)
  } catch {}
}
````

## File: electron/preload.ts
````typescript
import { contextBridge, ipcRenderer } from 'electron'

export type Language = 'javascript' | 'python' | 'ruby' | 'elixir' | 'unknown'
export type ScheduleFrequency = 'daily' | 'weekly' | 'monthly'

export interface Repository {
  path: string
  name: string
  languages: Language[]
  hasGit: boolean
  addedAt: string
  exists: boolean
}

export interface OutdatedPackage {
  name: string
  current: string
  wanted: string
  latest: string
  type: 'dependencies' | 'devDependencies'
  hasPatchUpdate: boolean
  language: Language
}

export interface FileEntry {
  name: string
  path: string
  isDirectory: boolean
  size?: number
  modified?: string
}

export interface RepoInfo {
  branch: string
  remote: string | null
  hasChanges: boolean
  isProtectedBranch: boolean
  defaultBranch: string
  ahead: number
  behind: number
}

export interface PatchBatchConfig {
  repoPath: string
  branchName: string
  packages: { name: string; language: Language }[]
  createPR: boolean
  runTests: boolean
  prTitle?: string
  prBody?: string
}

export interface PatchBatchResult {
  success: boolean
  updatedPackages?: string[]
  failedPackages?: string[]
  prUrl?: string | null
  error?: string
  testsPassed?: boolean
  testOutput?: string
}

export interface LargeFile {
  path: string
  size: number
  sizeFormatted: string
  type: 'current' | 'git-history'
}

export interface OversizedComponent {
  path: string
  lines: number
  type: string
}

export interface CleanupReport {
  largeFiles: LargeFile[]
  gitHistoryFiles: LargeFile[]
  oversizedComponents: OversizedComponent[]
  totalWastedSpace: number
  totalWastedSpaceFormatted: string
}

export interface FileSizeStats {
  totalSize: number
  totalSizeFormatted: string
  fileCount: number
  largestFiles: LargeFile[]
}

export interface ScheduledJob {
  id: string
  repoPath: string
  repoName: string
  frequency: ScheduleFrequency
  enabled: boolean
  lastRun: string | null
  nextRun: string
  language: string
  createPR: boolean
  runTests: boolean
  createdAt: string
}

export interface JobResult {
  jobId: string
  success: boolean
  timestamp: string
  updatedPackages: string[]
  prUrl?: string
  error?: string
  testsPassed?: boolean
}

export interface SecurityFinding {
  file: string
  line: number
  issue: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  code: string
  description: string
  cwe: string
  owasp: string
  solution?: string
  fixedCode?: string
}

export interface ScanResult {
  scanId: string
  repoPath: string
  totalFindings: number
  criticalCount: number
  highCount: number
  mediumCount: number
  lowCount: number
  findings: SecurityFinding[]
  scannedAt: string
  duration: number
}

export interface ScanProgress {
  status: 'scanning' | 'analyzing' | 'generating-fixes' | 'complete' | 'error'
  progress: number
  message: string
  currentFile?: string
}

contextBridge.exposeInMainWorld('bridge', {
  // Repository management
  selectDirectory: (): Promise<string | null> =>
    ipcRenderer.invoke('select-directory'),

  scanRepository: (path: string): Promise<Repository> =>
    ipcRenderer.invoke('scan-repository', path),

  readDirectory: (path: string): Promise<FileEntry[]> =>
    ipcRenderer.invoke('read-directory', path),

  readFile: (path: string): Promise<string> =>
    ipcRenderer.invoke('read-file', path),

  detectLanguages: (path: string): Promise<Language[]> =>
    ipcRenderer.invoke('detect-languages', path),

  // Persistence
  getRepositories: (): Promise<Repository[]> =>
    ipcRenderer.invoke('get-repositories'),

  saveRepositories: (repos: Repository[]): Promise<boolean> =>
    ipcRenderer.invoke('save-repositories', repos),

  removeRepository: (path: string): Promise<Repository[]> =>
    ipcRenderer.invoke('remove-repository', path),

  cleanupMissingRepos: (): Promise<Repository[]> =>
    ipcRenderer.invoke('cleanup-missing-repos'),

  // Analysis
  getFileStats: (repoPath: string): Promise<FileSizeStats> =>
    ipcRenderer.invoke('get-file-stats', repoPath),

  getCleanupReport: (repoPath: string): Promise<CleanupReport> =>
    ipcRenderer.invoke('get-cleanup-report', repoPath),

  // Patch Batch
  getOutdatedPackages: (repoPath: string, language?: Language): Promise<OutdatedPackage[]> =>
    ipcRenderer.invoke('get-outdated-packages', repoPath, language),

  runPatchBatch: (config: PatchBatchConfig): Promise<PatchBatchResult> =>
    ipcRenderer.invoke('run-patch-batch', config),

  onPatchBatchProgress: (callback: (progress: { message: string; step: number; total: number }) => void) => {
    ipcRenderer.on('patch-batch-progress', (_, progress) => callback(progress))
    return () => ipcRenderer.removeAllListeners('patch-batch-progress')
  },

  onPatchBatchWarning: (callback: (warning: { message: string; output: string }) => void) => {
    ipcRenderer.on('patch-batch-warning', (_, warning) => callback(warning))
    return () => ipcRenderer.removeAllListeners('patch-batch-warning')
  },

  // Git
  getRepoInfo: (repoPath: string): Promise<RepoInfo> =>
    ipcRenderer.invoke('get-repo-info', repoPath),

  checkProtectedBranch: (repoPath: string): Promise<boolean> =>
    ipcRenderer.invoke('check-protected-branch', repoPath),

  // Scheduler
  getScheduledJobs: (): Promise<ScheduledJob[]> =>
    ipcRenderer.invoke('get-scheduled-jobs'),

  addScheduledJob: (job: Omit<ScheduledJob, 'id' | 'createdAt' | 'lastRun' | 'nextRun'>): Promise<ScheduledJob> =>
    ipcRenderer.invoke('add-scheduled-job', job),

  updateScheduledJob: (jobId: string, updates: Partial<ScheduledJob>): Promise<ScheduledJob | null> =>
    ipcRenderer.invoke('update-scheduled-job', jobId, updates),

  deleteScheduledJob: (jobId: string): Promise<boolean> =>
    ipcRenderer.invoke('delete-scheduled-job', jobId),

  getJobResults: (jobId?: string): Promise<JobResult[]> =>
    ipcRenderer.invoke('get-job-results', jobId),

  onSchedulerJobStarted: (callback: (data: { jobId: string; repoName: string }) => void) => {
    ipcRenderer.on('scheduler-job-started', (_, data) => callback(data))
    return () => ipcRenderer.removeAllListeners('scheduler-job-started')
  },

  // Security Scanner
  checkSecurityScannerAvailable: (): Promise<boolean> =>
    ipcRenderer.invoke('check-security-scanner-available'),

  runSecurityScan: (repoPath: string): Promise<ScanResult> =>
    ipcRenderer.invoke('run-security-scan', repoPath),

  generateSecurityFix: (finding: SecurityFinding): Promise<string | null> =>
    ipcRenderer.invoke('generate-security-fix', finding),

  onSecurityScanProgress: (callback: (progress: ScanProgress) => void) => {
    ipcRenderer.on('security-scan-progress', (_, progress) => callback(progress))
    return () => ipcRenderer.removeAllListeners('security-scan-progress')
  }
})

declare global {
  interface Window {
    bridge: {
      selectDirectory: () => Promise<string | null>
      scanRepository: (path: string) => Promise<Repository>
      readDirectory: (path: string) => Promise<FileEntry[]>
      readFile: (path: string) => Promise<string>
      detectLanguages: (path: string) => Promise<Language[]>
      getRepositories: () => Promise<Repository[]>
      saveRepositories: (repos: Repository[]) => Promise<boolean>
      removeRepository: (path: string) => Promise<Repository[]>
      cleanupMissingRepos: () => Promise<Repository[]>
      getFileStats: (repoPath: string) => Promise<FileSizeStats>
      getCleanupReport: (repoPath: string) => Promise<CleanupReport>
      getOutdatedPackages: (repoPath: string, language?: Language) => Promise<OutdatedPackage[]>
      runPatchBatch: (config: PatchBatchConfig) => Promise<PatchBatchResult>
      onPatchBatchProgress: (callback: (progress: { message: string; step: number; total: number }) => void) => () => void
      onPatchBatchWarning: (callback: (warning: { message: string; output: string }) => void) => () => void
      getRepoInfo: (repoPath: string) => Promise<RepoInfo>
      checkProtectedBranch: (repoPath: string) => Promise<boolean>
      getScheduledJobs: () => Promise<ScheduledJob[]>
      addScheduledJob: (job: Omit<ScheduledJob, 'id' | 'createdAt' | 'lastRun' | 'nextRun'>) => Promise<ScheduledJob>
      updateScheduledJob: (jobId: string, updates: Partial<ScheduledJob>) => Promise<ScheduledJob | null>
      deleteScheduledJob: (jobId: string) => Promise<boolean>
      getJobResults: (jobId?: string) => Promise<JobResult[]>
      onSchedulerJobStarted: (callback: (data: { jobId: string; repoName: string }) => void) => () => void
      checkSecurityScannerAvailable: () => Promise<boolean>
      runSecurityScan: (repoPath: string) => Promise<ScanResult>
      generateSecurityFix: (finding: SecurityFinding) => Promise<string | null>
      onSecurityScanProgress: (callback: (progress: ScanProgress) => void) => () => void
    }
  }
}
````

## File: src/components/Layout/Sidebar.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { View, Language, RepoInfo } from '../../types'

interface SidebarProps {
  currentView: View
  onNavigate: (view: View) => void
}

const LANGUAGE_COLORS: Record<Language, string> = {
  javascript: '#f7df1e',
  python: '#3776ab',
  ruby: '#cc342d',
  elixir: '#6e4a7e',
  unknown: '#666666'
}

export default function Sidebar({ currentView, onNavigate }: SidebarProps) {
  const { repositories, selectedRepo, selectRepository, addRepository } = useRepositories()
  const [repoInfoMap, setRepoInfoMap] = useState<Record<string, RepoInfo>>({})

  useEffect(() => {
    const fetchRepoInfo = async () => {
      const newInfoMap: Record<string, RepoInfo> = {}
      for (const repo of repositories) {
        if (repo.hasGit && repo.exists) {
          try {
            const info = await window.bridge.getRepoInfo(repo.path)
            newInfoMap[repo.path] = info
          } catch {
            // Ignore errors
          }
        }
      }
      setRepoInfoMap(newInfoMap)
    }
    fetchRepoInfo()
  }, [repositories])

  const handleImport = async () => {
    const path = await window.bridge.selectDirectory()
    if (path) {
      await addRepository(path)
    }
  }

  return (
    <aside className="app-sidebar">
      <div className="sidebar-header">
        <div className="sidebar-logo">
          <span className="sidebar-logo-icon">B</span>
          Bridge
        </div>
      </div>

      <nav className="sidebar-nav">
        <div className="nav-section">
          <div className="nav-section-title">Navigation</div>
          <button
            className={`nav-item ${currentView === 'dashboard' ? 'active' : ''}`}
            onClick={() => onNavigate('dashboard')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <rect x="3" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="3" width="7" height="7" rx="1" />
              <rect x="3" y="14" width="7" height="7" rx="1" />
              <rect x="14" y="14" width="7" height="7" rx="1" />
            </svg>
            Dashboard
          </button>
          <button
            className={`nav-item ${currentView === 'files' ? 'active' : ''}`}
            onClick={() => onNavigate('files')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
            </svg>
            Files
          </button>
          <button
            className={`nav-item ${currentView === 'patch-batch' ? 'active' : ''}`}
            onClick={() => onNavigate('patch-batch')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M21 12a9 9 0 11-9-9" />
              <path d="M21 3v6h-6" />
            </svg>
            Patch Batch
          </button>
          <button
            className={`nav-item ${currentView === 'cleanup' ? 'active' : ''}`}
            onClick={() => onNavigate('cleanup')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
            </svg>
            Cleanup
          </button>
          <button
            className={`nav-item ${currentView === 'scheduler' ? 'active' : ''}`}
            onClick={() => onNavigate('scheduler')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
            Scheduler
          </button>
          <button
            className={`nav-item ${currentView === 'security' ? 'active' : ''}`}
            onClick={() => onNavigate('security')}
          >
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            Security
          </button>
        </div>

        <div className="nav-section">
          <div className="nav-section-title">Repositories</div>
          <button className="nav-item" onClick={handleImport}>
            <svg className="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Import Repository
          </button>

          <div className="repo-list">
            {repositories.map(repo => {
              const info = repoInfoMap[repo.path]
              const hasSync = info && (info.ahead > 0 || info.behind > 0)
              return (
                <button
                  key={repo.path}
                  className={`repo-item ${selectedRepo?.path === repo.path ? 'active' : ''}`}
                  onClick={() => selectRepository(repo)}
                  style={{ opacity: repo.exists ? 1 : 0.5 }}
                >
                  <span
                    className="repo-dot"
                    style={{
                      background: repo.languages?.[0] ? LANGUAGE_COLORS[repo.languages[0]] : LANGUAGE_COLORS.unknown
                    }}
                  />
                  <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis' }}>{repo.name}</span>
                  {hasSync && (
                    <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', display: 'flex', gap: '4px' }}>
                      {info.behind > 0 && <span title={`${info.behind} behind`}>{info.behind}</span>}
                      {info.ahead > 0 && <span title={`${info.ahead} ahead`}>{info.ahead}</span>}
                    </span>
                  )}
                  {(repo.languages?.length ?? 0) > 1 && (
                    <span style={{ fontSize: '10px', color: 'var(--text-tertiary)' }}>+{repo.languages!.length - 1}</span>
                  )}
                </button>
              )
            })}
          </div>
        </div>
      </nav>
    </aside>
  )
}
````

## File: src/components/PatchBatch/PatchBatch.tsx
````typescript
import { useState, useEffect } from 'react'
import { useRepositories } from '../../contexts/RepositoryContext'
import type { OutdatedPackage, Language } from '../../types'

const LANGUAGE_LABELS: Record<Language, string> = {
  javascript: 'JS',
  python: 'Py',
  ruby: 'Rb',
  elixir: 'Ex',
  unknown: '?'
}

export default function PatchBatch() {
  const { selectedRepo } = useRepositories()
  const [packages, setPackages] = useState<OutdatedPackage[]>([])
  const [selectedPackages, setSelectedPackages] = useState<Set<string>>(new Set())
  const [loading, setLoading] = useState(false)
  const [running, setRunning] = useState(false)
  const [progress, setProgress] = useState<{ message: string; step: number; total: number } | null>(null)
  const [result, setResult] = useState<{ success: boolean; prUrl?: string | null; error?: string; testsPassed?: boolean } | null>(null)
  const [branchName, setBranchName] = useState('bridge-updates')
  const [createPR, setCreatePR] = useState(true)
  const [runTests, setRunTests] = useState(true)
  const [repoInfo, setRepoInfo] = useState<{ branch: string; isProtectedBranch: boolean } | null>(null)

  useEffect(() => {
    if (selectedRepo) {
      loadOutdatedPackages()
      loadRepoInfo()
    }
  }, [selectedRepo])

  useEffect(() => {
    if (running) {
      const cleanup = window.bridge.onPatchBatchProgress(setProgress)
      return cleanup
    }
  }, [running])

  const loadRepoInfo = async () => {
    if (!selectedRepo) return
    const info = await window.bridge.getRepoInfo(selectedRepo.path)
    setRepoInfo(info)
  }

  const loadOutdatedPackages = async () => {
    if (!selectedRepo) return

    setLoading(true)
    setResult(null)
    try {
      const outdated = await window.bridge.getOutdatedPackages(selectedRepo.path)
      setPackages(outdated)

      const patchPackages = outdated.filter(p => p.hasPatchUpdate).map(p => `${p.language}:${p.name}`)
      setSelectedPackages(new Set(patchPackages))
    } catch (error) {
      console.error('Failed to get outdated packages:', error)
    } finally {
      setLoading(false)
    }
  }

  const getPackageKey = (pkg: OutdatedPackage) => `${pkg.language}:${pkg.name}`

  const togglePackage = (pkg: OutdatedPackage) => {
    const key = getPackageKey(pkg)
    const next = new Set(selectedPackages)
    if (next.has(key)) {
      next.delete(key)
    } else {
      next.add(key)
    }
    setSelectedPackages(next)
  }

  const selectAllPatch = () => {
    const patchPackages = packages.filter(p => p.hasPatchUpdate).map(getPackageKey)
    setSelectedPackages(new Set(patchPackages))
  }

  const clearSelection = () => {
    setSelectedPackages(new Set())
  }

  const runPatchBatch = async () => {
    if (!selectedRepo || selectedPackages.size === 0) return

    setRunning(true)
    setProgress(null)
    setResult(null)

    try {
      const packagesToUpdate = packages
        .filter(p => selectedPackages.has(getPackageKey(p)))
        .map(p => ({ name: p.name, language: p.language }))

      const result = await window.bridge.runPatchBatch({
        repoPath: selectedRepo.path,
        branchName: `${branchName}-${Date.now()}`,
        packages: packagesToUpdate,
        createPR,
        runTests,
        prTitle: `chore(deps): update ${packagesToUpdate.length} packages to latest patch versions`,
        prBody: `## Summary\nAutomated patch version updates via Bridge.\n\n### Updated packages\n${packagesToUpdate.map(p => `- ${p.name} (${p.language})`).join('\n')}`
      })

      setResult(result)

      if (result.success) {
        await loadOutdatedPackages()
        await loadRepoInfo()
      }
    } catch (error) {
      setResult({
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error'
      })
    } finally {
      setRunning(false)
      setProgress(null)
    }
  }

  const patchUpdatesCount = packages.filter(p => p.hasPatchUpdate).length

  if (!selectedRepo) {
    return (
      <div className="empty-state fade-in">
        <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
          <path d="M21 12a9 9 0 11-9-9" />
          <path d="M21 3v6h-6" />
        </svg>
        <h3 className="empty-state-title">No repository selected</h3>
        <p className="empty-state-desc">Select a repository from the sidebar to update packages</p>
      </div>
    )
  }

  if ((selectedRepo.languages?.length ?? 0) === 0) {
    return (
      <div className="empty-state fade-in">
        <svg className="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
        <h3 className="empty-state-title">No supported package manager</h3>
        <p className="empty-state-desc">This repository doesn't have package.json, requirements.txt, Gemfile, or mix.exs</p>
      </div>
    )
  }

  return (
    <div className="fade-in">
      <div style={{ marginBottom: '24px' }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
          <div>
            <h2 style={{ marginBottom: '4px' }}>Patch Batch</h2>
            <p style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
              Update packages to their latest patch versions safely.
            </p>
          </div>
          <button
            className="btn btn-secondary btn-sm"
            onClick={loadOutdatedPackages}
            disabled={loading}
          >
            {loading ? <div className="spinner" style={{ width: '14px', height: '14px' }} /> : (
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 4v6h-6M1 20v-6h6" />
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
              </svg>
            )}
            Refresh
          </button>
        </div>

        {repoInfo?.isProtectedBranch && (
          <div className="card" style={{ marginBottom: '16px', borderColor: 'var(--warning)', background: 'rgba(245, 158, 11, 0.1)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: 'var(--warning)' }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
              <span>You're on <strong>{repoInfo.branch}</strong> (protected). Bridge will create a new branch automatically.</span>
            </div>
          </div>
        )}

        {result && (
          <div
            className="card"
            style={{
              marginBottom: '16px',
              borderColor: result.success ? 'var(--success)' : 'var(--error)',
              background: result.success ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'
            }}
          >
            {result.success ? (
              <div>
                <div style={{ fontWeight: 500, marginBottom: '8px', color: 'var(--success)' }}>
                  Patch update completed successfully!
                </div>
                {result.testsPassed && (
                  <div style={{ fontSize: '13px', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                    All tests passed
                  </div>
                )}
                {result.prUrl && (
                  <div style={{ fontSize: '13px' }}>
                    Pull request created:{' '}
                    <a href={result.prUrl} target="_blank" rel="noopener noreferrer">
                      {result.prUrl}
                    </a>
                  </div>
                )}
              </div>
            ) : (
              <div style={{ color: 'var(--error)' }}>
                <div style={{ fontWeight: 500, marginBottom: '4px' }}>Update failed</div>
                <div style={{ fontSize: '13px' }}>{result.error}</div>
              </div>
            )}
          </div>
        )}

        {running && progress && (
          <div className="card" style={{ marginBottom: '16px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
              <div className="spinner" />
              <span>{progress.message}</span>
            </div>
            <div className="progress-bar">
              <div className="progress-fill" style={{ width: `${(progress.step / progress.total) * 100}%` }} />
            </div>
          </div>
        )}
      </div>

      <div className="card" style={{ marginBottom: '24px' }}>
        <div className="card-header">
          <h3 className="card-title">Configuration</h3>
        </div>

        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          <div>
            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: 'var(--text-secondary)' }}>
              Branch name prefix
            </label>
            <input
              type="text"
              className="input"
              value={branchName}
              onChange={e => setBranchName(e.target.value)}
              placeholder="bridge-updates"
              style={{ maxWidth: '300px' }}
            />
          </div>

          <div style={{ display: 'flex', gap: '24px' }}>
            <label className="checkbox-wrapper">
              <div
                className={`checkbox ${createPR ? 'checked' : ''}`}
                onClick={() => setCreatePR(!createPR)}
              >
                {createPR && (
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="3">
                    <polyline points="20 6 9 17 4 12" />
                  </svg>
                )}
              </div>
              <span className="checkbox-label">Create pull request</span>
            </label>

            <label className="checkbox-wrapper">
              <div
                className={`checkbox ${runTests ? 'checked' : ''}`}
                onClick={() => setRunTests(!runTests)}
              >
                {runTests && (
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="3">
                    <polyline points="20 6 9 17 4 12" />
                  </svg>
                )}
              </div>
              <span className="checkbox-label">Run tests before PR</span>
            </label>
          </div>
        </div>
      </div>

      <div className="card">
        <div className="card-header">
          <div>
            <h3 className="card-title">Outdated Packages</h3>
            {patchUpdatesCount > 0 && (
              <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                {patchUpdatesCount} patch update{patchUpdatesCount !== 1 ? 's' : ''} available
              </span>
            )}
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <button className="btn btn-ghost btn-sm" onClick={selectAllPatch}>
              Select patch updates
            </button>
            <button className="btn btn-ghost btn-sm" onClick={clearSelection}>
              Clear
            </button>
          </div>
        </div>

        {loading ? (
          <div style={{ display: 'flex', justifyContent: 'center', padding: '40px' }}>
            <div className="spinner" />
          </div>
        ) : packages.length === 0 ? (
          <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ margin: '0 auto 16px', opacity: 0.5 }}>
              <circle cx="12" cy="12" r="10" />
              <path d="M9 12l2 2 4-4" />
            </svg>
            <div>All packages are up to date!</div>
          </div>
        ) : (
          <div className="package-list">
            {packages.map(pkg => {
              const key = getPackageKey(pkg)
              return (
                <div
                  key={key}
                  className={`package-item ${selectedPackages.has(key) ? 'selected' : ''}`}
                  onClick={() => pkg.hasPatchUpdate && togglePackage(pkg)}
                  style={{ opacity: pkg.hasPatchUpdate ? 1 : 0.5, cursor: pkg.hasPatchUpdate ? 'pointer' : 'default' }}
                >
                  <div
                    className={`checkbox ${selectedPackages.has(key) ? 'checked' : ''}`}
                    style={{ pointerEvents: 'none' }}
                  >
                    {selectedPackages.has(key) && (
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="3">
                        <polyline points="20 6 9 17 4 12" />
                      </svg>
                    )}
                  </div>
                  <div className="package-info">
                    <div className="package-name">{pkg.name}</div>
                    <div className="package-versions">
                      <span>{pkg.current}</span>
                      <span className="version-arrow"></span>
                      <span className="version-new">{pkg.wanted}</span>
                      {pkg.latest !== pkg.wanted && (
                        <>
                          <span style={{ color: 'var(--text-tertiary)' }}>|</span>
                          <span style={{ color: 'var(--text-tertiary)' }}>latest: {pkg.latest}</span>
                        </>
                      )}
                    </div>
                  </div>
                  <span className="badge" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', fontSize: '10px' }}>
                    {LANGUAGE_LABELS[pkg.language]}
                  </span>
                  <span className={`badge ${pkg.hasPatchUpdate ? 'badge-success' : 'badge-warning'}`}>
                    {pkg.hasPatchUpdate ? 'patch' : 'minor/major'}
                  </span>
                  <span className="badge" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>
                    {pkg.type === 'devDependencies' ? 'dev' : 'prod'}
                  </span>
                </div>
              )
            })}
          </div>
        )}

        {packages.length > 0 && (
          <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid var(--border-color)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <span style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
              {selectedPackages.size} package{selectedPackages.size !== 1 ? 's' : ''} selected
            </span>
            <button
              className="btn btn-primary"
              onClick={runPatchBatch}
              disabled={selectedPackages.size === 0 || running}
            >
              {running ? (
                <>
                  <div className="spinner" style={{ width: '14px', height: '14px', borderTopColor: '#000' }} />
                  Running...
                </>
              ) : (
                <>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 12a9 9 0 11-9-9" />
                    <path d="M21 3v6h-6" />
                  </svg>
                  Run Patch Batch
                </>
              )}
            </button>
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: src/contexts/RepositoryContext.tsx
````typescript
import React, { createContext, useContext, useEffect, useState } from 'react'
import type { Repository } from '../types'

interface RepositoryContextType {
  repositories: Repository[]
  selectedRepo: Repository | null
  loading: boolean
  addRepository: (path: string) => Promise<void>
  removeRepository: (path: string) => Promise<void>
  selectRepository: (repo: Repository | null) => void
  refreshRepositories: () => Promise<void>
  cleanupMissingRepos: () => Promise<void>
}

const RepositoryContext = createContext<RepositoryContextType | undefined>(undefined)

export function RepositoryProvider({ children }: { children: React.ReactNode }) {
  const [repositories, setRepositories] = useState<Repository[]>([])
  const [selectedRepo, setSelectedRepo] = useState<Repository | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadRepositories()
  }, [])

  const loadRepositories = async () => {
    try {
      const repos = await window.bridge.getRepositories()
      // Filter out missing repos
      const existingRepos = repos.filter((r: Repository) => r.exists)
      setRepositories(existingRepos)

      // If selected repo no longer exists, deselect it
      if (selectedRepo && !existingRepos.find((r: Repository) => r.path === selectedRepo.path)) {
        setSelectedRepo(null)
      }
    } catch (error) {
      console.error('Failed to load repositories:', error)
    } finally {
      setLoading(false)
    }
  }

  const addRepository = async (path: string) => {
    const repo = await window.bridge.scanRepository(path)

    if (!repo.exists) {
      throw new Error('Repository path does not exist')
    }

    const exists = repositories.find(r => r.path === repo.path)
    if (exists) {
      setSelectedRepo(exists)
      return
    }

    const updated = [...repositories, repo]
    await window.bridge.saveRepositories(updated)
    setRepositories(updated)
    setSelectedRepo(repo)
  }

  const removeRepository = async (path: string) => {
    const updated = await window.bridge.removeRepository(path)
    setRepositories(updated.filter((r: Repository) => r.exists))

    if (selectedRepo?.path === path) {
      setSelectedRepo(null)
    }
  }

  const selectRepository = (repo: Repository | null) => {
    setSelectedRepo(repo)
  }

  const refreshRepositories = async () => {
    setLoading(true)
    await loadRepositories()
  }

  const cleanupMissingRepos = async () => {
    const cleaned = await window.bridge.cleanupMissingRepos()
    setRepositories(cleaned)
  }

  return (
    <RepositoryContext.Provider value={{
      repositories,
      selectedRepo,
      loading,
      addRepository,
      removeRepository,
      selectRepository,
      refreshRepositories,
      cleanupMissingRepos
    }}>
      {children}
    </RepositoryContext.Provider>
  )
}

export function useRepositories() {
  const context = useContext(RepositoryContext)
  if (!context) {
    throw new Error('useRepositories must be used within a RepositoryProvider')
  }
  return context
}
````

## File: src/types/index.ts
````typescript
export type Language = 'javascript' | 'python' | 'ruby' | 'elixir' | 'unknown'
export type ScheduleFrequency = 'daily' | 'weekly' | 'monthly'

export interface Repository {
  path: string
  name: string
  languages: Language[]
  hasGit: boolean
  addedAt: string
  exists: boolean
}

export interface OutdatedPackage {
  name: string
  current: string
  wanted: string
  latest: string
  type: 'dependencies' | 'devDependencies'
  hasPatchUpdate: boolean
  language: Language
}

export interface FileEntry {
  name: string
  path: string
  isDirectory: boolean
  size?: number
  modified?: string
}

export interface RepoInfo {
  branch: string
  remote: string | null
  hasChanges: boolean
  isProtectedBranch: boolean
  defaultBranch: string
  ahead: number
  behind: number
}

export interface PatchBatchConfig {
  repoPath: string
  branchName: string
  packages: { name: string; language: Language }[]
  createPR: boolean
  runTests: boolean
  prTitle?: string
  prBody?: string
}

export interface PatchBatchResult {
  success: boolean
  updatedPackages?: string[]
  failedPackages?: string[]
  prUrl?: string | null
  error?: string
  testsPassed?: boolean
  testOutput?: string
}

export interface LargeFile {
  path: string
  size: number
  sizeFormatted: string
  type: 'current' | 'git-history'
}

export interface OversizedComponent {
  path: string
  lines: number
  type: string
}

export interface CleanupReport {
  largeFiles: LargeFile[]
  gitHistoryFiles: LargeFile[]
  oversizedComponents: OversizedComponent[]
  totalWastedSpace: number
  totalWastedSpaceFormatted: string
}

export interface FileSizeStats {
  totalSize: number
  totalSizeFormatted: string
  fileCount: number
  largestFiles: LargeFile[]
}

export interface ScheduledJob {
  id: string
  repoPath: string
  repoName: string
  frequency: ScheduleFrequency
  enabled: boolean
  lastRun: string | null
  nextRun: string
  language: string
  createPR: boolean
  runTests: boolean
  createdAt: string
}

export interface JobResult {
  jobId: string
  success: boolean
  timestamp: string
  updatedPackages: string[]
  prUrl?: string
  error?: string
  testsPassed?: boolean
}

export interface SecurityFinding {
  file: string
  line: number
  issue: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  code: string
  description: string
  cwe: string
  owasp: string
  solution?: string
  fixedCode?: string
}

export interface ScanResult {
  scanId: string
  repoPath: string
  totalFindings: number
  criticalCount: number
  highCount: number
  mediumCount: number
  lowCount: number
  findings: SecurityFinding[]
  scannedAt: string
  duration: number
}

export interface ScanProgress {
  status: 'scanning' | 'analyzing' | 'generating-fixes' | 'complete' | 'error'
  progress: number
  message: string
  currentFile?: string
}

export type View = 'dashboard' | 'files' | 'patch-batch' | 'cleanup' | 'scheduler' | 'security'
````

## File: .gitignore
````
# Dependencies
node_modules/

# Build intermediates (not final releases)
dist-electron/
out/
build/

# Keep dist/ for releases but ignore intermediate files
dist/
!dist/*.dmg
!dist/*.zip

# Releases folder is tracked
!releases/

# macOS
.DS_Store
._*

# Logs
*.log
npm-debug.log*
yarn-debug.log*

# TypeScript
*.tsbuildinfo

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# Environment
.env
.env.local
.env.*.local

# Python (for agentic_fixer if used)
__pycache__/
*.py[cod]
venv/
.venv/

# Temp
*.tmp
*.temp
.cache/
````
